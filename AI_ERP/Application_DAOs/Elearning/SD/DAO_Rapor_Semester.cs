using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Data;
using System.Data.Common;
using System.Data.SqlClient;
using System.Drawing;
using System.IO;

using AI_ERP.Application_Libs;
using AI_ERP.Application_Entities;
using AI_ERP.Application_Entities.Elearning.SD;
using AI_ERP.Application_Entities.Elearning.SD.Reports;

namespace AI_ERP.Application_DAOs.Elearning.SD
{
    public static class DAO_Rapor_Semester
    {
        public const string SP_SELECT_ALL = "SD_Rapor_Semester_SELECT_ALL";
        public const string SP_SELECT_ALL_FOR_SEARCH = "SD_Rapor_Semester_SELECT_ALL_FOR_SEARCH";
        public const string SP_SELECT_BY_ID = "SD_Rapor_Semester_SELECT_BY_ID";
        public const string SP_SELECT_BY_TA_BY_SM_BY_KELAS_DET = "SD_Rapor_Semester_SELECT_BY_TA_BY_SM_BY_KELAS_DET";

        public const string SP_INSERT = "SD_Rapor_Semester_INSERT";

        public const string SP_UPDATE = "SD_Rapor_Semester_UPDATE";

        public const string SP_DELETE = "SD_Rapor_Semester_DELETE";

        public const string FONT_SIZE = "@fontsize";

        public const string KODE_NAWA = "C51F0E0D-D248-4031-A1C5-3738804E4294";
        public const string KODE_SIKAP = "8479B957-2322-4625-86BA-946F4B89B74D";
        public const string KODE_SIKAP_SPIRITUAL = "3016777D-6DD5-4799-AEE3-A85DAE1273AD";
        public const string KODE_SIKAP_SOSIAL = "8D695150-10C6-4D26-9B14-90250ACA6A84";

        //public static List<RaporLTSCapaianKedisiplinan> ListRaporLTSCapaianKedisiplinan = new List<RaporLTSCapaianKedisiplinan>();

        public static class NamaField
        {
            public const string Kode = "Kode";
            public const string TahunAjaran = "TahunAjaran";
            public const string Semester = "Semester";
            public const string Rel_KelasDet = "Rel_KelasDet";
            public const string IsLocked = "IsLocked";
            public const string GuruKelas = "GuruKelas";
            public const string Kurikulum = "Kurikulum";
            public const string Tanggal = "Tanggal";
        }

        public class FormatNilai
        {
            public string Rel_StrukturNilai_AP { get; set; }
            public string Rel_StrukturNilai_KD { get; set; }
            public string Rel_KP { get; set; }
        }

        public class FormatNilaiWithNilai : FormatNilai
        {
            public string Nama_KP { get; set; }
            public string Nilai { get; set; }
        }

        public class NilaiWithKey
        {
            public string Rel_Siswa { get; set; }
            public string Key { get; set; }
            public decimal Nilai { get; set; }
        }

        private static Rapor_Semester GetEntityFromDataRow(DataRow row)
        {
            return new Rapor_Semester
            {
                Kode = new Guid(row[NamaField.Kode].ToString()),
                TahunAjaran = row[NamaField.TahunAjaran].ToString(),
                Semester = row[NamaField.Semester].ToString(),
                IsLocked = Convert.ToBoolean((row[NamaField.IsLocked] == DBNull.Value ? false : row[NamaField.IsLocked])),
                GuruKelas = row[NamaField.GuruKelas].ToString(),
                Kurikulum = row[NamaField.Kurikulum].ToString(),
                Tanggal = (row[NamaField.Tanggal] == DBNull.Value ? DateTime.MinValue : Convert.ToDateTime(row[NamaField.Tanggal]))
            };
        }

        public static string GetPredikatRapor(decimal nilai)
        {
            if (nilai >= 90 && nilai <= 100) return "A";
            if (nilai >= 80 && nilai < 90) return "B";
            if (nilai >= 70 && nilai < 80) return "C";
            if (nilai < 70) return "D";
            return "";
        }

        public static void Delete(string Kode)
        {
            SqlConnection conn = Application_Libs.Libs.GetConnection_Rapor();
            SqlCommand comm = conn.CreateCommand();
            SqlTransaction transaction = null;
            try
            {
                conn.Open();
                comm.CommandTimeout = 1200;
                transaction = conn.BeginTransaction();
                comm.Transaction = transaction;
                comm.CommandType = CommandType.StoredProcedure;
                comm.CommandText = SP_DELETE;

                comm.Parameters.Add(new SqlParameter("@" + NamaField.Kode, Kode));
                comm.ExecuteNonQuery();
                transaction.Commit();
            }
            catch (Exception ec)
            {
                transaction.Rollback();
                throw new Exception(ec.Message.ToString());
            }
            finally
            {
                conn.Close();
            }
        }

        public static void Insert(Rapor_Semester m)
        {
            SqlConnection conn = Application_Libs.Libs.GetConnection_Rapor();
            SqlCommand comm = conn.CreateCommand();
            SqlTransaction transaction = null;
            try
            {
                conn.Open();
                comm.CommandTimeout = 1200;
                transaction = conn.BeginTransaction();

                comm.Parameters.Clear();
                comm.Transaction = transaction;
                comm.CommandType = CommandType.StoredProcedure;
                comm.CommandText = SP_INSERT;

                comm.Parameters.Add(new SqlParameter("@" + NamaField.Kode, m.Kode));
                comm.Parameters.Add(new SqlParameter("@" + NamaField.TahunAjaran, m.TahunAjaran));
                comm.Parameters.Add(new SqlParameter("@" + NamaField.Semester, m.Semester));
                comm.Parameters.Add(new SqlParameter("@" + NamaField.Rel_KelasDet, m.Rel_KelasDet));
                comm.Parameters.Add(new SqlParameter("@" + NamaField.IsLocked, m.IsLocked));
                comm.Parameters.Add(new SqlParameter("@" + NamaField.GuruKelas, m.GuruKelas));
                comm.Parameters.Add(new SqlParameter("@" + NamaField.Kurikulum, m.Kurikulum));
                comm.Parameters.Add(new SqlParameter("@" + NamaField.Tanggal, m.Tanggal));
                comm.ExecuteNonQuery();

                transaction.Commit();
            }
            catch (Exception ec)
            {
                transaction.Rollback();
                throw new Exception(ec.Message.ToString());
            }
            finally
            {
                conn.Close();
            }
        }

        public static void Update(Rapor_Semester m)
        {
            SqlConnection conn = Application_Libs.Libs.GetConnection_Rapor();
            SqlCommand comm = conn.CreateCommand();
            SqlTransaction transaction = null;
            try
            {
                conn.Open();
                comm.CommandTimeout = 1200;
                transaction = conn.BeginTransaction();

                comm.Parameters.Clear();
                comm.Transaction = transaction;
                comm.CommandType = CommandType.StoredProcedure;
                comm.CommandText = SP_UPDATE;

                comm.Parameters.Add(new SqlParameter("@" + NamaField.Kode, m.Kode));
                comm.Parameters.Add(new SqlParameter("@" + NamaField.TahunAjaran, m.TahunAjaran));
                comm.Parameters.Add(new SqlParameter("@" + NamaField.Semester, m.Semester));
                comm.Parameters.Add(new SqlParameter("@" + NamaField.Rel_KelasDet, m.Rel_KelasDet));
                comm.Parameters.Add(new SqlParameter("@" + NamaField.IsLocked, m.IsLocked));
                comm.Parameters.Add(new SqlParameter("@" + NamaField.GuruKelas, m.GuruKelas));
                comm.Parameters.Add(new SqlParameter("@" + NamaField.Kurikulum, m.Kurikulum));
                comm.Parameters.Add(new SqlParameter("@" + NamaField.Tanggal, m.Tanggal));
                comm.ExecuteNonQuery();

                transaction.Commit();
            }
            catch (Exception ec)
            {
                transaction.Rollback();
                throw new Exception(ec.Message.ToString());
            }
            finally
            {
                conn.Close();
            }
        }

        public static List<Rapor_Semester> GetAllByTABySMByKelasDet_Entity(
                string tahun_ajaran,
                string semester,
                string rel_kelasdet
            )
        {
            List<Rapor_Semester> hasil = new List<Rapor_Semester>();
            SqlConnection conn = Application_Libs.Libs.GetConnection_Rapor();
            SqlCommand comm = conn.CreateCommand();
            SqlDataAdapter sqlDA;

            try
            {
                conn.Open();
                comm.CommandTimeout = 1200;
                comm.CommandType = CommandType.StoredProcedure;
                comm.CommandText = SP_SELECT_BY_TA_BY_SM_BY_KELAS_DET;
                comm.Parameters.AddWithValue("@" + NamaField.TahunAjaran, tahun_ajaran);
                comm.Parameters.AddWithValue("@" + NamaField.Semester, semester);
                comm.Parameters.AddWithValue("@" + NamaField.Rel_KelasDet, rel_kelasdet);

                DataTable dtResult = new DataTable();
                sqlDA = new SqlDataAdapter(comm);
                sqlDA.Fill(dtResult);
                foreach (DataRow row in dtResult.Rows)
                {
                    hasil.Add(GetEntityFromDataRow(row));
                }
            }
            catch (Exception ec)
            {
                throw new Exception(ec.Message.ToString());
            }
            finally
            {
                conn.Close();
            }

            return hasil;
        }

        public static List<KTSP_RaporSikap> GetNilaiSikap_KTSP(string tahun_ajaran, string semester, string rel_kelas_det, string rel_siswa)
        {
            List<KTSP_RaporSikap> hasil = new List<KTSP_RaporSikap>();
            KelasDet m_kelas_det = DAO_KelasDet.GetByID_Entity(rel_kelas_det);
            if (m_kelas_det != null)
            {
                if (m_kelas_det.Nama != null)
                {

                    Kelas m_kelas = DAO_Kelas.GetByID_Entity(m_kelas_det.Rel_Kelas.ToString());
                    if (m_kelas != null)
                    {
                        if (m_kelas.Nama != null)
                        {

                            Rapor_Desain rapor_desain = DAO_Rapor_Desain.GetByTABySMByKelas_Entity(
                                    tahun_ajaran, semester, rel_kelas_det, DAO_Rapor_Desain.JenisRapor.Semester
                                ).FirstOrDefault();
                            List<Rapor_Desain_Det> lst_rapor_desain_det = DAO_Rapor_Desain_Det.GetAllByHeader_Entity(rapor_desain.Kode.ToString());

                            if (rapor_desain != null)
                            {

                                List<DAO_Siswa.SiswaDataSimple> lst_siswa = DAO_Siswa.GetAllSiswaDataSimpleByTahunAjaranUnitKelas_Entity(
                                        m_kelas.Rel_Sekolah.ToString(),
                                        rel_kelas_det,
                                        tahun_ajaran,
                                        semester
                                    );

                                foreach (var m_siswa in lst_siswa)
                                {   
                                    List<Rapor_StrukturNilai> lst_sn_sikap = DAO_Rapor_StrukturNilai.GetMapelSikapByTAByKelas_Entity(tahun_ajaran, DAO_KelasDet.GetByID_Entity(rel_kelas_det).Rel_Kelas.ToString());
                                    foreach (var sn_sikap in lst_sn_sikap.FindAll(m => m.Semester == semester))
                                    {
                                        List<Rapor_StrukturNilai_AP> lst_ap_sikap = DAO_Rapor_StrukturNilai_AP.GetAllByHeader_Entity(sn_sikap.Kode.ToString());
                                        foreach (var sn_ap_sikap in lst_ap_sikap)
                                        {
                                            List<Rapor_StrukturNilai_KD> lst_kd_sikap = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(sn_ap_sikap.Kode.ToString());
                                            foreach (var sn_kd_sikap in lst_kd_sikap)
                                            {

                                                List<Rapor_StrukturNilai_KP> lst_kp_sikap = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(sn_kd_sikap.Kode.ToString());
                                                foreach (var sn_kp_sikap in lst_kp_sikap)
                                                {
                                                    Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(sn_kp_sikap.Rel_Rapor_KomponenPenilaian.ToString());
                                                    if (m_kp != null)
                                                    {
                                                        if (m_kp.Nama != null)
                                                        {
                                                            decimal nilai_sikap = DAO_Rapor_SikapSemester.GetNilaiSikapSemester_Entity(
                                                                    tahun_ajaran, semester, rel_kelas_det, m_siswa.Kode.ToString(),
                                                                    sn_ap_sikap.Kode.ToString(), sn_kd_sikap.Kode.ToString(), sn_kp_sikap.Kode.ToString(),
                                                                    sn_sikap.BobotSikapGuruKelas, sn_sikap.BobotSikapGuruMapel
                                                                );
                                                            hasil.Add(new KTSP_RaporSikap {
                                                                IDSiswa = m_siswa.Nama.Trim().ToUpper() + "_" + m_siswa.Kode.ToString(),
                                                                Aspek = Libs.GetHTMLSimpleText(m_kp.Nama),
                                                                Nilai = nilai_sikap,
                                                                Predikat = ""
                                                            });

                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }


                                }

                            }
                        }
                    }
                }
            }

            return hasil;
        }

        public static List<KURTILAS_RaporSikap> GetNilaiSikap_KURTILAS(string tahun_ajaran, string semester, string rel_kelas_det, string rel_siswa)
        {
            List<KURTILAS_RaporSikap> hasil = new List<KURTILAS_RaporSikap>();
            KelasDet m_kelas_det = DAO_KelasDet.GetByID_Entity(rel_kelas_det);
            if (m_kelas_det != null)
            {
                if (m_kelas_det.Nama != null)
                {

                    Kelas m_kelas = DAO_Kelas.GetByID_Entity(m_kelas_det.Rel_Kelas.ToString());
                    if (m_kelas != null)
                    {
                        if (m_kelas.Nama != null)
                        {

                            Rapor_Desain rapor_desain = DAO_Rapor_Desain.GetByTABySMByKelas_Entity(
                                    tahun_ajaran, semester, rel_kelas_det, DAO_Rapor_Desain.JenisRapor.Semester
                                ).FirstOrDefault();
                            List<Rapor_Desain_Det> lst_rapor_desain_det = DAO_Rapor_Desain_Det.GetAllByHeader_Entity(rapor_desain.Kode.ToString());

                            if (rapor_desain != null)
                            {

                                List<DAO_Siswa.SiswaDataSimple> lst_siswa = DAO_Siswa.GetAllSiswaDataSimpleByTahunAjaranUnitKelas_Entity(
                                        m_kelas.Rel_Sekolah.ToString(),
                                        rel_kelas_det,
                                        tahun_ajaran,
                                        semester
                                    );

                                foreach (var m_siswa in lst_siswa)
                                {
                                    List<Rapor_StrukturNilai> lst_sn_sikap = DAO_Rapor_StrukturNilai.GetMapelSikapByTABySMByKelas_Entity(
                                            tahun_ajaran, semester, DAO_KelasDet.GetByID_Entity(rel_kelas_det).Rel_Kelas.ToString()
                                        );
                                    foreach (var sn_sikap in lst_sn_sikap)
                                    {
                                        List<Rapor_StrukturNilai_AP> lst_ap_sikap = DAO_Rapor_StrukturNilai_AP.GetAllByHeader_Entity(sn_sikap.Kode.ToString());
                                        string s_mapel = "";
                                        Mapel m_mapel = DAO_Mapel.GetByID_Entity(sn_sikap.Rel_Mapel.ToString());
                                        if (m_mapel != null)
                                        {
                                            if (m_mapel.Nama != null)
                                            {
                                                s_mapel = Libs.GetHTMLNoParagraphDiAwal(Libs.GetHTMLSimpleText(m_mapel.Nama));
                                            }
                                        }
                                        foreach (var sn_ap_sikap in lst_ap_sikap)
                                        {
                                            List<Rapor_StrukturNilai_KD> lst_kd_sikap = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(sn_ap_sikap.Kode.ToString());
                                            foreach (var sn_kd_sikap in lst_kd_sikap)
                                            {
                                                Rapor_KompetensiDasar m_kd = DAO_Rapor_KompetensiDasar.GetByID_Entity(sn_kd_sikap.Rel_Rapor_KompetensiDasar.ToString());
                                                List<Rapor_StrukturNilai_KP> lst_kp_sikap = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(sn_kd_sikap.Kode.ToString());
                                                foreach (var sn_kp_sikap in lst_kp_sikap)
                                                {
                                                    Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(sn_kp_sikap.Rel_Rapor_KomponenPenilaian.ToString());
                                                    if (m_kp != null)
                                                    {
                                                        if (m_kp.Nama != null)
                                                        {
                                                            if (m_kd.Nama.ToLower().IndexOf("spiritual") >= 0 || m_kd.Nama.ToLower().IndexOf("sosial") >= 0 ||
                                                                s_mapel.ToLower().IndexOf("spiritual") >= 0 || s_mapel.ToLower().IndexOf("sosial") >= 0)
                                                            {

                                                                m_kd.Nama = s_mapel;
                                                                decimal nilai_sikap = DAO_Rapor_SikapSemester.GetNilaiSikapSemester_Entity(
                                                                        tahun_ajaran, semester, rel_kelas_det, m_siswa.Kode.ToString(),
                                                                        sn_ap_sikap.Kode.ToString(), sn_kd_sikap.Kode.ToString(), sn_kp_sikap.Kode.ToString(),
                                                                        sn_sikap.BobotSikapGuruKelas, sn_sikap.BobotSikapGuruMapel
                                                                    );
                                                                hasil.Add(new KURTILAS_RaporSikap
                                                                {
                                                                    IDSiswa = m_siswa.Nama.Trim().ToUpper() + "_" + m_siswa.Kode.ToString(),
                                                                    Aspek = Libs.GetHTMLSimpleText(
                                                                                m_kd.Nama.ToLower().IndexOf("spiritual") >= 0
                                                                                ? "1.  " + m_kd.Nama
                                                                                : "2.  " + m_kd.Nama
                                                                            ),
                                                                    Indikator = Libs.GetHTMLSimpleText(m_kp.Nama),
                                                                    Kemampuan = nilai_sikap
                                                                });


                                                            }

                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }


                                }

                            }
                        }
                    }
                }
            }

            return hasil;
        }

        public static List<KTSP_RaporEkskul> GetNilaiEkskul_KTSP(
                string tahun_ajaran,
                string semester, 
                string rel_kelas,
                string rel_kelas_det,
                string rel_siswa
            )
        {
            List<KTSP_RaporEkskul> hasil = new List<KTSP_RaporEkskul>();
            SqlConnection conn = Application_Libs.Libs.GetConnection_Rapor();
            SqlCommand comm = conn.CreateCommand();
            SqlDataAdapter sqlDA;

            try
            {
                List<string> lst_kelas = new List<string>();
                lst_kelas.Clear();
                string[] arr_kelas = (rel_kelas + ";").Split(new string[] { ";" }, StringSplitOptions.RemoveEmptyEntries);
                foreach (string kelas in arr_kelas)
                {
                    lst_kelas.Add(kelas);
                }

                List<Rapor_StrukturNilai> lst_stuktur_nilai = new List<Rapor_StrukturNilai>();
                
                conn.Open();
                comm.CommandTimeout = 1200;
                comm.CommandType = CommandType.StoredProcedure;
                comm.CommandText = DAO_Rapor_EkskulSiswa.SP_SELECT_BY_TA_BY_SM_BY_KELASDET;
                comm.Parameters.AddWithValue("@" + NamaField.TahunAjaran, tahun_ajaran);
                comm.Parameters.AddWithValue("@" + NamaField.Semester, semester);
                comm.Parameters.AddWithValue("@" + NamaField.Rel_KelasDet, rel_kelas_det);

                if (Libs.GetStringToDecimal(tahun_ajaran.Substring(0, 4)) <= 2018)
                {
                    DataTable dtResult = new DataTable();
                    sqlDA = new SqlDataAdapter(comm);
                    sqlDA.Fill(dtResult);
                    foreach (DataRow row in dtResult.Rows)
                    {
                        string materi = "";
                        lst_kelas = new List<string>();
                        lst_kelas.Clear();
                        if (row["Rel_Kelas"].ToString().Trim() != "") lst_kelas.Add(row["Rel_Kelas"].ToString());
                        if (row["Rel_Kelas2"].ToString().Trim() != "") lst_kelas.Add(row["Rel_Kelas2"].ToString());
                        if (row["Rel_Kelas3"].ToString().Trim() != "") lst_kelas.Add(row["Rel_Kelas3"].ToString());
                        if (row["Rel_Kelas4"].ToString().Trim() != "") lst_kelas.Add(row["Rel_Kelas4"].ToString());
                        if (row["Rel_Kelas5"].ToString().Trim() != "") lst_kelas.Add(row["Rel_Kelas5"].ToString());
                        if (row["Rel_Kelas6"].ToString().Trim() != "") lst_kelas.Add(row["Rel_Kelas6"].ToString());

                        //get struktur nilainya
                        lst_stuktur_nilai = DAO_Rapor_StrukturNilai.GetAllByTABySMByKelasByMapel_Entity(
                            tahun_ajaran, semester, lst_kelas, row["Rel_mapel"].ToString()
                        );
                        //lst_stuktur_nilai = lst_stuktur_nilai.FindAll(
                        //        m0 => m0.Rel_Kelas.ToString().ToUpper().Trim() == rel_kelas.ToString().ToUpper().Trim() ||
                        //              m0.Rel_Kelas2.ToString().ToUpper().Trim() == rel_kelas.ToString().ToUpper().Trim() ||
                        //              m0.Rel_Kelas3.ToString().ToUpper().Trim() == rel_kelas.ToString().ToUpper().Trim() ||
                        //              m0.Rel_Kelas4.ToString().ToUpper().Trim() == rel_kelas.ToString().ToUpper().Trim() ||
                        //              m0.Rel_Kelas5.ToString().ToUpper().Trim() == rel_kelas.ToString().ToUpper().Trim() ||
                        //              m0.Rel_Kelas6.ToString().ToUpper().Trim() == rel_kelas.ToString().ToUpper().Trim()
                        //    );
                        List<string> lst_materi = new List<string>();
                        lst_materi.Clear();

                        if (lst_stuktur_nilai.Count == 1)
                        {
                            if (lst_stuktur_nilai.FirstOrDefault() != null)
                            {
                                Rapor_StrukturNilai m_struktur_nilai = lst_stuktur_nilai.FirstOrDefault();

                                //get struktur nilai det AP
                                List<Rapor_StrukturNilai_AP> lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeader_Entity(
                                        m_struktur_nilai.Kode.ToString()
                                    );
                                foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                {

                                    //get struktur nilai det KD
                                    List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                            item_rapor_struktur_nilai_ap.Kode.ToString()
                                        );
                                    foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                    {
                                        Rapor_KompetensiDasar m_kd = DAO_Rapor_KompetensiDasar.GetByID_Entity(item_rapor_struktur_nilai_kd.Rel_Rapor_KompetensiDasar.ToString());

                                        //get struktur nilai det KP
                                        List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                            item_rapor_struktur_nilai_kd.Kode.ToString()
                                        );
                                        foreach (var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp)
                                        {
                                            Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString());
                                            if (m_kp != null)
                                            {
                                                lst_materi.Add(Libs.GetHTMLSimpleText2(m_kp.Nama));
                                            }
                                        }
                                    }
                                }
                            }
                        }

                        int id_materi = 0;
                        bool ada_br = false;
                        foreach (var item_materi in lst_materi)
                        {
                            id_materi++;
                            if (id_materi > Convert.ToInt16(lst_materi.Count / 2) && ada_br == false)
                            {
                                materi += (materi.Trim() != "" ? "<br>" : "");
                                materi += item_materi;
                                ada_br = true;
                            }
                            else
                            {
                                materi += (materi.Trim() != "" ? ", " : "");
                                materi += item_materi;
                            }
                        }

                        Siswa m_siswa = DAO_Siswa.GetByKode_Entity(
                            tahun_ajaran,
                            semester,
                            row["Rel_Siswa"].ToString());
                        if (m_siswa != null)
                        {
                            if (m_siswa.Nama != null)
                            {
                                hasil.Add(new KTSP_RaporEkskul
                                {
                                    Rel_Siswa = row["Rel_Siswa"].ToString(),
                                    IDSiswa = m_siswa.Nama.Trim().ToUpper() + "_" + m_siswa.Kode.ToString(),
                                    Kegiatan = row["Mapel"].ToString(),
                                    Nilai = Libs.GetStringToDecimal(row["Rapor"].ToString()).ToString(),
                                    Materi = materi,
                                    Sakit = (row["Sakit"].ToString().Trim() == "" || row["Sakit"].ToString().Trim() == "0" ? "-" : row["Sakit"].ToString()),
                                    Izin = (row["Izin"].ToString().Trim() == "" || row["Izin"].ToString().Trim() == "0" ? "-" : row["Izin"].ToString()),
                                    Alpa = (row["Alpa"].ToString().Trim() == "" || row["Alpa"].ToString().Trim() == "0" ? "-" : row["Alpa"].ToString()),
                                    LTS_CK_KEHADIRAN = (row["LTS_CK_KEHADIRAN"].ToString().Trim() == "" || row["LTS_CK_KEHADIRAN"].ToString().Trim() == "0" ? "-" : row["LTS_CK_KEHADIRAN"].ToString()),
                                    LTS_CK_KETEPATAN_WKT = (row["LTS_CK_KETEPATAN_WKT"].ToString().Trim() == "" || row["LTS_CK_KETEPATAN_WKT"].ToString().Trim() == "0" ? "-" : row["LTS_CK_KETEPATAN_WKT"].ToString()),
                                    LTS_CK_PENGGUNAAN_SRGM = (row["LTS_CK_PENGGUNAAN_SRGM"].ToString().Trim() == "" || row["LTS_CK_PENGGUNAAN_SRGM"].ToString().Trim() == "0" ? "-" : row["LTS_CK_PENGGUNAAN_SRGM"].ToString()),
                                    LTS_CK_PENGGUNAAN_KMR = (row["LTS_CK_PENGGUNAAN_KMR"].ToString().Trim() == "" || row["LTS_CK_PENGGUNAAN_KMR"].ToString().Trim() == "0" ? "-" : row["LTS_CK_PENGGUNAAN_KMR"].ToString()),
                                    SM_CK_KEHADIRAN = (row["SM_CK_KEHADIRAN"].ToString().Trim() == "" || row["SM_CK_KEHADIRAN"].ToString().Trim() == "0" ? "-" : row["SM_CK_KEHADIRAN"].ToString()),
                                    SM_CK_KETEPATAN_WKT = (row["SM_CK_KETEPATAN_WKT"].ToString().Trim() == "" || row["SM_CK_KETEPATAN_WKT"].ToString().Trim() == "0" ? "-" : row["SM_CK_KETEPATAN_WKT"].ToString()),
                                    SM_CK_PENGGUNAAN_SRGM = (row["SM_CK_PENGGUNAAN_SRGM"].ToString().Trim() == "" || row["SM_CK_PENGGUNAAN_SRGM"].ToString().Trim() == "0" ? "-" : row["SM_CK_PENGGUNAAN_SRGM"].ToString()),
                                    SM_CK_PENGGUNAAN_KMR = (row["SM_CK_PENGGUNAAN_KMR"].ToString().Trim() == "" || row["SM_CK_PENGGUNAAN_KMR"].ToString().Trim() == "0" ? "-" : row["SM_CK_PENGGUNAAN_KMR"].ToString())
                                });
                            }
                        }
                    }
                }
                else
                {
                    DataTable dtResult = new DataTable();
                    sqlDA = new SqlDataAdapter(comm);
                    sqlDA.Fill(dtResult);

                    foreach (DataRow row in dtResult.Rows)
                    {
                        bool is_proses = true;
                        if (rel_siswa.Trim() != "")
                        {
                            if (rel_siswa.ToUpper().Trim().IndexOf(row["Rel_Siswa"].ToString().ToUpper().Trim()) >= 0)
                            {
                                is_proses = true;
                            }
                            else
                            {
                                is_proses = false;
                            }
                        }
                        if (is_proses)
                        {
                            //List<Rapor_EkskulSiswa_Det> lst_nilai_ekskul_siswa = DAO_Rapor_EkskulSiswa_Det.GetAllByHeaderBySiswa_Entity(
                            //    row["Rel_Rapor_Ekskul"].ToString(), row["Rel_Siswa"].ToString()
                            //);
                            List<Rapor_EkskulSiswa_Det> lst_nilai_ekskul_siswa = DAO_Rapor_EkskulSiswa_Det.GetAllByTABySMBySiswa_Entity(
                                    tahun_ajaran, semester, row["Rel_Siswa"].ToString()
                                );

                            //if (row["Rel_Siswa"].ToString().ToLower() == "cddcb5c0-6c88-4f3b-8634-bebbe4f36d1a" && row["Rel_mapel"].ToString().ToUpper() == "7CFEA583-7685-43CF-BA9D-E1F194ECEEF1")
                            //{
                            //    int a = 0;
                            //}

                            List<decimal> lst_nilai_ekskul_1 = new List<decimal>();
                            List<decimal> lst_nilai_ekskul_2 = new List<decimal>();
                            lst_nilai_ekskul_1.Clear();
                            lst_nilai_ekskul_2.Clear();

                            lst_kelas.Clear();
                            foreach (string kelas in arr_kelas)
                            {
                                lst_kelas.Add(kelas);
                            }

                            //get struktur nilainya
                            lst_stuktur_nilai = DAO_Rapor_StrukturNilai.GetAllByTABySMByKelasByMapel_Entity(
                                    tahun_ajaran, semester, lst_kelas, row["Rel_mapel"].ToString()
                                );
                            lst_stuktur_nilai = lst_stuktur_nilai.FindAll(
                                    m0 => m0.Rel_Kelas.ToString().ToUpper().Trim() == rel_kelas.ToString().ToUpper().Trim() ||
                                          m0.Rel_Kelas2.ToString().ToUpper().Trim() == rel_kelas.ToString().ToUpper().Trim() ||
                                          m0.Rel_Kelas3.ToString().ToUpper().Trim() == rel_kelas.ToString().ToUpper().Trim() ||
                                          m0.Rel_Kelas4.ToString().ToUpper().Trim() == rel_kelas.ToString().ToUpper().Trim() ||
                                          m0.Rel_Kelas5.ToString().ToUpper().Trim() == rel_kelas.ToString().ToUpper().Trim() ||
                                          m0.Rel_Kelas6.ToString().ToUpper().Trim() == rel_kelas.ToString().ToUpper().Trim()
                                );
                            if (lst_stuktur_nilai.Count == 0)
                            {
                                lst_kelas.Clear();
                                if (row["Rel_Kelas"].ToString().Trim() != "") lst_kelas.Add(row["Rel_Kelas"].ToString());
                                if (row["Rel_Kelas2"].ToString().Trim() != "") lst_kelas.Add(row["Rel_Kelas2"].ToString());
                                if (row["Rel_Kelas3"].ToString().Trim() != "") lst_kelas.Add(row["Rel_Kelas3"].ToString());
                                if (row["Rel_Kelas4"].ToString().Trim() != "") lst_kelas.Add(row["Rel_Kelas4"].ToString());
                                if (row["Rel_Kelas5"].ToString().Trim() != "") lst_kelas.Add(row["Rel_Kelas5"].ToString());
                                if (row["Rel_Kelas6"].ToString().Trim() != "") lst_kelas.Add(row["Rel_Kelas6"].ToString());
                                lst_stuktur_nilai = DAO_Rapor_StrukturNilai.GetAllByTABySMByKelasByMapel_Entity(
                                    tahun_ajaran, semester, lst_kelas, row["Rel_mapel"].ToString()
                                );
                            }

                            List<string> lst_materi = new List<string>();
                            lst_materi.Clear();

                            if (lst_stuktur_nilai.Count == 1)
                            {
                                if (lst_stuktur_nilai.FirstOrDefault() != null)
                                {
                                    Rapor_StrukturNilai m_struktur_nilai = lst_stuktur_nilai.FirstOrDefault();

                                    //get struktur nilai det AP                                
                                    List<Rapor_StrukturNilai_AP> lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeader_Entity(
                                            m_struktur_nilai.Kode.ToString()
                                        );
                                    int i_count_kp = 0;
                                    foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                    {
                                        //get struktur nilai det KD
                                        List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                item_rapor_struktur_nilai_ap.Kode.ToString()
                                            );
                                        foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                        {
                                            //get struktur nilai det KP
                                            List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                item_rapor_struktur_nilai_kd.Kode.ToString()
                                            );
                                            foreach (var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp)
                                            {
                                                Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString());
                                                if (m_kp != null)
                                                {
                                                    i_count_kp++;
                                                }
                                            }
                                        }
                                    }

                                    int id_kp = 0;
                                    string s_materi_1 = "";
                                    string s_materi_2 = "";
                                    lst_materi.Clear();
                                    foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                    {
                                        //get struktur nilai det KD
                                        List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                item_rapor_struktur_nilai_ap.Kode.ToString()
                                            );
                                        foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                        {
                                            Rapor_KompetensiDasar m_kd = DAO_Rapor_KompetensiDasar.GetByID_Entity(item_rapor_struktur_nilai_kd.Rel_Rapor_KompetensiDasar.ToString());

                                            //get struktur nilai det KP
                                            List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                item_rapor_struktur_nilai_kd.Kode.ToString()
                                            );
                                            foreach (var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp)
                                            {
                                                Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString());
                                                if (m_kp != null)
                                                {
                                                    var m_nilai = lst_nilai_ekskul_siswa.FindAll(
                                                        m0 => m0.Rel_Rapor_StrukturNilai_KP.ToString().Trim().ToUpper() ==
                                                                item_rapor_struktur_nilai_kp.Kode.ToString().Trim().ToUpper()
                                                    ).FirstOrDefault();

                                                    id_kp++;
                                                    if (id_kp > (i_count_kp / 2))
                                                    {
                                                        s_materi_2 += (s_materi_2.Trim() != "" ? ", " : "") +
                                                                      Libs.GetHTMLSimpleText2(m_kp.Nama);

                                                        if (m_nilai != null)
                                                        {
                                                            lst_nilai_ekskul_2.Add(
                                                                Libs.GetStringToDecimal(
                                                                        m_nilai.Nilai
                                                                    )
                                                            );
                                                        }
                                                        else
                                                        {
                                                            lst_nilai_ekskul_2.Add(
                                                                Libs.GetStringToDecimal("0")
                                                            );
                                                        }
                                                    }
                                                    else
                                                    {
                                                        s_materi_1 += (s_materi_1.Trim() != "" ? ", " : "") +
                                                                      Libs.GetHTMLSimpleText2(m_kp.Nama);

                                                        if (m_nilai != null)
                                                        {
                                                            lst_nilai_ekskul_1.Add(
                                                                Libs.GetStringToDecimal(
                                                                        m_nilai.Nilai
                                                                    )
                                                            );
                                                        }
                                                        else
                                                        {
                                                            lst_nilai_ekskul_1.Add(
                                                                Libs.GetStringToDecimal("0")
                                                            );
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                    lst_materi.Add(s_materi_1);
                                    lst_materi.Add(s_materi_2);
                                }
                            }

                            Siswa m_siswa = DAO_Siswa.GetByKode_Entity(
                                tahun_ajaran,
                                semester,
                                row["Rel_Siswa"].ToString());
                            int id_materi = 1;

                            foreach (var item_materi in lst_materi)
                            {
                                if (m_siswa != null)
                                {
                                    if (m_siswa.Nama != null)
                                    {
                                        decimal nilai = 0;
                                        if (id_materi == 1)
                                        {
                                            if (lst_nilai_ekskul_1.Count > 0)
                                            {
                                                nilai = lst_nilai_ekskul_1.Select(m => m).Average();
                                            }
                                        }
                                        else if (id_materi == 2)
                                        {
                                            if (lst_nilai_ekskul_2.Count > 0)
                                            {
                                                nilai = lst_nilai_ekskul_2.Select(m => m).Average();
                                            }
                                        }
                                        if (
                                                hasil.FindAll(
                                                        m0 => m0.IDSiswa == m_siswa.Nama.Trim().ToUpper() + "_" + m_siswa.Kode.ToString() &&
                                                              m0.Kegiatan == row["Mapel"].ToString() &&
                                                              m0.Materi == item_materi
                                                    ).Count == 0
                                            )
                                        {
                                            hasil.Add(new KTSP_RaporEkskul
                                            {
                                                Rel_Siswa = row["Rel_Siswa"].ToString(),
                                                IDSiswa = m_siswa.Nama.Trim().ToUpper() + "_" + m_siswa.Kode.ToString(),
                                                Kegiatan = row["Mapel"].ToString(),
                                                Nilai = nilai.ToString(),
                                                Materi = item_materi,
                                                UrutKD = id_materi,
                                                Sakit = (row["Sakit"].ToString().Trim() == "" || row["Sakit"].ToString().Trim() == "0" ? "-" : row["Sakit"].ToString()),
                                                Izin = (row["Izin"].ToString().Trim() == "" || row["Izin"].ToString().Trim() == "0" ? "-" : row["Izin"].ToString()),
                                                Alpa = (row["Alpa"].ToString().Trim() == "" || row["Alpa"].ToString().Trim() == "0" ? "-" : row["Alpa"].ToString()),
                                                LTS_CK_KEHADIRAN = (row["LTS_CK_KEHADIRAN"].ToString().Trim() == "" || row["LTS_CK_KEHADIRAN"].ToString().Trim() == "0" ? "-" : row["LTS_CK_KEHADIRAN"].ToString()),
                                                LTS_CK_KETEPATAN_WKT = (row["LTS_CK_KETEPATAN_WKT"].ToString().Trim() == "" || row["LTS_CK_KETEPATAN_WKT"].ToString().Trim() == "0" ? "-" : row["LTS_CK_KETEPATAN_WKT"].ToString()),
                                                LTS_CK_PENGGUNAAN_SRGM = (row["LTS_CK_PENGGUNAAN_SRGM"].ToString().Trim() == "" || row["LTS_CK_PENGGUNAAN_SRGM"].ToString().Trim() == "0" ? "-" : row["LTS_CK_PENGGUNAAN_SRGM"].ToString()),
                                                LTS_CK_PENGGUNAAN_KMR = (row["LTS_CK_PENGGUNAAN_KMR"].ToString().Trim() == "" || row["LTS_CK_PENGGUNAAN_KMR"].ToString().Trim() == "0" ? "-" : row["LTS_CK_PENGGUNAAN_KMR"].ToString()),
                                                SM_CK_KEHADIRAN = (row["SM_CK_KEHADIRAN"].ToString().Trim() == "" || row["SM_CK_KEHADIRAN"].ToString().Trim() == "0" ? "-" : row["SM_CK_KEHADIRAN"].ToString()),
                                                SM_CK_KETEPATAN_WKT = (row["SM_CK_KETEPATAN_WKT"].ToString().Trim() == "" || row["SM_CK_KETEPATAN_WKT"].ToString().Trim() == "0" ? "-" : row["SM_CK_KETEPATAN_WKT"].ToString()),
                                                SM_CK_PENGGUNAAN_SRGM = (row["SM_CK_PENGGUNAAN_SRGM"].ToString().Trim() == "" || row["SM_CK_PENGGUNAAN_SRGM"].ToString().Trim() == "0" ? "-" : row["SM_CK_PENGGUNAAN_SRGM"].ToString()),
                                                SM_CK_PENGGUNAAN_KMR = (row["SM_CK_PENGGUNAAN_KMR"].ToString().Trim() == "" || row["SM_CK_PENGGUNAAN_KMR"].ToString().Trim() == "0" ? "-" : row["SM_CK_PENGGUNAAN_KMR"].ToString())
                                            });
                                            id_materi++;
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
            catch (Exception ec)
            {
                throw new Exception(ec.Message.ToString());
            }
            finally
            {
                conn.Close();
            }

            return hasil;
        }

        public static List<KTSP_RaporVolunteer> GetVolunteer(
                string tahun_ajaran,
                string semester,
                string rel_kelas_det
            )
        {
            List<KTSP_RaporVolunteer> hasil = new List<KTSP_RaporVolunteer>();
            List<KTSP_RaporVolunteer> hasil_proses = new List<KTSP_RaporVolunteer>();
            SqlConnection conn = Application_Libs.Libs.GetConnection_Rapor();
            SqlCommand comm = conn.CreateCommand();
            SqlDataAdapter sqlDA;

            Kelas m_kelas = DAO_Kelas.GetByID_Entity(DAO_KelasDet.GetByID_Entity(rel_kelas_det).Rel_Kelas.ToString());

            try
            {
                conn.Open();
                comm.CommandTimeout = 1200;
                comm.CommandType = CommandType.StoredProcedure;
                comm.CommandText = DAO_Rapor_VolunteerSiswa.SP_SELECT_BY_TA_BY_SM_BY_KELASDET;
                comm.Parameters.AddWithValue("@" + NamaField.TahunAjaran, tahun_ajaran);
                comm.Parameters.AddWithValue("@" + NamaField.Semester, semester);
                comm.Parameters.AddWithValue("@" + NamaField.Rel_KelasDet, rel_kelas_det);

                DataTable dtResult = new DataTable();
                sqlDA = new SqlDataAdapter(comm);
                sqlDA.Fill(dtResult);
                foreach (DataRow row in dtResult.Rows)
                {
                    Siswa m_siswa = DAO_Siswa.GetByKode_Entity(
                        tahun_ajaran,
                        semester,
                        row["Rel_Siswa"].ToString());
                    if (m_siswa != null)
                    {
                        if (m_siswa.Nama != null)
                        {
                            hasil_proses.Add(new KTSP_RaporVolunteer
                            {
                                IDSiswa = m_siswa.Nama.Trim().ToUpper() + "_" + m_siswa.Kode.ToString(),
                                Kelas = m_kelas.Nama,
                                Kegiatan = row["Kegiatan"].ToString(),
                                Durasi = Libs.GetStringToDecimal(row["Nilai"].ToString()).ToString(),
                                AkumulasiWaktu = Math.Round(Libs.GetStringToDecimal(row["AkumulasiWaktu"].ToString()), 0)
                            });
                        }
                    }
                    
                }
            }
            catch (Exception ec)
            {
                throw new Exception(ec.Message.ToString());
            }
            finally
            {
                conn.Close();
            }

            if (Libs.GetStringToInteger(tahun_ajaran.Substring(0, 4)) >= 2020)
            {
                foreach (string rel_siswa in hasil_proses.Select(m0 => m0.IDSiswa).Distinct().ToList())
                {
                    string s_keterangan = "";
                    decimal d_akumulasi_waktu = 0;
                    decimal d_durasi_waktu = 0;

                    var lst_proses = hasil_proses.FindAll(
                            m0 => m0.IDSiswa.ToUpper().Trim().IndexOf(rel_siswa.ToUpper().Trim()) >= 0
                        );
                    foreach (var item_proses in lst_proses)
                    {
                        s_keterangan += 
                            (
                                s_keterangan.Trim() != "" && 
                                item_proses.Kegiatan.Trim() != ""
                                ? ", "
                                : ""
                            ) + 
                            item_proses.Kegiatan.Trim();

                        d_durasi_waktu += Libs.GetStringToDecimal(item_proses.Durasi);
                        d_akumulasi_waktu = Math.Round(item_proses.AkumulasiWaktu, 0);
                    }

                    hasil.Add(
                        new KTSP_RaporVolunteer {
                                IDSiswa = rel_siswa,
                                Kegiatan = "Ananda telah melakukan kegiatan " + s_keterangan + ".",
                                Durasi = d_durasi_waktu.ToString(),
                                AkumulasiWaktu = d_akumulasi_waktu,
                                Kelas = m_kelas.Nama
                            }
                        );
                }
            }
            else
            {
                hasil = hasil_proses;
            }

            return hasil;
        }
        
        public static List<KTSP_RaporKetidakhadiran> GetAbsen(
                string tahun_ajaran, string semester, string rel_kelas_det, string rel_siswa
            )
        {
            List<KTSP_RaporKetidakhadiran> hasil = new List<KTSP_RaporKetidakhadiran>();
            KelasDet m_kelas_det = DAO_KelasDet.GetByID_Entity(rel_kelas_det);
            if (m_kelas_det != null)
            {
                if (m_kelas_det.Nama != null)
                {

                    Kelas m_kelas = DAO_Kelas.GetByID_Entity(m_kelas_det.Rel_Kelas.ToString());
                    if (m_kelas != null)
                    {
                        if (m_kelas.Nama != null)
                        {

                            Rapor_Desain rapor_desain = DAO_Rapor_Desain.GetByTABySMByKelas_Entity(
                                    tahun_ajaran, semester, rel_kelas_det, DAO_Rapor_Desain.JenisRapor.Semester
                                ).FirstOrDefault();
                            List<Rapor_Desain_Det> lst_rapor_desain_det = DAO_Rapor_Desain_Det.GetAllByHeader_Entity(rapor_desain.Kode.ToString());

                            if (rapor_desain != null)
                            {

                                List<DAO_Siswa.SiswaDataSimple> lst_siswa = DAO_Siswa.GetAllSiswaDataSimpleByTahunAjaranUnitKelas_Entity(
                                        m_kelas.Rel_Sekolah.ToString(),
                                        rel_kelas_det,
                                        tahun_ajaran,
                                        semester
                                    );

                                Rapor_Arsip m_rapor_arsip = DAO_Rapor_Arsip.GetAll_Entity().FindAll(
                                    m0 => m0.TahunAjaran == tahun_ajaran &&
                                          m0.Semester == semester &&
                                          m0.JenisRapor == "Semester"

                                ).FirstOrDefault();
                                foreach (var m_siswa in lst_siswa)
                                {

                                    string s_sakit = "-";
                                    string s_izin = "-";
                                    string s_alpa = "-";
                                    string s_terlambat = "-";

                                    List<DAO_SiswaAbsen.AbsenRekapRapor> lst_absen = new List<DAO_SiswaAbsen.AbsenRekapRapor>();
                                    lst_absen = DAO_SiswaAbsen.GetRekapAbsenRaporBySiswaByPeriode_Entity(
                                            m_siswa.Kode.ToString(),
                                            (m_rapor_arsip != null ? m_rapor_arsip.TanggalAwalAbsen : DateTime.MinValue),
                                            (m_rapor_arsip != null ? m_rapor_arsip.TanggalAkhirAbsen : DateTime.MinValue)
                                        );
                                    foreach (var absen in lst_absen)
                                    {
                                        if (absen.Absen == Libs.JENIS_ABSENSI.SAKIT.Substring(0, 1)) s_sakit = absen.Jumlah.ToString();
                                        if (absen.Absen == Libs.JENIS_ABSENSI.IZIN.Substring(0, 1)) s_izin = absen.Jumlah.ToString();
                                        if (absen.Absen == Libs.JENIS_ABSENSI.ALPA.Substring(0, 1)) s_alpa = absen.Jumlah.ToString();
                                        if (absen.Absen == Libs.JENIS_ABSENSI.TERLAMBAT.Substring(0, 1)) s_terlambat = absen.Jumlah.ToString();
                                    }

                                    hasil.Add(new KTSP_RaporKetidakhadiran
                                    {
                                        IDSiswa = m_siswa.Nama.Trim().ToUpper() + "_" + m_siswa.Kode.ToString(),
                                        Sakit = s_sakit,
                                        Izin = s_izin,
                                        Alpa = s_alpa
                                    });

                                }

                            }
                        }
                    }
                }
            }

            return hasil;
        }

        public static List<KTSP_RaporSaran> GetSaran_KTSP(string tahun_ajaran, string semester, string rel_kelas_det, string rel_siswa)
        {

            List<KTSP_RaporSaran> hasil = new List<KTSP_RaporSaran>();
            KelasDet m_kelas_det = DAO_KelasDet.GetByID_Entity(rel_kelas_det);
            if (m_kelas_det != null)
            {
                if (m_kelas_det.Nama != null)
                {

                    Kelas m_kelas = DAO_Kelas.GetByID_Entity(m_kelas_det.Rel_Kelas.ToString());
                    if (m_kelas != null)
                    {
                        if (m_kelas.Nama != null)
                        {

                            Rapor_Desain rapor_desain = DAO_Rapor_Desain.GetByTABySMByKelas_Entity(
                                    tahun_ajaran, semester, rel_kelas_det, DAO_Rapor_Desain.JenisRapor.Semester
                                ).FirstOrDefault();
                            List<Rapor_Desain_Det> lst_rapor_desain_det = DAO_Rapor_Desain_Det.GetAllByHeader_Entity(rapor_desain.Kode.ToString());

                            if (rapor_desain != null)
                            {

                                List<DAO_Siswa.SiswaDataSimple> lst_siswa = DAO_Siswa.GetAllSiswaDataSimpleByTahunAjaranUnitKelas_Entity(
                                        m_kelas.Rel_Sekolah.ToString(),
                                        rel_kelas_det,
                                        tahun_ajaran,
                                        semester
                                    );

                                foreach (var m_siswa in lst_siswa)
                                {

                                    Rapor_CatatanSiswa m_catatan_siswa = DAO_Rapor_CatatanSiswa.GetAllByTABySMByKelasDetSiswa_Entity(
                                                tahun_ajaran, semester, rel_kelas_det, m_siswa.Kode.ToString()
                                            ).FirstOrDefault();

                                    if (m_catatan_siswa != null)
                                    {
                                        if (m_catatan_siswa.TahunAjaran != null)
                                        {
                                            hasil.Add(new KTSP_RaporSaran {
                                                IDSiswa = m_siswa.Nama.Trim().ToUpper() + "_" + m_siswa.Kode.ToString(),
                                                Saran = Libs.GetHTMLSimpleText2(m_catatan_siswa.Catatan)
                                            });
                                        }
                                    }

                                }

                            }
                        }
                    }
                }
            }

            return hasil;
        }

        public static Sekolah GetUnitSekolah()
        {
            Sekolah m_unit = DAO_Sekolah.GetAll_Entity().FindAll(m => m.UrutanJenjang == (int)Libs.UnitSekolah.SD).FirstOrDefault();
            return m_unit;
        }

        public static List<KTSP_UraianKompetensi> GetNilaiUraianKompetensi_KTSP(string tahun_ajaran, string semester, string rel_kelas_det, string rel_siswa, string lokasi_ttd = "")
        {
            List<KTSP_UraianKompetensi> hasil = new List<KTSP_UraianKompetensi>();
            Rapor_Arsip m_rapor_arsip = DAO_Rapor_Arsip.GetAll_Entity().FindAll(
                m0 => m0.TahunAjaran == tahun_ajaran &&
                        m0.Semester == semester &&
                        m0.JenisRapor == "Semester"

            ).FirstOrDefault();

            string s_walikelas = "";
            List<FormasiGuruKelas> lst_formasi_guru_kelas = DAO_FormasiGuruKelas.GetByUnitByTABySM_Entity(
                        GetUnitSekolah().Kode.ToString(), tahun_ajaran, semester
                    ).FindAll(m => m.Rel_KelasDet.ToString().ToUpper() == rel_kelas_det.Trim().ToUpper());
            if (lst_formasi_guru_kelas != null)
            {
                if (lst_formasi_guru_kelas.Count > 0)
                {
                    FormasiGuruKelas m_guru_kelas = lst_formasi_guru_kelas.FirstOrDefault();
                    if (m_guru_kelas != null)
                    {
                        if (m_guru_kelas.TahunAjaran != null)
                        {
                            Pegawai m_pegawai = DAO_Pegawai.GetByID_Entity(m_guru_kelas.Rel_GuruKelas);
                            if (m_pegawai != null)
                            {
                                if (m_pegawai.Nama != null)
                                {
                                    s_walikelas = m_pegawai.Nama;
                                }
                            }
                        }
                    }
                }
            }

            KelasDet m_kelas_det = DAO_KelasDet.GetByID_Entity(rel_kelas_det);
            if (m_kelas_det != null)
            {
                if (m_kelas_det.Nama != null)
                {
                    System.Drawing.Image img = null;
                    string s_loc = lokasi_ttd;
                    if (File.Exists(s_loc) && s_loc.Trim() != "")
                    {
                        img = System.Drawing.Image.FromFile(s_loc);
                    }
                    byte[] img_ttd_guru = (byte[])(new ImageConverter()).ConvertTo(img, typeof(byte[]));

                    Kelas m_kelas = DAO_Kelas.GetByID_Entity(m_kelas_det.Rel_Kelas.ToString());
                    if (m_kelas != null)
                    {
                        if (m_kelas.Nama != null)
                        {

                            Rapor_Desain rapor_desain = DAO_Rapor_Desain.GetByTABySMByKelas_Entity(
                                    tahun_ajaran, semester, rel_kelas_det, DAO_Rapor_Desain.JenisRapor.Semester
                                ).FirstOrDefault();
                            List<Rapor_Desain_Det> lst_rapor_desain_det = DAO_Rapor_Desain_Det.GetAllByHeader_Entity(rapor_desain.Kode.ToString());

                            if (rapor_desain != null)
                            {

                                List<DAO_Siswa.SiswaDataSimple> lst_siswa = DAO_Siswa.GetAllSiswaDataSimpleByTahunAjaranUnitKelas_Entity(
                                        m_kelas.Rel_Sekolah.ToString(),
                                        rel_kelas_det,
                                        tahun_ajaran,
                                        semester
                                    );
                                List<decimal> lst_nilai_ap = new List<decimal>();
                                List<decimal> lst_nilai_kd = new List<decimal>();
                                List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT> lst_nilai_siswa_det = new List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT>();
                                List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT> lst_nilai_siswa_det_by_periode = new List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT>();

                                lst_nilai_siswa_det_by_periode = DAO_Rapor_NilaiSiswa_Det.GetAllByTABySMByKelasDet_Entity(
                                        tahun_ajaran, semester, rel_kelas_det
                                    );

                                if (rel_siswa.Trim() != "")
                                {
                                    lst_siswa = lst_siswa.FindAll(m0 => (rel_siswa + ";").Trim().ToUpper().IndexOf(m0.Kode.ToString().ToUpper() + ";") >= 0).ToList();
                                }
                                List<NilaiWithKey> lst_all_nilai_rapor = new List<NilaiWithKey>();
                                List<NilaiWithKey> lst_kkm_nilai_rapor = new List<NilaiWithKey>();
                                List<NilaiWithKey> lst_jumlah_nilai_keseluruhan = new List<NilaiWithKey>();
                                List<NilaiWithKey> lst_nilai_rapor = new List<NilaiWithKey>();
                                decimal jumlah_mapel_rapor = 0;
                                foreach (DAO_Siswa.SiswaDataSimple m_siswa in lst_siswa.OrderBy(m => m.Nama))
                                {

                                    bool is_naik_kelas = true;
                                    string naik_ke_kelas = "";
                                    KenaikanKelas kenaikan_kelas = DAO_KenaikanKelas.GetByTAByKelasBySiswa_Entity(tahun_ajaran, rel_kelas_det, m_siswa.Kode.ToString());
                                    if (kenaikan_kelas != null)
                                    {
                                        if (kenaikan_kelas.TahunAjaran != null)
                                        {
                                            is_naik_kelas = kenaikan_kelas.IsNaik;
                                        }
                                    }
                                    Kelas kelas_naik = DAO_Kelas.GetKelasNext(m_kelas.Rel_Sekolah.ToString(), m_kelas.Kode.ToString());
                                    if (is_naik_kelas)
                                    {
                                        naik_ke_kelas = kelas_naik.Nama;
                                    }
                                    else
                                    {
                                        naik_ke_kelas = m_kelas.Nama;
                                    }

                                    lst_kkm_nilai_rapor.Clear();
                                    int urutan_mapel_rapor = 0;
                                    foreach (Rapor_Desain_Det item in lst_rapor_desain_det.FindAll(m => m.Rel_Mapel.Trim() != ""))
                                    {

                                        if (item.Rel_Mapel.Trim() != "")
                                        {
                                            urutan_mapel_rapor++;
                                            lst_nilai_siswa_det = lst_nilai_siswa_det_by_periode.FindAll(
                                                    m => m.Rel_Mapel == item.Rel_Mapel &&
                                                         m.Rel_Siswa == m.Rel_Siswa
                                                );

                                            //get struktur nilainya
                                            Rapor_StrukturNilai m_struktur_nilai = DAO_Rapor_StrukturNilai.GetATop1ByTABySMByKelasByMapel_Entity(
                                                    tahun_ajaran, semester, m_kelas.Kode.ToString(), item.Rel_Mapel
                                                );

                                            DateTime dt_tanggal_rapor = DateTime.Now;
                                            if (m_rapor_arsip != null)
                                            {
                                                if (m_rapor_arsip.TahunAjaran != null)
                                                {
                                                    dt_tanggal_rapor = m_rapor_arsip.TanggalRapor;
                                                }
                                            }

                                            string guru_kelas = "";
                                            string tanggal_rapor = Libs.GetTanggalIndonesiaFromDate(dt_tanggal_rapor, false);
                                            Rapor_LTS_MengetahuiGuruKelas m_guru_kelas = DAO_Rapor_LTS_MengetahuiGuruKelas.GetByTABySMByKelasDet_Entity(
                                                    tahun_ajaran, semester, rel_kelas_det
                                                ).FirstOrDefault();
                                            if (m_guru_kelas != null)
                                            {
                                                if (m_guru_kelas.NamaGuru != null)
                                                {
                                                    guru_kelas = m_guru_kelas.NamaGuru;
                                                }
                                            }

                                            if (m_struktur_nilai != null)
                                            {
                                                if (m_struktur_nilai.TahunAjaran != null)
                                                {

                                                    lst_kkm_nilai_rapor.Add(new NilaiWithKey
                                                    {
                                                        Key = (jumlah_mapel_rapor + 1).ToString(),
                                                        Nilai = m_struktur_nilai.KKM
                                                    });
                                                    if (
                                                        !(m_struktur_nilai.IsKelompokanKP && m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString()) &&
                                                        !(m_struktur_nilai.IsKelompokanKP && m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                    )
                                                    {

                                                        //get struktur nilai det AP
                                                        List<Rapor_StrukturNilai_AP> lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeader_Entity(
                                                                m_struktur_nilai.Kode.ToString()
                                                            );
                                                        lst_nilai_ap.Clear();
                                                        foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                        {
                                                            Rapor_AspekPenilaian m_ap = DAO_Rapor_AspekPenilaian.GetByID_Entity(item_rapor_struktur_nilai_ap.Rel_Rapor_AspekPenilaian.ToString());
                                                            //get struktur nilai det KD
                                                            List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                );
                                                            lst_nilai_kd.Clear();
                                                            foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                            {
                                                                Rapor_KompetensiDasar m_kd = DAO_Rapor_KompetensiDasar.GetByID_Entity(item_rapor_struktur_nilai_kd.Rel_Rapor_KompetensiDasar.ToString());
                                                                string nama_kd = Libs.GetHTMLSimpleText(Libs.GetHTMLNoParagraphDiAwal(m_kd.Nama));
                                                                if (nama_kd.ToUpper() != "UAT" && nama_kd.ToUpper() != "PAT/UKK" && nama_kd.ToUpper() != "PAT" && nama_kd.ToUpper() != "UKK")
                                                                {
                                                                    //get struktur nilai det KP
                                                                    List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                        item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                    );
                                                                    decimal jumlah_nilai_kd = 0;
                                                                    decimal nilai_kd = 0;
                                                                    int count_kd = 0;
                                                                    foreach (var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp)
                                                                    {
                                                                        Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString());
                                                                        if (m_kp != null)
                                                                        {

                                                                            string nama_kp = Libs.GetHTMLSimpleText(Libs.GetHTMLNoParagraphDiAwal(m_kp.Nama));
                                                                            if (nama_kp.ToUpper() != "UAT" && nama_kp.ToUpper() != "PAT/UKK" && nama_kp.ToUpper() != "PAT" && nama_kp.ToUpper() != "UKK")
                                                                            {
                                                                                Rapor_NilaiSiswa_Det m_nilai_det = lst_nilai_siswa_det.FindAll(
                                                                                    m => m.Rel_Siswa.ToString().Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                         m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper() &&
                                                                                         m.Rel_Rapor_StrukturNilai_AP.Trim().ToUpper() == item_rapor_struktur_nilai_ap.Kode.ToString().ToUpper() &&
                                                                                         m.Rel_Rapor_StrukturNilai_KD.Trim().ToUpper() == item_rapor_struktur_nilai_kd.Kode.ToString().ToUpper() &&
                                                                                         m.Rel_Rapor_StrukturNilai_KP.Trim().ToUpper() == item_rapor_struktur_nilai_kp.Kode.ToString().ToUpper()
                                                                                ).FirstOrDefault();

                                                                                if (m_nilai_det != null)
                                                                                {
                                                                                    if (m_nilai_det.Nilai.Trim() != "")
                                                                                    {
                                                                                        if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                                        {
                                                                                            nilai_kd += Math.Round((item_rapor_struktur_nilai_kp.BobotNK / 100) * Libs.GetStringToDecimal(m_nilai_det.Nilai), 2, MidpointRounding.AwayFromZero);
                                                                                        }
                                                                                        else if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                                        {
                                                                                            jumlah_nilai_kd += Libs.GetStringToDecimal(m_nilai_det.Nilai);
                                                                                        }
                                                                                        count_kd++;
                                                                                    }
                                                                                }
                                                                            }

                                                                        }

                                                                    }

                                                                    if (count_kd > 0)
                                                                    {
                                                                        if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                        {
                                                                            nilai_kd = Math.Round(jumlah_nilai_kd / count_kd, 2, MidpointRounding.AwayFromZero);
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        nilai_kd = 0;
                                                                    }

                                                                    //load nilai manual
                                                                    Rapor_NilaiSiswa_AP_or_KD m_nilai_manual = DAO_Rapor_NilaiSiswa_AP_or_KD.GetAllByTABySMByKelasByMapelBySiswaByStruktur_Entity(
                                                                            tahun_ajaran, semester, rel_kelas_det, m_siswa.Kode.ToString(), item.Rel_Mapel,
                                                                            item_rapor_struktur_nilai_kd.Kode.ToString().Trim().ToUpper()

                                                                        ).FirstOrDefault();
                                                                    if (m_nilai_manual != null)
                                                                    {
                                                                        if (m_nilai_manual.Nilai != null)
                                                                        {
                                                                            nilai_kd = Libs.GetStringToDecimal(m_nilai_manual.Nilai);
                                                                        }
                                                                    }
                                                                    //end load nilai manual

                                                                    nilai_kd = Math.Round(nilai_kd, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);

                                                                    hasil.Add(new KTSP_UraianKompetensi
                                                                    {
                                                                        IDSiswa = m_siswa.Nama.Trim().ToUpper() + "_" + m_siswa.Kode.ToString(),
                                                                        TahunAjaran = tahun_ajaran,
                                                                        Semester = semester,
                                                                        NIS = m_siswa.NISSekolah,
                                                                        NISN = m_siswa.NISN,
                                                                        Nama = Libs.GetPerbaikiEjaanNama(m_siswa.Nama.ToString()),
                                                                        Kelas = DAO_KelasDet.GetKelasForRapor(rel_kelas_det),
                                                                        UrutanMapelRapor = urutan_mapel_rapor,
                                                                        NamaMapel = item.NamaMapelRapor,
                                                                        Uraian = Libs.GetHTMLNoParagraphDiAwal(m_kd.Nama),
                                                                        Nilai = nilai_kd,
                                                                        GuruKelas = s_walikelas,
                                                                        Tanggal = tanggal_rapor,
                                                                        KepalaSekolah = m_rapor_arsip.KepalaSekolah,
                                                                        IsNaik = is_naik_kelas,
                                                                        NaikKeKelas = naik_ke_kelas,
                                                                        AspekPenilaian = Libs.GetHTMLSimpleText(m_ap.Nama),
                                                                        UrutAspekPenilaian = item_rapor_struktur_nilai_ap.Urutan,
                                                                        TTDGuru = img_ttd_guru
                                                                    });
                                                                }
                                                                //end get struktur nilai det KP

                                                            }
                                                            //end get struktur nilai det KD

                                                        }
                                                        //end get struktur nilai det AP
                                                    }
                                                    else 
                                                    {
                                                        List<decimal> lst_lk = new List<decimal>();
                                                        List<decimal> lst_uh = new List<decimal>();
                                                        List<decimal> lst_ph = new List<decimal>();
                                                        List<string> lst_nama_kd = new List<string>();

                                                        lst_lk.Clear();
                                                        lst_uh.Clear();
                                                        lst_ph.Clear();

                                                        //get struktur nilai det AP
                                                        List<Rapor_StrukturNilai_AP> lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeader_Entity(
                                                                m_struktur_nilai.Kode.ToString()
                                                            );
                                                        lst_nilai_ap.Clear();
                                                        foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                        {
                                                            Rapor_AspekPenilaian m_ap = DAO_Rapor_AspekPenilaian.GetByID_Entity(item_rapor_struktur_nilai_ap.Rel_Rapor_AspekPenilaian.ToString());
                                                            //get struktur nilai det KD
                                                            List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                );
                                                            lst_nilai_kd.Clear();
                                                            foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                            {
                                                                Rapor_KompetensiDasar m_kd = DAO_Rapor_KompetensiDasar.GetByID_Entity(item_rapor_struktur_nilai_kd.Rel_Rapor_KompetensiDasar.ToString());
                                                                string nama_kd = Libs.GetHTMLSimpleText(Libs.GetHTMLNoParagraphDiAwal(m_kd.Nama));
                                                                if (nama_kd.ToUpper() != "UAT" && nama_kd.ToUpper() != "PAT/UKK" && nama_kd.ToUpper() != "PAT" && nama_kd.ToUpper() != "UKK")
                                                                {
                                                                    //get struktur nilai det KP
                                                                    List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                );
                                                                    decimal jumlah_nilai_kd = 0;
                                                                    decimal nilai_kd = 0;
                                                                    int count_kd = 0;
                                                                    foreach (var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp)
                                                                    {
                                                                        Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString());
                                                                        if (m_kp != null)
                                                                        {

                                                                            string nama_kp = Libs.GetHTMLSimpleText(Libs.GetHTMLNoParagraphDiAwal(m_kp.Nama));
                                                                            if (nama_kp.ToUpper() != "UAT" && nama_kp.ToUpper() != "PAT/UKK" && nama_kp.ToUpper() != "PAT" && nama_kp.ToUpper() != "UKK")
                                                                            {
                                                                                Rapor_NilaiSiswa_Det m_nilai_det = lst_nilai_siswa_det.FindAll(
                                                                                m => m.Rel_Siswa.ToString().Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                     m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper() &&
                                                                                     m.Rel_Rapor_StrukturNilai_AP.Trim().ToUpper() == item_rapor_struktur_nilai_ap.Kode.ToString().ToUpper() &&
                                                                                     m.Rel_Rapor_StrukturNilai_KD.Trim().ToUpper() == item_rapor_struktur_nilai_kd.Kode.ToString().ToUpper() &&
                                                                                     m.Rel_Rapor_StrukturNilai_KP.Trim().ToUpper() == item_rapor_struktur_nilai_kp.Kode.ToString().ToUpper()
                                                                            ).FirstOrDefault();

                                                                                if (m_nilai_det != null)
                                                                                {
                                                                                    if (m_nilai_det.Nilai.Trim() != "")
                                                                                    {
                                                                                        if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                                        {
                                                                                            nilai_kd += Math.Round((item_rapor_struktur_nilai_kp.BobotNK / 100) * Libs.GetStringToDecimal(m_nilai_det.Nilai), 2, MidpointRounding.AwayFromZero);
                                                                                        }
                                                                                        else if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                                        {
                                                                                            jumlah_nilai_kd += Libs.GetStringToDecimal(m_nilai_det.Nilai);
                                                                                        }
                                                                                        count_kd++;
                                                                                    }
                                                                                }
                                                                            }

                                                                        }

                                                                    }

                                                                    if (count_kd > 0)
                                                                    {
                                                                        if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                        {
                                                                            nilai_kd = Math.Round(jumlah_nilai_kd / count_kd, 2, MidpointRounding.AwayFromZero);
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        nilai_kd = 0;
                                                                    }

                                                                    //load nilai manual
                                                                    Rapor_NilaiSiswa_AP_or_KD m_nilai_manual = DAO_Rapor_NilaiSiswa_AP_or_KD.GetAllByTABySMByKelasByMapelBySiswaByStruktur_Entity(
                                                                            tahun_ajaran, semester, rel_kelas_det, m_siswa.Kode.ToString(), item.Rel_Mapel,
                                                                            item_rapor_struktur_nilai_kd.Kode.ToString().Trim().ToUpper()

                                                                        ).FirstOrDefault();
                                                                    if (m_nilai_manual != null)
                                                                    {
                                                                        if (m_nilai_manual.Nilai != null)
                                                                        {
                                                                            nilai_kd = Libs.GetStringToDecimal(m_nilai_manual.Nilai);
                                                                        }
                                                                    }
                                                                    //end load nilai manual

                                                                    nilai_kd = Math.Round(nilai_kd, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);

                                                                    if (Libs.GetHTMLSimpleText(m_kd.Nama).Substring(0, 2) == "LK")
                                                                    {
                                                                        if (lst_nama_kd.FindAll(m => m == Libs.GetCleanDeskripsiKD(Libs.GetHTMLNoParagraphDiAwal(m_kd.Nama))).Count == 0)
                                                                        {
                                                                            lst_nama_kd.Add(Libs.GetCleanDeskripsiKD(Libs.GetHTMLNoParagraphDiAwal(m_kd.Nama)));
                                                                        }
                                                                        lst_lk.Add(nilai_kd * Convert.ToDecimal(0.4));
                                                                        //if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                        //{
                                                                        //    lst_lk.Add(nilai_kd * (item_rapor_struktur_nilai_ap.BobotRapor / 100));
                                                                        //}
                                                                        //else if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                        //{
                                                                        //    lst_lk.Add(nilai_kd);
                                                                        //}
                                                                    }
                                                                    else if (
                                                                            Libs.GetHTMLSimpleText(m_kd.Nama).Substring(0, 2) == "UH"
                                                                        )
                                                                    {
                                                                        if (lst_nama_kd.FindAll(m => m == Libs.GetCleanDeskripsiKD(Libs.GetHTMLNoParagraphDiAwal(m_kd.Nama))).Count == 0)
                                                                        {
                                                                            lst_nama_kd.Add(Libs.GetCleanDeskripsiKD(Libs.GetHTMLNoParagraphDiAwal(m_kd.Nama)));
                                                                        }
                                                                        lst_uh.Add(nilai_kd * Convert.ToDecimal(0.6));
                                                                        //if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                        //{
                                                                        //    lst_uh.Add(nilai_kd * (item_rapor_struktur_nilai_ap.BobotRapor / 100));
                                                                        //}
                                                                        //else if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                        //{
                                                                        //    lst_lk.Add(nilai_kd);
                                                                        //}
                                                                    }
                                                                    else if (
                                                                            Libs.GetHTMLSimpleText(m_kd.Nama).Substring(0, 2) == "PH"
                                                                        )
                                                                    {
                                                                        if (lst_nama_kd.FindAll(m => m == Libs.GetCleanDeskripsiKD(Libs.GetHTMLNoParagraphDiAwal(m_kd.Nama))).Count == 0)
                                                                        {
                                                                            lst_nama_kd.Add(Libs.GetCleanDeskripsiKD(Libs.GetHTMLNoParagraphDiAwal(m_kd.Nama)));
                                                                        }
                                                                        if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                        {
                                                                            lst_ph.Add(nilai_kd * (item_rapor_struktur_nilai_kd.BobotAP / 100));
                                                                        }
                                                                        else if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                        {
                                                                            lst_ph.Add(nilai_kd);
                                                                        }
                                                                    }
                                                                    //end get struktur nilai det KP

                                                                    if (lst_uh.Count > 0)
                                                                    {
                                                                        if (lst_uh.Count == lst_lk.Count)
                                                                        {
                                                                            for (int i = 0; i < lst_uh.Count; i++)
                                                                            {
                                                                                if (hasil.FindAll(mq => mq.Uraian == lst_nama_kd[i] && mq.IDSiswa == m_siswa.Nama.Trim().ToUpper() + "_" + m_siswa.Kode.ToString()).Count == 0)
                                                                                {
                                                                                    hasil.Add(new KTSP_UraianKompetensi
                                                                                    {
                                                                                        IDSiswa = m_siswa.Nama.Trim().ToUpper() + "_" + m_siswa.Kode.ToString(),
                                                                                        TahunAjaran = tahun_ajaran,
                                                                                        Semester = semester,
                                                                                        NIS = m_siswa.NISSekolah,
                                                                                        NISN = m_siswa.NISN,
                                                                                        Nama = Libs.GetPerbaikiEjaanNama(m_siswa.Nama.ToString()),
                                                                                        Kelas = DAO_KelasDet.GetKelasForRapor(rel_kelas_det),
                                                                                        UrutanMapelRapor = urutan_mapel_rapor,
                                                                                        NamaMapel = item.NamaMapelRapor,
                                                                                        Uraian = lst_nama_kd[i],
                                                                                        Nilai = lst_lk[i] + lst_uh[i],
                                                                                        GuruKelas = s_walikelas,
                                                                                        Tanggal = tanggal_rapor,
                                                                                        IsNaik = is_naik_kelas,
                                                                                        NaikKeKelas = naik_ke_kelas,
                                                                                        AspekPenilaian = Libs.GetHTMLSimpleText(m_ap.Nama),
                                                                                        UrutAspekPenilaian = item_rapor_struktur_nilai_ap.Urutan,
                                                                                        TTDGuru = img_ttd_guru
                                                                                    });
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }

                                                            }
                                                            //end get struktur nilai det KD

                                                            if (lst_ph.Count > 0)
                                                            {
                                                                for (int i = 0; i < lst_ph.Count; i++)
                                                                {
                                                                    if (hasil.FindAll(mq => mq.Uraian == lst_nama_kd[i] && mq.IDSiswa == m_siswa.Nama.Trim().ToUpper() + "_" + m_siswa.Kode.ToString()).Count == 0)
                                                                    {
                                                                        decimal nilai_ph = 0;
                                                                        nilai_ph = Math.Round(lst_ph[i], Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);
                                                                        hasil.Add(new KTSP_UraianKompetensi
                                                                        {
                                                                            IDSiswa = m_siswa.Nama.Trim().ToUpper() + "_" + m_siswa.Kode.ToString(),
                                                                            TahunAjaran = tahun_ajaran,
                                                                            Semester = semester,
                                                                            NIS = m_siswa.NISSekolah,
                                                                            NISN = m_siswa.NISN,
                                                                            Nama = Libs.GetPerbaikiEjaanNama(m_siswa.Nama.ToString()),
                                                                            Kelas = DAO_KelasDet.GetKelasForRapor(rel_kelas_det),
                                                                            UrutanMapelRapor = urutan_mapel_rapor,
                                                                            NamaMapel = item.NamaMapelRapor,
                                                                            Uraian = lst_nama_kd[i],
                                                                            Nilai = nilai_ph,
                                                                            GuruKelas = s_walikelas,
                                                                            Tanggal = tanggal_rapor,
                                                                            IsNaik = is_naik_kelas,
                                                                            NaikKeKelas = naik_ke_kelas,
                                                                            AspekPenilaian = Libs.GetCleanDeskripsiKD(Libs.GetHTMLSimpleText(m_ap.Nama)),
                                                                            UrutAspekPenilaian = item_rapor_struktur_nilai_ap.Urutan,
                                                                            TTDGuru = img_ttd_guru
                                                                        });
                                                                    }
                                                                }
                                                            }

                                                        }
                                                        //end get struktur nilai det AP

                                                    }

                                                }
                                            }
                                            //end get struktur nilai

                                        }

                                    }
                                }
                                
                            }

                        }
                    }
                }
            }

            return hasil;
        }

        public static List<KTSP_RaporNilai> GetNilaiRapor_KTSP(string tahun_ajaran, string semester, string rel_kelas_det, string rel_siswa, string lokasi_ttd)
        {
            List<KTSP_RaporNilai> hasil = new List<KTSP_RaporNilai>();
            KelasDet m_kelas_det = DAO_KelasDet.GetByID_Entity(rel_kelas_det);
            if (m_kelas_det != null)
            {
                if (m_kelas_det.Nama != null)
                {
                    System.Drawing.Image img = null;
                    string s_loc = lokasi_ttd;
                    if (File.Exists(s_loc) && s_loc.Trim() != "")
                    {
                        img = System.Drawing.Image.FromFile(s_loc);
                    }
                    byte[] img_ttd_guru = (byte[])(new ImageConverter()).ConvertTo(img, typeof(byte[]));

                    string s_walikelas = "";
                    List<FormasiGuruKelas> lst_formasi_guru_kelas = DAO_FormasiGuruKelas.GetByUnitByTABySM_Entity(
                                GetUnitSekolah().Kode.ToString(), tahun_ajaran, semester
                            ).FindAll(m => m.Rel_KelasDet.ToString().ToUpper() == rel_kelas_det.Trim().ToUpper());
                    if (lst_formasi_guru_kelas != null)
                    {
                        if (lst_formasi_guru_kelas.Count > 0)
                        {
                            FormasiGuruKelas m_guru_kelas = lst_formasi_guru_kelas.FirstOrDefault();
                            if (m_guru_kelas != null)
                            {
                                if (m_guru_kelas.TahunAjaran != null)
                                {
                                    Pegawai m_pegawai = DAO_Pegawai.GetByID_Entity(m_guru_kelas.Rel_GuruKelas);
                                    if (m_pegawai != null)
                                    {
                                        if (m_pegawai.Nama != null)
                                        {
                                            s_walikelas = m_pegawai.Nama;
                                        }
                                    }
                                }
                            }
                        }
                    }

                    Kelas m_kelas = DAO_Kelas.GetByID_Entity(m_kelas_det.Rel_Kelas.ToString());
                    if (m_kelas != null)
                    {
                        if (m_kelas.Nama != null)
                        {

                            Rapor_Desain rapor_desain = DAO_Rapor_Desain.GetByTABySMByKelas_Entity(
                                    tahun_ajaran, semester, rel_kelas_det, DAO_Rapor_Desain.JenisRapor.Semester
                                ).FirstOrDefault();
                            List<Rapor_Desain_Det> lst_rapor_desain_det = DAO_Rapor_Desain_Det.GetAllByHeader_Entity(rapor_desain.Kode.ToString());

                            if (rapor_desain != null)
                            {

                                List<DAO_Siswa.SiswaDataSimple> lst_siswa = DAO_Siswa.GetAllSiswaDataSimpleByTahunAjaranUnitKelas_Entity(
                                        m_kelas.Rel_Sekolah.ToString(),
                                        rel_kelas_det,
                                        tahun_ajaran,
                                        semester
                                    );
                                List<decimal> lst_nilai_ap = new List<decimal>();
                                List<decimal> lst_nilai_ap_bobot = new List<decimal>();
                                List<decimal> lst_nilai_kd = new List<decimal>();
                                List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT> lst_nilai_siswa_det_sm1 = new List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT>();
                                List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT> lst_nilai_siswa_det_by_periode_sm1 = new List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT>();
                                List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT> lst_nilai_siswa_det = new List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT>();
                                List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT> lst_nilai_siswa_det_by_periode = new List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT>();

                                lst_nilai_siswa_det_by_periode_sm1 = DAO_Rapor_NilaiSiswa_Det.GetAllByTABySMByKelasDet_Entity(
                                        tahun_ajaran, "1", rel_kelas_det
                                    );
                                lst_nilai_siswa_det_by_periode = DAO_Rapor_NilaiSiswa_Det.GetAllByTABySMByKelasDet_Entity(
                                        tahun_ajaran, semester, rel_kelas_det
                                    );
                                if (rel_siswa.Trim() != "")
                                {
                                    lst_siswa = lst_siswa.FindAll(m0 => (rel_siswa + ";").Trim().ToUpper().IndexOf(m0.Kode.ToString().ToUpper() + ";") >= 0).ToList();
                                }
                                List<NilaiWithKey> lst_all_nilai_rapor = new List<NilaiWithKey>();
                                List<NilaiWithKey> lst_kkm_nilai_rapor = new List<NilaiWithKey>();
                                List<NilaiWithKey> lst_kkm_nilai_rapor_sm1 = new List<NilaiWithKey>();
                                List<NilaiWithKey> lst_jumlah_nilai_keseluruhan = new List<NilaiWithKey>();
                                List<NilaiWithKey> lst_nilai_rapor = new List<NilaiWithKey>();
                                decimal jumlah_keseluruhan = 0;
                                decimal jumlah_mapel_rapor = 0;
                                foreach (DAO_Siswa.SiswaDataSimple m_siswa in lst_siswa.OrderBy(m => m.Nama))
                                {

                                    bool is_naik_kelas = true;
                                    string naik_ke_kelas = "";
                                    KenaikanKelas kenaikan_kelas = DAO_KenaikanKelas.GetByTAByKelasBySiswa_Entity(tahun_ajaran, rel_kelas_det, m_siswa.Kode.ToString());
                                    if (kenaikan_kelas != null)
                                    {
                                        if (kenaikan_kelas.TahunAjaran != null)
                                        {
                                            is_naik_kelas = kenaikan_kelas.IsNaik;
                                        }
                                    }
                                    Kelas kelas_naik = DAO_Kelas.GetKelasNext(m_kelas.Rel_Sekolah.ToString(), m_kelas.Kode.ToString());
                                    if (is_naik_kelas)
                                    {
                                        naik_ke_kelas = (m_kelas.Nama.ToUpper() == "VI" || m_kelas.Nama == "6" ? "Lulus" : kelas_naik.Nama);
                                    }
                                    else
                                    {
                                        naik_ke_kelas = m_kelas.Nama;
                                    }

                                    lst_kkm_nilai_rapor.Clear();
                                    lst_kkm_nilai_rapor_sm1.Clear();
                                    int urutan_mapel_rapor = 0;
                                    foreach (Rapor_Desain_Det item in lst_rapor_desain_det.FindAll(m => m.Rel_Mapel.Trim() != ""))
                                    {

                                        if (item.Rel_Mapel.Trim() != "")
                                        {

                                            lst_nilai_siswa_det = lst_nilai_siswa_det_by_periode.FindAll(
                                                    m => m.Rel_Mapel == item.Rel_Mapel &&
                                                         m.Rel_Siswa == m_siswa.Kode.ToString()
                                                );
                                            lst_nilai_siswa_det_sm1 = lst_nilai_siswa_det_by_periode_sm1.FindAll(
                                                    m => m.Rel_Mapel == item.Rel_Mapel &&
                                                         m.Rel_Siswa == m_siswa.Kode.ToString()
                                                );

                                            //get struktur nilainya
                                            Rapor_StrukturNilai m_struktur_nilai_sm1 = DAO_Rapor_StrukturNilai.GetATop1ByTABySMByKelasByMapel_Entity(
                                                    tahun_ajaran, "1", m_kelas.Kode.ToString(), item.Rel_Mapel
                                                );
                                            decimal nilai_rapor_sm1 = 0;
                                            decimal jumlah_nilai_rapor_sm1 = 0;
                                            decimal count_nilai_rapor_sm1 = 0;
                                            if (m_struktur_nilai_sm1 != null)
                                            {
                                                if (m_struktur_nilai_sm1.TahunAjaran != null)
                                                {

                                                    lst_kkm_nilai_rapor_sm1.Add(new NilaiWithKey
                                                    {
                                                        Key = (jumlah_mapel_rapor + 1).ToString(),
                                                        Nilai = m_struktur_nilai_sm1.KKM
                                                    });
                                                    if (!(m_struktur_nilai_sm1.IsKelompokanKP && m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString()))
                                                    {
                                                        //get struktur nilai det AP
                                                        List<Rapor_StrukturNilai_AP> lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeader_Entity(
                                                                m_struktur_nilai_sm1.Kode.ToString()
                                                            );
                                                        lst_nilai_ap.Clear();
                                                        lst_nilai_ap_bobot.Clear();
                                                        decimal jumlah_nilai_ap = 0;
                                                        decimal nilai_ap = 0;
                                                        int count_ap = 0;
                                                        foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                        {

                                                            //get struktur nilai det KD
                                                            List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                );
                                                            lst_nilai_kd.Clear();
                                                            foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                            {

                                                                //get struktur nilai det KP
                                                                List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                );
                                                                decimal jumlah_nilai_kd = 0;
                                                                decimal nilai_kd = 0;
                                                                int count_kd = 0;
                                                                foreach (var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp)
                                                                {
                                                                    Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString());
                                                                    if (m_kp != null)
                                                                    {

                                                                        Rapor_NilaiSiswa_Det m_nilai_det = lst_nilai_siswa_det_sm1.FindAll(
                                                                            m => m.Rel_Siswa.ToString().Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai_sm1.Rel_Mapel.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_AP.Trim().ToUpper() == item_rapor_struktur_nilai_ap.Kode.ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KD.Trim().ToUpper() == item_rapor_struktur_nilai_kd.Kode.ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KP.Trim().ToUpper() == item_rapor_struktur_nilai_kp.Kode.ToString().ToUpper()
                                                                        ).FirstOrDefault();

                                                                        if (m_nilai_det != null)
                                                                        {
                                                                            if (m_nilai_det.Nilai.Trim() != "")
                                                                            {
                                                                                if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                                {
                                                                                    nilai_kd += Math.Round((item_rapor_struktur_nilai_kp.BobotNK / 100) * Libs.GetStringToDecimal(m_nilai_det.Nilai), 2, MidpointRounding.AwayFromZero);
                                                                                }
                                                                                else if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                                {
                                                                                    jumlah_nilai_kd += Libs.GetStringToDecimal(m_nilai_det.Nilai);
                                                                                }
                                                                                count_kd++;
                                                                            }
                                                                        }

                                                                    }

                                                                }

                                                                if (count_kd > 0)
                                                                {
                                                                    if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                    {
                                                                        nilai_kd = Math.Round(jumlah_nilai_kd / count_kd, 2, MidpointRounding.AwayFromZero);
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    nilai_kd = 0;
                                                                }

                                                                //load nilai manual
                                                                Rapor_NilaiSiswa_AP_or_KD m_nilai_manual = DAO_Rapor_NilaiSiswa_AP_or_KD.GetAllByTABySMByKelasByMapelBySiswaByStruktur_Entity(
                                                                        tahun_ajaran, m_struktur_nilai_sm1.Semester, rel_kelas_det, m_siswa.Kode.ToString(), item.Rel_Mapel,
                                                                        item_rapor_struktur_nilai_kd.Kode.ToString().Trim().ToUpper()

                                                                    ).FirstOrDefault();
                                                                if (m_nilai_manual != null)
                                                                {
                                                                    if (m_nilai_manual.Nilai != null)
                                                                    {
                                                                        nilai_kd = Libs.GetStringToDecimal(m_nilai_manual.Nilai);
                                                                    }
                                                                }
                                                                //end load nilai manual

                                                                nilai_kd = Math.Round(nilai_kd, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);
                                                                lst_nilai_kd.Add(nilai_kd);
                                                                //end get struktur nilai det KP

                                                            }
                                                            //end get struktur nilai det KD

                                                            //get nilai ap
                                                            count_ap = 0;
                                                            nilai_ap = 0;
                                                            jumlah_nilai_ap = 0;
                                                            foreach (var item_nilai_kd in lst_nilai_kd)
                                                            {
                                                                if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                {
                                                                    nilai_ap += Math.Round((item_rapor_struktur_nilai_ap.BobotRapor / 100) * item_nilai_kd, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                                else if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    jumlah_nilai_ap += item_nilai_kd;
                                                                }
                                                                count_ap++;
                                                            }
                                                            if (count_ap > 0)
                                                            {
                                                                if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_ap = Math.Round(jumlah_nilai_ap / count_ap, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_ap = 0;
                                                            }
                                                            nilai_ap = Math.Round(nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                            lst_nilai_ap.Add(nilai_ap);
                                                            lst_nilai_ap_bobot.Add(item_rapor_struktur_nilai_ap.BobotRapor);
                                                            //end get nilai ap

                                                        }
                                                        //end get struktur nilai det AP

                                                        //get nilai rapor
                                                        nilai_rapor_sm1 = 0;
                                                        jumlah_nilai_rapor_sm1 = 0;
                                                        count_nilai_rapor_sm1 = 0;
                                                        foreach (var item_nilai_ap in lst_nilai_ap)
                                                        {
                                                            if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                            {
                                                                nilai_rapor_sm1 += Math.Round((lst_nilai_ap_bobot[Convert.ToInt16(count_nilai_rapor_sm1)] / 100) * item_nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                            }
                                                            else if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                jumlah_nilai_rapor_sm1 += item_nilai_ap;
                                                            }
                                                            count_nilai_rapor_sm1++;
                                                        }
                                                        if (count_nilai_rapor_sm1 > 0)
                                                        {
                                                            if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                nilai_rapor_sm1 = Math.Round(jumlah_nilai_rapor_sm1 / count_nilai_rapor_sm1, 3, MidpointRounding.AwayFromZero);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            nilai_rapor_sm1 = 0;
                                                        }
                                                        nilai_rapor_sm1 = Math.Round(nilai_rapor_sm1, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);
                                                        jumlah_keseluruhan += nilai_rapor_sm1;
                                                        jumlah_mapel_rapor++;
                                                        lst_all_nilai_rapor.Add(new NilaiWithKey
                                                        {
                                                            Key = jumlah_mapel_rapor.ToString(),
                                                            Nilai = nilai_rapor_sm1
                                                        });
                                                        lst_nilai_rapor.Add(new NilaiWithKey
                                                        {
                                                            Key = m_siswa.Kode.ToString(),
                                                            Nilai = nilai_rapor_sm1
                                                        });
                                                        //end get nilai rapor
                                                    }
                                                    else 
                                                    {

                                                        List<FormatNilai> lst_format_nilai = new List<FormatNilai>();
                                                        List<Rapor_StrukturNilai_AP> lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeader_Entity(
                                                                m_struktur_nilai_sm1.Kode.ToString()
                                                            );
                                                        foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                        {

                                                            List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                );

                                                            foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                            {

                                                                List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                );
                                                                foreach (var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp)
                                                                {

                                                                    if (
                                                                        lst_format_nilai.FindAll(
                                                                                m => m.Rel_StrukturNilai_AP == item_rapor_struktur_nilai_ap.Kode.ToString() &&
                                                                                     m.Rel_KP == item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                            ).Count == 0
                                                                    )
                                                                    {
                                                                        lst_format_nilai.Add(new FormatNilai
                                                                        {
                                                                            Rel_StrukturNilai_AP = item_rapor_struktur_nilai_ap.Kode.ToString(),
                                                                            Rel_KP = item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                        });
                                                                    }

                                                                }
                                                            }

                                                        }

                                                        List<FormatNilaiWithNilai> lst_formatnilai_nilai = new List<FormatNilaiWithNilai>();
                                                        //distinct ap
                                                        foreach (string rel_sn_ap in lst_format_nilai.Select(m => m.Rel_StrukturNilai_AP).Distinct())
                                                        {
                                                            foreach (string rel_kp in lst_format_nilai.Select(m => m.Rel_KP).Distinct())
                                                            {

                                                                Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(rel_kp);
                                                                if (m_kp != null)
                                                                {
                                                                    if (m_kp.Nama != null)
                                                                    {

                                                                        double nilai = lst_nilai_siswa_det_sm1.Where(
                                                                            m => m.Rel_Rapor_StrukturNilai_AP.ToString().Trim().ToUpper() == rel_sn_ap.Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == rel_kp.Trim().ToUpper() &&
                                                                                 m.Rel_Siswa.Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai_sm1.Rel_Mapel.ToString().Trim().ToUpper()
                                                                        ).Select(m => Libs.GetStringToDouble(m.Nilai)).DefaultIfEmpty().Average();

                                                                        lst_formatnilai_nilai.Add(new FormatNilaiWithNilai
                                                                        {
                                                                            Nama_KP = m_kp.Nama,
                                                                            Nilai = nilai.ToString(),
                                                                            Rel_KP = rel_kp,
                                                                            Rel_StrukturNilai_AP = rel_sn_ap
                                                                        });

                                                                    }
                                                                }

                                                            }
                                                        }

                                                        //get nilai rapor                                                        
                                                        List<NilaiWithKey> lst_nilai = new List<NilaiWithKey>();
                                                        lst_nilai.Clear();
                                                        foreach (string rel_kp in lst_formatnilai_nilai.Select(m => m.Rel_KP).Distinct())
                                                        {

                                                            nilai_rapor_sm1 = 0;
                                                            jumlah_nilai_rapor_sm1 = 0;
                                                            count_nilai_rapor_sm1 = 0;
                                                            foreach (var m_formatnilai_nilai in lst_formatnilai_nilai.FindAll(m => m.Rel_KP == rel_kp))
                                                            {
                                                                Rapor_StrukturNilai_AP m_rel_sn_ap = DAO_Rapor_StrukturNilai_AP.GetByID_Entity(m_formatnilai_nilai.Rel_StrukturNilai_AP);
                                                                if (m_rel_sn_ap != null)
                                                                {
                                                                    if (m_rel_sn_ap.JenisPerhitungan != null)
                                                                    {

                                                                        if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                        {
                                                                            nilai_rapor_sm1 += Math.Round((m_rel_sn_ap.BobotRapor / 100) * Libs.GetStringToDecimal(m_formatnilai_nilai.Nilai), 3, MidpointRounding.AwayFromZero);
                                                                        }
                                                                        else if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                        {
                                                                            jumlah_nilai_rapor_sm1 += Libs.GetStringToDecimal(m_formatnilai_nilai.Nilai);
                                                                        }
                                                                        count_nilai_rapor_sm1++;

                                                                    }
                                                                }
                                                            }

                                                            if (count_nilai_rapor_sm1 > 0)
                                                            {
                                                                if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_rapor_sm1 = Math.Round(jumlah_nilai_rapor_sm1 / count_nilai_rapor_sm1, 3, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_rapor_sm1 = 0;
                                                            }
                                                            nilai_rapor_sm1 = Math.Round(nilai_rapor_sm1, 3, MidpointRounding.AwayFromZero);
                                                            lst_nilai.Add(new NilaiWithKey
                                                            {
                                                                Key = rel_kp,
                                                                Nilai = nilai_rapor_sm1
                                                            });
                                                        }

                                                        nilai_rapor_sm1 = 0;
                                                        jumlah_nilai_rapor_sm1 = 0;
                                                        count_nilai_rapor_sm1 = 0;
                                                        List<Rapor_StrukturNilai_KPKelompok> lst_kpkelompok = DAO_Rapor_StrukturNilai_KPKelompok.GetAllByHeader_Entity(
                                                                m_struktur_nilai_sm1.Kode.ToString()
                                                            );
                                                        foreach (var item_nilai in lst_nilai)
                                                        {
                                                            Rapor_StrukturNilai_KPKelompok m_kpkelompok = lst_kpkelompok.FindAll(
                                                                    m => m.Rel_Rapor_KomponenPenilaian == new Guid(item_nilai.Key)
                                                                ).FirstOrDefault();
                                                            if (m_kpkelompok != null)
                                                            {
                                                                if (m_kpkelompok.Rel_Rapor_StrukturNilai != null)
                                                                {
                                                                    nilai_rapor_sm1 += Math.Round((m_kpkelompok.Bobot / 100) * item_nilai.Nilai, 3, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                        }
                                                        nilai_rapor_sm1 = Math.Round(nilai_rapor_sm1, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);
                                                        jumlah_keseluruhan += nilai_rapor_sm1;
                                                        jumlah_mapel_rapor++;
                                                        lst_all_nilai_rapor.Add(new NilaiWithKey
                                                        {
                                                            Key = jumlah_mapel_rapor.ToString(),
                                                            Nilai = nilai_rapor_sm1
                                                        });
                                                        lst_nilai_rapor.Add(new NilaiWithKey
                                                        {
                                                            Key = m_siswa.Kode.ToString(),
                                                            Nilai = nilai_rapor_sm1
                                                        });
                                                        urutan_mapel_rapor++;
                                                        //end get nilai rapor
                                                        //end distinct ap

                                                    }

                                                }
                                            }
                                            //end get struktur nilai

                                            Rapor_StrukturNilai m_struktur_nilai = DAO_Rapor_StrukturNilai.GetATop1ByTABySMByKelasByMapel_Entity(
                                                    tahun_ajaran, semester, m_kelas.Kode.ToString(), item.Rel_Mapel
                                                );

                                            decimal nilai_rapor = 0;
                                            decimal jumlah_nilai_rapor = 0;
                                            decimal count_nilai_rapor = 0;
                                            if (m_struktur_nilai != null)
                                            {
                                                if (m_struktur_nilai.TahunAjaran != null)
                                                {

                                                    lst_kkm_nilai_rapor.Add(new NilaiWithKey
                                                    {
                                                        Key = (jumlah_mapel_rapor + 1).ToString(),
                                                        Nilai = m_struktur_nilai.KKM
                                                    });
                                                    if (!(m_struktur_nilai.IsKelompokanKP && m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString()))
                                                    {

                                                        //get struktur nilai det AP
                                                        List<Rapor_StrukturNilai_AP> lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeader_Entity(
                                                                m_struktur_nilai.Kode.ToString()
                                                            );
                                                        lst_nilai_ap.Clear();
                                                        lst_nilai_ap_bobot.Clear();
                                                        decimal jumlah_nilai_ap = 0;
                                                        decimal nilai_ap = 0;
                                                        int count_ap = 0;
                                                        foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                        {

                                                            //get struktur nilai det KD
                                                            List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                );
                                                            lst_nilai_kd.Clear();
                                                            foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                            {

                                                                //get struktur nilai det KP
                                                                List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                );
                                                                decimal jumlah_nilai_kd = 0;
                                                                decimal nilai_kd = 0;
                                                                int count_kd = 0;
                                                                foreach (var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp)
                                                                {
                                                                    Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString());
                                                                    if (m_kp != null)
                                                                    {

                                                                        Rapor_NilaiSiswa_Det m_nilai_det = lst_nilai_siswa_det.FindAll(
                                                                            m => m.Rel_Siswa.ToString().Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_AP.Trim().ToUpper() == item_rapor_struktur_nilai_ap.Kode.ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KD.Trim().ToUpper() == item_rapor_struktur_nilai_kd.Kode.ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KP.Trim().ToUpper() == item_rapor_struktur_nilai_kp.Kode.ToString().ToUpper()
                                                                        ).FirstOrDefault();

                                                                        if (m_nilai_det != null)
                                                                        {
                                                                            if (m_nilai_det.Nilai.Trim() != "")
                                                                            {
                                                                                if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                                {
                                                                                    nilai_kd += Math.Round((item_rapor_struktur_nilai_kp.BobotNK / 100) * Libs.GetStringToDecimal(m_nilai_det.Nilai), 2, MidpointRounding.AwayFromZero);
                                                                                }
                                                                                else if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                                {
                                                                                    jumlah_nilai_kd += Libs.GetStringToDecimal(m_nilai_det.Nilai);
                                                                                }
                                                                                count_kd++;
                                                                            }
                                                                        }

                                                                    }

                                                                }

                                                                if (count_kd > 0)
                                                                {
                                                                    if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                    {
                                                                        nilai_kd = Math.Round(jumlah_nilai_kd / count_kd, 2, MidpointRounding.AwayFromZero);
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    nilai_kd = 0;
                                                                }

                                                                //load nilai manual
                                                                Rapor_NilaiSiswa_AP_or_KD m_nilai_manual = DAO_Rapor_NilaiSiswa_AP_or_KD.GetAllByTABySMByKelasByMapelBySiswaByStruktur_Entity(
                                                                        tahun_ajaran, semester, rel_kelas_det, m_siswa.Kode.ToString(), item.Rel_Mapel,
                                                                        item_rapor_struktur_nilai_kd.Kode.ToString().Trim().ToUpper()

                                                                    ).FirstOrDefault();
                                                                if (m_nilai_manual != null)
                                                                {
                                                                    if (m_nilai_manual.Nilai != null)
                                                                    {
                                                                        nilai_kd = Libs.GetStringToDecimal(m_nilai_manual.Nilai);
                                                                    }
                                                                }
                                                                //end load nilai manual

                                                                nilai_kd = Math.Round(nilai_kd, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);
                                                                lst_nilai_kd.Add(nilai_kd);
                                                                //end get struktur nilai det KP

                                                            }
                                                            //end get struktur nilai det KD

                                                            //get nilai ap
                                                            count_ap = 0;
                                                            nilai_ap = 0;
                                                            jumlah_nilai_ap = 0;
                                                            foreach (var item_nilai_kd in lst_nilai_kd)
                                                            {
                                                                if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                {
                                                                    nilai_ap += Math.Round((item_rapor_struktur_nilai_ap.BobotRapor / 100) * item_nilai_kd, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                                else if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    jumlah_nilai_ap += item_nilai_kd;
                                                                }
                                                                count_ap++;
                                                            }
                                                            if (count_ap > 0)
                                                            {
                                                                if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_ap = Math.Round(jumlah_nilai_ap / count_ap, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_ap = 0;
                                                            }
                                                            nilai_ap = Math.Round(nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                            lst_nilai_ap.Add(nilai_ap);
                                                            lst_nilai_ap_bobot.Add(item_rapor_struktur_nilai_ap.BobotRapor);
                                                            //end get nilai ap

                                                        }
                                                        //end get struktur nilai det AP

                                                        //get nilai rapor
                                                        nilai_rapor = 0;
                                                        jumlah_nilai_rapor = 0;
                                                        count_nilai_rapor = 0;
                                                        foreach (var item_nilai_ap in lst_nilai_ap)
                                                        {
                                                            if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                            {
                                                                nilai_rapor += Math.Round((lst_nilai_ap_bobot[Convert.ToInt16(count_nilai_rapor)] / 100) * item_nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                            }
                                                            else if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                jumlah_nilai_rapor += item_nilai_ap;
                                                            }
                                                            count_nilai_rapor++;
                                                        }
                                                        if (count_nilai_rapor > 0)
                                                        {
                                                            if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            nilai_rapor = 0;
                                                        }
                                                        nilai_rapor = Math.Round(nilai_rapor, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);
                                                        jumlah_keseluruhan += nilai_rapor;
                                                        jumlah_mapel_rapor++;
                                                        lst_all_nilai_rapor.Add(new NilaiWithKey
                                                        {
                                                            Key = jumlah_mapel_rapor.ToString(),
                                                            Nilai = nilai_rapor
                                                        });
                                                        lst_nilai_rapor.Add(new NilaiWithKey
                                                        {
                                                            Key = m_siswa.Kode.ToString(),
                                                            Nilai = nilai_rapor
                                                        });
                                                        //end get nilai rapor
                                                    }
                                                    else 
                                                    {

                                                        List<FormatNilai> lst_format_nilai = new List<FormatNilai>();
                                                        List<Rapor_StrukturNilai_AP> lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeader_Entity(
                                                                m_struktur_nilai.Kode.ToString()
                                                            );
                                                        foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                        {

                                                            List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                );

                                                            foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                            {

                                                                List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                );
                                                                foreach (var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp)
                                                                {

                                                                    if (
                                                                        lst_format_nilai.FindAll(
                                                                                m => m.Rel_StrukturNilai_AP == item_rapor_struktur_nilai_ap.Kode.ToString() &&
                                                                                     m.Rel_KP == item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                            ).Count == 0
                                                                    )
                                                                    {
                                                                        lst_format_nilai.Add(new FormatNilai
                                                                        {
                                                                            Rel_StrukturNilai_AP = item_rapor_struktur_nilai_ap.Kode.ToString(),
                                                                            Rel_KP = item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                        });
                                                                    }

                                                                }
                                                            }

                                                        }

                                                        List<FormatNilaiWithNilai> lst_formatnilai_nilai = new List<FormatNilaiWithNilai>();
                                                        //distinct ap
                                                        foreach (string rel_sn_ap in lst_format_nilai.Select(m => m.Rel_StrukturNilai_AP).Distinct())
                                                        {
                                                            foreach (string rel_kp in lst_format_nilai.Select(m => m.Rel_KP).Distinct())
                                                            {

                                                                Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(rel_kp);
                                                                if (m_kp != null)
                                                                {
                                                                    if (m_kp.Nama != null)
                                                                    {

                                                                        double nilai = lst_nilai_siswa_det.Where(
                                                                            m => m.Rel_Rapor_StrukturNilai_AP.ToString().Trim().ToUpper() == rel_sn_ap.Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == rel_kp.Trim().ToUpper() &&
                                                                                 m.Rel_Siswa.Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper()
                                                                        ).Select(m => Libs.GetStringToDouble(m.Nilai)).DefaultIfEmpty().Average();

                                                                        lst_formatnilai_nilai.Add(new FormatNilaiWithNilai
                                                                        {
                                                                            Nama_KP = m_kp.Nama,
                                                                            Nilai = nilai.ToString(),
                                                                            Rel_KP = rel_kp,
                                                                            Rel_StrukturNilai_AP = rel_sn_ap
                                                                        });

                                                                    }
                                                                }

                                                            }
                                                        }

                                                        //get nilai rapor                                                        
                                                        List<NilaiWithKey> lst_nilai = new List<NilaiWithKey>();
                                                        lst_nilai.Clear();
                                                        foreach (string rel_kp in lst_formatnilai_nilai.Select(m => m.Rel_KP).Distinct())
                                                        {

                                                            nilai_rapor = 0;
                                                            jumlah_nilai_rapor = 0;
                                                            count_nilai_rapor = 0;
                                                            foreach (var m_formatnilai_nilai in lst_formatnilai_nilai.FindAll(m => m.Rel_KP == rel_kp))
                                                            {
                                                                Rapor_StrukturNilai_AP m_rel_sn_ap = DAO_Rapor_StrukturNilai_AP.GetByID_Entity(m_formatnilai_nilai.Rel_StrukturNilai_AP);
                                                                if (m_rel_sn_ap != null)
                                                                {
                                                                    if (m_rel_sn_ap.JenisPerhitungan != null)
                                                                    {

                                                                        if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                        {
                                                                            nilai_rapor += Math.Round((m_rel_sn_ap.BobotRapor / 100) * Libs.GetStringToDecimal(m_formatnilai_nilai.Nilai), 3, MidpointRounding.AwayFromZero);
                                                                        }
                                                                        else if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                        {
                                                                            jumlah_nilai_rapor += Libs.GetStringToDecimal(m_formatnilai_nilai.Nilai);
                                                                        }
                                                                        count_nilai_rapor++;

                                                                    }
                                                                }
                                                            }

                                                            if (count_nilai_rapor > 0)
                                                            {
                                                                if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_rapor = 0;
                                                            }
                                                            nilai_rapor = Math.Round(nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                            lst_nilai.Add(new NilaiWithKey
                                                            {
                                                                Key = rel_kp,
                                                                Nilai = nilai_rapor
                                                            });
                                                        }

                                                        nilai_rapor = 0;
                                                        jumlah_nilai_rapor = 0;
                                                        count_nilai_rapor = 0;
                                                        List<Rapor_StrukturNilai_KPKelompok> lst_kpkelompok = DAO_Rapor_StrukturNilai_KPKelompok.GetAllByHeader_Entity(
                                                                m_struktur_nilai.Kode.ToString()
                                                            );
                                                        foreach (var item_nilai in lst_nilai)
                                                        {
                                                            Rapor_StrukturNilai_KPKelompok m_kpkelompok = lst_kpkelompok.FindAll(
                                                                    m => m.Rel_Rapor_KomponenPenilaian == new Guid(item_nilai.Key)
                                                                ).FirstOrDefault();
                                                            if (m_kpkelompok != null)
                                                            {
                                                                if (m_kpkelompok.Rel_Rapor_StrukturNilai != null)
                                                                {
                                                                    nilai_rapor += Math.Round((m_kpkelompok.Bobot / 100) * item_nilai.Nilai, 3, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                        }
                                                        nilai_rapor = Math.Round(nilai_rapor, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);
                                                        jumlah_keseluruhan += nilai_rapor;
                                                        jumlah_mapel_rapor++;
                                                        lst_all_nilai_rapor.Add(new NilaiWithKey
                                                        {
                                                            Key = jumlah_mapel_rapor.ToString(),
                                                            Nilai = nilai_rapor
                                                        });
                                                        lst_nilai_rapor.Add(new NilaiWithKey
                                                        {
                                                            Key = m_siswa.Kode.ToString(),
                                                            Nilai = nilai_rapor
                                                        });
                                                        urutan_mapel_rapor++;
                                                        //end get nilai rapor
                                                        //end distinct ap

                                                    }

                                                }
                                            }
                                            //end get struktur nilai

                                            Rapor_Arsip m_rapor_arsip = DAO_Rapor_Arsip.GetAll_Entity().FindAll(
                                                m0 => m0.TahunAjaran == tahun_ajaran &&
                                                      m0.Semester == semester &&
                                                      m0.JenisRapor == "Semester"

                                            ).FirstOrDefault();
                                            DateTime dt_tanggal_rapor = DateTime.Now;
                                            if (m_rapor_arsip != null)
                                            {
                                                if (m_rapor_arsip.TahunAjaran != null)
                                                {
                                                    dt_tanggal_rapor = m_rapor_arsip.TanggalRapor;
                                                }
                                            }

                                            string guru_kelas = "";
                                            string tanggal_rapor = Libs.GetTanggalIndonesiaFromDate(dt_tanggal_rapor, false);
                                            Rapor_LTS_MengetahuiGuruKelas m_guru_kelas = DAO_Rapor_LTS_MengetahuiGuruKelas.GetByTABySMByKelasDet_Entity(
                                                    tahun_ajaran, semester, rel_kelas_det
                                                ).FirstOrDefault();
                                            if (m_guru_kelas != null)
                                            {
                                                if (m_guru_kelas.NamaGuru != null)
                                                {
                                                    guru_kelas = m_guru_kelas.NamaGuru;
                                                }
                                            }

                                            hasil.Add(new KTSP_RaporNilai
                                            {
                                                IDSiswa = m_siswa.Nama.Trim().ToUpper() + "_" + m_siswa.Kode.ToString(),
                                                TahunAjaran = tahun_ajaran,
                                                Semester = semester,
                                                NIS = m_siswa.NISSekolah,
                                                NISN = m_siswa.NISN,
                                                Nama = Libs.GetPerbaikiEjaanNama(m_siswa.Nama.ToString()),
                                                Kelas = DAO_KelasDet.GetKelasForRapor(rel_kelas_det),
                                                UrutanMapelRapor = urutan_mapel_rapor,
                                                NamaMapel = item.NamaMapelRapor,
                                                Nilai = nilai_rapor,
                                                KKM = m_struktur_nilai.KKM,
                                                GuruKelas = s_walikelas,
                                                KepalaSekolah = m_rapor_arsip.KepalaSekolah,
                                                Tanggal = tanggal_rapor,
                                                NilaiRataRataSM1SM2 = ((nilai_rapor + nilai_rapor_sm1) / 2).ToString(),
                                                IsNaik = is_naik_kelas,
                                                NaikKeKelas = naik_ke_kelas,
                                                TTDGuru = img_ttd_guru
                                            });

                                        }

                                    }
                                }
                            }

                        }
                    }
                }
            }

            return hasil;
        }

        public static string GetHTMLLedger_KTSP(
            System.Web.UI.Page page,
            string tahun_ajaran,
            string semester,
            string rel_kelas_det,
            string rel_siswa = ""
        )
        {
            string css_cell_headers = "border-style: solid; border-width: 1px; text-align: center; font-weight: bold; padding: 5px;";
            string css_cell_body = "border-style: solid; border-width: 1px; padding: 3px;";

            string html = "";
            string html_row_header = "<td rowspan=\"2\" style=\"" + css_cell_headers + "\">" +
                                        "No" +
                                     "</td>" +
                                     "<td rowspan=\"2\" style=\"" + css_cell_headers + "\">" +
                                        "NIS" +
                                     "</td>" +
                                     "<td rowspan=\"2\" style=\"" + css_cell_headers + "\">" +
                                        "NAMA LENGKAP" +
                                     "</td>" +
                                     "<td rowspan=\"2\" style=\"" + css_cell_headers + "\">" +
                                        "L/P" +
                                     "</td>";
            string html_row_mapel = "";
            string html_row_body =  "";

            KelasDet m_kelas_det = DAO_KelasDet.GetByID_Entity(rel_kelas_det);
            if (m_kelas_det != null)
            {
                if (m_kelas_det.Nama != null)
                {

                    Kelas m_kelas = DAO_Kelas.GetByID_Entity(m_kelas_det.Rel_Kelas.ToString());
                    if (m_kelas != null)
                    {
                        if (m_kelas.Nama != null)
                        {

                            Rapor_Desain rapor_desain = DAO_Rapor_Desain.GetByTABySMByKelas_Entity(
                                    tahun_ajaran, semester, rel_kelas_det, DAO_Rapor_Desain.JenisRapor.Semester
                                ).FirstOrDefault();
                            List<Rapor_Desain_Det> lst_rapor_desain_det = DAO_Rapor_Desain_Det.GetAllByHeader_Entity(rapor_desain.Kode.ToString());

                            //list cols header
                            int jumlah_mapel = 0;
                            html_row_mapel = "";
                            foreach (Rapor_Desain_Det item_desain_det in lst_rapor_desain_det)
                            {
                                if (item_desain_det.Rel_Mapel.Trim() != "")
                                {
                                    html_row_mapel +=  "<td style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                            item_desain_det.NamaMapelRapor.Trim().ToUpper() +
                                                       "</td>";
                                    jumlah_mapel++;
                                }
                            }
                            html_row_header += "<td colspan=\"" + jumlah_mapel.ToString() + "\" style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                    "NILAI MATA PELAJARAN" +
                                               "</td>";
                            html_row_header += "<td colspan=\"4\" style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                    "PRESENSI" +
                                               "</td>";
                            html_row_header += "<td colspan=\"2\" style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                    "JUMLAH NILAI<br />" +
                                                    "KESELURUHAN" +
                                               "</td>";
                            html_row_mapel += "<td style=\"" + css_cell_headers + " width: 30px; font-size: 8.5px; \">" +
                                                    "S" +
                                              "</td>" +
                                              "<td style=\"" + css_cell_headers + " width: 30px; font-size: 8.5px; \">" +
                                                    "I" +
                                              "</td>" +
                                              "<td style=\"" + css_cell_headers + " width: 30px; font-size: 8.5px; \">" +
                                                    "A" +
                                              "</td>" +
                                              "<td style=\"" + css_cell_headers + " width: 30px; font-size: 8.5px; \">" +
                                                    "T" +
                                              "</td>";
                            html_row_mapel += "<td style=\"" + css_cell_headers + " width: 30px; font-size: 8.5px; \">" +
                                                    "JUMLAH" +
                                              "</td>" +
                                              "<td style=\"" + css_cell_headers + " width: 30px; font-size: 8.5px; \">" +
                                                    "RATA-RATA" +
                                              "</td>";
                            //end list cols header
                            if (rapor_desain != null)
                            {

                                List<DAO_Siswa.SiswaDataSimple> lst_siswa = DAO_Siswa.GetAllSiswaDataSimpleByTahunAjaranUnitKelas_Entity(
                                        m_kelas.Rel_Sekolah.ToString(),
                                        rel_kelas_det,
                                        tahun_ajaran,
                                        semester
                                    );
                                List<decimal> lst_nilai_ap = new List<decimal>();
                                List<decimal> lst_nilai_ap_bobot = new List<decimal>();
                                List<decimal> lst_nilai_kd = new List<decimal>();
                                List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT> lst_nilai_siswa_det = new List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT>();
                                List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT> lst_nilai_siswa_det_by_periode = new List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT>();
                                
                                lst_nilai_siswa_det_by_periode = DAO_Rapor_NilaiSiswa_Det.GetAllByTABySMByKelasDet_Entity(
                                        tahun_ajaran, semester, rel_kelas_det
                                    );

                                int nomor = 1;
                                if (rel_siswa.Trim() != "")
                                {
                                    lst_siswa = lst_siswa.FindAll(m0 => (rel_siswa + ";").Trim().ToUpper().IndexOf(m0.Kode.ToString().ToUpper() + ";") >= 0).ToList();
                                }
                                List<NilaiWithKey> lst_all_nilai_rapor = new List<NilaiWithKey>();
                                List<NilaiWithKey> lst_kkm_nilai_rapor = new List<NilaiWithKey>();
                                List<NilaiWithKey> lst_jumlah_nilai_keseluruhan = new List<NilaiWithKey>();
                                List<NilaiWithKey> lst_nilai_rapor = new List<NilaiWithKey>();
                                decimal jumlah_keseluruhan = 0;
                                decimal jumlah_mapel_rapor = 0;
                                foreach (DAO_Siswa.SiswaDataSimple m_siswa in lst_siswa.OrderBy(m => m.Nama))
                                {
                                    jumlah_keseluruhan = 0;                                    
                                    jumlah_mapel_rapor = 0;
                                    
                                    string html_row_body_siswa = "";
                                    html_row_body_siswa += "<td style=\"" + css_cell_body + " text-align: center;\">" +
                                                                nomor.ToString() +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + "\">" +
                                                                m_siswa.NISSekolah +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + " white-space: nowrap;\">" +
                                                                Libs.GetPerbaikiEjaanNama(m_siswa.Nama) +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + "\">" +
                                                                m_siswa.JenisKelamin +
                                                           "</td>";

                                    lst_kkm_nilai_rapor.Clear();
                                    foreach (Rapor_Desain_Det item in lst_rapor_desain_det.FindAll(m => m.Rel_Mapel.Trim() != ""))
                                    {

                                        if (item.Rel_Mapel.Trim() != "")
                                        {

                                            lst_nilai_siswa_det = lst_nilai_siswa_det_by_periode.FindAll(
                                                    m => m.Rel_Mapel == item.Rel_Mapel &&
                                                         m.Rel_Siswa == m.Rel_Siswa
                                                );

                                            //get struktur nilainya
                                            Rapor_StrukturNilai m_struktur_nilai = DAO_Rapor_StrukturNilai.GetATop1ByTABySMByKelasByMapel_Entity(
                                                    tahun_ajaran, semester, m_kelas.Kode.ToString(), item.Rel_Mapel
                                                );
                                            
                                            decimal nilai_rapor = 0;
                                            decimal jumlah_nilai_rapor = 0;
                                            decimal count_nilai_rapor = 0;
                                            if (m_struktur_nilai != null)
                                            {
                                                if (m_struktur_nilai.TahunAjaran != null)
                                                {

                                                    lst_kkm_nilai_rapor.Add(new NilaiWithKey
                                                    {
                                                        Key = (jumlah_mapel_rapor + 1).ToString(),
                                                        Nilai = m_struktur_nilai.KKM
                                                    });
                                                    if (!(m_struktur_nilai.IsKelompokanKP && m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString()))
                                                    {

                                                        //get struktur nilai det AP
                                                        List<Rapor_StrukturNilai_AP> lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeader_Entity(
                                                                m_struktur_nilai.Kode.ToString()
                                                            );
                                                        lst_nilai_ap.Clear();
                                                        lst_nilai_ap_bobot.Clear();
                                                        decimal jumlah_nilai_ap = 0;
                                                        decimal nilai_ap = 0;
                                                        int count_ap = 0;
                                                        foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                        {

                                                            //get struktur nilai det KD
                                                            List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                );
                                                            lst_nilai_kd.Clear();
                                                            foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                            {

                                                                //get struktur nilai det KP
                                                                List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                );
                                                                decimal jumlah_nilai_kd = 0;
                                                                decimal nilai_kd = 0;
                                                                int count_kd = 0;
                                                                foreach (var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp)
                                                                {
                                                                    Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString());
                                                                    if (m_kp != null)
                                                                    {

                                                                        Rapor_NilaiSiswa_Det m_nilai_det = lst_nilai_siswa_det.FindAll(
                                                                            m => m.Rel_Siswa.ToString().Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_AP.Trim().ToUpper() == item_rapor_struktur_nilai_ap.Kode.ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KD.Trim().ToUpper() == item_rapor_struktur_nilai_kd.Kode.ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KP.Trim().ToUpper() == item_rapor_struktur_nilai_kp.Kode.ToString().ToUpper()
                                                                        ).FirstOrDefault();

                                                                        if (m_nilai_det != null)
                                                                        {
                                                                            if (m_nilai_det.Nilai.Trim() != "")
                                                                            {
                                                                                if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                                {
                                                                                    nilai_kd += Math.Round((item_rapor_struktur_nilai_kp.BobotNK / 100) * Libs.GetStringToDecimal(m_nilai_det.Nilai), 2, MidpointRounding.AwayFromZero);
                                                                                }
                                                                                else if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                                {
                                                                                    jumlah_nilai_kd += Libs.GetStringToDecimal(m_nilai_det.Nilai);
                                                                                }
                                                                                count_kd++;
                                                                            }
                                                                        }

                                                                    }

                                                                }

                                                                if (count_kd > 0)
                                                                {
                                                                    if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                    {
                                                                        nilai_kd = Math.Round(jumlah_nilai_kd / count_kd, 2, MidpointRounding.AwayFromZero);
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    nilai_kd = 0;
                                                                }

                                                                //load nilai manual
                                                                Rapor_NilaiSiswa_AP_or_KD m_nilai_manual = DAO_Rapor_NilaiSiswa_AP_or_KD.GetAllByTABySMByKelasByMapelBySiswaByStruktur_Entity(
                                                                        tahun_ajaran, semester, rel_kelas_det, m_siswa.Kode.ToString(), item.Rel_Mapel,
                                                                        item_rapor_struktur_nilai_kd.Kode.ToString().Trim().ToUpper()

                                                                    ).FirstOrDefault();
                                                                if (m_nilai_manual != null)
                                                                {
                                                                    if (m_nilai_manual.Nilai != null)
                                                                    {
                                                                        nilai_kd = Libs.GetStringToDecimal(m_nilai_manual.Nilai);
                                                                    }
                                                                }
                                                                //end load nilai manual

                                                                nilai_kd = Math.Round(nilai_kd, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);
                                                                lst_nilai_kd.Add(nilai_kd);
                                                                //end get struktur nilai det KP

                                                            }
                                                            //end get struktur nilai det KD

                                                            //get nilai ap
                                                            count_ap = 0;
                                                            nilai_ap = 0;
                                                            jumlah_nilai_ap = 0;
                                                            foreach (var item_nilai_kd in lst_nilai_kd)
                                                            {
                                                                if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                {
                                                                    nilai_ap += Math.Round((item_rapor_struktur_nilai_ap.BobotRapor / 100) * item_nilai_kd, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                                else if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    jumlah_nilai_ap += item_nilai_kd;
                                                                }
                                                                count_ap++;
                                                            }
                                                            if (count_ap > 0)
                                                            {
                                                                if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_ap = Math.Round(jumlah_nilai_ap / count_ap, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_ap = 0;
                                                            }
                                                            nilai_ap = Math.Round(nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                            lst_nilai_ap.Add(nilai_ap);
                                                            lst_nilai_ap_bobot.Add(item_rapor_struktur_nilai_ap.BobotRapor);
                                                            //end get nilai ap

                                                        }
                                                        //end get struktur nilai det AP

                                                        //get nilai rapor
                                                        nilai_rapor = 0;
                                                        jumlah_nilai_rapor = 0;
                                                        count_nilai_rapor = 0;
                                                        foreach (var item_nilai_ap in lst_nilai_ap)
                                                        {
                                                            if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                            {
                                                                nilai_rapor += Math.Round((lst_nilai_ap_bobot[Convert.ToInt16(count_nilai_rapor)] / 100) * item_nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                            }
                                                            else if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                jumlah_nilai_rapor += item_nilai_ap;
                                                            }
                                                            count_nilai_rapor++;
                                                        }
                                                        if (count_nilai_rapor > 0)
                                                        {
                                                            if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            nilai_rapor = 0;
                                                        }
                                                        nilai_rapor = Math.Round(nilai_rapor, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);                                                        
                                                        jumlah_keseluruhan += nilai_rapor;
                                                        jumlah_mapel_rapor++;
                                                        lst_all_nilai_rapor.Add(new NilaiWithKey
                                                        {
                                                            Rel_Siswa = m_siswa.Kode.ToString(),
                                                            Key = jumlah_mapel_rapor.ToString(),
                                                            Nilai = nilai_rapor
                                                        });
                                                        lst_nilai_rapor.Add(new NilaiWithKey
                                                        {
                                                            Key = m_siswa.Kode.ToString(),
                                                            Nilai = nilai_rapor
                                                        });
                                                        //end get nilai rapor
                                                    }
                                                    else 
                                                    {

                                                        List<FormatNilai> lst_format_nilai = new List<FormatNilai>();
                                                        List<Rapor_StrukturNilai_AP> lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeader_Entity(
                                                                m_struktur_nilai.Kode.ToString()
                                                            );
                                                        foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                        {

                                                            List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                );

                                                            foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                            {

                                                                List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                );
                                                                foreach (var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp)
                                                                {

                                                                    if (
                                                                        lst_format_nilai.FindAll(
                                                                                m => m.Rel_StrukturNilai_AP == item_rapor_struktur_nilai_ap.Kode.ToString() &&
                                                                                     m.Rel_StrukturNilai_KD == item_rapor_struktur_nilai_kp.Rel_Rapor_StrukturNilai_KD.ToString() &&
                                                                                     m.Rel_KP == item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                            ).Count == 0
                                                                    ){
                                                                        lst_format_nilai.Add(new FormatNilai
                                                                        {
                                                                            Rel_StrukturNilai_AP = item_rapor_struktur_nilai_ap.Kode.ToString(),
                                                                            Rel_StrukturNilai_KD = item_rapor_struktur_nilai_kp.Rel_Rapor_StrukturNilai_KD.ToString(),
                                                                            Rel_KP = item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                        });
                                                                    }

                                                                }
                                                            }

                                                        }

                                                        List<FormatNilaiWithNilai> lst_formatnilai_nilai = new List<FormatNilaiWithNilai>();
                                                        //distinct ap
                                                        foreach (var m_sn_ap in lst_format_nilai.Select(m => new { m.Rel_StrukturNilai_AP, m.Rel_StrukturNilai_KD }).Distinct())
                                                        {
                                                            //foreach (string rel_sn_kd in lst_format_nilai.Select(m => m.Rel_StrukturNilai_KD).Distinct())
                                                            //{
                                                                foreach (string rel_kp in lst_format_nilai.Select(m => m.Rel_KP).Distinct())
                                                                {

                                                                    Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(rel_kp);
                                                                    if (m_kp != null)
                                                                    {
                                                                        if (m_kp.Nama != null)
                                                                        {

                                                                            double nilai = lst_nilai_siswa_det.Where(
                                                                                m => m.Rel_Rapor_StrukturNilai_AP.ToString().Trim().ToUpper() == m_sn_ap.Rel_StrukturNilai_AP.Trim().ToUpper() &&
                                                                                     m.Rel_Rapor_StrukturNilai_KD.ToString().Trim().ToUpper() == m_sn_ap.Rel_StrukturNilai_KD.Trim().ToUpper() &&
                                                                                     m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == rel_kp.Trim().ToUpper() &&
                                                                                     m.Rel_Siswa.Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                     m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper()
                                                                            ).Select(m => Libs.GetStringToDouble(m.Nilai)).DefaultIfEmpty().Average();

                                                                            lst_formatnilai_nilai.Add(new FormatNilaiWithNilai
                                                                            {
                                                                                Nama_KP = m_kp.Nama,
                                                                                Nilai = nilai.ToString(),
                                                                                Rel_KP = rel_kp,
                                                                                Rel_StrukturNilai_AP = m_sn_ap.Rel_StrukturNilai_AP,
                                                                                Rel_StrukturNilai_KD = "" //rel_sn_kd
                                                                            });

                                                                        }
                                                                    }

                                                                }
                                                            //}
                                                        }

                                                        //get nilai rapor                                                        
                                                        List<NilaiWithKey> lst_nilai = new List<NilaiWithKey>();
                                                        lst_nilai.Clear();
                                                        foreach (string rel_kp in lst_formatnilai_nilai.Select(m => m.Rel_KP).Distinct())
                                                        {

                                                            nilai_rapor = 0;
                                                            jumlah_nilai_rapor = 0;
                                                            count_nilai_rapor = 0;

                                                            foreach (var item_formatnilai_nilai_ap in lst_formatnilai_nilai.Select(m => new { m.Rel_StrukturNilai_AP }).Distinct())
                                                            {
                                                                List<double> lst_nilai_ = lst_formatnilai_nilai.FindAll(
                                                                            m => m.Rel_StrukturNilai_AP == item_formatnilai_nilai_ap.Rel_StrukturNilai_AP &&
                                                                                 m.Rel_StrukturNilai_KD == "" &&
                                                                                 m.Rel_KP == rel_kp
                                                                        ).Select(m => Libs.GetStringToDouble(m.Nilai)).ToList();
                                                                double nilai = lst_nilai_.DefaultIfEmpty().Average();
                                                                Rapor_StrukturNilai_AP m_rel_sn_ap = DAO_Rapor_StrukturNilai_AP.GetByID_Entity(item_formatnilai_nilai_ap.Rel_StrukturNilai_AP);
                                                                if (m_rel_sn_ap != null)
                                                                {
                                                                    if (m_rel_sn_ap.JenisPerhitungan != null)
                                                                    {

                                                                        if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                        {
                                                                            nilai_rapor += Math.Round((m_rel_sn_ap.BobotRapor / 100) * Libs.GetStringToDecimal(nilai.ToString()), 3, MidpointRounding.AwayFromZero);
                                                                        }
                                                                        else if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                        {
                                                                            jumlah_nilai_rapor += Math.Round(Libs.GetStringToDecimal(nilai.ToString()), 3, MidpointRounding.AwayFromZero);
                                                                        }
                                                                        count_nilai_rapor++;

                                                                    }
                                                                }
                                                            }

                                                            if (count_nilai_rapor > 0)
                                                            {
                                                                if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_rapor = 0;
                                                            }
                                                            nilai_rapor = Math.Round(nilai_rapor,3, MidpointRounding.AwayFromZero);
                                                            lst_nilai.Add(new NilaiWithKey {
                                                                Key = rel_kp,
                                                                Nilai = nilai_rapor
                                                            });
                                                        }

                                                        nilai_rapor = 0;
                                                        jumlah_nilai_rapor = 0;
                                                        count_nilai_rapor = 0;
                                                        List<Rapor_StrukturNilai_KPKelompok> lst_kpkelompok = DAO_Rapor_StrukturNilai_KPKelompok.GetAllByHeader_Entity(
                                                                m_struktur_nilai.Kode.ToString()
                                                            );
                                                        foreach (var item_nilai in lst_nilai)
                                                        {
                                                            Rapor_StrukturNilai_KPKelompok m_kpkelompok = lst_kpkelompok.FindAll(
                                                                    m => m.Rel_Rapor_KomponenPenilaian == new Guid(item_nilai.Key)
                                                                ).FirstOrDefault();
                                                            if (m_kpkelompok != null)
                                                            {
                                                                if (m_kpkelompok.Rel_Rapor_StrukturNilai != null)
                                                                {
                                                                    nilai_rapor += Math.Round((m_kpkelompok.Bobot / 100) * item_nilai.Nilai, 3, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                        }
                                                        nilai_rapor = Math.Round(nilai_rapor, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);
                                                        jumlah_keseluruhan += nilai_rapor;
                                                        jumlah_mapel_rapor++;
                                                        lst_all_nilai_rapor.Add(new NilaiWithKey
                                                        {
                                                            Rel_Siswa = m_siswa.Kode.ToString(),
                                                            Key = jumlah_mapel_rapor.ToString(),
                                                            Nilai = nilai_rapor
                                                        });
                                                        lst_nilai_rapor.Add(new NilaiWithKey
                                                        {
                                                            Key = m_siswa.Kode.ToString(),
                                                            Nilai = nilai_rapor
                                                        });
                                                        //end get nilai rapor
                                                        //end distinct ap

                                                    }

                                                }
                                            }
                                            //end get struktur nilai

                                            html_row_body_siswa += "<td style=\"" + css_cell_body + " text-align: center; " + (nilai_rapor < m_struktur_nilai.KKM ? " font-weight: bold; color: #9C0006; background-color: #FFC7CE; " : "") + "\">" +
                                                                        Libs.GetFormatBilangan(nilai_rapor, Constantas.PEMBULATAN_DESIMAL_NILAI_SD) +
                                                                   "</td>";
                                        }

                                    }

                                    lst_jumlah_nilai_keseluruhan.Add(new NilaiWithKey
                                    {
                                        Key = m_siswa.Kode.ToString(),
                                        Nilai = jumlah_keseluruhan
                                    });

                                    //absen
                                    string s_sakit = "-";
                                    string s_izin = "-";
                                    string s_alpa = "-";
                                    string s_terlambat = "-";

                                    Rapor_Arsip m_rapor_arsip = DAO_Rapor_Arsip.GetAll_Entity().FindAll(
                                            m0 => m0.TahunAjaran == tahun_ajaran &&
                                                  m0.Semester == semester &&
                                                  m0.JenisRapor == "Semester"

                                        ).FirstOrDefault();
                                    List<DAO_SiswaAbsen.AbsenRekapRapor> lst_absen = new List<DAO_SiswaAbsen.AbsenRekapRapor>();
                                    lst_absen = DAO_SiswaAbsen.GetRekapAbsenRaporBySiswaByPeriode_Entity(
                                            m_siswa.Kode.ToString(),
                                            (m_rapor_arsip != null ? m_rapor_arsip.TanggalAwalAbsen : DateTime.MinValue),
                                            (m_rapor_arsip != null ? m_rapor_arsip.TanggalAkhirAbsen : DateTime.MinValue)
                                        );
                                    foreach (var absen in lst_absen)
                                    {
                                        if (absen.Absen == Libs.JENIS_ABSENSI.SAKIT.Substring(0, 1)) s_sakit = absen.Jumlah.ToString();
                                        if (absen.Absen == Libs.JENIS_ABSENSI.IZIN.Substring(0, 1)) s_izin = absen.Jumlah.ToString();
                                        if (absen.Absen == Libs.JENIS_ABSENSI.ALPA.Substring(0, 1)) s_alpa = absen.Jumlah.ToString();
                                        if (absen.Absen == Libs.JENIS_ABSENSI.TERLAMBAT.Substring(0, 1)) s_terlambat = absen.Jumlah.ToString();
                                    }
                                    html_row_body_siswa += "<td style=\"" + css_cell_body + " text-align: center; \">" +
                                                                s_sakit +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + " text-align: center; \">" +
                                                                s_izin +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + " text-align: center; \">" +
                                                                s_alpa +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + " text-align: center; \">" +
                                                                s_terlambat +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + " text-align: center; \">" +
                                                                Math.Round(jumlah_keseluruhan, 0).ToString() +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + " text-align: center; \">" +
                                                                Libs.GetFormatBilangan(
                                                                        (Math.Round(jumlah_keseluruhan / jumlah_mapel_rapor, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero)),
                                                                    Constantas.PEMBULATAN_DESIMAL_NILAI_SD) +
                                                           "</td>";
                                    //end absen

                                    html_row_body += "<tr>" +
                                                        html_row_body_siswa +
                                                     "</tr>";

                                    nomor++;
                                }
                                // end foreach siswa
                                string html_row_rata_rata = "<td colspan=\"4\" style=\"" + css_cell_body + " font-weight: bold;\">" +
                                                                "RATA-RATA KELAS" +
                                                            "</td>";
                                string html_row_kkm = "<td colspan=\"4\" style=\"" + css_cell_body + " font-weight: bold;\">" +
                                                            "KKM" +
                                                      "</td>";
                                for (int i = 1; i <= jumlah_mapel_rapor; i++)
                                {
                                    decimal rata_rata = Math.Round(lst_all_nilai_rapor.FindAll(m => m.Key == i.ToString() && m.Rel_Siswa.Trim().ToUpper() != KODE_NAWA).Select(m => m.Nilai).DefaultIfEmpty().Average(), Constantas.PEMBULATAN_DESIMAL_NILAI_SD);
                                    decimal kkm = 0;
                                    NilaiWithKey m_kkm = lst_kkm_nilai_rapor.FindAll(m => m.Key == i.ToString()).FirstOrDefault();
                                    if (m_kkm != null)
                                    {
                                        if (m_kkm.Key != null)
                                        {
                                            kkm = m_kkm.Nilai;
                                        }
                                    }
                                    html_row_rata_rata += "<td style=\"" + css_cell_body + " text-align: right; " + (rata_rata < kkm ? " font-weight: bold; color: #9C0006; background-color: #FFC7CE; " : "") + "\">" +
                                                                 Libs.GetFormatBilangan(rata_rata, Constantas.PEMBULATAN_DESIMAL_NILAI_SD) +
                                                          "</td>";
                                    html_row_kkm += "<td style=\"" + css_cell_body + " text-align: center; " + (rata_rata < kkm ? " font-weight: bold; color: #9C0006; background-color: #FFC7CE; " : "") + "\">" +
                                                        Libs.GetFormatBilangan(kkm, Constantas.PEMBULATAN_DESIMAL_NILAI_SD) +
                                                    "</td>";
                                }
                                for (int i = 1; i <= 6; i++)
                                {
                                    if (i <= 4)
                                    {
                                        html_row_rata_rata += "<td style=\"" + css_cell_body + " text-align: right;\">" +
                                                                    "&nbsp;" +
                                                              "</td>";
                                    }
                                    html_row_kkm += "<td style=\"" + css_cell_body + " text-align: center;\">" +
                                                        "&nbsp;" +
                                                    "</td>";
                                }
                                decimal rata_rata_nilai_keseluruhan = Math.Round(lst_jumlah_nilai_keseluruhan.Select(m => m.Nilai).DefaultIfEmpty().Average(), Constantas.PEMBULATAN_DESIMAL_NILAI_SD);
                                decimal rata_rata_nilai_rata_rata_rapor = Math.Round(lst_nilai_rapor.Select(m => m.Nilai).DefaultIfEmpty().Average(), Constantas.PEMBULATAN_DESIMAL_NILAI_SD);
                                html_row_rata_rata += "<td style=\"" + css_cell_body + " text-align: center;\">" +
                                                        Libs.GetFormatBilangan(Math.Round(rata_rata_nilai_keseluruhan, 2, MidpointRounding.AwayFromZero), 2) +
                                                      "</td>";
                                html_row_rata_rata += "<td style=\"" + css_cell_body + " text-align: center;\">" +
                                                        Libs.GetFormatBilangan(Math.Round(rata_rata_nilai_rata_rata_rapor, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero), Constantas.PEMBULATAN_DESIMAL_NILAI_SD) +
                                                      "</td>";
                                html_row_body += "<tr>" +
                                                    html_row_rata_rata +
                                                 "</tr>" +
                                                 "<tr>" +
                                                    html_row_kkm +
                                                 "</tr>";

                            }

                        }
                    }

                }
            }

            html_row_header = "<tr>" +
                                html_row_header +
                              "</tr>" +
                              "<tr>" +
                                html_row_mapel +
                              "</tr>" +
                              html_row_body;

            html = "<table style=\"border-collapse: collapse;\">" +
                        html_row_header +
                   "</table>";

            return html;
        }

        public static string GetHTMLLedger_KTSP_RataRata(
            System.Web.UI.Page page,
            string tahun_ajaran,
            string semester,
            string rel_kelas_det,
            string rel_siswa = ""
        )
        {
            string css_cell_headers = "border-style: solid; border-width: 1px; text-align: center; font-weight: bold; padding: 5px;";
            string css_cell_body = "border-style: solid; border-width: 1px; padding: 3px;";

            string html = "";
            string html_row_header = "<td rowspan=\"2\" style=\"" + css_cell_headers + "\">" +
                                        "No" +
                                     "</td>" +
                                     "<td rowspan=\"2\" style=\"" + css_cell_headers + "\">" +
                                        "NIS" +
                                     "</td>" +
                                     "<td rowspan=\"2\" style=\"" + css_cell_headers + "\">" +
                                        "NAMA LENGKAP" +
                                     "</td>" +
                                     "<td rowspan=\"2\" style=\"" + css_cell_headers + "\">" +
                                        "L/P" +
                                     "</td>";
            string html_row_mapel = "";
            string html_row_body = "";

            KelasDet m_kelas_det = DAO_KelasDet.GetByID_Entity(rel_kelas_det);
            if (m_kelas_det != null)
            {
                if (m_kelas_det.Nama != null)
                {

                    Kelas m_kelas = DAO_Kelas.GetByID_Entity(m_kelas_det.Rel_Kelas.ToString());
                    if (m_kelas != null)
                    {
                        if (m_kelas.Nama != null)
                        {

                            Rapor_Desain rapor_desain = DAO_Rapor_Desain.GetByTABySMByKelas_Entity(
                                    tahun_ajaran, semester, rel_kelas_det, DAO_Rapor_Desain.JenisRapor.Semester
                                ).FirstOrDefault();
                            List<Rapor_Desain_Det> lst_rapor_desain_det = DAO_Rapor_Desain_Det.GetAllByHeader_Entity(rapor_desain.Kode.ToString());

                            //list cols header
                            int jumlah_mapel = 0;
                            html_row_mapel = "";
                            foreach (Rapor_Desain_Det item_desain_det in lst_rapor_desain_det)
                            {
                                if (item_desain_det.Rel_Mapel.Trim() != "")
                                {
                                    html_row_mapel += "<td style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                            item_desain_det.NamaMapelRapor.Trim().ToUpper() +
                                                       "</td>";
                                    jumlah_mapel++;
                                }
                            }
                            html_row_header += "<td colspan=\"" + jumlah_mapel.ToString() + "\" style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                    "NILAI MATA PELAJARAN" +
                                               "</td>";
                            html_row_header += "<td colspan=\"4\" style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                    "PRESENSI" +
                                               "</td>";
                            html_row_header += "<td colspan=\"2\" style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                    "JUMLAH NILAI<br />" +
                                                    "KESELURUHAN" +
                                               "</td>";
                            html_row_mapel += "<td style=\"" + css_cell_headers + " width: 30px; font-size: 8.5px; \">" +
                                                    "S" +
                                              "</td>" +
                                              "<td style=\"" + css_cell_headers + " width: 30px; font-size: 8.5px; \">" +
                                                    "I" +
                                              "</td>" +
                                              "<td style=\"" + css_cell_headers + " width: 30px; font-size: 8.5px; \">" +
                                                    "A" +
                                              "</td>" +
                                              "<td style=\"" + css_cell_headers + " width: 30px; font-size: 8.5px; \">" +
                                                    "T" +
                                              "</td>";
                            html_row_mapel += "<td style=\"" + css_cell_headers + " width: 30px; font-size: 8.5px; \">" +
                                                    "JUMLAH" +
                                              "</td>" +
                                              "<td style=\"" + css_cell_headers + " width: 30px; font-size: 8.5px; \">" +
                                                    "RATA-RATA" +
                                              "</td>";
                            //end list cols header
                            if (rapor_desain != null)
                            {

                                List<DAO_Siswa.SiswaDataSimple> lst_siswa = DAO_Siswa.GetAllSiswaDataSimpleByTahunAjaranUnitKelas_Entity(
                                        m_kelas.Rel_Sekolah.ToString(),
                                        rel_kelas_det,
                                        tahun_ajaran,
                                        semester
                                    );
                                List<decimal> lst_nilai_ap = new List<decimal>();
                                List<decimal> lst_nilai_ap_bobot = new List<decimal>();
                                List<decimal> lst_nilai_kd = new List<decimal>();
                                List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT> lst_nilai_siswa_det_sm1 = new List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT>();
                                List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT> lst_nilai_siswa_det_by_periode_sm1 = new List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT>();
                                List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT> lst_nilai_siswa_det = new List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT>();
                                List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT> lst_nilai_siswa_det_by_periode = new List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT>();

                                lst_nilai_siswa_det_by_periode_sm1 = DAO_Rapor_NilaiSiswa_Det.GetAllByTABySMByKelasDet_Entity(
                                        tahun_ajaran, "1", rel_kelas_det
                                    );
                                lst_nilai_siswa_det_by_periode = DAO_Rapor_NilaiSiswa_Det.GetAllByTABySMByKelasDet_Entity(
                                        tahun_ajaran, semester, rel_kelas_det
                                    );

                                int nomor = 1;
                                if (rel_siswa.Trim() != "")
                                {
                                    lst_siswa = lst_siswa.FindAll(m0 => (rel_siswa + ";").Trim().ToUpper().IndexOf(m0.Kode.ToString().ToUpper() + ";") >= 0).ToList();
                                }
                                List<NilaiWithKey> lst_all_nilai_rapor = new List<NilaiWithKey>();
                                List<NilaiWithKey> lst_kkm_nilai_rapor = new List<NilaiWithKey>();
                                List<NilaiWithKey> lst_kkm_nilai_rapor_sm1 = new List<NilaiWithKey>();
                                List<NilaiWithKey> lst_jumlah_nilai_keseluruhan = new List<NilaiWithKey>();
                                List<NilaiWithKey> lst_nilai_rapor = new List<NilaiWithKey>();
                                decimal jumlah_keseluruhan = 0;
                                decimal jumlah_mapel_rapor = 0;
                                foreach (DAO_Siswa.SiswaDataSimple m_siswa in lst_siswa.OrderBy(m => m.Nama))
                                {
                                    jumlah_keseluruhan = 0;
                                    jumlah_mapel_rapor = 0;

                                    string html_row_body_siswa = "";
                                    html_row_body_siswa += "<td style=\"" + css_cell_body + " text-align: center;\">" +
                                                                nomor.ToString() +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + "\">" +
                                                                m_siswa.NISSekolah +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + " white-space: nowrap;\">" +
                                                                Libs.GetPerbaikiEjaanNama(m_siswa.Nama) +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + "\">" +
                                                                m_siswa.JenisKelamin +
                                                           "</td>";

                                    lst_kkm_nilai_rapor.Clear();
                                    lst_kkm_nilai_rapor_sm1.Clear();
                                    foreach (Rapor_Desain_Det item in lst_rapor_desain_det.FindAll(m => m.Rel_Mapel.Trim() != ""))
                                    {

                                        if (item.Rel_Mapel.Trim() != "")
                                        {

                                            lst_nilai_siswa_det = lst_nilai_siswa_det_by_periode.FindAll(
                                                    m => m.Rel_Mapel == item.Rel_Mapel &&
                                                         m.Rel_Siswa == m.Rel_Siswa
                                                );
                                            lst_nilai_siswa_det_sm1 = lst_nilai_siswa_det_by_periode_sm1.FindAll(
                                                    m => m.Rel_Mapel == item.Rel_Mapel &&
                                                         m.Rel_Siswa == m_siswa.Kode.ToString()
                                                );

                                            //get struktur nilainya
                                            Rapor_StrukturNilai m_struktur_nilai = DAO_Rapor_StrukturNilai.GetATop1ByTABySMByKelasByMapel_Entity(
                                                    tahun_ajaran, semester, m_kelas.Kode.ToString(), item.Rel_Mapel
                                                );
                                            Rapor_StrukturNilai m_struktur_nilai_sm1 = DAO_Rapor_StrukturNilai.GetATop1ByTABySMByKelasByMapel_Entity(
                                                    tahun_ajaran, "1", m_kelas.Kode.ToString(), item.Rel_Mapel
                                                );
                                            
                                            decimal nilai_rapor_sm1 = 0;
                                            decimal jumlah_nilai_rapor_sm1 = 0;
                                            decimal count_nilai_rapor_sm1 = 0;
                                            if (m_struktur_nilai_sm1 != null)
                                            {
                                                if (m_struktur_nilai_sm1.TahunAjaran != null)
                                                {

                                                    lst_kkm_nilai_rapor_sm1.Add(new NilaiWithKey
                                                    {
                                                        Key = (jumlah_mapel_rapor + 1).ToString(),
                                                        Nilai = m_struktur_nilai_sm1.KKM
                                                    });
                                                    if (!(m_struktur_nilai_sm1.IsKelompokanKP && m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString()))
                                                    {
                                                        //get struktur nilai det AP
                                                        List<Rapor_StrukturNilai_AP> lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeader_Entity(
                                                                m_struktur_nilai_sm1.Kode.ToString()
                                                            );
                                                        lst_nilai_ap.Clear();
                                                        lst_nilai_ap_bobot.Clear();
                                                        decimal jumlah_nilai_ap = 0;
                                                        decimal nilai_ap = 0;
                                                        int count_ap = 0;
                                                        foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                        {

                                                            //get struktur nilai det KD
                                                            List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                );
                                                            lst_nilai_kd.Clear();
                                                            foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                            {

                                                                //get struktur nilai det KP
                                                                List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                );
                                                                decimal jumlah_nilai_kd = 0;
                                                                decimal nilai_kd = 0;
                                                                int count_kd = 0;
                                                                foreach (var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp)
                                                                {
                                                                    Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString());
                                                                    if (m_kp != null)
                                                                    {

                                                                        Rapor_NilaiSiswa_Det m_nilai_det = lst_nilai_siswa_det_sm1.FindAll(
                                                                            m => m.Rel_Siswa.ToString().Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai_sm1.Rel_Mapel.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_AP.Trim().ToUpper() == item_rapor_struktur_nilai_ap.Kode.ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KD.Trim().ToUpper() == item_rapor_struktur_nilai_kd.Kode.ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KP.Trim().ToUpper() == item_rapor_struktur_nilai_kp.Kode.ToString().ToUpper()
                                                                        ).FirstOrDefault();

                                                                        if (m_nilai_det != null)
                                                                        {
                                                                            if (m_nilai_det.Nilai.Trim() != "")
                                                                            {
                                                                                if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                                {
                                                                                    nilai_kd += Math.Round((item_rapor_struktur_nilai_kp.BobotNK / 100) * Libs.GetStringToDecimal(m_nilai_det.Nilai), 2, MidpointRounding.AwayFromZero);
                                                                                }
                                                                                else if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                                {
                                                                                    jumlah_nilai_kd += Libs.GetStringToDecimal(m_nilai_det.Nilai);
                                                                                }
                                                                                count_kd++;
                                                                            }
                                                                        }

                                                                    }

                                                                }

                                                                if (count_kd > 0)
                                                                {
                                                                    if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                    {
                                                                        nilai_kd = Math.Round(jumlah_nilai_kd / count_kd, 2, MidpointRounding.AwayFromZero);
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    nilai_kd = 0;
                                                                }

                                                                //load nilai manual
                                                                Rapor_NilaiSiswa_AP_or_KD m_nilai_manual = DAO_Rapor_NilaiSiswa_AP_or_KD.GetAllByTABySMByKelasByMapelBySiswaByStruktur_Entity(
                                                                        tahun_ajaran, m_struktur_nilai_sm1.Semester, rel_kelas_det, m_siswa.Kode.ToString(), item.Rel_Mapel,
                                                                        item_rapor_struktur_nilai_kd.Kode.ToString().Trim().ToUpper()

                                                                    ).FirstOrDefault();
                                                                if (m_nilai_manual != null)
                                                                {
                                                                    if (m_nilai_manual.Nilai != null)
                                                                    {
                                                                        nilai_kd = Libs.GetStringToDecimal(m_nilai_manual.Nilai);
                                                                    }
                                                                }
                                                                //end load nilai manual

                                                                nilai_kd = Math.Round(nilai_kd, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);
                                                                lst_nilai_kd.Add(nilai_kd);
                                                                //end get struktur nilai det KP

                                                            }
                                                            //end get struktur nilai det KD

                                                            //get nilai ap
                                                            count_ap = 0;
                                                            nilai_ap = 0;
                                                            jumlah_nilai_ap = 0;
                                                            foreach (var item_nilai_kd in lst_nilai_kd)
                                                            {
                                                                if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                {
                                                                    nilai_ap += Math.Round((item_rapor_struktur_nilai_ap.BobotRapor / 100) * item_nilai_kd, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                                else if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    jumlah_nilai_ap += item_nilai_kd;
                                                                }
                                                                count_ap++;
                                                            }
                                                            if (count_ap > 0)
                                                            {
                                                                if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_ap = Math.Round(jumlah_nilai_ap / count_ap, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_ap = 0;
                                                            }
                                                            nilai_ap = Math.Round(nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                            lst_nilai_ap.Add(nilai_ap);
                                                            lst_nilai_ap_bobot.Add(item_rapor_struktur_nilai_ap.BobotRapor);
                                                            //end get nilai ap

                                                        }
                                                        //end get struktur nilai det AP

                                                        //get nilai rapor
                                                        nilai_rapor_sm1 = 0;
                                                        jumlah_nilai_rapor_sm1 = 0;
                                                        count_nilai_rapor_sm1 = 0;
                                                        foreach (var item_nilai_ap in lst_nilai_ap)
                                                        {
                                                            if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                            {
                                                                nilai_rapor_sm1 += Math.Round((lst_nilai_ap_bobot[Convert.ToInt16(count_nilai_rapor_sm1)] / 100) * item_nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                            }
                                                            else if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                jumlah_nilai_rapor_sm1 += item_nilai_ap;
                                                            }
                                                            count_nilai_rapor_sm1++;
                                                        }
                                                        if (count_nilai_rapor_sm1 > 0)
                                                        {
                                                            if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                nilai_rapor_sm1 = Math.Round(jumlah_nilai_rapor_sm1 / count_nilai_rapor_sm1, 3, MidpointRounding.AwayFromZero);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            nilai_rapor_sm1 = 0;
                                                        }
                                                        nilai_rapor_sm1 = Math.Round(nilai_rapor_sm1, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);                                                        
                                                        //end get nilai rapor
                                                    }
                                                    else
                                                    {

                                                        List<FormatNilai> lst_format_nilai = new List<FormatNilai>();
                                                        List<Rapor_StrukturNilai_AP> lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeader_Entity(
                                                                m_struktur_nilai_sm1.Kode.ToString()
                                                            );
                                                        foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                        {

                                                            List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                );

                                                            foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                            {

                                                                List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                );
                                                                foreach (var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp)
                                                                {

                                                                    if (
                                                                        lst_format_nilai.FindAll(
                                                                                m => m.Rel_StrukturNilai_AP == item_rapor_struktur_nilai_ap.Kode.ToString() &&
                                                                                     m.Rel_KP == item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                            ).Count == 0
                                                                    )
                                                                    {
                                                                        lst_format_nilai.Add(new FormatNilai
                                                                        {
                                                                            Rel_StrukturNilai_AP = item_rapor_struktur_nilai_ap.Kode.ToString(),
                                                                            Rel_KP = item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                        });
                                                                    }

                                                                }
                                                            }

                                                        }

                                                        List<FormatNilaiWithNilai> lst_formatnilai_nilai = new List<FormatNilaiWithNilai>();
                                                        //distinct ap
                                                        foreach (string rel_sn_ap in lst_format_nilai.Select(m => m.Rel_StrukturNilai_AP).Distinct())
                                                        {
                                                            foreach (string rel_kp in lst_format_nilai.Select(m => m.Rel_KP).Distinct())
                                                            {

                                                                Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(rel_kp);
                                                                if (m_kp != null)
                                                                {
                                                                    if (m_kp.Nama != null)
                                                                    {

                                                                        double nilai = lst_nilai_siswa_det_sm1.Where(
                                                                            m => m.Rel_Rapor_StrukturNilai_AP.ToString().Trim().ToUpper() == rel_sn_ap.Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == rel_kp.Trim().ToUpper() &&
                                                                                 m.Rel_Siswa.Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai_sm1.Rel_Mapel.ToString().Trim().ToUpper()
                                                                        ).Select(m => Libs.GetStringToDouble(m.Nilai)).DefaultIfEmpty().Average();

                                                                        lst_formatnilai_nilai.Add(new FormatNilaiWithNilai
                                                                        {
                                                                            Nama_KP = m_kp.Nama,
                                                                            Nilai = nilai.ToString(),
                                                                            Rel_KP = rel_kp,
                                                                            Rel_StrukturNilai_AP = rel_sn_ap
                                                                        });

                                                                    }
                                                                }

                                                            }
                                                        }

                                                        //get nilai rapor                                                        
                                                        List<NilaiWithKey> lst_nilai = new List<NilaiWithKey>();
                                                        lst_nilai.Clear();
                                                        foreach (string rel_kp in lst_formatnilai_nilai.Select(m => m.Rel_KP).Distinct())
                                                        {

                                                            nilai_rapor_sm1 = 0;
                                                            jumlah_nilai_rapor_sm1 = 0;
                                                            count_nilai_rapor_sm1 = 0;
                                                            foreach (var m_formatnilai_nilai in lst_formatnilai_nilai.FindAll(m => m.Rel_KP == rel_kp))
                                                            {
                                                                Rapor_StrukturNilai_AP m_rel_sn_ap = DAO_Rapor_StrukturNilai_AP.GetByID_Entity(m_formatnilai_nilai.Rel_StrukturNilai_AP);
                                                                if (m_rel_sn_ap != null)
                                                                {
                                                                    if (m_rel_sn_ap.JenisPerhitungan != null)
                                                                    {

                                                                        if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                        {
                                                                            nilai_rapor_sm1 += Math.Round((m_rel_sn_ap.BobotRapor / 100) * Libs.GetStringToDecimal(m_formatnilai_nilai.Nilai), 3, MidpointRounding.AwayFromZero);
                                                                        }
                                                                        else if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                        {
                                                                            jumlah_nilai_rapor_sm1 += Libs.GetStringToDecimal(m_formatnilai_nilai.Nilai);
                                                                        }
                                                                        count_nilai_rapor_sm1++;

                                                                    }
                                                                }
                                                            }

                                                            if (count_nilai_rapor_sm1 > 0)
                                                            {
                                                                if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_rapor_sm1 = Math.Round(jumlah_nilai_rapor_sm1 / count_nilai_rapor_sm1, 3, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_rapor_sm1 = 0;
                                                            }
                                                            nilai_rapor_sm1 = Math.Round(nilai_rapor_sm1, 3, MidpointRounding.AwayFromZero);
                                                            lst_nilai.Add(new NilaiWithKey
                                                            {
                                                                Key = rel_kp,
                                                                Nilai = nilai_rapor_sm1
                                                            });
                                                        }

                                                        nilai_rapor_sm1 = 0;
                                                        jumlah_nilai_rapor_sm1 = 0;
                                                        count_nilai_rapor_sm1 = 0;
                                                        List<Rapor_StrukturNilai_KPKelompok> lst_kpkelompok = DAO_Rapor_StrukturNilai_KPKelompok.GetAllByHeader_Entity(
                                                                m_struktur_nilai_sm1.Kode.ToString()
                                                            );
                                                        foreach (var item_nilai in lst_nilai)
                                                        {
                                                            Rapor_StrukturNilai_KPKelompok m_kpkelompok = lst_kpkelompok.FindAll(
                                                                    m => m.Rel_Rapor_KomponenPenilaian == new Guid(item_nilai.Key)
                                                                ).FirstOrDefault();
                                                            if (m_kpkelompok != null)
                                                            {
                                                                if (m_kpkelompok.Rel_Rapor_StrukturNilai != null)
                                                                {
                                                                    nilai_rapor_sm1 += Math.Round((m_kpkelompok.Bobot / 100) * item_nilai.Nilai, 3, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                        }
                                                        nilai_rapor_sm1 = Math.Round(nilai_rapor_sm1, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);                                                        
                                                        //end get nilai rapor
                                                        //end distinct ap

                                                    }

                                                }
                                            }
                                            //end get struktur nilai

                                            decimal nilai_rapor = 0;
                                            decimal jumlah_nilai_rapor = 0;
                                            decimal count_nilai_rapor = 0;
                                            if (m_struktur_nilai != null)
                                            {
                                                if (m_struktur_nilai.TahunAjaran != null)
                                                {

                                                    lst_kkm_nilai_rapor.Add(new NilaiWithKey
                                                    {
                                                        Key = (jumlah_mapel_rapor + 1).ToString(),
                                                        Nilai = m_struktur_nilai.KKM
                                                    });
                                                    if (!(m_struktur_nilai.IsKelompokanKP && m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString()))
                                                    {

                                                        //get struktur nilai det AP
                                                        List<Rapor_StrukturNilai_AP> lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeader_Entity(
                                                                m_struktur_nilai.Kode.ToString()
                                                            );
                                                        lst_nilai_ap.Clear();
                                                        lst_nilai_ap_bobot.Clear();
                                                        decimal jumlah_nilai_ap = 0;
                                                        decimal nilai_ap = 0;
                                                        int count_ap = 0;
                                                        foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                        {

                                                            //get struktur nilai det KD
                                                            List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                );
                                                            lst_nilai_kd.Clear();
                                                            foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                            {

                                                                //get struktur nilai det KP
                                                                List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                );
                                                                decimal jumlah_nilai_kd = 0;
                                                                decimal nilai_kd = 0;
                                                                int count_kd = 0;
                                                                foreach (var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp)
                                                                {
                                                                    Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString());
                                                                    if (m_kp != null)
                                                                    {

                                                                        Rapor_NilaiSiswa_Det m_nilai_det = lst_nilai_siswa_det.FindAll(
                                                                            m => m.Rel_Siswa.ToString().Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_AP.Trim().ToUpper() == item_rapor_struktur_nilai_ap.Kode.ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KD.Trim().ToUpper() == item_rapor_struktur_nilai_kd.Kode.ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KP.Trim().ToUpper() == item_rapor_struktur_nilai_kp.Kode.ToString().ToUpper()
                                                                        ).FirstOrDefault();

                                                                        if (m_nilai_det != null)
                                                                        {
                                                                            if (m_nilai_det.Nilai.Trim() != "")
                                                                            {
                                                                                if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                                {
                                                                                    nilai_kd += Math.Round((item_rapor_struktur_nilai_kp.BobotNK / 100) * Libs.GetStringToDecimal(m_nilai_det.Nilai), 2, MidpointRounding.AwayFromZero);
                                                                                }
                                                                                else if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                                {
                                                                                    jumlah_nilai_kd += Libs.GetStringToDecimal(m_nilai_det.Nilai);
                                                                                }
                                                                                count_kd++;
                                                                            }
                                                                        }

                                                                    }

                                                                }

                                                                if (count_kd > 0)
                                                                {
                                                                    if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                    {
                                                                        nilai_kd = Math.Round(jumlah_nilai_kd / count_kd, 2, MidpointRounding.AwayFromZero);
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    nilai_kd = 0;
                                                                }

                                                                //load nilai manual
                                                                Rapor_NilaiSiswa_AP_or_KD m_nilai_manual = DAO_Rapor_NilaiSiswa_AP_or_KD.GetAllByTABySMByKelasByMapelBySiswaByStruktur_Entity(
                                                                        tahun_ajaran, semester, rel_kelas_det, m_siswa.Kode.ToString(), item.Rel_Mapel,
                                                                        item_rapor_struktur_nilai_kd.Kode.ToString().Trim().ToUpper()

                                                                    ).FirstOrDefault();
                                                                if (m_nilai_manual != null)
                                                                {
                                                                    if (m_nilai_manual.Nilai != null)
                                                                    {
                                                                        nilai_kd = Libs.GetStringToDecimal(m_nilai_manual.Nilai);
                                                                    }
                                                                }
                                                                //end load nilai manual

                                                                nilai_kd = Math.Round(nilai_kd, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);
                                                                lst_nilai_kd.Add(nilai_kd);
                                                                //end get struktur nilai det KP

                                                            }
                                                            //end get struktur nilai det KD

                                                            //get nilai ap
                                                            count_ap = 0;
                                                            nilai_ap = 0;
                                                            jumlah_nilai_ap = 0;
                                                            foreach (var item_nilai_kd in lst_nilai_kd)
                                                            {
                                                                if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                {
                                                                    nilai_ap += Math.Round((item_rapor_struktur_nilai_ap.BobotRapor / 100) * item_nilai_kd, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                                else if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    jumlah_nilai_ap += item_nilai_kd;
                                                                }
                                                                count_ap++;
                                                            }
                                                            if (count_ap > 0)
                                                            {
                                                                if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_ap = Math.Round(jumlah_nilai_ap / count_ap, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_ap = 0;
                                                            }
                                                            nilai_ap = Math.Round(nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                            lst_nilai_ap.Add(nilai_ap);
                                                            lst_nilai_ap_bobot.Add(item_rapor_struktur_nilai_ap.BobotRapor);
                                                            //end get nilai ap

                                                        }
                                                        //end get struktur nilai det AP

                                                        //get nilai rapor
                                                        nilai_rapor = 0;
                                                        jumlah_nilai_rapor = 0;
                                                        count_nilai_rapor = 0;
                                                        foreach (var item_nilai_ap in lst_nilai_ap)
                                                        {
                                                            if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                            {
                                                                nilai_rapor += Math.Round((lst_nilai_ap_bobot[Convert.ToInt16(count_nilai_rapor)] / 100) * item_nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                            }
                                                            else if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                jumlah_nilai_rapor += item_nilai_ap;
                                                            }
                                                            count_nilai_rapor++;
                                                        }
                                                        if (count_nilai_rapor > 0)
                                                        {
                                                            if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            nilai_rapor = 0;
                                                        }
                                                        nilai_rapor = Math.Round(nilai_rapor, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);
                                                        nilai_rapor = Math.Round((nilai_rapor + nilai_rapor_sm1) / 2, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);
                                                        jumlah_keseluruhan += nilai_rapor;
                                                        jumlah_mapel_rapor++;
                                                        lst_all_nilai_rapor.Add(new NilaiWithKey
                                                        {
                                                            Rel_Siswa = m_siswa.Kode.ToString(),
                                                            Key = jumlah_mapel_rapor.ToString(),
                                                            Nilai = nilai_rapor
                                                        });
                                                        lst_nilai_rapor.Add(new NilaiWithKey
                                                        {
                                                            Key = m_siswa.Kode.ToString(),
                                                            Nilai = nilai_rapor
                                                        });
                                                        //end get nilai rapor
                                                    }
                                                    else
                                                    {

                                                        List<FormatNilai> lst_format_nilai = new List<FormatNilai>();
                                                        List<Rapor_StrukturNilai_AP> lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeader_Entity(
                                                                m_struktur_nilai.Kode.ToString()
                                                            );
                                                        foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                        {

                                                            List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                );

                                                            foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                            {

                                                                List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                );
                                                                foreach (var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp)
                                                                {

                                                                    if (
                                                                        lst_format_nilai.FindAll(
                                                                                m => m.Rel_StrukturNilai_AP == item_rapor_struktur_nilai_ap.Kode.ToString() &&
                                                                                     m.Rel_StrukturNilai_KD == item_rapor_struktur_nilai_kp.Rel_Rapor_StrukturNilai_KD.ToString() &&
                                                                                     m.Rel_KP == item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                            ).Count == 0
                                                                    )
                                                                    {
                                                                        lst_format_nilai.Add(new FormatNilai
                                                                        {
                                                                            Rel_StrukturNilai_AP = item_rapor_struktur_nilai_ap.Kode.ToString(),
                                                                            Rel_StrukturNilai_KD = item_rapor_struktur_nilai_kp.Rel_Rapor_StrukturNilai_KD.ToString(),
                                                                            Rel_KP = item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                        });
                                                                    }

                                                                }
                                                            }

                                                        }

                                                        List<FormatNilaiWithNilai> lst_formatnilai_nilai = new List<FormatNilaiWithNilai>();
                                                        //distinct ap
                                                        foreach (var m_sn_ap in lst_format_nilai.Select(m => new { m.Rel_StrukturNilai_AP, m.Rel_StrukturNilai_KD }).Distinct())
                                                        {
                                                            //foreach (string rel_sn_kd in lst_format_nilai.Select(m => m.Rel_StrukturNilai_KD).Distinct())
                                                            //{
                                                            foreach (string rel_kp in lst_format_nilai.Select(m => m.Rel_KP).Distinct())
                                                            {

                                                                Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(rel_kp);
                                                                if (m_kp != null)
                                                                {
                                                                    if (m_kp.Nama != null)
                                                                    {

                                                                        double nilai = lst_nilai_siswa_det.Where(
                                                                            m => m.Rel_Rapor_StrukturNilai_AP.ToString().Trim().ToUpper() == m_sn_ap.Rel_StrukturNilai_AP.Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KD.ToString().Trim().ToUpper() == m_sn_ap.Rel_StrukturNilai_KD.Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == rel_kp.Trim().ToUpper() &&
                                                                                 m.Rel_Siswa.Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper()
                                                                        ).Select(m => Libs.GetStringToDouble(m.Nilai)).DefaultIfEmpty().Average();

                                                                        lst_formatnilai_nilai.Add(new FormatNilaiWithNilai
                                                                        {
                                                                            Nama_KP = m_kp.Nama,
                                                                            Nilai = nilai.ToString(),
                                                                            Rel_KP = rel_kp,
                                                                            Rel_StrukturNilai_AP = m_sn_ap.Rel_StrukturNilai_AP,
                                                                            Rel_StrukturNilai_KD = "" //rel_sn_kd
                                                                        });

                                                                    }
                                                                }

                                                            }
                                                            //}
                                                        }

                                                        //get nilai rapor                                                        
                                                        List<NilaiWithKey> lst_nilai = new List<NilaiWithKey>();
                                                        lst_nilai.Clear();
                                                        foreach (string rel_kp in lst_formatnilai_nilai.Select(m => m.Rel_KP).Distinct())
                                                        {

                                                            nilai_rapor = 0;
                                                            jumlah_nilai_rapor = 0;
                                                            count_nilai_rapor = 0;

                                                            foreach (var item_formatnilai_nilai_ap in lst_formatnilai_nilai.Select(m => new { m.Rel_StrukturNilai_AP }).Distinct())
                                                            {
                                                                List<double> lst_nilai_ = lst_formatnilai_nilai.FindAll(
                                                                            m => m.Rel_StrukturNilai_AP == item_formatnilai_nilai_ap.Rel_StrukturNilai_AP &&
                                                                                 m.Rel_StrukturNilai_KD == "" &&
                                                                                 m.Rel_KP == rel_kp
                                                                        ).Select(m => Libs.GetStringToDouble(m.Nilai)).ToList();
                                                                double nilai = lst_nilai_.DefaultIfEmpty().Average();
                                                                Rapor_StrukturNilai_AP m_rel_sn_ap = DAO_Rapor_StrukturNilai_AP.GetByID_Entity(item_formatnilai_nilai_ap.Rel_StrukturNilai_AP);
                                                                if (m_rel_sn_ap != null)
                                                                {
                                                                    if (m_rel_sn_ap.JenisPerhitungan != null)
                                                                    {

                                                                        if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                        {
                                                                            nilai_rapor += Math.Round((m_rel_sn_ap.BobotRapor / 100) * Libs.GetStringToDecimal(nilai.ToString()), 3, MidpointRounding.AwayFromZero);
                                                                        }
                                                                        else if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                        {
                                                                            jumlah_nilai_rapor += Math.Round(Libs.GetStringToDecimal(nilai.ToString()), 3, MidpointRounding.AwayFromZero);
                                                                        }
                                                                        count_nilai_rapor++;

                                                                    }
                                                                }
                                                            }

                                                            if (count_nilai_rapor > 0)
                                                            {
                                                                if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_rapor = 0;
                                                            }
                                                            nilai_rapor = Math.Round(nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                            lst_nilai.Add(new NilaiWithKey
                                                            {
                                                                Key = rel_kp,
                                                                Nilai = nilai_rapor
                                                            });
                                                        }

                                                        nilai_rapor = 0;
                                                        jumlah_nilai_rapor = 0;
                                                        count_nilai_rapor = 0;
                                                        List<Rapor_StrukturNilai_KPKelompok> lst_kpkelompok = DAO_Rapor_StrukturNilai_KPKelompok.GetAllByHeader_Entity(
                                                                m_struktur_nilai.Kode.ToString()
                                                            );
                                                        foreach (var item_nilai in lst_nilai)
                                                        {
                                                            Rapor_StrukturNilai_KPKelompok m_kpkelompok = lst_kpkelompok.FindAll(
                                                                    m => m.Rel_Rapor_KomponenPenilaian == new Guid(item_nilai.Key)
                                                                ).FirstOrDefault();
                                                            if (m_kpkelompok != null)
                                                            {
                                                                if (m_kpkelompok.Rel_Rapor_StrukturNilai != null)
                                                                {
                                                                    nilai_rapor += Math.Round((m_kpkelompok.Bobot / 100) * item_nilai.Nilai, 3, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                        }
                                                        nilai_rapor = Math.Round(nilai_rapor, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);
                                                        nilai_rapor = Math.Round((nilai_rapor + nilai_rapor_sm1) / 2, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);

                                                        jumlah_keseluruhan += nilai_rapor;
                                                        jumlah_mapel_rapor++;
                                                        lst_all_nilai_rapor.Add(new NilaiWithKey
                                                        {
                                                            Rel_Siswa = m_siswa.Kode.ToString(),
                                                            Key = jumlah_mapel_rapor.ToString(),
                                                            Nilai = nilai_rapor
                                                        });
                                                        lst_nilai_rapor.Add(new NilaiWithKey
                                                        {
                                                            Key = m_siswa.Kode.ToString(),
                                                            Nilai = nilai_rapor
                                                        });
                                                        //end get nilai rapor
                                                        //end distinct ap

                                                    }

                                                }
                                            }
                                            //end get struktur nilai

                                            html_row_body_siswa += "<td style=\"" + css_cell_body + " text-align: center; " + (nilai_rapor < m_struktur_nilai.KKM ? " font-weight: bold; color: #9C0006; background-color: #FFC7CE; " : "") + "\">" +
                                                                        Libs.GetFormatBilangan(nilai_rapor, Constantas.PEMBULATAN_DESIMAL_NILAI_SD) +
                                                                   "</td>";
                                        }

                                    }

                                    lst_jumlah_nilai_keseluruhan.Add(new NilaiWithKey
                                    {
                                        Key = m_siswa.Kode.ToString(),
                                        Nilai = jumlah_keseluruhan
                                    });

                                    //absen
                                    string s_sakit = "-";
                                    string s_izin = "-";
                                    string s_alpa = "-";
                                    string s_terlambat = "-";

                                    Rapor_Arsip m_rapor_arsip = DAO_Rapor_Arsip.GetAll_Entity().FindAll(
                                            m0 => m0.TahunAjaran == tahun_ajaran &&
                                                  m0.Semester == semester &&
                                                  m0.JenisRapor == "Semester"

                                        ).FirstOrDefault();
                                    List<DAO_SiswaAbsen.AbsenRekapRapor> lst_absen = new List<DAO_SiswaAbsen.AbsenRekapRapor>();
                                    lst_absen = DAO_SiswaAbsen.GetRekapAbsenRaporBySiswaByPeriode_Entity(
                                            m_siswa.Kode.ToString(),
                                            (m_rapor_arsip != null ? m_rapor_arsip.TanggalAwalAbsen : DateTime.MinValue),
                                            (m_rapor_arsip != null ? m_rapor_arsip.TanggalAkhirAbsen : DateTime.MinValue)
                                        );
                                    foreach (var absen in lst_absen)
                                    {
                                        if (absen.Absen == Libs.JENIS_ABSENSI.SAKIT.Substring(0, 1)) s_sakit = absen.Jumlah.ToString();
                                        if (absen.Absen == Libs.JENIS_ABSENSI.IZIN.Substring(0, 1)) s_izin = absen.Jumlah.ToString();
                                        if (absen.Absen == Libs.JENIS_ABSENSI.ALPA.Substring(0, 1)) s_alpa = absen.Jumlah.ToString();
                                        if (absen.Absen == Libs.JENIS_ABSENSI.TERLAMBAT.Substring(0, 1)) s_terlambat = absen.Jumlah.ToString();
                                    }
                                    html_row_body_siswa += "<td style=\"" + css_cell_body + " text-align: center; \">" +
                                                                s_sakit +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + " text-align: center; \">" +
                                                                s_izin +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + " text-align: center; \">" +
                                                                s_alpa +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + " text-align: center; \">" +
                                                                s_terlambat +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + " text-align: center; \">" +
                                                                Math.Round(jumlah_keseluruhan, 0).ToString() +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + " text-align: center; \">" +
                                                                Libs.GetFormatBilangan(
                                                                        (Math.Round(jumlah_keseluruhan / jumlah_mapel_rapor, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero)),
                                                                    Constantas.PEMBULATAN_DESIMAL_NILAI_SD) +
                                                           "</td>";
                                    //end absen

                                    html_row_body += "<tr>" +
                                                        html_row_body_siswa +
                                                     "</tr>";

                                    nomor++;
                                }
                                // end foreach siswa
                                string html_row_rata_rata = "<td colspan=\"4\" style=\"" + css_cell_body + " font-weight: bold;\">" +
                                                                "RATA-RATA KELAS" +
                                                            "</td>";
                                string html_row_kkm = "<td colspan=\"4\" style=\"" + css_cell_body + " font-weight: bold;\">" +
                                                            "KKM" +
                                                      "</td>";
                                for (int i = 1; i <= jumlah_mapel_rapor; i++)
                                {
                                    decimal rata_rata = Math.Round(lst_all_nilai_rapor.FindAll(m => m.Key == i.ToString() && m.Rel_Siswa.Trim().ToUpper() != KODE_NAWA).Select(m => m.Nilai).DefaultIfEmpty().Average(), Constantas.PEMBULATAN_DESIMAL_NILAI_SD);
                                    decimal kkm = 0;
                                    NilaiWithKey m_kkm = lst_kkm_nilai_rapor.FindAll(m => m.Key == i.ToString()).FirstOrDefault();
                                    if (m_kkm != null)
                                    {
                                        if (m_kkm.Key != null)
                                        {
                                            kkm = m_kkm.Nilai;
                                        }
                                    }
                                    html_row_rata_rata += "<td style=\"" + css_cell_body + " text-align: right; " + (rata_rata < kkm ? " font-weight: bold; color: #9C0006; background-color: #FFC7CE; " : "") + "\">" +
                                                                 Libs.GetFormatBilangan(rata_rata, Constantas.PEMBULATAN_DESIMAL_NILAI_SD) +
                                                          "</td>";
                                    html_row_kkm += "<td style=\"" + css_cell_body + " text-align: center; " + (rata_rata < kkm ? " font-weight: bold; color: #9C0006; background-color: #FFC7CE; " : "") + "\">" +
                                                        Libs.GetFormatBilangan(kkm, Constantas.PEMBULATAN_DESIMAL_NILAI_SD) +
                                                    "</td>";
                                }
                                for (int i = 1; i <= 6; i++)
                                {
                                    if (i <= 4)
                                    {
                                        html_row_rata_rata += "<td style=\"" + css_cell_body + " text-align: right;\">" +
                                                                    "&nbsp;" +
                                                              "</td>";
                                    }
                                    html_row_kkm += "<td style=\"" + css_cell_body + " text-align: center;\">" +
                                                        "&nbsp;" +
                                                    "</td>";
                                }
                                decimal rata_rata_nilai_keseluruhan = Math.Round(lst_jumlah_nilai_keseluruhan.Select(m => m.Nilai).DefaultIfEmpty().Average(), Constantas.PEMBULATAN_DESIMAL_NILAI_SD);
                                decimal rata_rata_nilai_rata_rata_rapor = Math.Round(lst_nilai_rapor.Select(m => m.Nilai).DefaultIfEmpty().Average(), Constantas.PEMBULATAN_DESIMAL_NILAI_SD);
                                html_row_rata_rata += "<td style=\"" + css_cell_body + " text-align: center;\">" +
                                                        Libs.GetFormatBilangan(Math.Round(rata_rata_nilai_keseluruhan, 2, MidpointRounding.AwayFromZero), 2) +
                                                      "</td>";
                                html_row_rata_rata += "<td style=\"" + css_cell_body + " text-align: center;\">" +
                                                        Libs.GetFormatBilangan(Math.Round(rata_rata_nilai_rata_rata_rapor, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero), Constantas.PEMBULATAN_DESIMAL_NILAI_SD) +
                                                      "</td>";
                                html_row_body += "<tr>" +
                                                    html_row_rata_rata +
                                                 "</tr>" +
                                                 "<tr>" +
                                                    html_row_kkm +
                                                 "</tr>";

                            }

                        }
                    }

                }
            }

            html_row_header = "<tr>" +
                                html_row_header +
                              "</tr>" +
                              "<tr>" +
                                html_row_mapel +
                              "</tr>" +
                              html_row_body;

            html = "<table style=\"border-collapse: collapse;\">" +
                        html_row_header +
                   "</table>";

            return html;
        }

        public static string GetHTMLLedger_KURTILAS_RataRata_2020(
            System.Web.UI.Page page,
            string tahun_ajaran,
            string semester,
            string rel_kelas_det,
            string rel_siswa = ""
        )
        {
            string css_cell_headers = "border-style: solid; border-width: 1px; text-align: center; font-weight: bold; padding: 5px;";
            string css_cell_body = "border-style: solid; border-width: 1px; padding: 3px;";

            string html = "";
            string html_row_header = "<td rowspan=\"3\" style=\"" + css_cell_headers + "\">" +
                                        "No" +
                                     "</td>" +
                                     "<td rowspan=\"3\" style=\"" + css_cell_headers + "\">" +
                                        "NIS" +
                                     "</td>" +
                                     "<td rowspan=\"3\" style=\"" + css_cell_headers + "\">" +
                                        "NAMA LENGKAP" +
                                     "</td>" +
                                     "<td rowspan=\"3\" style=\"" + css_cell_headers + "\">" +
                                        "L/P" +
                                     "</td>";
            string html_row_mapel = "";
            string html_row_jenis_nilai = "";
            string html_row_body = "";

            KelasDet m_kelas_det = DAO_KelasDet.GetByID_Entity(rel_kelas_det);
            if (m_kelas_det != null)
            {
                if (m_kelas_det.Nama != null)
                {

                    Kelas m_kelas = DAO_Kelas.GetByID_Entity(m_kelas_det.Rel_Kelas.ToString());
                    if (m_kelas != null)
                    {
                        if (m_kelas.Nama != null)
                        {

                            Rapor_Desain rapor_desain = DAO_Rapor_Desain.GetByTABySMByKelas_Entity(
                                    tahun_ajaran, semester, rel_kelas_det, DAO_Rapor_Desain.JenisRapor.Semester
                                ).FirstOrDefault();

                            List<Rapor_Desain_Det> lst_rapor_desain_det = DAO_Rapor_Desain_Det.GetAllByHeader_Entity(rapor_desain.Kode.ToString()).FindAll(m => m.Rel_Mapel.Trim() != "");

                            //list cols header
                            int jml_colspan_mapel = 0;
                            int jumlah_mapel = 0;
                            html_row_mapel = "";
                            foreach (Rapor_Desain_Det item_desain_det in lst_rapor_desain_det)
                            {
                                html_row_mapel += "<td colspan=\"4\" style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                    item_desain_det.NamaMapelRapor.Trim().ToUpper() +
                                                  "</td>";
                                html_row_jenis_nilai += "<td style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                                "PENGETAHUAN" +
                                                        "</td>" +
                                                        "<td style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                                "PREDIKAT" +
                                                        "</td>" +
                                                        "<td style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                                "KETERAMPILAN" +
                                                        "</td>" +
                                                        "<td style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                                "PREDIKAT" +
                                                        "</td>";
                                jumlah_mapel++;
                            }
                            jml_colspan_mapel = (jumlah_mapel * 4);

                            html_row_header += "<td colspan=\"" + jml_colspan_mapel.ToString() + "\" style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                    "NILAI MATA PELAJARAN" +
                                               "</td>";
                            html_row_header += "<td colspan=\"4\" style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                    "PRESENSI" +
                                               "</td>";
                            html_row_mapel += "<td rowspan=\"2\" style=\"" + css_cell_headers + " width: 30px; font-size: 8.5px; \">" +
                                                    "S" +
                                              "</td>" +
                                              "<td rowspan=\"2\" style=\"" + css_cell_headers + " width: 30px; font-size: 8.5px; \">" +
                                                    "I" +
                                              "</td>" +
                                              "<td rowspan=\"2\" style=\"" + css_cell_headers + " width: 30px; font-size: 8.5px; \">" +
                                                    "A" +
                                              "</td>" +
                                              "<td rowspan=\"2\" style=\"" + css_cell_headers + " width: 30px; font-size: 8.5px; \">" +
                                                    "T" +
                                              "</td>";
                            //end list cols header
                            if (rapor_desain != null)
                            {

                                List<DAO_Siswa.SiswaDataSimple> lst_siswa = DAO_Siswa.GetAllSiswaDataSimpleByTahunAjaranUnitKelas_Entity(
                                        m_kelas.Rel_Sekolah.ToString(),
                                        rel_kelas_det,
                                        tahun_ajaran,
                                        semester
                                    );
                                List<decimal> lst_nilai_ap = new List<decimal>();
                                List<decimal> lst_nilai_ap_bobot = new List<decimal>();
                                List<decimal> lst_nilai_kd = new List<decimal>();
                                List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT> lst_nilai_siswa_det = new List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT>();
                                List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT> lst_nilai_siswa_det_by_periode = new List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT>();
                                List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT> lst_nilai_siswa_det_sm1 = new List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT>();
                                List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT> lst_nilai_siswa_det_by_periode_sm1 = new List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT>();

                                lst_nilai_siswa_det_by_periode = DAO_Rapor_NilaiSiswa_Det.GetAllByTABySMByKelasDet_Entity(
                                        tahun_ajaran, semester, rel_kelas_det
                                    );
                                lst_nilai_siswa_det_by_periode_sm1 = DAO_Rapor_NilaiSiswa_Det.GetAllByTABySMByKelasDet_Entity(
                                        tahun_ajaran, "1", rel_kelas_det
                                    );

                                int id_kolom_ledger = 0;
                                int nomor = 1;
                                int jumlah_awal_col_ledger = 3;
                                int jumlah_mapel_rapor = 0;
                                if (rel_siswa.Trim() != "")
                                {
                                    lst_siswa = lst_siswa.FindAll(m0 => (rel_siswa + ";").Trim().ToUpper().IndexOf(m0.Kode.ToString().ToUpper() + ";") >= 0).ToList();
                                }
                                List<NilaiWithKey> lst_all_nilai_rapor = new List<NilaiWithKey>();
                                List<NilaiWithKey> lst_kkm_nilai_rapor = new List<NilaiWithKey>();
                                List<NilaiWithKey> lst_jumlah_nilai_keseluruhan = new List<NilaiWithKey>();
                                List<NilaiWithKey> lst_nilai_rapor = new List<NilaiWithKey>();
                                decimal jumlah_keseluruhan = 0;

                                string html_row_rata_rata = "<td colspan=\"4\" style=\"" + css_cell_body + " font-weight: bold;\">" +
                                                                "RATA-RATA KELAS" +
                                                            "</td>";
                                string html_row_kkm = "<td colspan=\"4\" style=\"" + css_cell_body + " font-weight: bold;\">" +
                                                            "KKM" +
                                                      "</td>";

                                int id_mulai_looping_rata_rata = id_kolom_ledger + 1;
                                int id_mulai_looping_kkm = jumlah_mapel_rapor + 1;

                                foreach (DAO_Siswa.SiswaDataSimple m_siswa in lst_siswa.OrderBy(m => m.Nama))
                                {
                                    jumlah_keseluruhan = 0;
                                    jumlah_mapel_rapor = 0;

                                    string html_row_body_siswa = "";
                                    html_row_body_siswa += "<td style=\"" + css_cell_body + " text-align: center;\">" +
                                                                nomor.ToString() +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + "\">" +
                                                                m_siswa.NISSekolah +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + " white-space: nowrap;\">" +
                                                                Libs.GetPerbaikiEjaanNama(m_siswa.Nama) +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + "\">" +
                                                                m_siswa.JenisKelamin +
                                                           "</td>";

                                    lst_kkm_nilai_rapor.Clear();
                                    id_kolom_ledger = jumlah_awal_col_ledger;

                                    //nilai non mulok & mulok
                                    foreach (Rapor_Desain_Det item in DAO_Rapor_Desain_Det.GetAllByHeader_Entity(rapor_desain.Kode.ToString()).FindAll(m => m.Rel_Mapel.Trim() != ""))
                                    {

                                        if (item.Rel_Mapel.Trim() != "")
                                        {

                                            lst_nilai_siswa_det = lst_nilai_siswa_det_by_periode.FindAll(
                                                    m => m.Rel_Mapel == item.Rel_Mapel &&
                                                         m.Rel_Siswa == m.Rel_Siswa
                                                );
                                            lst_nilai_siswa_det_sm1 = lst_nilai_siswa_det_by_periode_sm1.FindAll(
                                                    m => m.Rel_Mapel == item.Rel_Mapel &&
                                                         m.Rel_Siswa == m.Rel_Siswa
                                                );

                                            //get struktur nilainya
                                            Rapor_StrukturNilai m_struktur_nilai_sm1 = DAO_Rapor_StrukturNilai.GetATop1ByTABySMByKelasByMapel_Entity(
                                                    tahun_ajaran, "1", m_kelas.Kode.ToString(), item.Rel_Mapel
                                                );
                                            Rapor_StrukturNilai m_struktur_nilai = DAO_Rapor_StrukturNilai.GetATop1ByTABySMByKelasByMapel_Entity(
                                                    tahun_ajaran, semester, m_kelas.Kode.ToString(), item.Rel_Mapel
                                                );

                                            decimal nilai_rapor = 0;
                                            decimal jumlah_nilai_rapor = 0;
                                            decimal count_nilai_rapor = 0;

                                            decimal nilai_rapor_pengetahuan_sm1 = 0;
                                            decimal nilai_rapor_keterampilan_sm1 = 0;
                                            decimal nilai_rapor_pengetahuan = 0;
                                            decimal nilai_rapor_keterampilan = 0;

                                            Rapor_StrukturNilai_AP m_sn_ap = new Rapor_StrukturNilai_AP();

                                            if (m_struktur_nilai != null)
                                            {
                                                if (m_struktur_nilai.TahunAjaran != null)
                                                {

                                                    lst_kkm_nilai_rapor.Add(new NilaiWithKey
                                                    {
                                                        Key = (jumlah_mapel_rapor + 1).ToString(),
                                                        Nilai = m_struktur_nilai.KKM
                                                    });
                                                    if (!(m_struktur_nilai.IsKelompokanKP && m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString()))
                                                    {
                                                        decimal jumlah_nilai_ap = 0;
                                                        decimal nilai_ap = 0;
                                                        int count_ap = 0;
                                                        List<Rapor_StrukturNilai_AP> lst_rapor_struktur_nilai_ap = new List<Rapor_StrukturNilai_AP>();
                                                        List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = new List<Rapor_StrukturNilai_KD>();

                                                        //jika semester 2 get semester 1
                                                        if (semester == "2")
                                                        {
                                                            lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeaderByJenisAspekPenilaian_Entity(
                                                                m_struktur_nilai_sm1.Kode.ToString(), DAO_Rapor_StrukturNilai_AP.JenisAspekPenilaian.Pengetahuan
                                                            );
                                                            lst_nilai_ap.Clear();
                                                            lst_nilai_ap_bobot.Clear();
                                                            jumlah_nilai_ap = 0;
                                                            nilai_ap = 0;
                                                            count_ap = 0;
                                                            m_sn_ap = new Rapor_StrukturNilai_AP();
                                                            foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                            {

                                                                //get struktur nilai det KD
                                                                lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                        item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                    );
                                                                lst_nilai_kd.Clear();
                                                                foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                                {

                                                                    //get struktur nilai det KP
                                                                    List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                        item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                    );
                                                                    decimal jumlah_nilai_kd = 0;
                                                                    decimal nilai_kd = 0;
                                                                    int count_kd = 0;
                                                                    foreach (var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp)
                                                                    {
                                                                        Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString());
                                                                        if (m_kp != null)
                                                                        {

                                                                            Rapor_NilaiSiswa_Det m_nilai_det = lst_nilai_siswa_det_sm1.FindAll(
                                                                                m => m.Rel_Siswa.ToString().Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                     m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai_sm1.Rel_Mapel.ToString().Trim().ToUpper() &&
                                                                                     m.Rel_Rapor_StrukturNilai_AP.Trim().ToUpper() == item_rapor_struktur_nilai_ap.Kode.ToString().ToUpper() &&
                                                                                     m.Rel_Rapor_StrukturNilai_KD.Trim().ToUpper() == item_rapor_struktur_nilai_kd.Kode.ToString().ToUpper() &&
                                                                                     m.Rel_Rapor_StrukturNilai_KP.Trim().ToUpper() == item_rapor_struktur_nilai_kp.Kode.ToString().ToUpper()
                                                                            ).FirstOrDefault();

                                                                            if (m_nilai_det != null)
                                                                            {
                                                                                if (m_nilai_det.Nilai.Trim() != "")
                                                                                {
                                                                                    if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                                    {
                                                                                        nilai_kd += Math.Round((item_rapor_struktur_nilai_kp.BobotNK / 100) * Libs.GetStringToDecimal(m_nilai_det.Nilai), 2, MidpointRounding.AwayFromZero);
                                                                                    }
                                                                                    else if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                                    {
                                                                                        jumlah_nilai_kd += Libs.GetStringToDecimal(m_nilai_det.Nilai);
                                                                                    }
                                                                                    count_kd++;
                                                                                }
                                                                            }

                                                                        }

                                                                    }

                                                                    if (count_kd > 0)
                                                                    {
                                                                        if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                        {
                                                                            nilai_kd = Math.Round(jumlah_nilai_kd / count_kd, 2, MidpointRounding.AwayFromZero);
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        nilai_kd = 0;
                                                                    }

                                                                    //load nilai manual
                                                                    Rapor_NilaiSiswa_AP_or_KD m_nilai_manual = DAO_Rapor_NilaiSiswa_AP_or_KD.GetAllByTABySMByKelasByMapelBySiswaByStruktur_Entity(
                                                                            tahun_ajaran, m_struktur_nilai_sm1.Semester, rel_kelas_det, m_siswa.Kode.ToString(), item.Rel_Mapel,
                                                                            item_rapor_struktur_nilai_kd.Kode.ToString().Trim().ToUpper()

                                                                        ).FirstOrDefault();
                                                                    if (m_nilai_manual != null)
                                                                    {
                                                                        if (m_nilai_manual.Nilai != null)
                                                                        {
                                                                            nilai_kd = Libs.GetStringToDecimal(m_nilai_manual.Nilai);
                                                                        }
                                                                    }
                                                                    //end load nilai manual

                                                                    nilai_kd = Math.Round(nilai_kd, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);
                                                                    lst_nilai_kd.Add(nilai_kd);
                                                                    //end get struktur nilai det KP

                                                                }
                                                                //end get struktur nilai det KD

                                                                //get nilai ap
                                                                count_ap = 0;
                                                                nilai_ap = 0;
                                                                jumlah_nilai_ap = 0;
                                                                foreach (var item_nilai_kd in lst_nilai_kd)
                                                                {
                                                                    if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                    {
                                                                        nilai_ap += Math.Round((item_rapor_struktur_nilai_ap.BobotRapor / 100) * item_nilai_kd, 2, MidpointRounding.AwayFromZero);
                                                                    }
                                                                    else if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                    {
                                                                        jumlah_nilai_ap += item_nilai_kd;
                                                                    }
                                                                    count_ap++;
                                                                }
                                                                if (count_ap > 0)
                                                                {
                                                                    if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                    {
                                                                        nilai_ap = Math.Round(jumlah_nilai_ap / count_ap, 2, MidpointRounding.AwayFromZero);
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    nilai_ap = 0;
                                                                }
                                                                nilai_ap = Math.Round(nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                                lst_nilai_ap.Add(nilai_ap);
                                                                lst_nilai_ap_bobot.Add(item_rapor_struktur_nilai_ap.BobotRapor);
                                                                //end get nilai ap

                                                            }
                                                            //end get struktur nilai det AP

                                                            //get nilai rapor
                                                            nilai_rapor = 0;
                                                            jumlah_nilai_rapor = 0;
                                                            count_nilai_rapor = 0;
                                                            foreach (var item_nilai_ap in lst_nilai_ap)
                                                            {
                                                                if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                {
                                                                    nilai_rapor += Math.Round((lst_nilai_ap_bobot[Convert.ToInt16(count_nilai_rapor)] / 100) * item_nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                                else if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    jumlah_nilai_rapor += item_nilai_ap;
                                                                }
                                                                count_nilai_rapor++;
                                                            }
                                                            if (count_nilai_rapor > 0)
                                                            {
                                                                if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_rapor = 0;
                                                            }
                                                            nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);
                                                            nilai_rapor_pengetahuan_sm1 = nilai_rapor;
                                                        }
                                                        //end jika semester 2 get semester 1

                                                        //-----------nilai pengetahuan---------------
                                                        id_kolom_ledger++;
                                                        //get struktur nilai det AP
                                                        lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeaderByJenisAspekPenilaian_Entity(
                                                                m_struktur_nilai.Kode.ToString(), DAO_Rapor_StrukturNilai_AP.JenisAspekPenilaian.Pengetahuan
                                                            );
                                                        lst_nilai_ap.Clear();
                                                        lst_nilai_ap_bobot.Clear();
                                                        jumlah_nilai_ap = 0;
                                                        nilai_ap = 0;
                                                        count_ap = 0;
                                                        m_sn_ap = new Rapor_StrukturNilai_AP();
                                                        foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                        {

                                                            //get struktur nilai det KD
                                                            lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                );
                                                            lst_nilai_kd.Clear();
                                                            foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                            {

                                                                //get struktur nilai det KP
                                                                List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                );
                                                                decimal jumlah_nilai_kd = 0;
                                                                decimal nilai_kd = 0;
                                                                int count_kd = 0;
                                                                foreach (var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp)
                                                                {
                                                                    Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString());
                                                                    if (m_kp != null)
                                                                    {

                                                                        Rapor_NilaiSiswa_Det m_nilai_det = lst_nilai_siswa_det.FindAll(
                                                                            m => m.Rel_Siswa.ToString().Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_AP.Trim().ToUpper() == item_rapor_struktur_nilai_ap.Kode.ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KD.Trim().ToUpper() == item_rapor_struktur_nilai_kd.Kode.ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KP.Trim().ToUpper() == item_rapor_struktur_nilai_kp.Kode.ToString().ToUpper()
                                                                        ).FirstOrDefault();

                                                                        if (m_nilai_det != null)
                                                                        {
                                                                            if (m_nilai_det.Nilai.Trim() != "")
                                                                            {
                                                                                if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                                {
                                                                                    nilai_kd += Math.Round((item_rapor_struktur_nilai_kp.BobotNK / 100) * Libs.GetStringToDecimal(m_nilai_det.Nilai), 2, MidpointRounding.AwayFromZero);
                                                                                }
                                                                                else if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                                {
                                                                                    jumlah_nilai_kd += Libs.GetStringToDecimal(m_nilai_det.Nilai);
                                                                                }
                                                                                count_kd++;
                                                                            }
                                                                        }

                                                                    }

                                                                }

                                                                if (count_kd > 0)
                                                                {
                                                                    if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                    {
                                                                        nilai_kd = Math.Round(jumlah_nilai_kd / count_kd, 2, MidpointRounding.AwayFromZero);
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    nilai_kd = 0;
                                                                }

                                                                //load nilai manual
                                                                Rapor_NilaiSiswa_AP_or_KD m_nilai_manual = DAO_Rapor_NilaiSiswa_AP_or_KD.GetAllByTABySMByKelasByMapelBySiswaByStruktur_Entity(
                                                                        tahun_ajaran, semester, rel_kelas_det, m_siswa.Kode.ToString(), item.Rel_Mapel,
                                                                        item_rapor_struktur_nilai_kd.Kode.ToString().Trim().ToUpper()

                                                                    ).FirstOrDefault();
                                                                if (m_nilai_manual != null)
                                                                {
                                                                    if (m_nilai_manual.Nilai != null)
                                                                    {
                                                                        nilai_kd = Libs.GetStringToDecimal(m_nilai_manual.Nilai);
                                                                    }
                                                                }
                                                                //end load nilai manual

                                                                nilai_kd = Math.Round(nilai_kd, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);
                                                                lst_nilai_kd.Add(nilai_kd);
                                                                //end get struktur nilai det KP

                                                            }
                                                            //end get struktur nilai det KD

                                                            //get nilai ap
                                                            count_ap = 0;
                                                            nilai_ap = 0;
                                                            jumlah_nilai_ap = 0;
                                                            foreach (var item_nilai_kd in lst_nilai_kd)
                                                            {
                                                                if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                {
                                                                    nilai_ap += Math.Round((item_rapor_struktur_nilai_ap.BobotRapor / 100) * item_nilai_kd, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                                else if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    jumlah_nilai_ap += item_nilai_kd;
                                                                }
                                                                count_ap++;
                                                            }
                                                            if (count_ap > 0)
                                                            {
                                                                if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_ap = Math.Round(jumlah_nilai_ap / count_ap, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_ap = 0;
                                                            }
                                                            nilai_ap = Math.Round(nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                            lst_nilai_ap.Add(nilai_ap);
                                                            //end get nilai ap

                                                            m_sn_ap = item_rapor_struktur_nilai_ap;
                                                        }
                                                        //end get struktur nilai det AP

                                                        //get nilai rapor
                                                        nilai_rapor = 0;
                                                        jumlah_nilai_rapor = 0;
                                                        count_nilai_rapor = 0;
                                                        foreach (var item_nilai_ap in lst_nilai_ap)
                                                        {
                                                            if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                            {
                                                                nilai_rapor += Math.Round((lst_nilai_ap_bobot[Convert.ToInt16(count_nilai_rapor)] / 100) * item_nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                            }
                                                            else if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                jumlah_nilai_rapor += item_nilai_ap;
                                                            }
                                                            count_nilai_rapor++;
                                                        }
                                                        if (count_nilai_rapor > 0)
                                                        {
                                                            if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            nilai_rapor = 0;
                                                        }
                                                        nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);

                                                        //jika ada PAT atau UKK
                                                        if (m_sn_ap.IsAdaPAT_UKK)
                                                        {
                                                            Rapor_NilaiSiswa_Det m_nilai_det = lst_nilai_siswa_det.FindAll(
                                                                            m => m.Rel_Siswa.ToString().Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_AP.Trim().ToUpper() == (Constantas.SD.GetKode_NK_KD_UKKPAT(m_sn_ap.Kode.ToString())).ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KD.Trim().ToUpper() == (Constantas.SD.GetKode_NK_KD_UKKPAT(m_sn_ap.Kode.ToString())).ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KP.Trim().ToUpper() == (Constantas.SD.GetKode_NK_KD_UKKPAT(m_sn_ap.Kode.ToString())).ToString().ToUpper()
                                                                        ).FirstOrDefault();

                                                            string s_nilai_pat_ukk = "0";
                                                            if (m_nilai_det != null)
                                                            {
                                                                if (m_nilai_det.Nilai.Trim() != "")
                                                                {
                                                                    s_nilai_pat_ukk = m_nilai_det.Nilai;
                                                                }
                                                            }

                                                            nilai_rapor = Math.Round(
                                                                            Libs.GetStringToDecimal(s_nilai_pat_ukk) * (m_sn_ap.Bobot_PAT_UKK / 100), 2
                                                                          ) +
                                                                            Math.Round(
                                                                            nilai_rapor * (m_sn_ap.Bobot_Non_PAT_UKK / 100), 2
                                                                          );

                                                            nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);
                                                        }
                                                        //jika ada PAT atau UKK

                                                        nilai_rapor_pengetahuan = Math.Round((nilai_rapor + nilai_rapor_pengetahuan_sm1) / 2, 0, MidpointRounding.AwayFromZero);
                                                        lst_all_nilai_rapor.Add(new NilaiWithKey
                                                        {
                                                            Key = (id_kolom_ledger).ToString(),
                                                            Nilai = nilai_rapor_pengetahuan
                                                        });
                                                        id_kolom_ledger += 2;
                                                        //end get nilai rapor
                                                        //-----------end nilai pengetahuan---------------

                                                        //-----------nilai keterampilan---------------
                                                        if (semester == "2")
                                                        {
                                                            lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeaderByJenisAspekPenilaian_Entity(
                                                                m_struktur_nilai_sm1.Kode.ToString(), DAO_Rapor_StrukturNilai_AP.JenisAspekPenilaian.Keterampilan
                                                            );
                                                            lst_nilai_ap.Clear();
                                                            lst_nilai_ap_bobot.Clear();
                                                            jumlah_nilai_ap = 0;
                                                            nilai_ap = 0;
                                                            count_ap = 0;
                                                            m_sn_ap = new Rapor_StrukturNilai_AP();
                                                            foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                            {

                                                                //get struktur nilai det KD
                                                                lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                        item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                    );
                                                                lst_nilai_kd.Clear();
                                                                foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                                {

                                                                    //get struktur nilai det KP
                                                                    List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                        item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                    );
                                                                    decimal jumlah_nilai_kd = 0;
                                                                    decimal nilai_kd = 0;
                                                                    int count_kd = 0;
                                                                    foreach (var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp)
                                                                    {
                                                                        Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString());
                                                                        if (m_kp != null)
                                                                        {

                                                                            Rapor_NilaiSiswa_Det m_nilai_det = lst_nilai_siswa_det_sm1.FindAll(
                                                                                m => m.Rel_Siswa.ToString().Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                     m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai_sm1.Rel_Mapel.ToString().Trim().ToUpper() &&
                                                                                     m.Rel_Rapor_StrukturNilai_AP.Trim().ToUpper() == item_rapor_struktur_nilai_ap.Kode.ToString().ToUpper() &&
                                                                                     m.Rel_Rapor_StrukturNilai_KD.Trim().ToUpper() == item_rapor_struktur_nilai_kd.Kode.ToString().ToUpper() &&
                                                                                     m.Rel_Rapor_StrukturNilai_KP.Trim().ToUpper() == item_rapor_struktur_nilai_kp.Kode.ToString().ToUpper()
                                                                            ).FirstOrDefault();

                                                                            if (m_nilai_det != null)
                                                                            {
                                                                                if (m_nilai_det.Nilai.Trim() != "")
                                                                                {
                                                                                    if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                                    {
                                                                                        nilai_kd += Math.Round((item_rapor_struktur_nilai_kp.BobotNK / 100) * Libs.GetStringToDecimal(m_nilai_det.Nilai), 2, MidpointRounding.AwayFromZero);
                                                                                    }
                                                                                    else if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                                    {
                                                                                        jumlah_nilai_kd += Libs.GetStringToDecimal(m_nilai_det.Nilai);
                                                                                    }
                                                                                    count_kd++;
                                                                                }
                                                                            }

                                                                        }

                                                                    }

                                                                    if (count_kd > 0)
                                                                    {
                                                                        if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                        {
                                                                            nilai_kd = Math.Round(jumlah_nilai_kd / count_kd, 2, MidpointRounding.AwayFromZero);
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        nilai_kd = 0;
                                                                    }

                                                                    //load nilai manual
                                                                    Rapor_NilaiSiswa_AP_or_KD m_nilai_manual = DAO_Rapor_NilaiSiswa_AP_or_KD.GetAllByTABySMByKelasByMapelBySiswaByStruktur_Entity(
                                                                            tahun_ajaran, semester, rel_kelas_det, m_siswa.Kode.ToString(), item.Rel_Mapel,
                                                                            item_rapor_struktur_nilai_kd.Kode.ToString().Trim().ToUpper()

                                                                        ).FirstOrDefault();
                                                                    if (m_nilai_manual != null)
                                                                    {
                                                                        if (m_nilai_manual.Nilai != null)
                                                                        {
                                                                            nilai_kd = Libs.GetStringToDecimal(m_nilai_manual.Nilai);
                                                                        }
                                                                    }
                                                                    //end load nilai manual

                                                                    nilai_kd = Math.Round(nilai_kd, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);
                                                                    lst_nilai_kd.Add(nilai_kd);
                                                                    //end get struktur nilai det KP

                                                                }
                                                                //end get struktur nilai det KD

                                                                //get nilai ap
                                                                count_ap = 0;
                                                                nilai_ap = 0;
                                                                jumlah_nilai_ap = 0;
                                                                foreach (var item_nilai_kd in lst_nilai_kd)
                                                                {
                                                                    if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                    {
                                                                        nilai_ap += Math.Round((item_rapor_struktur_nilai_ap.BobotRapor / 100) * item_nilai_kd, 2, MidpointRounding.AwayFromZero);
                                                                    }
                                                                    else if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                    {
                                                                        jumlah_nilai_ap += item_nilai_kd;
                                                                    }
                                                                    count_ap++;
                                                                }
                                                                if (count_ap > 0)
                                                                {
                                                                    if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                    {
                                                                        nilai_ap = Math.Round(jumlah_nilai_ap / count_ap, 2, MidpointRounding.AwayFromZero);
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    nilai_ap = 0;
                                                                }
                                                                nilai_ap = Math.Round(nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                                lst_nilai_ap.Add(nilai_ap);
                                                                lst_nilai_ap_bobot.Add(item_rapor_struktur_nilai_ap.BobotRapor);
                                                                //end get nilai ap

                                                            }
                                                            //end get struktur nilai det AP

                                                            //get nilai rapor
                                                            nilai_rapor = 0;
                                                            jumlah_nilai_rapor = 0;
                                                            count_nilai_rapor = 0;
                                                            foreach (var item_nilai_ap in lst_nilai_ap)
                                                            {
                                                                if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                {
                                                                    nilai_rapor += Math.Round((lst_nilai_ap_bobot[Convert.ToInt16(count_nilai_rapor)] / 100) * item_nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                                else if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    jumlah_nilai_rapor += item_nilai_ap;
                                                                }
                                                                count_nilai_rapor++;
                                                            }
                                                            if (count_nilai_rapor > 0)
                                                            {
                                                                if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_rapor = 0;
                                                            }
                                                            nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);
                                                            nilai_rapor_keterampilan_sm1 = nilai_rapor;
                                                        }
                                                        //end jika semester 2 get semester 1

                                                        //get struktur nilai det AP
                                                        lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeaderByJenisAspekPenilaian_Entity(
                                                                m_struktur_nilai.Kode.ToString(), DAO_Rapor_StrukturNilai_AP.JenisAspekPenilaian.Keterampilan
                                                            );
                                                        lst_nilai_ap.Clear();
                                                        lst_nilai_ap_bobot.Clear();
                                                        jumlah_nilai_ap = 0;
                                                        nilai_ap = 0;
                                                        count_ap = 0;
                                                        foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                        {

                                                            //get struktur nilai det KD
                                                            lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                );
                                                            lst_nilai_kd.Clear();
                                                            foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                            {

                                                                //get struktur nilai det KP
                                                                List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                );
                                                                decimal jumlah_nilai_kd = 0;
                                                                decimal nilai_kd = 0;
                                                                int count_kd = 0;
                                                                foreach (var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp)
                                                                {
                                                                    Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString());
                                                                    if (m_kp != null)
                                                                    {

                                                                        Rapor_NilaiSiswa_Det m_nilai_det = lst_nilai_siswa_det.FindAll(
                                                                            m => m.Rel_Siswa.ToString().Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_AP.Trim().ToUpper() == item_rapor_struktur_nilai_ap.Kode.ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KD.Trim().ToUpper() == item_rapor_struktur_nilai_kd.Kode.ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KP.Trim().ToUpper() == item_rapor_struktur_nilai_kp.Kode.ToString().ToUpper()
                                                                        ).FirstOrDefault();

                                                                        if (m_nilai_det != null)
                                                                        {
                                                                            if (m_nilai_det.Nilai.Trim() != "")
                                                                            {
                                                                                if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                                {
                                                                                    nilai_kd += Math.Round((item_rapor_struktur_nilai_kp.BobotNK / 100) * Libs.GetStringToDecimal(m_nilai_det.Nilai), 2, MidpointRounding.AwayFromZero);
                                                                                }
                                                                                else if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                                {
                                                                                    jumlah_nilai_kd += Libs.GetStringToDecimal(m_nilai_det.Nilai);
                                                                                }
                                                                                count_kd++;
                                                                            }
                                                                        }

                                                                    }

                                                                }

                                                                if (count_kd > 0)
                                                                {
                                                                    if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                    {
                                                                        nilai_kd = Math.Round(jumlah_nilai_kd / count_kd, 2, MidpointRounding.AwayFromZero);
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    nilai_kd = 0;
                                                                }

                                                                //load nilai manual
                                                                Rapor_NilaiSiswa_AP_or_KD m_nilai_manual = DAO_Rapor_NilaiSiswa_AP_or_KD.GetAllByTABySMByKelasByMapelBySiswaByStruktur_Entity(
                                                                        tahun_ajaran, semester, rel_kelas_det, m_siswa.Kode.ToString(), item.Rel_Mapel,
                                                                        item_rapor_struktur_nilai_kd.Kode.ToString().Trim().ToUpper()

                                                                    ).FirstOrDefault();
                                                                if (m_nilai_manual != null)
                                                                {
                                                                    if (m_nilai_manual.Nilai != null)
                                                                    {
                                                                        nilai_kd = Libs.GetStringToDecimal(m_nilai_manual.Nilai);
                                                                    }
                                                                }
                                                                //end load nilai manual

                                                                nilai_kd = Math.Round(nilai_kd, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);
                                                                lst_nilai_kd.Add(nilai_kd);
                                                                //end get struktur nilai det KP

                                                            }
                                                            //end get struktur nilai det KD

                                                            //get nilai ap
                                                            count_ap = 0;
                                                            nilai_ap = 0;
                                                            jumlah_nilai_ap = 0;
                                                            foreach (var item_nilai_kd in lst_nilai_kd)
                                                            {
                                                                if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                {
                                                                    nilai_ap += Math.Round((item_rapor_struktur_nilai_ap.BobotRapor / 100) * item_nilai_kd, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                                else if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    jumlah_nilai_ap += item_nilai_kd;
                                                                }
                                                                count_ap++;
                                                            }
                                                            if (count_ap > 0)
                                                            {
                                                                if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_ap = Math.Round(jumlah_nilai_ap / count_ap, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_ap = 0;
                                                            }
                                                            nilai_ap = Math.Round(nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                            lst_nilai_ap.Add(nilai_ap);
                                                            lst_nilai_ap_bobot.Add(item_rapor_struktur_nilai_ap.BobotRapor);
                                                            //end get nilai ap
                                                            //-----------end nilai keterampilan---------------

                                                        }
                                                        //end get struktur nilai det AP

                                                        //get nilai rapor
                                                        nilai_rapor = 0;
                                                        jumlah_nilai_rapor = 0;
                                                        count_nilai_rapor = 0;
                                                        foreach (var item_nilai_ap in lst_nilai_ap)
                                                        {
                                                            if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                            {
                                                                nilai_rapor += Math.Round((lst_nilai_ap_bobot[Convert.ToInt16(count_nilai_rapor)] / 100) * item_nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                            }
                                                            else if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                jumlah_nilai_rapor += item_nilai_ap;
                                                            }
                                                            count_nilai_rapor++;
                                                        }
                                                        if (count_nilai_rapor > 0)
                                                        {
                                                            if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            nilai_rapor = 0;
                                                        }
                                                        nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);
                                                        nilai_rapor_keterampilan = Math.Round((nilai_rapor + nilai_rapor_keterampilan_sm1) / 2, 0, MidpointRounding.AwayFromZero);
                                                        lst_all_nilai_rapor.Add(new NilaiWithKey
                                                        {
                                                            Key = (id_kolom_ledger).ToString(),
                                                            Nilai = nilai_rapor_keterampilan
                                                        });
                                                        id_kolom_ledger++;
                                                        //end get nilai rapor
                                                    }
                                                    else
                                                    {
                                                        id_kolom_ledger++;
                                                        List<FormatNilai> lst_format_nilai = new List<FormatNilai>();
                                                        List<Rapor_StrukturNilai_AP> lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeader_Entity(
                                                                m_struktur_nilai.Kode.ToString()
                                                            );
                                                        foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                        {

                                                            List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                );

                                                            foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                            {

                                                                List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                );
                                                                foreach (
                                                                    var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp.FindAll(
                                                                        m => (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == DAO_Rapor_StrukturNilai.Arr_KP_Quran[0]) ||
                                                                             (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == DAO_Rapor_StrukturNilai.Arr_KP_Quran[1]) ||
                                                                             (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == DAO_Rapor_StrukturNilai.Arr_KP_Quran[2])
                                                                        )
                                                                )
                                                                {

                                                                    if (
                                                                        lst_format_nilai.FindAll(
                                                                                m => m.Rel_StrukturNilai_AP == item_rapor_struktur_nilai_ap.Kode.ToString() &&
                                                                                     m.Rel_KP == item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                            ).Count == 0
                                                                    )
                                                                    {
                                                                        lst_format_nilai.Add(new FormatNilai
                                                                        {
                                                                            Rel_StrukturNilai_AP = item_rapor_struktur_nilai_ap.Kode.ToString(),
                                                                            Rel_KP = item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                        });
                                                                    }

                                                                }
                                                            }

                                                        }

                                                        List<FormatNilai> lst_format_nilai2 = new List<FormatNilai>();
                                                        foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                        {

                                                            List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                );

                                                            foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                            {

                                                                List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                );
                                                                foreach (
                                                                    var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp.FindAll(
                                                                        m => (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() != DAO_Rapor_StrukturNilai.Arr_KP_Quran[0]) &&
                                                                             (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() != DAO_Rapor_StrukturNilai.Arr_KP_Quran[1]) &&
                                                                             (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() != DAO_Rapor_StrukturNilai.Arr_KP_Quran[2])
                                                                        )
                                                                )
                                                                {

                                                                    if (
                                                                        lst_format_nilai2.FindAll(
                                                                                m => m.Rel_StrukturNilai_AP == item_rapor_struktur_nilai_ap.Kode.ToString() &&
                                                                                     m.Rel_KP == item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                            ).Count == 0
                                                                    )
                                                                    {
                                                                        lst_format_nilai2.Add(new FormatNilai
                                                                        {
                                                                            Rel_StrukturNilai_AP = item_rapor_struktur_nilai_ap.Kode.ToString(),
                                                                            Rel_KP = item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                        });
                                                                    }

                                                                }
                                                            }

                                                        }

                                                        List<FormatNilaiWithNilai> lst_formatnilai_nilai = new List<FormatNilaiWithNilai>();
                                                        //distinct ap
                                                        foreach (string rel_sn_ap in lst_format_nilai.Select(m => m.Rel_StrukturNilai_AP).Distinct())
                                                        {
                                                            foreach (string rel_kp in lst_format_nilai.Select(m => m.Rel_KP).Distinct())
                                                            {

                                                                Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(rel_kp);
                                                                if (m_kp != null)
                                                                {
                                                                    if (m_kp.Nama != null)
                                                                    {

                                                                        double nilai = lst_nilai_siswa_det.Where(
                                                                            m => m.Rel_Rapor_StrukturNilai_AP.ToString().Trim().ToUpper() == rel_sn_ap.Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == rel_kp.Trim().ToUpper() &&
                                                                                 m.Rel_Siswa.Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper()
                                                                        ).Select(m => Libs.GetStringToDouble(m.Nilai)).DefaultIfEmpty().Average();

                                                                        lst_formatnilai_nilai.Add(new FormatNilaiWithNilai
                                                                        {
                                                                            Nama_KP = m_kp.Nama,
                                                                            Nilai = nilai.ToString(),
                                                                            Rel_KP = rel_kp,
                                                                            Rel_StrukturNilai_AP = rel_sn_ap
                                                                        });

                                                                    }
                                                                }

                                                            }
                                                        }

                                                        List<FormatNilaiWithNilai> lst_formatnilai_nilai2 = new List<FormatNilaiWithNilai>();
                                                        //distinct ap
                                                        foreach (string rel_sn_ap in lst_format_nilai2.Select(m => m.Rel_StrukturNilai_AP).Distinct())
                                                        {
                                                            foreach (string rel_kp in lst_format_nilai2.Select(m => m.Rel_KP).Distinct())
                                                            {

                                                                Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(rel_kp);
                                                                if (m_kp != null)
                                                                {
                                                                    if (m_kp.Nama != null)
                                                                    {

                                                                        double nilai = lst_nilai_siswa_det.Where(
                                                                            m => m.Rel_Rapor_StrukturNilai_AP.ToString().Trim().ToUpper() == rel_sn_ap.Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == rel_kp.Trim().ToUpper() &&
                                                                                 m.Rel_Siswa.Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper()
                                                                        ).Select(m => Libs.GetStringToDouble(m.Nilai)).DefaultIfEmpty().Average();

                                                                        lst_formatnilai_nilai2.Add(new FormatNilaiWithNilai
                                                                        {
                                                                            Nama_KP = m_kp.Nama,
                                                                            Nilai = nilai.ToString(),
                                                                            Rel_KP = rel_kp,
                                                                            Rel_StrukturNilai_AP = rel_sn_ap
                                                                        });

                                                                    }
                                                                }

                                                            }
                                                        }

                                                        //get nilai rapor                                                        
                                                        List<NilaiWithKey> lst_nilai = new List<NilaiWithKey>();
                                                        lst_nilai.Clear();
                                                        foreach (string rel_kp in lst_formatnilai_nilai.Select(m => m.Rel_KP).Distinct())
                                                        {

                                                            nilai_rapor = 0;
                                                            jumlah_nilai_rapor = 0;
                                                            count_nilai_rapor = 0;
                                                            foreach (var m_formatnilai_nilai in lst_formatnilai_nilai.FindAll(m => m.Rel_KP == rel_kp))
                                                            {
                                                                Rapor_StrukturNilai_AP m_rel_sn_ap = DAO_Rapor_StrukturNilai_AP.GetByID_Entity(m_formatnilai_nilai.Rel_StrukturNilai_AP);
                                                                if (m_rel_sn_ap != null)
                                                                {
                                                                    if (m_rel_sn_ap.JenisPerhitungan != null)
                                                                    {

                                                                        if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                        {
                                                                            nilai_rapor += Math.Round((m_rel_sn_ap.BobotRapor / 100) * Libs.GetStringToDecimal(m_formatnilai_nilai.Nilai), 3, MidpointRounding.AwayFromZero);
                                                                        }
                                                                        else if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                        {
                                                                            jumlah_nilai_rapor += m_rel_sn_ap.BobotRapor;
                                                                        }
                                                                        count_nilai_rapor++;

                                                                    }
                                                                }
                                                            }

                                                            if (count_nilai_rapor > 0)
                                                            {
                                                                if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_rapor = 0;
                                                            }
                                                            nilai_rapor = Math.Round(nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                            lst_nilai.Add(new NilaiWithKey
                                                            {
                                                                Key = rel_kp,
                                                                Nilai = nilai_rapor
                                                            });
                                                        }

                                                        nilai_rapor = 0;
                                                        jumlah_nilai_rapor = 0;
                                                        count_nilai_rapor = 0;
                                                        List<Rapor_StrukturNilai_KPKelompok> lst_kpkelompok = DAO_Rapor_StrukturNilai_KPKelompok.GetAllByHeader_Entity(
                                                                m_struktur_nilai.Kode.ToString()
                                                            );
                                                        foreach (var item_nilai in lst_nilai)
                                                        {
                                                            Rapor_StrukturNilai_KPKelompok m_kpkelompok = lst_kpkelompok.FindAll(
                                                                    m => m.Rel_Rapor_KomponenPenilaian == new Guid(item_nilai.Key)
                                                                ).FirstOrDefault();
                                                            if (m_kpkelompok != null)
                                                            {
                                                                if (m_kpkelompok.Rel_Rapor_StrukturNilai != null)
                                                                {
                                                                    nilai_rapor += Math.Round((m_kpkelompok.Bobot / 100) * item_nilai.Nilai, 3, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                        }

                                                        decimal nilai_non_q = 0;
                                                        if (lst_formatnilai_nilai2.Count > 0)
                                                        {
                                                            nilai_non_q = lst_formatnilai_nilai2.Select(m => Libs.GetStringToDecimal(m.Nilai)).DefaultIfEmpty().Average();
                                                        }
                                                        if (nilai_non_q > 0)
                                                        {
                                                            nilai_rapor = Math.Round((nilai_rapor + nilai_non_q) / 2, 3, MidpointRounding.AwayFromZero);
                                                        }
                                                        nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);
                                                        nilai_rapor_pengetahuan = nilai_rapor;
                                                        jumlah_keseluruhan += nilai_rapor;
                                                        jumlah_mapel_rapor++;
                                                        lst_all_nilai_rapor.Add(new NilaiWithKey
                                                        {
                                                            Key = (id_kolom_ledger).ToString(),
                                                            Nilai = nilai_rapor_pengetahuan
                                                        });
                                                        //end get nilai rapor
                                                        //end distinct ap
                                                        id_kolom_ledger++;
                                                    }

                                                    jumlah_mapel_rapor++;
                                                }
                                            }
                                            //end get struktur nilai

                                            html_row_body_siswa += "<td style=\"" + css_cell_body + " text-align: center; " + (nilai_rapor_pengetahuan < m_struktur_nilai.KKM ? " font-weight: bold; color: #9C0006; background-color: #FFC7CE; " : "") + "\">" +
                                                                        nilai_rapor_pengetahuan.ToString() +
                                                                   "</td>" +
                                                                   "<td style=\"" + css_cell_body + " text-align: center; " + (nilai_rapor_pengetahuan < m_struktur_nilai.KKM ? " font-weight: bold; color: #9C0006; background-color: #FFC7CE; " : "") + "\">" +
                                                                        GetPredikatRapor(nilai_rapor_pengetahuan) +
                                                                   "</td>";
                                            html_row_body_siswa += "<td style=\"" + css_cell_body + " text-align: center; " + (nilai_rapor_keterampilan < m_struktur_nilai.KKM ? " font-weight: bold; color: #9C0006; background-color: #FFC7CE; " : "") + "\">" +
                                                                        nilai_rapor_keterampilan.ToString() +
                                                                   "</td>" +
                                                                   "<td style=\"" + css_cell_body + " text-align: center; " + (nilai_rapor_keterampilan < m_struktur_nilai.KKM ? " font-weight: bold; color: #9C0006; background-color: #FFC7CE; " : "") + "\">" +
                                                                        GetPredikatRapor(nilai_rapor_keterampilan) +
                                                                   "</td>";
                                        }

                                    }
                                    //end rapor non mulok

                                    id_mulai_looping_rata_rata = id_kolom_ledger + 1;
                                    id_mulai_looping_kkm = jumlah_mapel_rapor + 1;
                                    
                                    lst_jumlah_nilai_keseluruhan.Add(new NilaiWithKey
                                    {
                                        Key = m_siswa.Kode.ToString(),
                                        Nilai = jumlah_keseluruhan
                                    });

                                    //absen
                                    string s_sakit = "-";
                                    string s_izin = "-";
                                    string s_alpa = "-";
                                    string s_terlambat = "-";

                                    Rapor_Arsip m_rapor_arsip = DAO_Rapor_Arsip.GetAll_Entity().FindAll(
                                            m0 => m0.TahunAjaran == tahun_ajaran &&
                                                  m0.Semester == semester &&
                                                  m0.JenisRapor == "Semester"

                                        ).FirstOrDefault();
                                    List<DAO_SiswaAbsen.AbsenRekapRapor> lst_absen = new List<DAO_SiswaAbsen.AbsenRekapRapor>();
                                    lst_absen = DAO_SiswaAbsen.GetRekapAbsenRaporBySiswaByPeriode_Entity(
                                            m_siswa.Kode.ToString(),
                                            (m_rapor_arsip != null ? m_rapor_arsip.TanggalAwalAbsen : DateTime.MinValue),
                                            (m_rapor_arsip != null ? m_rapor_arsip.TanggalAkhirAbsen : DateTime.MinValue)
                                        );
                                    foreach (var absen in lst_absen)
                                    {
                                        if (absen.Absen == Libs.JENIS_ABSENSI.SAKIT.Substring(0, 1)) s_sakit = absen.Jumlah.ToString();
                                        if (absen.Absen == Libs.JENIS_ABSENSI.IZIN.Substring(0, 1)) s_izin = absen.Jumlah.ToString();
                                        if (absen.Absen == Libs.JENIS_ABSENSI.ALPA.Substring(0, 1)) s_alpa = absen.Jumlah.ToString();
                                        if (absen.Absen == Libs.JENIS_ABSENSI.TERLAMBAT.Substring(0, 1)) s_terlambat = absen.Jumlah.ToString();
                                    }
                                    html_row_body_siswa += "<td style=\"" + css_cell_body + " text-align: center; \">" +
                                                                s_sakit +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + " text-align: center; \">" +
                                                                s_izin +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + " text-align: center; \">" +
                                                                s_alpa +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + " text-align: center; \">" +
                                                                s_terlambat +
                                                           "</td>";
                                    //end absen

                                    html_row_body += "<tr>" +
                                                        html_row_body_siswa +
                                                     "</tr>";

                                    nomor++;
                                }
                                // end foreach siswa

                                for (int i = (jumlah_awal_col_ledger + 1); i <= id_kolom_ledger; i++)
                                {
                                    if (i >= id_mulai_looping_rata_rata)
                                    {
                                        decimal rata_rata = Math.Round(lst_all_nilai_rapor.FindAll(m => m.Key == i.ToString()).Select(m => m.Nilai).DefaultIfEmpty().Average(), Constantas.PEMBULATAN_DESIMAL_NILAI_SD);
                                        html_row_rata_rata += "<td style=\"" + css_cell_body + " text-align: right;\">" +
                                                                    (
                                                                        rata_rata > 0
                                                                        ? Libs.GetFormatBilangan(rata_rata, Constantas.PEMBULATAN_DESIMAL_NILAI_SD)
                                                                        : ""
                                                                    ) +
                                                              "</td>";
                                    }
                                    else
                                    {
                                        decimal rata_rata = Math.Round(lst_all_nilai_rapor.FindAll(m => m.Key == i.ToString()).Select(m => m.Nilai).DefaultIfEmpty().Average(), Constantas.PEMBULATAN_DESIMAL_NILAI_SD);
                                        html_row_rata_rata += "<td style=\"" + css_cell_body + " text-align: right;\">" +
                                                                    (
                                                                        rata_rata > 0
                                                                        ? Libs.GetFormatBilangan(rata_rata, Constantas.PEMBULATAN_DESIMAL_NILAI_SD)
                                                                        : ""
                                                                    ) +
                                                              "</td>";
                                    }
                                }
                                for (int i = 1; i <= jumlah_mapel_rapor; i++)
                                {
                                    decimal kkm = 0;
                                    NilaiWithKey m_kkm = lst_kkm_nilai_rapor.FindAll(m => m.Key == i.ToString()).FirstOrDefault();
                                    if (m_kkm != null)
                                    {
                                        if (m_kkm.Key != null)
                                        {
                                            kkm = m_kkm.Nilai;
                                        }
                                    }
                                    html_row_kkm += "<td colspan=\"4\" style=\"" + css_cell_body + " text-align: center;\">" +
                                                        Libs.GetFormatBilangan(kkm, Constantas.PEMBULATAN_DESIMAL_NILAI_SD) +
                                                    "</td>";
                                }
                                decimal rata_rata_nilai_keseluruhan = Math.Round(lst_jumlah_nilai_keseluruhan.Select(m => m.Nilai).DefaultIfEmpty().Average(), Constantas.PEMBULATAN_DESIMAL_NILAI_SD);
                                decimal rata_rata_nilai_rata_rata_rapor = Math.Round(lst_nilai_rapor.Select(m => m.Nilai).DefaultIfEmpty().Average(), Constantas.PEMBULATAN_DESIMAL_NILAI_SD);
                                html_row_body += "<tr>" +
                                                    html_row_rata_rata +
                                                 "</tr>" +
                                                 "<tr>" +
                                                    html_row_kkm +
                                                 "</tr>";

                            }

                        }
                    }

                }
            }

            html_row_header = "<tr>" +
                                html_row_header +
                              "</tr>" +
                              "<tr>" +
                                html_row_mapel +
                              "</tr>" +
                              "<tr>" +
                                html_row_jenis_nilai +
                              "</tr>" +
                              html_row_body;

            html = "<table style=\"border-collapse: collapse;\">" +
                        html_row_header +
                   "</table>";

            return html;
        }

        public static string GetHTMLLedger_KURTILAS_RataRata(
            System.Web.UI.Page page,
            string tahun_ajaran,
            string semester,
            string rel_kelas_det,
            string rel_siswa = ""
        )
        {
            string css_cell_headers = "border-style: solid; border-width: 1px; text-align: center; font-weight: bold; padding: 5px;";
            string css_cell_body = "border-style: solid; border-width: 1px; padding: 3px;";

            string html = "";
            string html_row_header = "<td rowspan=\"3\" style=\"" + css_cell_headers + "\">" +
                                        "No" +
                                     "</td>" +
                                     "<td rowspan=\"3\" style=\"" + css_cell_headers + "\">" +
                                        "NIS" +
                                     "</td>" +
                                     "<td rowspan=\"3\" style=\"" + css_cell_headers + "\">" +
                                        "NAMA LENGKAP" +
                                     "</td>" +
                                     "<td rowspan=\"3\" style=\"" + css_cell_headers + "\">" +
                                        "L/P" +
                                     "</td>";
            string html_row_mapel = "";
            string html_row_jenis_nilai = "";
            string html_row_body = "";

            KelasDet m_kelas_det = DAO_KelasDet.GetByID_Entity(rel_kelas_det);
            if (m_kelas_det != null)
            {
                if (m_kelas_det.Nama != null)
                {

                    Kelas m_kelas = DAO_Kelas.GetByID_Entity(m_kelas_det.Rel_Kelas.ToString());
                    if (m_kelas != null)
                    {
                        if (m_kelas.Nama != null)
                        {

                            Rapor_Desain rapor_desain = DAO_Rapor_Desain.GetByTABySMByKelas_Entity(
                                    tahun_ajaran, semester, rel_kelas_det, DAO_Rapor_Desain.JenisRapor.Semester
                                ).FirstOrDefault();

                            List<Rapor_Desain_Det> lst_rapor_desain_det = DAO_Rapor_Desain_Det.GetAllByHeader_Entity(rapor_desain.Kode.ToString()).FindAll(m => m.Nomor.Trim() != "" && m.Rel_Mapel.Trim() != "");

                            //list cols header
                            int jml_colspan_mapel = 0;
                            int jumlah_mapel = 0;
                            html_row_mapel = "";
                            foreach (Rapor_Desain_Det item_desain_det in lst_rapor_desain_det)
                            {
                                html_row_mapel += "<td colspan=\"4\" style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                    item_desain_det.NamaMapelRapor.Trim().ToUpper() +
                                                  "</td>";
                                html_row_jenis_nilai += "<td style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                                "PENGETAHUAN" +
                                                        "</td>" +
                                                        "<td style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                                "PREDIKAT" +
                                                        "</td>" +
                                                        "<td style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                                "KETERAMPILAN" +
                                                        "</td>" +
                                                        "<td style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                                "PREDIKAT" +
                                                        "</td>";
                                jumlah_mapel++;
                            }
                            jml_colspan_mapel = (jumlah_mapel * 4);

                            lst_rapor_desain_det = DAO_Rapor_Desain_Det.GetAllByHeader_Entity(rapor_desain.Kode.ToString()).FindAll(m => m.Nomor.Trim() == "" && m.Rel_Mapel.Trim() != "");
                            foreach (Rapor_Desain_Det item_desain_det in lst_rapor_desain_det)
                            {
                                html_row_mapel += "<td colspan=\"2\" style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                    item_desain_det.NamaMapelRapor.Trim().ToUpper() +
                                                  "</td>";
                                html_row_jenis_nilai += "<td style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                                "NILAI" +
                                                        "</td>" +
                                                        "<td style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                                "PREDIKAT" +
                                                        "</td>";
                                jumlah_mapel++;
                                jml_colspan_mapel += 2;
                            }

                            html_row_header += "<td colspan=\"" + jml_colspan_mapel.ToString() + "\" style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                    "NILAI MATA PELAJARAN" +
                                               "</td>";
                            html_row_header += "<td colspan=\"4\" style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                    "PRESENSI" +
                                               "</td>";
                            html_row_mapel += "<td rowspan=\"2\" style=\"" + css_cell_headers + " width: 30px; font-size: 8.5px; \">" +
                                                    "S" +
                                              "</td>" +
                                              "<td rowspan=\"2\" style=\"" + css_cell_headers + " width: 30px; font-size: 8.5px; \">" +
                                                    "I" +
                                              "</td>" +
                                              "<td rowspan=\"2\" style=\"" + css_cell_headers + " width: 30px; font-size: 8.5px; \">" +
                                                    "A" +
                                              "</td>" +
                                              "<td rowspan=\"2\" style=\"" + css_cell_headers + " width: 30px; font-size: 8.5px; \">" +
                                                    "T" +
                                              "</td>";
                            //end list cols header
                            if (rapor_desain != null)
                            {

                                List<DAO_Siswa.SiswaDataSimple> lst_siswa = DAO_Siswa.GetAllSiswaDataSimpleByTahunAjaranUnitKelas_Entity(
                                        m_kelas.Rel_Sekolah.ToString(),
                                        rel_kelas_det,
                                        tahun_ajaran,
                                        semester
                                    );
                                List<decimal> lst_nilai_ap = new List<decimal>();
                                List<decimal> lst_nilai_ap_bobot = new List<decimal>();                                
                                List<decimal> lst_nilai_kd = new List<decimal>();
                                List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT> lst_nilai_siswa_det = new List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT>();
                                List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT> lst_nilai_siswa_det_by_periode = new List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT>();
                                List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT> lst_nilai_siswa_det_sm1 = new List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT>();
                                List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT> lst_nilai_siswa_det_by_periode_sm1 = new List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT>();

                                lst_nilai_siswa_det_by_periode = DAO_Rapor_NilaiSiswa_Det.GetAllByTABySMByKelasDet_Entity(
                                        tahun_ajaran, semester, rel_kelas_det
                                    );
                                lst_nilai_siswa_det_by_periode_sm1 = DAO_Rapor_NilaiSiswa_Det.GetAllByTABySMByKelasDet_Entity(
                                        tahun_ajaran, "1", rel_kelas_det
                                    );

                                int id_kolom_ledger = 0;
                                int nomor = 1;
                                int jumlah_awal_col_ledger = 3;
                                int jumlah_mapel_rapor = 0;
                                if (rel_siswa.Trim() != "")
                                {
                                    lst_siswa = lst_siswa.FindAll(m0 => (rel_siswa + ";").Trim().ToUpper().IndexOf(m0.Kode.ToString().ToUpper() + ";") >= 0).ToList();
                                }
                                List<NilaiWithKey> lst_all_nilai_rapor = new List<NilaiWithKey>();
                                List<NilaiWithKey> lst_kkm_nilai_rapor = new List<NilaiWithKey>();
                                List<NilaiWithKey> lst_jumlah_nilai_keseluruhan = new List<NilaiWithKey>();
                                List<NilaiWithKey> lst_nilai_rapor = new List<NilaiWithKey>();
                                decimal jumlah_keseluruhan = 0;                                

                                string html_row_rata_rata = "<td colspan=\"4\" style=\"" + css_cell_body + " font-weight: bold;\">" +
                                                                "RATA-RATA KELAS" +
                                                            "</td>";
                                string html_row_kkm = "<td colspan=\"4\" style=\"" + css_cell_body + " font-weight: bold;\">" +
                                                            "KKM" +
                                                      "</td>";

                                int id_mulai_looping_rata_rata = id_kolom_ledger + 1;
                                int id_mulai_looping_kkm = jumlah_mapel_rapor + 1;

                                foreach (DAO_Siswa.SiswaDataSimple m_siswa in lst_siswa.OrderBy(m => m.Nama))
                                {
                                    jumlah_keseluruhan = 0;
                                    jumlah_mapel_rapor = 0;

                                    string html_row_body_siswa = "";
                                    html_row_body_siswa += "<td style=\"" + css_cell_body + " text-align: center;\">" +
                                                                nomor.ToString() +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + "\">" +
                                                                m_siswa.NISSekolah +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + " white-space: nowrap;\">" +
                                                                Libs.GetPerbaikiEjaanNama(m_siswa.Nama) +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + "\">" +
                                                                m_siswa.JenisKelamin +
                                                           "</td>";

                                    lst_kkm_nilai_rapor.Clear();
                                    id_kolom_ledger = jumlah_awal_col_ledger;
                                    
                                    //nilai non mulok
                                    foreach (Rapor_Desain_Det item in DAO_Rapor_Desain_Det.GetAllByHeader_Entity(rapor_desain.Kode.ToString()).FindAll(m => m.Nomor.Trim() != "" && m.Rel_Mapel.Trim() != ""))
                                    {

                                        if (item.Rel_Mapel.Trim() != "")
                                        {

                                            lst_nilai_siswa_det = lst_nilai_siswa_det_by_periode.FindAll(
                                                    m => m.Rel_Mapel == item.Rel_Mapel &&
                                                         m.Rel_Siswa == m.Rel_Siswa
                                                );
                                            lst_nilai_siswa_det_sm1 = lst_nilai_siswa_det_by_periode_sm1.FindAll(
                                                    m => m.Rel_Mapel == item.Rel_Mapel &&
                                                         m.Rel_Siswa == m.Rel_Siswa
                                                );

                                            //get struktur nilainya
                                            Rapor_StrukturNilai m_struktur_nilai_sm1 = DAO_Rapor_StrukturNilai.GetATop1ByTABySMByKelasByMapel_Entity(
                                                    tahun_ajaran, "1", m_kelas.Kode.ToString(), item.Rel_Mapel
                                                );
                                            Rapor_StrukturNilai m_struktur_nilai = DAO_Rapor_StrukturNilai.GetATop1ByTABySMByKelasByMapel_Entity(
                                                    tahun_ajaran, semester, m_kelas.Kode.ToString(), item.Rel_Mapel
                                                );

                                            decimal nilai_rapor = 0;
                                            decimal jumlah_nilai_rapor = 0;
                                            decimal count_nilai_rapor = 0;

                                            decimal nilai_rapor_pengetahuan_sm1 = 0;
                                            decimal nilai_rapor_keterampilan_sm1 = 0;
                                            decimal nilai_rapor_pengetahuan = 0;
                                            decimal nilai_rapor_keterampilan = 0;

                                            Rapor_StrukturNilai_AP m_sn_ap = new Rapor_StrukturNilai_AP();

                                            if (m_struktur_nilai != null)
                                            {
                                                if (m_struktur_nilai.TahunAjaran != null)
                                                {

                                                    lst_kkm_nilai_rapor.Add(new NilaiWithKey
                                                    {
                                                        Key = (jumlah_mapel_rapor + 1).ToString(),
                                                        Nilai = m_struktur_nilai.KKM
                                                    });
                                                    if (!(m_struktur_nilai.IsKelompokanKP && m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString()))
                                                    {
                                                        decimal jumlah_nilai_ap = 0;
                                                        decimal nilai_ap = 0;
                                                        int count_ap = 0;
                                                        List<Rapor_StrukturNilai_AP> lst_rapor_struktur_nilai_ap = new List<Rapor_StrukturNilai_AP>();
                                                        List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = new List<Rapor_StrukturNilai_KD>();                                                        

                                                        //jika semester 2 get semester 1
                                                        if (semester == "2")
                                                        {
                                                            lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeaderByJenisAspekPenilaian_Entity(
                                                                m_struktur_nilai_sm1.Kode.ToString(), DAO_Rapor_StrukturNilai_AP.JenisAspekPenilaian.Pengetahuan
                                                            );
                                                            lst_nilai_ap.Clear();
                                                            lst_nilai_ap_bobot.Clear();
                                                            jumlah_nilai_ap = 0;
                                                            nilai_ap = 0;
                                                            count_ap = 0;
                                                            m_sn_ap = new Rapor_StrukturNilai_AP();
                                                            foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                            {

                                                                //get struktur nilai det KD
                                                                lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                        item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                    );
                                                                lst_nilai_kd.Clear();
                                                                foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                                {

                                                                    //get struktur nilai det KP
                                                                    List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                        item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                    );
                                                                    decimal jumlah_nilai_kd = 0;
                                                                    decimal nilai_kd = 0;
                                                                    int count_kd = 0;
                                                                    foreach (var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp)
                                                                    {
                                                                        Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString());
                                                                        if (m_kp != null)
                                                                        {

                                                                            Rapor_NilaiSiswa_Det m_nilai_det = lst_nilai_siswa_det_sm1.FindAll(
                                                                                m => m.Rel_Siswa.ToString().Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                     m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai_sm1.Rel_Mapel.ToString().Trim().ToUpper() &&
                                                                                     m.Rel_Rapor_StrukturNilai_AP.Trim().ToUpper() == item_rapor_struktur_nilai_ap.Kode.ToString().ToUpper() &&
                                                                                     m.Rel_Rapor_StrukturNilai_KD.Trim().ToUpper() == item_rapor_struktur_nilai_kd.Kode.ToString().ToUpper() &&
                                                                                     m.Rel_Rapor_StrukturNilai_KP.Trim().ToUpper() == item_rapor_struktur_nilai_kp.Kode.ToString().ToUpper()
                                                                            ).FirstOrDefault();

                                                                            if (m_nilai_det != null)
                                                                            {
                                                                                if (m_nilai_det.Nilai.Trim() != "")
                                                                                {
                                                                                    if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                                    {
                                                                                        nilai_kd += Math.Round((item_rapor_struktur_nilai_kp.BobotNK / 100) * Libs.GetStringToDecimal(m_nilai_det.Nilai), 2, MidpointRounding.AwayFromZero);
                                                                                    }
                                                                                    else if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                                    {
                                                                                        jumlah_nilai_kd += Libs.GetStringToDecimal(m_nilai_det.Nilai);
                                                                                    }
                                                                                    count_kd++;
                                                                                }
                                                                            }

                                                                        }

                                                                    }

                                                                    if (count_kd > 0)
                                                                    {
                                                                        if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                        {
                                                                            nilai_kd = Math.Round(jumlah_nilai_kd / count_kd, 2, MidpointRounding.AwayFromZero);
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        nilai_kd = 0;
                                                                    }

                                                                    //load nilai manual
                                                                    Rapor_NilaiSiswa_AP_or_KD m_nilai_manual = DAO_Rapor_NilaiSiswa_AP_or_KD.GetAllByTABySMByKelasByMapelBySiswaByStruktur_Entity(
                                                                            tahun_ajaran, m_struktur_nilai_sm1.Semester, rel_kelas_det, m_siswa.Kode.ToString(), item.Rel_Mapel,
                                                                            item_rapor_struktur_nilai_kd.Kode.ToString().Trim().ToUpper()

                                                                        ).FirstOrDefault();
                                                                    if (m_nilai_manual != null)
                                                                    {
                                                                        if (m_nilai_manual.Nilai != null)
                                                                        {
                                                                            nilai_kd = Libs.GetStringToDecimal(m_nilai_manual.Nilai);
                                                                        }
                                                                    }
                                                                    //end load nilai manual

                                                                    nilai_kd = Math.Round(nilai_kd, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);
                                                                    lst_nilai_kd.Add(nilai_kd);
                                                                    //end get struktur nilai det KP

                                                                }
                                                                //end get struktur nilai det KD

                                                                //get nilai ap
                                                                count_ap = 0;
                                                                nilai_ap = 0;
                                                                jumlah_nilai_ap = 0;
                                                                foreach (var item_nilai_kd in lst_nilai_kd)
                                                                {
                                                                    if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                    {
                                                                        nilai_ap += Math.Round((item_rapor_struktur_nilai_ap.BobotRapor / 100) * item_nilai_kd, 2, MidpointRounding.AwayFromZero);
                                                                    }
                                                                    else if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                    {
                                                                        jumlah_nilai_ap += item_nilai_kd;
                                                                    }
                                                                    count_ap++;
                                                                }
                                                                if (count_ap > 0)
                                                                {
                                                                    if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                    {
                                                                        nilai_ap = Math.Round(jumlah_nilai_ap / count_ap, 2, MidpointRounding.AwayFromZero);
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    nilai_ap = 0;
                                                                }
                                                                nilai_ap = Math.Round(nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                                lst_nilai_ap.Add(nilai_ap);
                                                                lst_nilai_ap_bobot.Add(item_rapor_struktur_nilai_ap.BobotRapor);
                                                                //end get nilai ap

                                                            }
                                                            //end get struktur nilai det AP

                                                            //get nilai rapor
                                                            nilai_rapor = 0;
                                                            jumlah_nilai_rapor = 0;
                                                            count_nilai_rapor = 0;
                                                            foreach (var item_nilai_ap in lst_nilai_ap)
                                                            {
                                                                if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                {
                                                                    nilai_rapor += Math.Round((lst_nilai_ap_bobot[Convert.ToInt16(count_nilai_rapor)] / 100) * item_nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                                else if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    jumlah_nilai_rapor += item_nilai_ap;
                                                                }
                                                                count_nilai_rapor++;
                                                            }
                                                            if (count_nilai_rapor > 0)
                                                            {
                                                                if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_rapor = 0;
                                                            }
                                                            nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);
                                                            nilai_rapor_pengetahuan_sm1 = nilai_rapor;
                                                        }
                                                        //end jika semester 2 get semester 1

                                                        //-----------nilai pengetahuan---------------
                                                        id_kolom_ledger++;
                                                        //get struktur nilai det AP
                                                        lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeaderByJenisAspekPenilaian_Entity(
                                                                m_struktur_nilai.Kode.ToString(), DAO_Rapor_StrukturNilai_AP.JenisAspekPenilaian.Pengetahuan
                                                            );
                                                        lst_nilai_ap.Clear();
                                                        lst_nilai_ap_bobot.Clear();
                                                        jumlah_nilai_ap = 0;
                                                        nilai_ap = 0;
                                                        count_ap = 0;
                                                        m_sn_ap = new Rapor_StrukturNilai_AP();
                                                        foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                        {

                                                            //get struktur nilai det KD
                                                            lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                );
                                                            lst_nilai_kd.Clear();
                                                            foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                            {

                                                                //get struktur nilai det KP
                                                                List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                );
                                                                decimal jumlah_nilai_kd = 0;
                                                                decimal nilai_kd = 0;
                                                                int count_kd = 0;
                                                                foreach (var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp)
                                                                {
                                                                    Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString());
                                                                    if (m_kp != null)
                                                                    {

                                                                        Rapor_NilaiSiswa_Det m_nilai_det = lst_nilai_siswa_det.FindAll(
                                                                            m => m.Rel_Siswa.ToString().Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_AP.Trim().ToUpper() == item_rapor_struktur_nilai_ap.Kode.ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KD.Trim().ToUpper() == item_rapor_struktur_nilai_kd.Kode.ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KP.Trim().ToUpper() == item_rapor_struktur_nilai_kp.Kode.ToString().ToUpper()
                                                                        ).FirstOrDefault();

                                                                        if (m_nilai_det != null)
                                                                        {
                                                                            if (m_nilai_det.Nilai.Trim() != "")
                                                                            {
                                                                                if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                                {
                                                                                    nilai_kd += Math.Round((item_rapor_struktur_nilai_kp.BobotNK / 100) * Libs.GetStringToDecimal(m_nilai_det.Nilai), 2, MidpointRounding.AwayFromZero);
                                                                                }
                                                                                else if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                                {
                                                                                    jumlah_nilai_kd += Libs.GetStringToDecimal(m_nilai_det.Nilai);
                                                                                }
                                                                                count_kd++;
                                                                            }
                                                                        }

                                                                    }

                                                                }

                                                                if (count_kd > 0)
                                                                {
                                                                    if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                    {
                                                                        nilai_kd = Math.Round(jumlah_nilai_kd / count_kd, 2, MidpointRounding.AwayFromZero);
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    nilai_kd = 0;
                                                                }

                                                                //load nilai manual
                                                                Rapor_NilaiSiswa_AP_or_KD m_nilai_manual = DAO_Rapor_NilaiSiswa_AP_or_KD.GetAllByTABySMByKelasByMapelBySiswaByStruktur_Entity(
                                                                        tahun_ajaran, semester, rel_kelas_det, m_siswa.Kode.ToString(), item.Rel_Mapel,
                                                                        item_rapor_struktur_nilai_kd.Kode.ToString().Trim().ToUpper()

                                                                    ).FirstOrDefault();
                                                                if (m_nilai_manual != null)
                                                                {
                                                                    if (m_nilai_manual.Nilai != null)
                                                                    {
                                                                        nilai_kd = Libs.GetStringToDecimal(m_nilai_manual.Nilai);
                                                                    }
                                                                }
                                                                //end load nilai manual

                                                                nilai_kd = Math.Round(nilai_kd, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);
                                                                lst_nilai_kd.Add(nilai_kd);
                                                                //end get struktur nilai det KP

                                                            }
                                                            //end get struktur nilai det KD

                                                            //get nilai ap
                                                            count_ap = 0;
                                                            nilai_ap = 0;
                                                            jumlah_nilai_ap = 0;
                                                            foreach (var item_nilai_kd in lst_nilai_kd)
                                                            {
                                                                if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                {
                                                                    nilai_ap += Math.Round((item_rapor_struktur_nilai_ap.BobotRapor / 100) * item_nilai_kd, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                                else if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    jumlah_nilai_ap += item_nilai_kd;
                                                                }
                                                                count_ap++;
                                                            }
                                                            if (count_ap > 0)
                                                            {
                                                                if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_ap = Math.Round(jumlah_nilai_ap / count_ap, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_ap = 0;
                                                            }
                                                            nilai_ap = Math.Round(nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                            lst_nilai_ap.Add(nilai_ap);
                                                            //end get nilai ap

                                                            m_sn_ap = item_rapor_struktur_nilai_ap;
                                                        }
                                                        //end get struktur nilai det AP

                                                        //get nilai rapor
                                                        nilai_rapor = 0;
                                                        jumlah_nilai_rapor = 0;
                                                        count_nilai_rapor = 0;
                                                        foreach (var item_nilai_ap in lst_nilai_ap)
                                                        {
                                                            if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                            {
                                                                nilai_rapor += Math.Round((lst_nilai_ap_bobot[Convert.ToInt16(count_nilai_rapor)] / 100) * item_nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                            }
                                                            else if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                jumlah_nilai_rapor += item_nilai_ap;
                                                            }
                                                            count_nilai_rapor++;
                                                        }
                                                        if (count_nilai_rapor > 0)
                                                        {
                                                            if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            nilai_rapor = 0;
                                                        }
                                                        nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);

                                                        //jika ada PAT atau UKK
                                                        if (m_sn_ap.IsAdaPAT_UKK)
                                                        {
                                                            Rapor_NilaiSiswa_Det m_nilai_det = lst_nilai_siswa_det.FindAll(
                                                                            m => m.Rel_Siswa.ToString().Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_AP.Trim().ToUpper() == (Constantas.SD.GetKode_NK_KD_UKKPAT(m_sn_ap.Kode.ToString())).ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KD.Trim().ToUpper() == (Constantas.SD.GetKode_NK_KD_UKKPAT(m_sn_ap.Kode.ToString())).ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KP.Trim().ToUpper() == (Constantas.SD.GetKode_NK_KD_UKKPAT(m_sn_ap.Kode.ToString())).ToString().ToUpper()
                                                                        ).FirstOrDefault();

                                                            string s_nilai_pat_ukk = "0";
                                                            if (m_nilai_det != null)
                                                            {
                                                                if (m_nilai_det.Nilai.Trim() != "")
                                                                {
                                                                    s_nilai_pat_ukk = m_nilai_det.Nilai;
                                                                }
                                                            }

                                                            nilai_rapor = Math.Round(
                                                                            Libs.GetStringToDecimal(s_nilai_pat_ukk) * (m_sn_ap.Bobot_PAT_UKK / 100), 2
                                                                          ) +
                                                                            Math.Round(
                                                                            nilai_rapor * (m_sn_ap.Bobot_Non_PAT_UKK / 100), 2
                                                                          );

                                                            nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);
                                                        }
                                                        //jika ada PAT atau UKK

                                                        nilai_rapor_pengetahuan = Math.Round((nilai_rapor + nilai_rapor_pengetahuan_sm1) / 2, 0, MidpointRounding.AwayFromZero);
                                                        lst_all_nilai_rapor.Add(new NilaiWithKey {
                                                            Key = (id_kolom_ledger).ToString(),
                                                            Nilai = nilai_rapor_pengetahuan
                                                        });
                                                        id_kolom_ledger += 2;
                                                        //end get nilai rapor
                                                        //-----------end nilai pengetahuan---------------

                                                        //-----------nilai keterampilan---------------
                                                        if (semester == "2")
                                                        {
                                                            lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeaderByJenisAspekPenilaian_Entity(
                                                                m_struktur_nilai_sm1.Kode.ToString(), DAO_Rapor_StrukturNilai_AP.JenisAspekPenilaian.Keterampilan
                                                            );
                                                            lst_nilai_ap.Clear();
                                                            lst_nilai_ap_bobot.Clear();
                                                            jumlah_nilai_ap = 0;
                                                            nilai_ap = 0;
                                                            count_ap = 0;
                                                            m_sn_ap = new Rapor_StrukturNilai_AP();
                                                            foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                            {

                                                                //get struktur nilai det KD
                                                                lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                        item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                    );
                                                                lst_nilai_kd.Clear();
                                                                foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                                {

                                                                    //get struktur nilai det KP
                                                                    List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                        item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                    );
                                                                    decimal jumlah_nilai_kd = 0;
                                                                    decimal nilai_kd = 0;
                                                                    int count_kd = 0;
                                                                    foreach (var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp)
                                                                    {
                                                                        Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString());
                                                                        if (m_kp != null)
                                                                        {

                                                                            Rapor_NilaiSiswa_Det m_nilai_det = lst_nilai_siswa_det_sm1.FindAll(
                                                                                m => m.Rel_Siswa.ToString().Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                     m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai_sm1.Rel_Mapel.ToString().Trim().ToUpper() &&
                                                                                     m.Rel_Rapor_StrukturNilai_AP.Trim().ToUpper() == item_rapor_struktur_nilai_ap.Kode.ToString().ToUpper() &&
                                                                                     m.Rel_Rapor_StrukturNilai_KD.Trim().ToUpper() == item_rapor_struktur_nilai_kd.Kode.ToString().ToUpper() &&
                                                                                     m.Rel_Rapor_StrukturNilai_KP.Trim().ToUpper() == item_rapor_struktur_nilai_kp.Kode.ToString().ToUpper()
                                                                            ).FirstOrDefault();

                                                                            if (m_nilai_det != null)
                                                                            {
                                                                                if (m_nilai_det.Nilai.Trim() != "")
                                                                                {
                                                                                    if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                                    {
                                                                                        nilai_kd += Math.Round((item_rapor_struktur_nilai_kp.BobotNK / 100) * Libs.GetStringToDecimal(m_nilai_det.Nilai), 2, MidpointRounding.AwayFromZero);
                                                                                    }
                                                                                    else if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                                    {
                                                                                        jumlah_nilai_kd += Libs.GetStringToDecimal(m_nilai_det.Nilai);
                                                                                    }
                                                                                    count_kd++;
                                                                                }
                                                                            }

                                                                        }

                                                                    }

                                                                    if (count_kd > 0)
                                                                    {
                                                                        if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                        {
                                                                            nilai_kd = Math.Round(jumlah_nilai_kd / count_kd, 2, MidpointRounding.AwayFromZero);
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        nilai_kd = 0;
                                                                    }

                                                                    //load nilai manual
                                                                    Rapor_NilaiSiswa_AP_or_KD m_nilai_manual = DAO_Rapor_NilaiSiswa_AP_or_KD.GetAllByTABySMByKelasByMapelBySiswaByStruktur_Entity(
                                                                            tahun_ajaran, semester, rel_kelas_det, m_siswa.Kode.ToString(), item.Rel_Mapel,
                                                                            item_rapor_struktur_nilai_kd.Kode.ToString().Trim().ToUpper()

                                                                        ).FirstOrDefault();
                                                                    if (m_nilai_manual != null)
                                                                    {
                                                                        if (m_nilai_manual.Nilai != null)
                                                                        {
                                                                            nilai_kd = Libs.GetStringToDecimal(m_nilai_manual.Nilai);
                                                                        }
                                                                    }
                                                                    //end load nilai manual

                                                                    nilai_kd = Math.Round(nilai_kd, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);
                                                                    lst_nilai_kd.Add(nilai_kd);
                                                                    //end get struktur nilai det KP

                                                                }
                                                                //end get struktur nilai det KD

                                                                //get nilai ap
                                                                count_ap = 0;
                                                                nilai_ap = 0;
                                                                jumlah_nilai_ap = 0;
                                                                foreach (var item_nilai_kd in lst_nilai_kd)
                                                                {
                                                                    if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                    {
                                                                        nilai_ap += Math.Round((item_rapor_struktur_nilai_ap.BobotRapor / 100) * item_nilai_kd, 2, MidpointRounding.AwayFromZero);
                                                                    }
                                                                    else if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                    {
                                                                        jumlah_nilai_ap += item_nilai_kd;
                                                                    }
                                                                    count_ap++;
                                                                }
                                                                if (count_ap > 0)
                                                                {
                                                                    if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                    {
                                                                        nilai_ap = Math.Round(jumlah_nilai_ap / count_ap, 2, MidpointRounding.AwayFromZero);
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    nilai_ap = 0;
                                                                }
                                                                nilai_ap = Math.Round(nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                                lst_nilai_ap.Add(nilai_ap);
                                                                lst_nilai_ap_bobot.Add(item_rapor_struktur_nilai_ap.BobotRapor);
                                                                //end get nilai ap

                                                            }
                                                            //end get struktur nilai det AP

                                                            //get nilai rapor
                                                            nilai_rapor = 0;
                                                            jumlah_nilai_rapor = 0;
                                                            count_nilai_rapor = 0;
                                                            foreach (var item_nilai_ap in lst_nilai_ap)
                                                            {
                                                                if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                {
                                                                    nilai_rapor += Math.Round((lst_nilai_ap_bobot[Convert.ToInt16(count_nilai_rapor)] / 100) * item_nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                                else if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    jumlah_nilai_rapor += item_nilai_ap;
                                                                }
                                                                count_nilai_rapor++;
                                                            }
                                                            if (count_nilai_rapor > 0)
                                                            {
                                                                if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_rapor = 0;
                                                            }
                                                            nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);
                                                            nilai_rapor_keterampilan_sm1 = nilai_rapor;
                                                        }
                                                        //end jika semester 2 get semester 1

                                                        //get struktur nilai det AP
                                                        lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeaderByJenisAspekPenilaian_Entity(
                                                                m_struktur_nilai.Kode.ToString(), DAO_Rapor_StrukturNilai_AP.JenisAspekPenilaian.Keterampilan
                                                            );
                                                        lst_nilai_ap.Clear();
                                                        lst_nilai_ap_bobot.Clear();
                                                        jumlah_nilai_ap = 0;
                                                        nilai_ap = 0;
                                                        count_ap = 0;
                                                        foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                        {

                                                            //get struktur nilai det KD
                                                            lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                );
                                                            lst_nilai_kd.Clear();
                                                            foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                            {

                                                                //get struktur nilai det KP
                                                                List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                );
                                                                decimal jumlah_nilai_kd = 0;
                                                                decimal nilai_kd = 0;
                                                                int count_kd = 0;
                                                                foreach (var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp)
                                                                {
                                                                    Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString());
                                                                    if (m_kp != null)
                                                                    {

                                                                        Rapor_NilaiSiswa_Det m_nilai_det = lst_nilai_siswa_det.FindAll(
                                                                            m => m.Rel_Siswa.ToString().Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_AP.Trim().ToUpper() == item_rapor_struktur_nilai_ap.Kode.ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KD.Trim().ToUpper() == item_rapor_struktur_nilai_kd.Kode.ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KP.Trim().ToUpper() == item_rapor_struktur_nilai_kp.Kode.ToString().ToUpper()
                                                                        ).FirstOrDefault();

                                                                        if (m_nilai_det != null)
                                                                        {
                                                                            if (m_nilai_det.Nilai.Trim() != "")
                                                                            {
                                                                                if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                                {
                                                                                    nilai_kd += Math.Round((item_rapor_struktur_nilai_kp.BobotNK / 100) * Libs.GetStringToDecimal(m_nilai_det.Nilai), 2, MidpointRounding.AwayFromZero);
                                                                                }
                                                                                else if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                                {
                                                                                    jumlah_nilai_kd += Libs.GetStringToDecimal(m_nilai_det.Nilai);
                                                                                }
                                                                                count_kd++;
                                                                            }
                                                                        }

                                                                    }

                                                                }

                                                                if (count_kd > 0)
                                                                {
                                                                    if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                    {
                                                                        nilai_kd = Math.Round(jumlah_nilai_kd / count_kd, 2, MidpointRounding.AwayFromZero);
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    nilai_kd = 0;
                                                                }

                                                                //load nilai manual
                                                                Rapor_NilaiSiswa_AP_or_KD m_nilai_manual = DAO_Rapor_NilaiSiswa_AP_or_KD.GetAllByTABySMByKelasByMapelBySiswaByStruktur_Entity(
                                                                        tahun_ajaran, semester, rel_kelas_det, m_siswa.Kode.ToString(), item.Rel_Mapel,
                                                                        item_rapor_struktur_nilai_kd.Kode.ToString().Trim().ToUpper()

                                                                    ).FirstOrDefault();
                                                                if (m_nilai_manual != null)
                                                                {
                                                                    if (m_nilai_manual.Nilai != null)
                                                                    {
                                                                        nilai_kd = Libs.GetStringToDecimal(m_nilai_manual.Nilai);
                                                                    }
                                                                }
                                                                //end load nilai manual

                                                                nilai_kd = Math.Round(nilai_kd, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);
                                                                lst_nilai_kd.Add(nilai_kd);
                                                                //end get struktur nilai det KP

                                                            }
                                                            //end get struktur nilai det KD

                                                            //get nilai ap
                                                            count_ap = 0;
                                                            nilai_ap = 0;
                                                            jumlah_nilai_ap = 0;
                                                            foreach (var item_nilai_kd in lst_nilai_kd)
                                                            {
                                                                if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                {
                                                                    nilai_ap += Math.Round((item_rapor_struktur_nilai_ap.BobotRapor / 100) * item_nilai_kd, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                                else if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    jumlah_nilai_ap += item_nilai_kd;
                                                                }
                                                                count_ap++;
                                                            }
                                                            if (count_ap > 0)
                                                            {
                                                                if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_ap = Math.Round(jumlah_nilai_ap / count_ap, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_ap = 0;
                                                            }
                                                            nilai_ap = Math.Round(nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                            lst_nilai_ap.Add(nilai_ap);
                                                            lst_nilai_ap_bobot.Add(item_rapor_struktur_nilai_ap.BobotRapor);
                                                            //end get nilai ap
                                                            //-----------end nilai keterampilan---------------

                                                        }
                                                        //end get struktur nilai det AP

                                                        //get nilai rapor
                                                        nilai_rapor = 0;
                                                        jumlah_nilai_rapor = 0;
                                                        count_nilai_rapor = 0;
                                                        foreach (var item_nilai_ap in lst_nilai_ap)
                                                        {
                                                            if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                            {
                                                                nilai_rapor += Math.Round((lst_nilai_ap_bobot[Convert.ToInt16(count_nilai_rapor)] / 100) * item_nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                            }
                                                            else if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                jumlah_nilai_rapor += item_nilai_ap;
                                                            }
                                                            count_nilai_rapor++;
                                                        }
                                                        if (count_nilai_rapor > 0)
                                                        {
                                                            if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            nilai_rapor = 0;
                                                        }
                                                        nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);
                                                        nilai_rapor_keterampilan = Math.Round((nilai_rapor + nilai_rapor_keterampilan_sm1) / 2, 0, MidpointRounding.AwayFromZero);
                                                        lst_all_nilai_rapor.Add(new NilaiWithKey
                                                        {
                                                            Key = (id_kolom_ledger).ToString(),
                                                            Nilai = nilai_rapor_keterampilan
                                                        });
                                                        id_kolom_ledger++;
                                                        //end get nilai rapor
                                                    }
                                                    else 
                                                    {
                                                        id_kolom_ledger++;
                                                        List<FormatNilai> lst_format_nilai = new List<FormatNilai>();
                                                        List<Rapor_StrukturNilai_AP> lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeader_Entity(
                                                                m_struktur_nilai.Kode.ToString()
                                                            );
                                                        foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                        {

                                                            List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                );

                                                            foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                            {

                                                                List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                );
                                                                foreach (
                                                                    var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp.FindAll(
                                                                        m => (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == DAO_Rapor_StrukturNilai.Arr_KP_Quran[0]) ||
                                                                             (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == DAO_Rapor_StrukturNilai.Arr_KP_Quran[1]) ||
                                                                             (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == DAO_Rapor_StrukturNilai.Arr_KP_Quran[2])
                                                                        )
                                                                )
                                                                {

                                                                    if (
                                                                        lst_format_nilai.FindAll(
                                                                                m => m.Rel_StrukturNilai_AP == item_rapor_struktur_nilai_ap.Kode.ToString() &&
                                                                                     m.Rel_KP == item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                            ).Count == 0
                                                                    )
                                                                    {
                                                                        lst_format_nilai.Add(new FormatNilai
                                                                        {
                                                                            Rel_StrukturNilai_AP = item_rapor_struktur_nilai_ap.Kode.ToString(),
                                                                            Rel_KP = item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                        });
                                                                    }

                                                                }
                                                            }

                                                        }

                                                        List<FormatNilai> lst_format_nilai2 = new List<FormatNilai>();
                                                        foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                        {

                                                            List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                );

                                                            foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                            {

                                                                List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                );
                                                                foreach (
                                                                    var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp.FindAll(
                                                                        m => (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() != DAO_Rapor_StrukturNilai.Arr_KP_Quran[0]) &&
                                                                             (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() != DAO_Rapor_StrukturNilai.Arr_KP_Quran[1]) &&
                                                                             (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() != DAO_Rapor_StrukturNilai.Arr_KP_Quran[2])
                                                                        )
                                                                )
                                                                {

                                                                    if (
                                                                        lst_format_nilai2.FindAll(
                                                                                m => m.Rel_StrukturNilai_AP == item_rapor_struktur_nilai_ap.Kode.ToString() &&
                                                                                     m.Rel_KP == item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                            ).Count == 0
                                                                    )
                                                                    {
                                                                        lst_format_nilai2.Add(new FormatNilai
                                                                        {
                                                                            Rel_StrukturNilai_AP = item_rapor_struktur_nilai_ap.Kode.ToString(),
                                                                            Rel_KP = item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                        });
                                                                    }

                                                                }
                                                            }

                                                        }

                                                        List<FormatNilaiWithNilai> lst_formatnilai_nilai = new List<FormatNilaiWithNilai>();
                                                        //distinct ap
                                                        foreach (string rel_sn_ap in lst_format_nilai.Select(m => m.Rel_StrukturNilai_AP).Distinct())
                                                        {
                                                            foreach (string rel_kp in lst_format_nilai.Select(m => m.Rel_KP).Distinct())
                                                            {

                                                                Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(rel_kp);
                                                                if (m_kp != null)
                                                                {
                                                                    if (m_kp.Nama != null)
                                                                    {

                                                                        double nilai = lst_nilai_siswa_det.Where(
                                                                            m => m.Rel_Rapor_StrukturNilai_AP.ToString().Trim().ToUpper() == rel_sn_ap.Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == rel_kp.Trim().ToUpper() &&
                                                                                 m.Rel_Siswa.Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper()
                                                                        ).Select(m => Libs.GetStringToDouble(m.Nilai)).DefaultIfEmpty().Average();

                                                                        lst_formatnilai_nilai.Add(new FormatNilaiWithNilai
                                                                        {
                                                                            Nama_KP = m_kp.Nama,
                                                                            Nilai = nilai.ToString(),
                                                                            Rel_KP = rel_kp,
                                                                            Rel_StrukturNilai_AP = rel_sn_ap
                                                                        });

                                                                    }
                                                                }

                                                            }
                                                        }

                                                        List<FormatNilaiWithNilai> lst_formatnilai_nilai2 = new List<FormatNilaiWithNilai>();
                                                        //distinct ap
                                                        foreach (string rel_sn_ap in lst_format_nilai2.Select(m => m.Rel_StrukturNilai_AP).Distinct())
                                                        {
                                                            foreach (string rel_kp in lst_format_nilai2.Select(m => m.Rel_KP).Distinct())
                                                            {

                                                                Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(rel_kp);
                                                                if (m_kp != null)
                                                                {
                                                                    if (m_kp.Nama != null)
                                                                    {

                                                                        double nilai = lst_nilai_siswa_det.Where(
                                                                            m => m.Rel_Rapor_StrukturNilai_AP.ToString().Trim().ToUpper() == rel_sn_ap.Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == rel_kp.Trim().ToUpper() &&
                                                                                 m.Rel_Siswa.Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper()
                                                                        ).Select(m => Libs.GetStringToDouble(m.Nilai)).DefaultIfEmpty().Average();

                                                                        lst_formatnilai_nilai2.Add(new FormatNilaiWithNilai
                                                                        {
                                                                            Nama_KP = m_kp.Nama,
                                                                            Nilai = nilai.ToString(),
                                                                            Rel_KP = rel_kp,
                                                                            Rel_StrukturNilai_AP = rel_sn_ap
                                                                        });

                                                                    }
                                                                }

                                                            }
                                                        }

                                                        //get nilai rapor                                                        
                                                        List<NilaiWithKey> lst_nilai = new List<NilaiWithKey>();
                                                        lst_nilai.Clear();
                                                        foreach (string rel_kp in lst_formatnilai_nilai.Select(m => m.Rel_KP).Distinct())
                                                        {

                                                            nilai_rapor = 0;
                                                            jumlah_nilai_rapor = 0;
                                                            count_nilai_rapor = 0;
                                                            foreach (var m_formatnilai_nilai in lst_formatnilai_nilai.FindAll(m => m.Rel_KP == rel_kp))
                                                            {
                                                                Rapor_StrukturNilai_AP m_rel_sn_ap = DAO_Rapor_StrukturNilai_AP.GetByID_Entity(m_formatnilai_nilai.Rel_StrukturNilai_AP);
                                                                if (m_rel_sn_ap != null)
                                                                {
                                                                    if (m_rel_sn_ap.JenisPerhitungan != null)
                                                                    {

                                                                        if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                        {
                                                                            nilai_rapor += Math.Round((m_rel_sn_ap.BobotRapor / 100) * Libs.GetStringToDecimal(m_formatnilai_nilai.Nilai), 3, MidpointRounding.AwayFromZero);
                                                                        }
                                                                        else if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                        {
                                                                            jumlah_nilai_rapor += m_rel_sn_ap.BobotRapor;
                                                                        }
                                                                        count_nilai_rapor++;

                                                                    }
                                                                }
                                                            }

                                                            if (count_nilai_rapor > 0)
                                                            {
                                                                if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_rapor = 0;
                                                            }
                                                            nilai_rapor = Math.Round(nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                            lst_nilai.Add(new NilaiWithKey
                                                            {
                                                                Key = rel_kp,
                                                                Nilai = nilai_rapor
                                                            });
                                                        }

                                                        nilai_rapor = 0;
                                                        jumlah_nilai_rapor = 0;
                                                        count_nilai_rapor = 0;
                                                        List<Rapor_StrukturNilai_KPKelompok> lst_kpkelompok = DAO_Rapor_StrukturNilai_KPKelompok.GetAllByHeader_Entity(
                                                                m_struktur_nilai.Kode.ToString()
                                                            );
                                                        foreach (var item_nilai in lst_nilai)
                                                        {
                                                            Rapor_StrukturNilai_KPKelompok m_kpkelompok = lst_kpkelompok.FindAll(
                                                                    m => m.Rel_Rapor_KomponenPenilaian == new Guid(item_nilai.Key)
                                                                ).FirstOrDefault();
                                                            if (m_kpkelompok != null)
                                                            {
                                                                if (m_kpkelompok.Rel_Rapor_StrukturNilai != null)
                                                                {
                                                                    nilai_rapor += Math.Round((m_kpkelompok.Bobot / 100) * item_nilai.Nilai, 3, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                        }

                                                        decimal nilai_non_q = 0;
                                                        if (lst_formatnilai_nilai2.Count > 0)
                                                        {
                                                            nilai_non_q = lst_formatnilai_nilai2.Select(m => Libs.GetStringToDecimal(m.Nilai)).DefaultIfEmpty().Average();
                                                        }
                                                        if (nilai_non_q > 0)
                                                        {
                                                            nilai_rapor = Math.Round((nilai_rapor + nilai_non_q) / 2, 3, MidpointRounding.AwayFromZero);
                                                        }
                                                        nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);
                                                        nilai_rapor_pengetahuan = nilai_rapor;
                                                        jumlah_keseluruhan += nilai_rapor;
                                                        jumlah_mapel_rapor++;
                                                        lst_all_nilai_rapor.Add(new NilaiWithKey
                                                        {
                                                            Key = (id_kolom_ledger).ToString(),
                                                            Nilai = nilai_rapor_pengetahuan
                                                        });
                                                        //end get nilai rapor
                                                        //end distinct ap
                                                        id_kolom_ledger++;
                                                    }

                                                    jumlah_mapel_rapor++;
                                                }
                                            }
                                            //end get struktur nilai

                                            html_row_body_siswa += "<td style=\"" + css_cell_body + " text-align: center; " + (nilai_rapor_pengetahuan < m_struktur_nilai.KKM ? " font-weight: bold; color: #9C0006; background-color: #FFC7CE; " : "") + "\">" +
                                                                        nilai_rapor_pengetahuan.ToString() +
                                                                   "</td>" +
                                                                   "<td style=\"" + css_cell_body + " text-align: center; " + (nilai_rapor_pengetahuan < m_struktur_nilai.KKM ? " font-weight: bold; color: #9C0006; background-color: #FFC7CE; " : "") + "\">" +
                                                                        GetPredikatRapor(nilai_rapor_pengetahuan) +
                                                                   "</td>";
                                            html_row_body_siswa += "<td style=\"" + css_cell_body + " text-align: center; " + (nilai_rapor_keterampilan < m_struktur_nilai.KKM ? " font-weight: bold; color: #9C0006; background-color: #FFC7CE; " : "") + "\">" +
                                                                        nilai_rapor_keterampilan.ToString() +
                                                                   "</td>" +
                                                                   "<td style=\"" + css_cell_body + " text-align: center; " + (nilai_rapor_keterampilan < m_struktur_nilai.KKM ? " font-weight: bold; color: #9C0006; background-color: #FFC7CE; " : "") + "\">" +
                                                                        GetPredikatRapor(nilai_rapor_keterampilan) +
                                                                   "</td>";
                                        }

                                    }
                                    //end rapor non mulok

                                    id_mulai_looping_rata_rata = id_kolom_ledger + 1;
                                    id_mulai_looping_kkm = jumlah_mapel_rapor + 1;

                                    //rapor mulok
                                    lst_rapor_desain_det = DAO_Rapor_Desain_Det.GetAllByHeader_Entity(rapor_desain.Kode.ToString()).FindAll(m => m.Nomor.Trim() == "" && m.Rel_Mapel.Trim() != "");
                                    foreach (Rapor_Desain_Det item in lst_rapor_desain_det.FindAll(m => m.Rel_Mapel.Trim() != ""))
                                    {

                                        if (item.Rel_Mapel.Trim() != "")
                                        {

                                            lst_nilai_siswa_det_sm1 = lst_nilai_siswa_det_by_periode_sm1.FindAll(
                                                    m => m.Rel_Mapel == item.Rel_Mapel &&
                                                         m.Rel_Siswa == m.Rel_Siswa
                                                );
                                            lst_nilai_siswa_det = lst_nilai_siswa_det_by_periode.FindAll(
                                                    m => m.Rel_Mapel == item.Rel_Mapel &&
                                                         m.Rel_Siswa == m.Rel_Siswa
                                                );

                                            //get struktur nilainya
                                            Rapor_StrukturNilai m_struktur_nilai_sm1 = DAO_Rapor_StrukturNilai.GetATop1ByTABySMByKelasByMapel_Entity(
                                                    tahun_ajaran, "1", m_kelas.Kode.ToString(), item.Rel_Mapel
                                                );

                                            Rapor_StrukturNilai m_struktur_nilai = DAO_Rapor_StrukturNilai.GetATop1ByTABySMByKelasByMapel_Entity(
                                                    tahun_ajaran, semester, m_kelas.Kode.ToString(), item.Rel_Mapel
                                                );

                                            decimal nilai_rapor = 0;
                                            decimal nilai_rapor_mulok_sm1 = 0;
                                            decimal jumlah_nilai_rapor = 0;
                                            decimal count_nilai_rapor = 0;

                                            decimal nilai_rapor_pengetahuan = 0;
                                            if (m_struktur_nilai != null)
                                            {
                                                if (m_struktur_nilai.TahunAjaran != null)
                                                {

                                                    lst_kkm_nilai_rapor.Add(new NilaiWithKey
                                                    {
                                                        Key = (jumlah_mapel_rapor + 1).ToString(),
                                                        Nilai = m_struktur_nilai.KKM
                                                    });
                                                    if (!(m_struktur_nilai.IsKelompokanKP && m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString()))
                                                    {
                                                        decimal jumlah_nilai_ap = 0;
                                                        decimal nilai_ap = 0;
                                                        int count_ap = 0;
                                                        nilai_rapor = 0;
                                                        nilai_rapor_mulok_sm1 = 0;
                                                        List<Rapor_StrukturNilai_AP> lst_rapor_struktur_nilai_ap = new List<Rapor_StrukturNilai_AP>();
                                                        //jika semester 2 get nilai semester 1
                                                        if (m_struktur_nilai.Semester == "2")
                                                        {
                                                            //get struktur nilai det AP
                                                            lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeader_Entity(
                                                                    m_struktur_nilai_sm1.Kode.ToString()
                                                                );
                                                            lst_nilai_ap.Clear();
                                                            lst_nilai_ap_bobot.Clear();
                                                            foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                            {

                                                                //get struktur nilai det KD
                                                                List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                        item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                    );
                                                                lst_nilai_kd.Clear();
                                                                foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                                {

                                                                    //get struktur nilai det KP
                                                                    List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                        item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                    );
                                                                    decimal jumlah_nilai_kd = 0;
                                                                    decimal nilai_kd = 0;
                                                                    int count_kd = 0;
                                                                    foreach (var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp)
                                                                    {
                                                                        Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString());
                                                                        if (m_kp != null)
                                                                        {

                                                                            Rapor_NilaiSiswa_Det m_nilai_det = lst_nilai_siswa_det_sm1.FindAll(
                                                                                m => m.Rel_Siswa.ToString().Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                     m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai_sm1.Rel_Mapel.ToString().Trim().ToUpper() &&
                                                                                     m.Rel_Rapor_StrukturNilai_AP.Trim().ToUpper() == item_rapor_struktur_nilai_ap.Kode.ToString().ToUpper() &&
                                                                                     m.Rel_Rapor_StrukturNilai_KD.Trim().ToUpper() == item_rapor_struktur_nilai_kd.Kode.ToString().ToUpper() &&
                                                                                     m.Rel_Rapor_StrukturNilai_KP.Trim().ToUpper() == item_rapor_struktur_nilai_kp.Kode.ToString().ToUpper()
                                                                            ).FirstOrDefault();

                                                                            if (m_nilai_det != null)
                                                                            {
                                                                                if (m_nilai_det.Nilai.Trim() != "")
                                                                                {
                                                                                    if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                                    {
                                                                                        nilai_kd += Math.Round((item_rapor_struktur_nilai_kp.BobotNK / 100) * Libs.GetStringToDecimal(m_nilai_det.Nilai), 2, MidpointRounding.AwayFromZero);
                                                                                    }
                                                                                    else if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                                    {
                                                                                        jumlah_nilai_kd += Libs.GetStringToDecimal(m_nilai_det.Nilai);
                                                                                    }
                                                                                    count_kd++;
                                                                                }
                                                                            }

                                                                        }

                                                                    }

                                                                    if (count_kd > 0)
                                                                    {
                                                                        if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                        {
                                                                            nilai_kd = Math.Round(jumlah_nilai_kd / count_kd, 2, MidpointRounding.AwayFromZero);
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        nilai_kd = 0;
                                                                    }

                                                                    //load nilai manual
                                                                    Rapor_NilaiSiswa_AP_or_KD m_nilai_manual = DAO_Rapor_NilaiSiswa_AP_or_KD.GetAllByTABySMByKelasByMapelBySiswaByStruktur_Entity(
                                                                            tahun_ajaran, m_struktur_nilai_sm1.Semester, rel_kelas_det, m_siswa.Kode.ToString(), item.Rel_Mapel,
                                                                            item_rapor_struktur_nilai_kd.Kode.ToString().Trim().ToUpper()

                                                                        ).FirstOrDefault();
                                                                    if (m_nilai_manual != null)
                                                                    {
                                                                        if (m_nilai_manual.Nilai != null)
                                                                        {
                                                                            nilai_kd = Libs.GetStringToDecimal(m_nilai_manual.Nilai);
                                                                        }
                                                                    }
                                                                    //end load nilai manual

                                                                    nilai_kd = Math.Round(nilai_kd, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);
                                                                    lst_nilai_kd.Add(nilai_kd);
                                                                    //end get struktur nilai det KP

                                                                }
                                                                //end get struktur nilai det KD

                                                                //get nilai ap
                                                                count_ap = 0;
                                                                nilai_ap = 0;
                                                                jumlah_nilai_ap = 0;
                                                                foreach (var item_nilai_kd in lst_nilai_kd)
                                                                {
                                                                    if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                    {
                                                                        nilai_ap += Math.Round((item_rapor_struktur_nilai_ap.BobotRapor / 100) * item_nilai_kd, 2, MidpointRounding.AwayFromZero);
                                                                    }
                                                                    else if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                    {
                                                                        jumlah_nilai_ap += item_nilai_kd;
                                                                    }
                                                                    count_ap++;
                                                                }
                                                                if (count_ap > 0)
                                                                {
                                                                    if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                    {
                                                                        nilai_ap = Math.Round(jumlah_nilai_ap / count_ap, 2, MidpointRounding.AwayFromZero);
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    nilai_ap = 0;
                                                                }
                                                                nilai_ap = Math.Round(nilai_ap, 0, MidpointRounding.AwayFromZero);
                                                                lst_nilai_ap.Add(nilai_ap);
                                                                lst_nilai_ap_bobot.Add(item_rapor_struktur_nilai_ap.BobotRapor);
                                                                //end get nilai ap

                                                            }
                                                            //end get struktur nilai det AP

                                                            //get nilai rapor
                                                            nilai_rapor = 0;
                                                            jumlah_nilai_rapor = 0;
                                                            count_nilai_rapor = 0;
                                                            foreach (var item_nilai_ap in lst_nilai_ap)
                                                            {
                                                                if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                {
                                                                    nilai_rapor += Math.Round((lst_nilai_ap_bobot[Convert.ToInt16(count_nilai_rapor)] / 100) * item_nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                                else if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    jumlah_nilai_rapor += item_nilai_ap;
                                                                }
                                                                count_nilai_rapor++;
                                                            }
                                                            if (count_nilai_rapor > 0)
                                                            {
                                                                if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_rapor = 0;
                                                            }
                                                            nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);
                                                            nilai_rapor_mulok_sm1 = nilai_rapor;
                                                            //end get nilai rapor
                                                        }
                                                        //end get nilai semester 1

                                                        //-----------nilai pengetahuan---------------
                                                        id_kolom_ledger++;
                                                        //get struktur nilai det AP
                                                        lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeader_Entity(
                                                                m_struktur_nilai.Kode.ToString()
                                                            );
                                                        lst_nilai_ap.Clear();
                                                        lst_nilai_ap_bobot.Clear();
                                                        jumlah_nilai_ap = 0;
                                                        nilai_ap = 0;
                                                        count_ap = 0;
                                                        foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                        {

                                                            //get struktur nilai det KD
                                                            List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                );
                                                            lst_nilai_kd.Clear();
                                                            foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                            {

                                                                //get struktur nilai det KP
                                                                List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                );
                                                                decimal jumlah_nilai_kd = 0;
                                                                decimal nilai_kd = 0;
                                                                int count_kd = 0;
                                                                foreach (var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp)
                                                                {
                                                                    Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString());
                                                                    if (m_kp != null)
                                                                    {

                                                                        Rapor_NilaiSiswa_Det m_nilai_det = lst_nilai_siswa_det.FindAll(
                                                                            m => m.Rel_Siswa.ToString().Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_AP.Trim().ToUpper() == item_rapor_struktur_nilai_ap.Kode.ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KD.Trim().ToUpper() == item_rapor_struktur_nilai_kd.Kode.ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KP.Trim().ToUpper() == item_rapor_struktur_nilai_kp.Kode.ToString().ToUpper()
                                                                        ).FirstOrDefault();

                                                                        if (m_nilai_det != null)
                                                                        {
                                                                            if (m_nilai_det.Nilai.Trim() != "")
                                                                            {
                                                                                if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                                {
                                                                                    nilai_kd += Math.Round((item_rapor_struktur_nilai_kp.BobotNK / 100) * Libs.GetStringToDecimal(m_nilai_det.Nilai), 2, MidpointRounding.AwayFromZero);
                                                                                }
                                                                                else if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                                {
                                                                                    jumlah_nilai_kd += Libs.GetStringToDecimal(m_nilai_det.Nilai);
                                                                                }
                                                                                count_kd++;
                                                                            }
                                                                        }

                                                                    }

                                                                }

                                                                if (count_kd > 0)
                                                                {
                                                                    if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                    {
                                                                        nilai_kd = Math.Round(jumlah_nilai_kd / count_kd, 2, MidpointRounding.AwayFromZero);
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    nilai_kd = 0;
                                                                }

                                                                //load nilai manual
                                                                Rapor_NilaiSiswa_AP_or_KD m_nilai_manual = DAO_Rapor_NilaiSiswa_AP_or_KD.GetAllByTABySMByKelasByMapelBySiswaByStruktur_Entity(
                                                                        tahun_ajaran, semester, rel_kelas_det, m_siswa.Kode.ToString(), item.Rel_Mapel,
                                                                        item_rapor_struktur_nilai_kd.Kode.ToString().Trim().ToUpper()

                                                                    ).FirstOrDefault();
                                                                if (m_nilai_manual != null)
                                                                {
                                                                    if (m_nilai_manual.Nilai != null)
                                                                    {
                                                                        nilai_kd = Libs.GetStringToDecimal(m_nilai_manual.Nilai);
                                                                    }
                                                                }
                                                                //end load nilai manual

                                                                nilai_kd = Math.Round(nilai_kd, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);
                                                                lst_nilai_kd.Add(nilai_kd);
                                                                //end get struktur nilai det KP

                                                            }
                                                            //end get struktur nilai det KD

                                                            //get nilai ap
                                                            count_ap = 0;
                                                            nilai_ap = 0;
                                                            jumlah_nilai_ap = 0;
                                                            foreach (var item_nilai_kd in lst_nilai_kd)
                                                            {
                                                                if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                {
                                                                    nilai_ap += Math.Round((item_rapor_struktur_nilai_ap.BobotRapor / 100) * item_nilai_kd, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                                else if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    jumlah_nilai_ap += item_nilai_kd;
                                                                }
                                                                count_ap++;
                                                            }
                                                            if (count_ap > 0)
                                                            {
                                                                if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_ap = Math.Round(jumlah_nilai_ap / count_ap, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_ap = 0;
                                                            }
                                                            nilai_ap = Math.Round(nilai_ap, 0, MidpointRounding.AwayFromZero);
                                                            lst_nilai_ap.Add(nilai_ap);
                                                            lst_nilai_ap_bobot.Add(item_rapor_struktur_nilai_ap.BobotRapor);
                                                            //end get nilai ap

                                                        }
                                                        //end get struktur nilai det AP

                                                        //get nilai rapor
                                                        nilai_rapor = 0;
                                                        jumlah_nilai_rapor = 0;
                                                        count_nilai_rapor = 0;
                                                        foreach (var item_nilai_ap in lst_nilai_ap)
                                                        {
                                                            if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                            {
                                                                nilai_rapor += Math.Round((lst_nilai_ap_bobot[Convert.ToInt16(count_nilai_rapor)] / 100) * item_nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                            }
                                                            else if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                jumlah_nilai_rapor += item_nilai_ap;
                                                            }
                                                            count_nilai_rapor++;
                                                        }
                                                        if (count_nilai_rapor > 0)
                                                        {
                                                            if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            nilai_rapor = 0;
                                                        }
                                                        nilai_rapor = Math.Round((nilai_rapor + nilai_rapor_mulok_sm1) / 2, 0, MidpointRounding.AwayFromZero);
                                                        nilai_rapor_pengetahuan = nilai_rapor;
                                                        lst_all_nilai_rapor.Add(new NilaiWithKey
                                                        {
                                                            Key = (id_kolom_ledger).ToString(),
                                                            Nilai = nilai_rapor_pengetahuan
                                                        });
                                                        id_kolom_ledger++;
                                                        //end get nilai rapor
                                                        //-----------end nilai pengetahuan---------------
                                                    }
                                                    else 
                                                    {
                                                        nilai_rapor_mulok_sm1 = 0;
                                                        decimal nilai_non_q = 0;
                                                        List<Rapor_StrukturNilai_KPKelompok> lst_kpkelompok = new List<Rapor_StrukturNilai_KPKelompok>();
                                                        List<FormatNilai> lst_format_nilai = new List<FormatNilai>();
                                                        List<Rapor_StrukturNilai_AP> lst_rapor_struktur_nilai_ap = new List<Rapor_StrukturNilai_AP>();
                                                        List<FormatNilai> lst_format_nilai2 = new List<FormatNilai>();
                                                        List<FormatNilaiWithNilai> lst_formatnilai_nilai = new List<FormatNilaiWithNilai>();
                                                        List<FormatNilaiWithNilai> lst_formatnilai_nilai2 = new List<FormatNilaiWithNilai>();
                                                        List<NilaiWithKey> lst_nilai = new List<NilaiWithKey>();

                                                        //jika semester 2 get nilai semester 1
                                                        if (m_struktur_nilai.Semester == "2")
                                                        {
                                                            lst_format_nilai = new List<FormatNilai>();
                                                            lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeader_Entity(
                                                                    m_struktur_nilai_sm1.Kode.ToString()
                                                                );
                                                            foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                            {

                                                                List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                        item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                    );

                                                                foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                                {

                                                                    List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                        item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                    );
                                                                    foreach (
                                                                        var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp.FindAll(
                                                                            m => (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == DAO_Rapor_StrukturNilai.Arr_KP_Quran[0]) ||
                                                                                 (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == DAO_Rapor_StrukturNilai.Arr_KP_Quran[1]) ||
                                                                                 (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == DAO_Rapor_StrukturNilai.Arr_KP_Quran[2])
                                                                            )
                                                                    )
                                                                    {

                                                                        if (
                                                                            lst_format_nilai.FindAll(
                                                                                    m => m.Rel_StrukturNilai_AP == item_rapor_struktur_nilai_ap.Kode.ToString() &&
                                                                                         m.Rel_KP == item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                                ).Count == 0
                                                                        )
                                                                        {
                                                                            lst_format_nilai.Add(new FormatNilai
                                                                            {
                                                                                Rel_StrukturNilai_AP = item_rapor_struktur_nilai_ap.Kode.ToString(),
                                                                                Rel_KP = item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                            });
                                                                        }

                                                                    }
                                                                }

                                                            }

                                                            lst_format_nilai2 = new List<FormatNilai>();
                                                            foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                            {

                                                                List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                        item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                    );

                                                                foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                                {

                                                                    List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                        item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                    );
                                                                    foreach (
                                                                        var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp.FindAll(
                                                                            m => (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() != DAO_Rapor_StrukturNilai.Arr_KP_Quran[0]) &&
                                                                                 (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() != DAO_Rapor_StrukturNilai.Arr_KP_Quran[1]) &&
                                                                                 (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() != DAO_Rapor_StrukturNilai.Arr_KP_Quran[2])
                                                                            )
                                                                    )
                                                                    {

                                                                        if (
                                                                            lst_format_nilai2.FindAll(
                                                                                    m => m.Rel_StrukturNilai_AP == item_rapor_struktur_nilai_ap.Kode.ToString() &&
                                                                                         m.Rel_KP == item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                                ).Count == 0
                                                                        )
                                                                        {
                                                                            lst_format_nilai2.Add(new FormatNilai
                                                                            {
                                                                                Rel_StrukturNilai_AP = item_rapor_struktur_nilai_ap.Kode.ToString(),
                                                                                Rel_KP = item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                            });
                                                                        }

                                                                    }
                                                                }

                                                            }

                                                            lst_formatnilai_nilai = new List<FormatNilaiWithNilai>();
                                                            //distinct ap
                                                            foreach (string rel_sn_ap in lst_format_nilai.Select(m => m.Rel_StrukturNilai_AP).Distinct())
                                                            {
                                                                foreach (string rel_kp in lst_format_nilai.Select(m => m.Rel_KP).Distinct())
                                                                {

                                                                    Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(rel_kp);
                                                                    if (m_kp != null)
                                                                    {
                                                                        if (m_kp.Nama != null)
                                                                        {

                                                                            double nilai = lst_nilai_siswa_det_sm1.Where(
                                                                                m => m.Rel_Rapor_StrukturNilai_AP.ToString().Trim().ToUpper() == rel_sn_ap.Trim().ToUpper() &&
                                                                                     m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == rel_kp.Trim().ToUpper() &&
                                                                                     m.Rel_Siswa.Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                     m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai_sm1.Rel_Mapel.ToString().Trim().ToUpper()
                                                                            ).Select(m => Libs.GetStringToDouble(m.Nilai)).DefaultIfEmpty().Average();

                                                                            lst_formatnilai_nilai.Add(new FormatNilaiWithNilai
                                                                            {
                                                                                Nama_KP = m_kp.Nama,
                                                                                Nilai = nilai.ToString(),
                                                                                Rel_KP = rel_kp,
                                                                                Rel_StrukturNilai_AP = rel_sn_ap
                                                                            });

                                                                        }
                                                                    }

                                                                }
                                                            }

                                                            lst_formatnilai_nilai2 = new List<FormatNilaiWithNilai>();
                                                            //distinct ap
                                                            foreach (string rel_sn_ap in lst_format_nilai2.Select(m => m.Rel_StrukturNilai_AP).Distinct())
                                                            {
                                                                foreach (string rel_kp in lst_format_nilai2.Select(m => m.Rel_KP).Distinct())
                                                                {

                                                                    Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(rel_kp);
                                                                    if (m_kp != null)
                                                                    {
                                                                        if (m_kp.Nama != null)
                                                                        {

                                                                            double nilai = lst_nilai_siswa_det_sm1.Where(
                                                                                m => m.Rel_Rapor_StrukturNilai_AP.ToString().Trim().ToUpper() == rel_sn_ap.Trim().ToUpper() &&
                                                                                     m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == rel_kp.Trim().ToUpper() &&
                                                                                     m.Rel_Siswa.Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                     m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai_sm1.Rel_Mapel.ToString().Trim().ToUpper()
                                                                            ).Select(m => Libs.GetStringToDouble(m.Nilai)).DefaultIfEmpty().Average();

                                                                            lst_formatnilai_nilai2.Add(new FormatNilaiWithNilai
                                                                            {
                                                                                Nama_KP = m_kp.Nama,
                                                                                Nilai = nilai.ToString(),
                                                                                Rel_KP = rel_kp,
                                                                                Rel_StrukturNilai_AP = rel_sn_ap
                                                                            });

                                                                        }
                                                                    }

                                                                }
                                                            }

                                                            //get nilai rapor                                                        
                                                            lst_nilai = new List<NilaiWithKey>();
                                                            lst_nilai.Clear();
                                                            foreach (string rel_kp in lst_formatnilai_nilai.Select(m => m.Rel_KP).Distinct())
                                                            {

                                                                nilai_rapor = 0;
                                                                jumlah_nilai_rapor = 0;
                                                                count_nilai_rapor = 0;
                                                                foreach (var m_formatnilai_nilai in lst_formatnilai_nilai.FindAll(m => m.Rel_KP == rel_kp))
                                                                {
                                                                    Rapor_StrukturNilai_AP m_rel_sn_ap = DAO_Rapor_StrukturNilai_AP.GetByID_Entity(m_formatnilai_nilai.Rel_StrukturNilai_AP);
                                                                    if (m_rel_sn_ap != null)
                                                                    {
                                                                        if (m_rel_sn_ap.JenisPerhitungan != null)
                                                                        {

                                                                            if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                            {
                                                                                nilai_rapor += Math.Round((m_rel_sn_ap.BobotRapor / 100) * Libs.GetStringToDecimal(m_formatnilai_nilai.Nilai), 3, MidpointRounding.AwayFromZero);
                                                                            }
                                                                            else if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                            {
                                                                                jumlah_nilai_rapor += m_rel_sn_ap.BobotRapor;
                                                                            }
                                                                            count_nilai_rapor++;

                                                                        }
                                                                    }
                                                                }

                                                                if (count_nilai_rapor > 0)
                                                                {
                                                                    if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                    {
                                                                        nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    nilai_rapor = 0;
                                                                }
                                                                nilai_rapor = Math.Round(nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                                lst_nilai.Add(new NilaiWithKey
                                                                {
                                                                    Key = rel_kp,
                                                                    Nilai = nilai_rapor
                                                                });
                                                            }

                                                            nilai_rapor = 0;
                                                            jumlah_nilai_rapor = 0;
                                                            count_nilai_rapor = 0;
                                                            lst_kpkelompok = DAO_Rapor_StrukturNilai_KPKelompok.GetAllByHeader_Entity(
                                                                    m_struktur_nilai_sm1.Kode.ToString()
                                                                );
                                                            foreach (var item_nilai in lst_nilai)
                                                            {
                                                                Rapor_StrukturNilai_KPKelompok m_kpkelompok = lst_kpkelompok.FindAll(
                                                                        m => m.Rel_Rapor_KomponenPenilaian == new Guid(item_nilai.Key)
                                                                    ).FirstOrDefault();
                                                                if (m_kpkelompok != null)
                                                                {
                                                                    if (m_kpkelompok.Rel_Rapor_StrukturNilai != null)
                                                                    {
                                                                        nilai_rapor += Math.Round((m_kpkelompok.Bobot / 100) * item_nilai.Nilai, 3, MidpointRounding.AwayFromZero);
                                                                    }
                                                                }
                                                            }

                                                            nilai_non_q = 0;
                                                            if (lst_formatnilai_nilai2.Count > 0)
                                                            {
                                                                nilai_non_q = lst_formatnilai_nilai2.Select(m => Libs.GetStringToDecimal(m.Nilai)).DefaultIfEmpty().Average();
                                                            }
                                                            if (nilai_non_q > 0)
                                                            {
                                                                nilai_rapor = Math.Round((nilai_rapor + nilai_non_q) / 2, 3, MidpointRounding.AwayFromZero);
                                                            }
                                                            nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);
                                                            nilai_rapor_mulok_sm1 = nilai_rapor;
                                                        }
                                                        //end get nilai semester 1

                                                        id_kolom_ledger++;
                                                        lst_format_nilai = new List<FormatNilai>();
                                                        lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeader_Entity(
                                                                m_struktur_nilai.Kode.ToString()
                                                            );
                                                        foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap){

                                                            List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                );

                                                            foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                            {

                                                                List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                );
                                                                foreach (
                                                                    var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp.FindAll(
                                                                        m => (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == DAO_Rapor_StrukturNilai.Arr_KP_Quran[0]) ||
                                                                             (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == DAO_Rapor_StrukturNilai.Arr_KP_Quran[1]) ||
                                                                             (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == DAO_Rapor_StrukturNilai.Arr_KP_Quran[2])
                                                                        )
                                                                )
                                                                {

                                                                    if (
                                                                        lst_format_nilai.FindAll(
                                                                                m => m.Rel_StrukturNilai_AP == item_rapor_struktur_nilai_ap.Kode.ToString() &&
                                                                                     m.Rel_KP == item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                            ).Count == 0
                                                                    )
                                                                    {
                                                                        lst_format_nilai.Add(new FormatNilai
                                                                        {
                                                                            Rel_StrukturNilai_AP = item_rapor_struktur_nilai_ap.Kode.ToString(),
                                                                            Rel_KP = item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                        });
                                                                    }

                                                                }
                                                            }

                                                        }

                                                        lst_format_nilai2 = new List<FormatNilai>();
                                                        foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                        {

                                                            List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                );

                                                            foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                            {

                                                                List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                );
                                                                foreach (
                                                                    var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp.FindAll(
                                                                        m => (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() != DAO_Rapor_StrukturNilai.Arr_KP_Quran[0]) &&
                                                                             (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() != DAO_Rapor_StrukturNilai.Arr_KP_Quran[1]) &&
                                                                             (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() != DAO_Rapor_StrukturNilai.Arr_KP_Quran[2])
                                                                        )
                                                                ){

                                                                    if (
                                                                        lst_format_nilai2.FindAll(
                                                                                m => m.Rel_StrukturNilai_AP == item_rapor_struktur_nilai_ap.Kode.ToString() &&
                                                                                     m.Rel_KP == item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                            ).Count == 0
                                                                    )
                                                                    {
                                                                        lst_format_nilai2.Add(new FormatNilai
                                                                        {
                                                                            Rel_StrukturNilai_AP = item_rapor_struktur_nilai_ap.Kode.ToString(),
                                                                            Rel_KP = item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                        });
                                                                    }

                                                                }
                                                            }

                                                        }

                                                        lst_formatnilai_nilai = new List<FormatNilaiWithNilai>();
                                                        //distinct ap
                                                        foreach (string rel_sn_ap in lst_format_nilai.Select(m => m.Rel_StrukturNilai_AP).Distinct())
                                                        {
                                                            foreach (string rel_kp in lst_format_nilai.Select(m => m.Rel_KP).Distinct())
                                                            {

                                                                Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(rel_kp);
                                                                if (m_kp != null)
                                                                {
                                                                    if (m_kp.Nama != null)
                                                                    {

                                                                        double nilai = lst_nilai_siswa_det.Where(
                                                                            m => m.Rel_Rapor_StrukturNilai_AP.ToString().Trim().ToUpper() == rel_sn_ap.Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == rel_kp.Trim().ToUpper() &&
                                                                                 m.Rel_Siswa.Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper()
                                                                        ).Select(m => Libs.GetStringToDouble(m.Nilai)).DefaultIfEmpty().Average();

                                                                        lst_formatnilai_nilai.Add(new FormatNilaiWithNilai
                                                                        {
                                                                            Nama_KP = m_kp.Nama,
                                                                            Nilai = nilai.ToString(),
                                                                            Rel_KP = rel_kp,
                                                                            Rel_StrukturNilai_AP = rel_sn_ap
                                                                        });

                                                                    }
                                                                }

                                                            }
                                                        }

                                                        lst_formatnilai_nilai2 = new List<FormatNilaiWithNilai>();
                                                        //distinct ap
                                                        foreach (string rel_sn_ap in lst_format_nilai2.Select(m => m.Rel_StrukturNilai_AP).Distinct())
                                                        {
                                                            foreach (string rel_kp in lst_format_nilai2.Select(m => m.Rel_KP).Distinct())
                                                            {

                                                                Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(rel_kp);
                                                                if (m_kp != null)
                                                                {
                                                                    if (m_kp.Nama != null)
                                                                    {

                                                                        double nilai = lst_nilai_siswa_det.Where(
                                                                            m => m.Rel_Rapor_StrukturNilai_AP.ToString().Trim().ToUpper() == rel_sn_ap.Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == rel_kp.Trim().ToUpper() &&
                                                                                 m.Rel_Siswa.Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper()
                                                                        ).Select(m => Libs.GetStringToDouble(m.Nilai)).DefaultIfEmpty().Average();

                                                                        lst_formatnilai_nilai2.Add(new FormatNilaiWithNilai
                                                                        {
                                                                            Nama_KP = m_kp.Nama,
                                                                            Nilai = nilai.ToString(),
                                                                            Rel_KP = rel_kp,
                                                                            Rel_StrukturNilai_AP = rel_sn_ap
                                                                        });

                                                                    }
                                                                }

                                                            }
                                                        }

                                                        //get nilai rapor                                                        
                                                        lst_nilai = new List<NilaiWithKey>();
                                                        lst_nilai.Clear();
                                                        foreach (string rel_kp in lst_formatnilai_nilai.Select(m => m.Rel_KP).Distinct())
                                                        {

                                                            nilai_rapor = 0;
                                                            jumlah_nilai_rapor = 0;
                                                            count_nilai_rapor = 0;
                                                            foreach (var m_formatnilai_nilai in lst_formatnilai_nilai.FindAll(m => m.Rel_KP == rel_kp))
                                                            {
                                                                Rapor_StrukturNilai_AP m_rel_sn_ap = DAO_Rapor_StrukturNilai_AP.GetByID_Entity(m_formatnilai_nilai.Rel_StrukturNilai_AP);
                                                                if (m_rel_sn_ap != null)
                                                                {
                                                                    if (m_rel_sn_ap.JenisPerhitungan != null)
                                                                    {

                                                                        if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                        {
                                                                            nilai_rapor += Math.Round((m_rel_sn_ap.BobotRapor / 100) * Libs.GetStringToDecimal(m_formatnilai_nilai.Nilai), 3, MidpointRounding.AwayFromZero);
                                                                        }
                                                                        else if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                        {
                                                                            jumlah_nilai_rapor += m_rel_sn_ap.BobotRapor;
                                                                        }
                                                                        count_nilai_rapor++;

                                                                    }
                                                                }
                                                            }

                                                            if (count_nilai_rapor > 0)
                                                            {
                                                                if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_rapor = 0;
                                                            }
                                                            nilai_rapor = Math.Round(nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                            lst_nilai.Add(new NilaiWithKey
                                                            {
                                                                Key = rel_kp,
                                                                Nilai = nilai_rapor
                                                            });
                                                        }

                                                        nilai_rapor = 0;
                                                        jumlah_nilai_rapor = 0;
                                                        count_nilai_rapor = 0;
                                                        lst_kpkelompok = DAO_Rapor_StrukturNilai_KPKelompok.GetAllByHeader_Entity(
                                                                m_struktur_nilai.Kode.ToString()
                                                            );
                                                        foreach (var item_nilai in lst_nilai)
                                                        {
                                                            Rapor_StrukturNilai_KPKelompok m_kpkelompok = lst_kpkelompok.FindAll(
                                                                    m => m.Rel_Rapor_KomponenPenilaian == new Guid(item_nilai.Key)
                                                                ).FirstOrDefault();
                                                            if (m_kpkelompok != null)
                                                            {
                                                                if (m_kpkelompok.Rel_Rapor_StrukturNilai != null)
                                                                {
                                                                    nilai_rapor += Math.Round((m_kpkelompok.Bobot / 100) * item_nilai.Nilai, 3, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                        }

                                                        nilai_non_q = 0;
                                                        if (lst_formatnilai_nilai2.Count > 0)
                                                        {
                                                            nilai_non_q = lst_formatnilai_nilai2.Select(m => Libs.GetStringToDecimal(m.Nilai)).DefaultIfEmpty().Average();
                                                        }
                                                        if (nilai_non_q > 0)
                                                        {
                                                            nilai_rapor = Math.Round((nilai_rapor + nilai_non_q) / 2, 3, MidpointRounding.AwayFromZero);
                                                        }
                                                        nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);
                                                        nilai_rapor_pengetahuan = Math.Round((nilai_rapor + nilai_rapor_mulok_sm1) / 2, 0, MidpointRounding.AwayFromZero);
                                                        jumlah_keseluruhan += nilai_rapor_pengetahuan;
                                                        jumlah_mapel_rapor++;
                                                        lst_all_nilai_rapor.Add(new NilaiWithKey
                                                        {
                                                            Key = (id_kolom_ledger).ToString(),
                                                            Nilai = nilai_rapor_pengetahuan
                                                        });
                                                        //end get nilai rapor
                                                        //end distinct ap
                                                        id_kolom_ledger++;
                                                    }

                                                    jumlah_mapel_rapor++;
                                                }
                                            }
                                            //end get struktur nilai

                                            html_row_body_siswa += "<td style=\"" + css_cell_body + " text-align: center; " + (nilai_rapor_pengetahuan < m_struktur_nilai.KKM ? " font-weight: bold; color: #9C0006; background-color: #FFC7CE; " : "") + "\">" +
                                                                        nilai_rapor_pengetahuan.ToString() +
                                                                   "</td>" +
                                                                   "<td style=\"" + css_cell_body + " text-align: center; " + (nilai_rapor_pengetahuan < m_struktur_nilai.KKM ? " font-weight: bold; color: #9C0006; background-color: #FFC7CE; " : "") + "\">" +
                                                                        GetPredikatRapor(nilai_rapor_pengetahuan) +
                                                                   "</td>";
                                        }

                                    }
                                    //end rapor mulok

                                    lst_jumlah_nilai_keseluruhan.Add(new NilaiWithKey
                                    {
                                        Key = m_siswa.Kode.ToString(),
                                        Nilai = jumlah_keseluruhan
                                    });

                                    //absen
                                    string s_sakit = "-";
                                    string s_izin = "-";
                                    string s_alpa = "-";
                                    string s_terlambat = "-";

                                    Rapor_Arsip m_rapor_arsip = DAO_Rapor_Arsip.GetAll_Entity().FindAll(
                                            m0 => m0.TahunAjaran == tahun_ajaran &&
                                                  m0.Semester == semester &&
                                                  m0.JenisRapor == "Semester"

                                        ).FirstOrDefault();
                                    List<DAO_SiswaAbsen.AbsenRekapRapor> lst_absen = new List<DAO_SiswaAbsen.AbsenRekapRapor>();
                                    lst_absen = DAO_SiswaAbsen.GetRekapAbsenRaporBySiswaByPeriode_Entity(
                                            m_siswa.Kode.ToString(),
                                            (m_rapor_arsip != null ? m_rapor_arsip.TanggalAwalAbsen : DateTime.MinValue),
                                            (m_rapor_arsip != null ? m_rapor_arsip.TanggalAkhirAbsen : DateTime.MinValue)
                                        );
                                    foreach (var absen in lst_absen)
                                    {
                                        if (absen.Absen == Libs.JENIS_ABSENSI.SAKIT.Substring(0, 1)) s_sakit = absen.Jumlah.ToString();
                                        if (absen.Absen == Libs.JENIS_ABSENSI.IZIN.Substring(0, 1)) s_izin = absen.Jumlah.ToString();
                                        if (absen.Absen == Libs.JENIS_ABSENSI.ALPA.Substring(0, 1)) s_alpa = absen.Jumlah.ToString();
                                        if (absen.Absen == Libs.JENIS_ABSENSI.TERLAMBAT.Substring(0, 1)) s_terlambat = absen.Jumlah.ToString();
                                    }
                                    html_row_body_siswa += "<td style=\"" + css_cell_body + " text-align: center; \">" +
                                                                s_sakit +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + " text-align: center; \">" +
                                                                s_izin +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + " text-align: center; \">" +
                                                                s_alpa +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + " text-align: center; \">" +
                                                                s_terlambat +
                                                           "</td>";
                                    //end absen

                                    html_row_body += "<tr>" +
                                                        html_row_body_siswa +
                                                     "</tr>";

                                    nomor++;
                                }
                                // end foreach siswa
                                
                                for (int i = (jumlah_awal_col_ledger + 1); i <= id_kolom_ledger; i++)
                                {
                                    if (i >= id_mulai_looping_rata_rata)
                                    {
                                        decimal rata_rata = Math.Round(lst_all_nilai_rapor.FindAll(m => m.Key == i.ToString()).Select(m => m.Nilai).DefaultIfEmpty().Average(), Constantas.PEMBULATAN_DESIMAL_NILAI_SD);
                                        html_row_rata_rata += "<td style=\"" + css_cell_body + " text-align: right;\">" +
                                                                    (
                                                                        rata_rata > 0
                                                                        ? Libs.GetFormatBilangan(rata_rata, Constantas.PEMBULATAN_DESIMAL_NILAI_SD)
                                                                        : ""
                                                                    ) +
                                                              "</td>";
                                    }
                                    else
                                    {
                                        decimal rata_rata = Math.Round(lst_all_nilai_rapor.FindAll(m => m.Key == i.ToString()).Select(m => m.Nilai).DefaultIfEmpty().Average(), Constantas.PEMBULATAN_DESIMAL_NILAI_SD);
                                        html_row_rata_rata += "<td style=\"" + css_cell_body + " text-align: right;\">" +
                                                                    (
                                                                        rata_rata > 0
                                                                        ? Libs.GetFormatBilangan(rata_rata, Constantas.PEMBULATAN_DESIMAL_NILAI_SD)
                                                                        : ""
                                                                    ) +
                                                              "</td>";
                                    }                             
                                }
                                for (int i = 1; i < jumlah_mapel_rapor - 1; i++)
                                {
                                    if (i > id_mulai_looping_kkm)
                                    {
                                        decimal kkm = 0;
                                        NilaiWithKey m_kkm = lst_kkm_nilai_rapor.FindAll(m => m.Key == i.ToString()).FirstOrDefault();
                                        if (m_kkm != null)
                                        {
                                            if (m_kkm.Key != null)
                                            {
                                                kkm = m_kkm.Nilai;
                                            }
                                        }
                                        html_row_kkm += "<td colspan=\"2\" style=\"" + css_cell_body + " text-align: center;\">" +
                                                            Libs.GetFormatBilangan(kkm, Constantas.PEMBULATAN_DESIMAL_NILAI_SD) +
                                                        "</td>";
                                    }
                                    else
                                    {
                                        decimal kkm = 0;
                                        NilaiWithKey m_kkm = lst_kkm_nilai_rapor.FindAll(m => m.Key == i.ToString()).FirstOrDefault();
                                        if (m_kkm != null)
                                        {
                                            if (m_kkm.Key != null)
                                            {
                                                kkm = m_kkm.Nilai;
                                            }
                                        }
                                        html_row_kkm += "<td colspan=\"4\" style=\"" + css_cell_body + " text-align: center;\">" +
                                                            Libs.GetFormatBilangan(kkm, Constantas.PEMBULATAN_DESIMAL_NILAI_SD) +
                                                        "</td>";
                                    }
                                }
                                decimal rata_rata_nilai_keseluruhan = Math.Round(lst_jumlah_nilai_keseluruhan.Select(m => m.Nilai).DefaultIfEmpty().Average(), Constantas.PEMBULATAN_DESIMAL_NILAI_SD);
                                decimal rata_rata_nilai_rata_rata_rapor = Math.Round(lst_nilai_rapor.Select(m => m.Nilai).DefaultIfEmpty().Average(), Constantas.PEMBULATAN_DESIMAL_NILAI_SD);
                                html_row_body += "<tr>" +
                                                    html_row_rata_rata +
                                                 "</tr>" +
                                                 "<tr>" +
                                                    html_row_kkm +
                                                 "</tr>";

                            }

                        }
                    }

                }
            }

            html_row_header = "<tr>" +
                                html_row_header +
                              "</tr>" +
                              "<tr>" +
                                html_row_mapel +
                              "</tr>" +
                              "<tr>" +
                                html_row_jenis_nilai +
                              "</tr>" +
                              html_row_body;

            html = "<table style=\"border-collapse: collapse;\">" +
                        html_row_header +
                   "</table>";

            return html;
        }

        public static string GetHTMLLedger_KURTILAS(
            System.Web.UI.Page page,
            string tahun_ajaran,
            string semester,
            string rel_kelas_det,
            string rel_siswa = ""
        )
        {
            string css_cell_headers = "border-style: solid; border-width: 1px; text-align: center; font-weight: bold; padding: 5px;";
            string css_cell_body = "border-style: solid; border-width: 1px; padding: 3px;";

            string html = "";
            string html_row_header = "<td rowspan=\"3\" style=\"" + css_cell_headers + "\">" +
                                        "No" +
                                     "</td>" +
                                     "<td rowspan=\"3\" style=\"" + css_cell_headers + "\">" +
                                        "NIS" +
                                     "</td>" +
                                     "<td rowspan=\"3\" style=\"" + css_cell_headers + "\">" +
                                        "NAMA LENGKAP" +
                                     "</td>" +
                                     "<td rowspan=\"3\" style=\"" + css_cell_headers + "\">" +
                                        "L/P" +
                                     "</td>";
            string html_row_mapel = "";
            string html_row_jenis_nilai = "";
            string html_row_body = "";

            KelasDet m_kelas_det = DAO_KelasDet.GetByID_Entity(rel_kelas_det);
            if (m_kelas_det != null)
            {
                if (m_kelas_det.Nama != null)
                {

                    Kelas m_kelas = DAO_Kelas.GetByID_Entity(m_kelas_det.Rel_Kelas.ToString());
                    if (m_kelas != null)
                    {
                        if (m_kelas.Nama != null)
                        {

                            Rapor_Desain rapor_desain = DAO_Rapor_Desain.GetByTABySMByKelas_Entity(
                                    tahun_ajaran, semester, rel_kelas_det, DAO_Rapor_Desain.JenisRapor.Semester
                                ).FirstOrDefault();

                            List<Rapor_Desain_Det> lst_rapor_desain_det = DAO_Rapor_Desain_Det.GetAllByHeader_Entity(rapor_desain.Kode.ToString()).FindAll(m => m.Nomor.Trim() != "" && m.Rel_Mapel.Trim() != "");

                            //list cols header
                            int jml_colspan_mapel = 0;
                            int jumlah_mapel = 0;
                            html_row_mapel = "";
                            foreach (Rapor_Desain_Det item_desain_det in lst_rapor_desain_det)
                            {
                                html_row_mapel += "<td colspan=\"4\" style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                    item_desain_det.NamaMapelRapor.Trim().ToUpper() +
                                                  "</td>";
                                html_row_jenis_nilai += "<td style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                                "PENGETAHUAN" +
                                                        "</td>" +
                                                        "<td style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                                "PREDIKAT" +
                                                        "</td>" +
                                                        "<td style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                                "KETERAMPILAN" +
                                                        "</td>" +
                                                        "<td style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                                "PREDIKAT" +
                                                        "</td>";
                                jumlah_mapel++;
                            }
                            jml_colspan_mapel = (jumlah_mapel * 4);

                            lst_rapor_desain_det = DAO_Rapor_Desain_Det.GetAllByHeader_Entity(rapor_desain.Kode.ToString()).FindAll(m => m.Nomor.Trim() == "" && m.Rel_Mapel.Trim() != "");
                            foreach (Rapor_Desain_Det item_desain_det in lst_rapor_desain_det)
                            {
                                html_row_mapel += "<td colspan=\"2\" style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                    item_desain_det.NamaMapelRapor.Trim().ToUpper() +
                                                  "</td>";
                                html_row_jenis_nilai += "<td style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                                "NILAI" +
                                                        "</td>" +
                                                        "<td style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                                "PREDIKAT" +
                                                        "</td>";
                                jumlah_mapel++;
                                jml_colspan_mapel += 2;
                            }

                            html_row_header += "<td colspan=\"" + jml_colspan_mapel.ToString() + "\" style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                    "NILAI MATA PELAJARAN" +
                                               "</td>";
                            html_row_header += "<td colspan=\"4\" style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                    "PRESENSI" +
                                               "</td>";
                            html_row_mapel += "<td rowspan=\"2\" style=\"" + css_cell_headers + " width: 30px; font-size: 8.5px; \">" +
                                                    "S" +
                                              "</td>" +
                                              "<td rowspan=\"2\" style=\"" + css_cell_headers + " width: 30px; font-size: 8.5px; \">" +
                                                    "I" +
                                              "</td>" +
                                              "<td rowspan=\"2\" style=\"" + css_cell_headers + " width: 30px; font-size: 8.5px; \">" +
                                                    "A" +
                                              "</td>" +
                                              "<td rowspan=\"2\" style=\"" + css_cell_headers + " width: 30px; font-size: 8.5px; \">" +
                                                    "T" +
                                              "</td>";
                            //end list cols header
                            if (rapor_desain != null)
                            {

                                List<DAO_Siswa.SiswaDataSimple> lst_siswa = DAO_Siswa.GetAllSiswaDataSimpleByTahunAjaranUnitKelas_Entity(
                                        m_kelas.Rel_Sekolah.ToString(),
                                        rel_kelas_det,
                                        tahun_ajaran,
                                        semester
                                    );
                                List<decimal> lst_nilai_ap = new List<decimal>();
                                List<decimal> lst_nilai_ap_bobot = new List<decimal>();
                                List<decimal> lst_nilai_kd = new List<decimal>();
                                List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT> lst_nilai_siswa_det = new List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT>();
                                List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT> lst_nilai_siswa_det_by_periode = new List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT>();
                                List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT> lst_nilai_siswa_det_sm1 = new List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT>();
                                List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT> lst_nilai_siswa_det_by_periode_sm1 = new List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT>();

                                lst_nilai_siswa_det_by_periode = DAO_Rapor_NilaiSiswa_Det.GetAllByTABySMByKelasDet_Entity(
                                        tahun_ajaran, semester, rel_kelas_det
                                    );
                                lst_nilai_siswa_det_by_periode_sm1 = DAO_Rapor_NilaiSiswa_Det.GetAllByTABySMByKelasDet_Entity(
                                        tahun_ajaran, "1", rel_kelas_det
                                    );

                                int id_kolom_ledger = 0;
                                int nomor = 1;
                                int jumlah_awal_col_ledger = 3;
                                int jumlah_mapel_rapor = 0;

                                if (rel_siswa.Trim() != "")
                                {
                                    lst_siswa = lst_siswa.FindAll(m0 => (rel_siswa + ";").Trim().ToUpper().IndexOf(m0.Kode.ToString().ToUpper() + ";") >= 0).ToList();
                                }
                                List<NilaiWithKey> lst_all_nilai_rapor = new List<NilaiWithKey>();
                                List<NilaiWithKey> lst_kkm_nilai_rapor = new List<NilaiWithKey>();
                                List<NilaiWithKey> lst_jumlah_nilai_keseluruhan = new List<NilaiWithKey>();
                                List<NilaiWithKey> lst_nilai_rapor = new List<NilaiWithKey>();
                                decimal jumlah_keseluruhan = 0;

                                string html_row_rata_rata = "<td colspan=\"4\" style=\"" + css_cell_body + " font-weight: bold;\">" +
                                                                "RATA-RATA KELAS" +
                                                            "</td>";
                                string html_row_kkm = "<td colspan=\"4\" style=\"" + css_cell_body + " font-weight: bold;\">" +
                                                            "KKM" +
                                                      "</td>";

                                int id_mulai_looping_rata_rata = id_kolom_ledger + 1;
                                int id_mulai_looping_kkm = jumlah_mapel_rapor + 1;

                                foreach (DAO_Siswa.SiswaDataSimple m_siswa in lst_siswa.OrderBy(m => m.Nama))
                                {
                                    jumlah_keseluruhan = 0;
                                    jumlah_mapel_rapor = 0;

                                    string html_row_body_siswa = "";
                                    html_row_body_siswa += "<td style=\"" + css_cell_body + " text-align: center;\">" +
                                                                nomor.ToString() +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + "\">" +
                                                                m_siswa.NISSekolah +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + " white-space: nowrap;\">" +
                                                                Libs.GetPerbaikiEjaanNama(m_siswa.Nama) +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + "\">" +
                                                                m_siswa.JenisKelamin +
                                                           "</td>";

                                    lst_kkm_nilai_rapor.Clear();
                                    id_kolom_ledger = jumlah_awal_col_ledger;

                                    //nilai non mulok
                                    foreach (Rapor_Desain_Det item in DAO_Rapor_Desain_Det.GetAllByHeader_Entity(rapor_desain.Kode.ToString()).FindAll(m => m.Nomor.Trim() != "" && m.Rel_Mapel.Trim() != ""))
                                    {

                                        if (item.Rel_Mapel.Trim() != "")
                                        {

                                            lst_nilai_siswa_det = lst_nilai_siswa_det_by_periode.FindAll(
                                                    m => m.Rel_Mapel == item.Rel_Mapel &&
                                                         m.Rel_Siswa == m.Rel_Siswa
                                                );
                                            lst_nilai_siswa_det_sm1 = lst_nilai_siswa_det_by_periode_sm1.FindAll(
                                                    m => m.Rel_Mapel == item.Rel_Mapel &&
                                                         m.Rel_Siswa == m.Rel_Siswa
                                                );

                                            //get struktur nilainya
                                            Rapor_StrukturNilai m_struktur_nilai_sm1 = DAO_Rapor_StrukturNilai.GetATop1ByTABySMByKelasByMapel_Entity(
                                                    tahun_ajaran, "1", m_kelas.Kode.ToString(), item.Rel_Mapel
                                                );
                                            Rapor_StrukturNilai m_struktur_nilai = DAO_Rapor_StrukturNilai.GetATop1ByTABySMByKelasByMapel_Entity(
                                                    tahun_ajaran, semester, m_kelas.Kode.ToString(), item.Rel_Mapel
                                                );

                                            decimal nilai_rapor = 0;
                                            decimal jumlah_nilai_rapor = 0;
                                            decimal count_nilai_rapor = 0;

                                            decimal nilai_rapor_pengetahuan_sm1 = 0;
                                            decimal nilai_rapor_keterampilan_sm1 = 0;
                                            decimal nilai_rapor_pengetahuan = 0;
                                            decimal nilai_rapor_keterampilan = 0;

                                            Rapor_StrukturNilai_AP m_sn_ap = new Rapor_StrukturNilai_AP();

                                            if (m_struktur_nilai != null)
                                            {
                                                if (m_struktur_nilai.TahunAjaran != null)
                                                {

                                                    lst_kkm_nilai_rapor.Add(new NilaiWithKey
                                                    {
                                                        Key = (jumlah_mapel_rapor + 1).ToString(),
                                                        Nilai = m_struktur_nilai.KKM
                                                    });
                                                    if (!(m_struktur_nilai.IsKelompokanKP && m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString()))
                                                    {
                                                        decimal jumlah_nilai_ap = 0;
                                                        decimal nilai_ap = 0;
                                                        int count_ap = 0;
                                                        List<Rapor_StrukturNilai_AP> lst_rapor_struktur_nilai_ap = new List<Rapor_StrukturNilai_AP>();
                                                        List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = new List<Rapor_StrukturNilai_KD>();

                                                        //jika semester 2 get semester 1
                                                        if (semester == "2")
                                                        {
                                                            lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeaderByJenisAspekPenilaian_Entity(
                                                                m_struktur_nilai_sm1.Kode.ToString(), DAO_Rapor_StrukturNilai_AP.JenisAspekPenilaian.Pengetahuan
                                                            );
                                                            lst_nilai_ap.Clear();
                                                            lst_nilai_ap_bobot.Clear();
                                                            jumlah_nilai_ap = 0;
                                                            nilai_ap = 0;
                                                            count_ap = 0;
                                                            m_sn_ap = new Rapor_StrukturNilai_AP();
                                                            foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                            {

                                                                //get struktur nilai det KD
                                                                lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                        item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                    );
                                                                lst_nilai_kd.Clear();
                                                                foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                                {

                                                                    //get struktur nilai det KP
                                                                    List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                        item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                    );
                                                                    decimal jumlah_nilai_kd = 0;
                                                                    decimal nilai_kd = 0;
                                                                    int count_kd = 0;
                                                                    foreach (var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp)
                                                                    {
                                                                        Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString());
                                                                        if (m_kp != null)
                                                                        {

                                                                            Rapor_NilaiSiswa_Det m_nilai_det = lst_nilai_siswa_det_sm1.FindAll(
                                                                                m => m.Rel_Siswa.ToString().Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                     m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai_sm1.Rel_Mapel.ToString().Trim().ToUpper() &&
                                                                                     m.Rel_Rapor_StrukturNilai_AP.Trim().ToUpper() == item_rapor_struktur_nilai_ap.Kode.ToString().ToUpper() &&
                                                                                     m.Rel_Rapor_StrukturNilai_KD.Trim().ToUpper() == item_rapor_struktur_nilai_kd.Kode.ToString().ToUpper() &&
                                                                                     m.Rel_Rapor_StrukturNilai_KP.Trim().ToUpper() == item_rapor_struktur_nilai_kp.Kode.ToString().ToUpper()
                                                                            ).FirstOrDefault();

                                                                            if (m_nilai_det != null)
                                                                            {
                                                                                if (m_nilai_det.Nilai.Trim() != "")
                                                                                {
                                                                                    if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                                    {
                                                                                        nilai_kd += Math.Round((item_rapor_struktur_nilai_kp.BobotNK / 100) * Libs.GetStringToDecimal(m_nilai_det.Nilai), 2, MidpointRounding.AwayFromZero);
                                                                                    }
                                                                                    else if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                                    {
                                                                                        jumlah_nilai_kd += Libs.GetStringToDecimal(m_nilai_det.Nilai);
                                                                                    }
                                                                                    count_kd++;
                                                                                }
                                                                            }

                                                                        }

                                                                    }

                                                                    if (count_kd > 0)
                                                                    {
                                                                        if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                        {
                                                                            nilai_kd = Math.Round(jumlah_nilai_kd / count_kd, 2, MidpointRounding.AwayFromZero);
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        nilai_kd = 0;
                                                                    }

                                                                    //load nilai manual
                                                                    Rapor_NilaiSiswa_AP_or_KD m_nilai_manual = DAO_Rapor_NilaiSiswa_AP_or_KD.GetAllByTABySMByKelasByMapelBySiswaByStruktur_Entity(
                                                                            tahun_ajaran, m_struktur_nilai_sm1.Semester, rel_kelas_det, m_siswa.Kode.ToString(), item.Rel_Mapel,
                                                                            item_rapor_struktur_nilai_kd.Kode.ToString().Trim().ToUpper()

                                                                        ).FirstOrDefault();
                                                                    if (m_nilai_manual != null)
                                                                    {
                                                                        if (m_nilai_manual.Nilai != null)
                                                                        {
                                                                            nilai_kd = Libs.GetStringToDecimal(m_nilai_manual.Nilai);
                                                                        }
                                                                    }
                                                                    //end load nilai manual

                                                                    nilai_kd = Math.Round(nilai_kd, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);
                                                                    lst_nilai_kd.Add(nilai_kd);
                                                                    //end get struktur nilai det KP

                                                                }
                                                                //end get struktur nilai det KD

                                                                //get nilai ap
                                                                count_ap = 0;
                                                                nilai_ap = 0;
                                                                jumlah_nilai_ap = 0;
                                                                foreach (var item_nilai_kd in lst_nilai_kd)
                                                                {
                                                                    if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                    {
                                                                        nilai_ap += Math.Round((item_rapor_struktur_nilai_ap.BobotRapor / 100) * item_nilai_kd, 2, MidpointRounding.AwayFromZero);
                                                                    }
                                                                    else if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                    {
                                                                        jumlah_nilai_ap += item_nilai_kd;
                                                                    }
                                                                    count_ap++;
                                                                }
                                                                if (count_ap > 0)
                                                                {
                                                                    if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                    {
                                                                        nilai_ap = Math.Round(jumlah_nilai_ap / count_ap, 2, MidpointRounding.AwayFromZero);
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    nilai_ap = 0;
                                                                }
                                                                nilai_ap = Math.Round(nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                                lst_nilai_ap.Add(nilai_ap);
                                                                lst_nilai_ap_bobot.Add(item_rapor_struktur_nilai_ap.BobotRapor);
                                                                //end get nilai ap

                                                            }
                                                            //end get struktur nilai det AP

                                                            //get nilai rapor
                                                            nilai_rapor = 0;
                                                            jumlah_nilai_rapor = 0;
                                                            count_nilai_rapor = 0;
                                                            foreach (var item_nilai_ap in lst_nilai_ap)
                                                            {
                                                                if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                {
                                                                    nilai_rapor += Math.Round((lst_nilai_ap_bobot[Convert.ToInt16(count_nilai_rapor)] / 100) * item_nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                                else if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    jumlah_nilai_rapor += item_nilai_ap;
                                                                }
                                                                count_nilai_rapor++;
                                                            }
                                                            if (count_nilai_rapor > 0)
                                                            {
                                                                if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_rapor = 0;
                                                            }
                                                            nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);
                                                            nilai_rapor_pengetahuan_sm1 = nilai_rapor;
                                                        }
                                                        //end jika semester 2 get semester 1

                                                        //-----------nilai pengetahuan---------------
                                                        id_kolom_ledger++;
                                                        //get struktur nilai det AP
                                                        lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeaderByJenisAspekPenilaian_Entity(
                                                                m_struktur_nilai.Kode.ToString(), DAO_Rapor_StrukturNilai_AP.JenisAspekPenilaian.Pengetahuan
                                                            );
                                                        lst_nilai_ap.Clear();
                                                        lst_nilai_ap_bobot.Clear();
                                                        jumlah_nilai_ap = 0;
                                                        nilai_ap = 0;
                                                        count_ap = 0;
                                                        m_sn_ap = new Rapor_StrukturNilai_AP();
                                                        foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                        {

                                                            //get struktur nilai det KD
                                                            lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                );
                                                            lst_nilai_kd.Clear();
                                                            foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                            {

                                                                //get struktur nilai det KP
                                                                List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                );
                                                                decimal jumlah_nilai_kd = 0;
                                                                decimal nilai_kd = 0;
                                                                int count_kd = 0;
                                                                foreach (var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp)
                                                                {
                                                                    Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString());
                                                                    if (m_kp != null)
                                                                    {

                                                                        Rapor_NilaiSiswa_Det m_nilai_det = lst_nilai_siswa_det.FindAll(
                                                                            m => m.Rel_Siswa.ToString().Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_AP.Trim().ToUpper() == item_rapor_struktur_nilai_ap.Kode.ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KD.Trim().ToUpper() == item_rapor_struktur_nilai_kd.Kode.ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KP.Trim().ToUpper() == item_rapor_struktur_nilai_kp.Kode.ToString().ToUpper()
                                                                        ).FirstOrDefault();

                                                                        if (m_nilai_det != null)
                                                                        {
                                                                            if (m_nilai_det.Nilai.Trim() != "")
                                                                            {
                                                                                if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                                {
                                                                                    nilai_kd += Math.Round((item_rapor_struktur_nilai_kp.BobotNK / 100) * Libs.GetStringToDecimal(m_nilai_det.Nilai), 2, MidpointRounding.AwayFromZero);
                                                                                }
                                                                                else if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                                {
                                                                                    jumlah_nilai_kd += Libs.GetStringToDecimal(m_nilai_det.Nilai);
                                                                                }
                                                                                count_kd++;
                                                                            }
                                                                        }

                                                                    }

                                                                }

                                                                if (count_kd > 0)
                                                                {
                                                                    if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                    {
                                                                        nilai_kd = Math.Round(jumlah_nilai_kd / count_kd, 2, MidpointRounding.AwayFromZero);
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    nilai_kd = 0;
                                                                }

                                                                //load nilai manual
                                                                Rapor_NilaiSiswa_AP_or_KD m_nilai_manual = DAO_Rapor_NilaiSiswa_AP_or_KD.GetAllByTABySMByKelasByMapelBySiswaByStruktur_Entity(
                                                                        tahun_ajaran, semester, rel_kelas_det, m_siswa.Kode.ToString(), item.Rel_Mapel,
                                                                        item_rapor_struktur_nilai_kd.Kode.ToString().Trim().ToUpper()

                                                                    ).FirstOrDefault();
                                                                if (m_nilai_manual != null)
                                                                {
                                                                    if (m_nilai_manual.Nilai != null)
                                                                    {
                                                                        nilai_kd = Libs.GetStringToDecimal(m_nilai_manual.Nilai);
                                                                    }
                                                                }
                                                                //end load nilai manual

                                                                nilai_kd = Math.Round(nilai_kd, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);
                                                                lst_nilai_kd.Add(nilai_kd);
                                                                //end get struktur nilai det KP

                                                            }
                                                            //end get struktur nilai det KD

                                                            //get nilai ap
                                                            count_ap = 0;
                                                            nilai_ap = 0;
                                                            jumlah_nilai_ap = 0;
                                                            foreach (var item_nilai_kd in lst_nilai_kd)
                                                            {
                                                                if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                {
                                                                    nilai_ap += Math.Round((item_rapor_struktur_nilai_ap.BobotRapor / 100) * item_nilai_kd, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                                else if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    jumlah_nilai_ap += item_nilai_kd;
                                                                }
                                                                count_ap++;
                                                            }
                                                            if (count_ap > 0)
                                                            {
                                                                if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_ap = Math.Round(jumlah_nilai_ap / count_ap, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_ap = 0;
                                                            }
                                                            nilai_ap = Math.Round(nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                            lst_nilai_ap.Add(nilai_ap);
                                                            //end get nilai ap

                                                            m_sn_ap = item_rapor_struktur_nilai_ap;
                                                        }
                                                        //end get struktur nilai det AP

                                                        //get nilai rapor
                                                        nilai_rapor = 0;
                                                        jumlah_nilai_rapor = 0;
                                                        count_nilai_rapor = 0;
                                                        foreach (var item_nilai_ap in lst_nilai_ap)
                                                        {
                                                            if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                            {
                                                                nilai_rapor += Math.Round((lst_nilai_ap_bobot[Convert.ToInt16(count_nilai_rapor)] / 100) * item_nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                            }
                                                            else if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                jumlah_nilai_rapor += item_nilai_ap;
                                                            }
                                                            count_nilai_rapor++;
                                                        }
                                                        if (count_nilai_rapor > 0)
                                                        {
                                                            if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            nilai_rapor = 0;
                                                        }
                                                        nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);

                                                        //jika ada PAT atau UKK
                                                        if (m_sn_ap.IsAdaPAT_UKK)
                                                        {
                                                            Rapor_NilaiSiswa_Det m_nilai_det = lst_nilai_siswa_det.FindAll(
                                                                            m => m.Rel_Siswa.ToString().Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_AP.Trim().ToUpper() == (Constantas.SD.GetKode_NK_KD_UKKPAT(m_sn_ap.Kode.ToString())).ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KD.Trim().ToUpper() == (Constantas.SD.GetKode_NK_KD_UKKPAT(m_sn_ap.Kode.ToString())).ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KP.Trim().ToUpper() == (Constantas.SD.GetKode_NK_KD_UKKPAT(m_sn_ap.Kode.ToString())).ToString().ToUpper()
                                                                        ).FirstOrDefault();

                                                            string s_nilai_pat_ukk = "0";
                                                            if (m_nilai_det != null)
                                                            {
                                                                if (m_nilai_det.Nilai.Trim() != "")
                                                                {
                                                                    s_nilai_pat_ukk = m_nilai_det.Nilai;
                                                                }
                                                            }

                                                            nilai_rapor = Math.Round(
                                                                            Libs.GetStringToDecimal(s_nilai_pat_ukk) * (m_sn_ap.Bobot_PAT_UKK / 100), 2
                                                                          ) +
                                                                            Math.Round(
                                                                            nilai_rapor * (m_sn_ap.Bobot_Non_PAT_UKK / 100), 2
                                                                          );

                                                            nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);
                                                        }
                                                        //jika ada PAT atau UKK

                                                        nilai_rapor_pengetahuan = nilai_rapor;
                                                        lst_all_nilai_rapor.Add(new NilaiWithKey
                                                        {
                                                            Key = (id_kolom_ledger).ToString(),
                                                            Nilai = nilai_rapor_pengetahuan
                                                        });
                                                        id_kolom_ledger += 2;
                                                        //end get nilai rapor
                                                        //-----------end nilai pengetahuan---------------

                                                        //-----------nilai keterampilan---------------
                                                        if (semester == "2")
                                                        {
                                                            lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeaderByJenisAspekPenilaian_Entity(
                                                                m_struktur_nilai_sm1.Kode.ToString(), DAO_Rapor_StrukturNilai_AP.JenisAspekPenilaian.Keterampilan
                                                            );
                                                            lst_nilai_ap.Clear();
                                                            lst_nilai_ap_bobot.Clear();
                                                            jumlah_nilai_ap = 0;
                                                            nilai_ap = 0;
                                                            count_ap = 0;
                                                            m_sn_ap = new Rapor_StrukturNilai_AP();
                                                            foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                            {

                                                                //get struktur nilai det KD
                                                                lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                        item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                    );
                                                                lst_nilai_kd.Clear();
                                                                foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                                {

                                                                    //get struktur nilai det KP
                                                                    List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                        item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                    );
                                                                    decimal jumlah_nilai_kd = 0;
                                                                    decimal nilai_kd = 0;
                                                                    int count_kd = 0;
                                                                    foreach (var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp)
                                                                    {
                                                                        Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString());
                                                                        if (m_kp != null)
                                                                        {

                                                                            Rapor_NilaiSiswa_Det m_nilai_det = lst_nilai_siswa_det_sm1.FindAll(
                                                                                m => m.Rel_Siswa.ToString().Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                     m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai_sm1.Rel_Mapel.ToString().Trim().ToUpper() &&
                                                                                     m.Rel_Rapor_StrukturNilai_AP.Trim().ToUpper() == item_rapor_struktur_nilai_ap.Kode.ToString().ToUpper() &&
                                                                                     m.Rel_Rapor_StrukturNilai_KD.Trim().ToUpper() == item_rapor_struktur_nilai_kd.Kode.ToString().ToUpper() &&
                                                                                     m.Rel_Rapor_StrukturNilai_KP.Trim().ToUpper() == item_rapor_struktur_nilai_kp.Kode.ToString().ToUpper()
                                                                            ).FirstOrDefault();

                                                                            if (m_nilai_det != null)
                                                                            {
                                                                                if (m_nilai_det.Nilai.Trim() != "")
                                                                                {
                                                                                    if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                                    {
                                                                                        nilai_kd += Math.Round((item_rapor_struktur_nilai_kp.BobotNK / 100) * Libs.GetStringToDecimal(m_nilai_det.Nilai), 2, MidpointRounding.AwayFromZero);
                                                                                    }
                                                                                    else if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                                    {
                                                                                        jumlah_nilai_kd += Libs.GetStringToDecimal(m_nilai_det.Nilai);
                                                                                    }
                                                                                    count_kd++;
                                                                                }
                                                                            }

                                                                        }

                                                                    }

                                                                    if (count_kd > 0)
                                                                    {
                                                                        if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                        {
                                                                            nilai_kd = Math.Round(jumlah_nilai_kd / count_kd, 2, MidpointRounding.AwayFromZero);
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        nilai_kd = 0;
                                                                    }

                                                                    //load nilai manual
                                                                    Rapor_NilaiSiswa_AP_or_KD m_nilai_manual = DAO_Rapor_NilaiSiswa_AP_or_KD.GetAllByTABySMByKelasByMapelBySiswaByStruktur_Entity(
                                                                            tahun_ajaran, semester, rel_kelas_det, m_siswa.Kode.ToString(), item.Rel_Mapel,
                                                                            item_rapor_struktur_nilai_kd.Kode.ToString().Trim().ToUpper()

                                                                        ).FirstOrDefault();
                                                                    if (m_nilai_manual != null)
                                                                    {
                                                                        if (m_nilai_manual.Nilai != null)
                                                                        {
                                                                            nilai_kd = Libs.GetStringToDecimal(m_nilai_manual.Nilai);
                                                                        }
                                                                    }
                                                                    //end load nilai manual

                                                                    nilai_kd = Math.Round(nilai_kd, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);
                                                                    lst_nilai_kd.Add(nilai_kd);
                                                                    //end get struktur nilai det KP

                                                                }
                                                                //end get struktur nilai det KD

                                                                //get nilai ap
                                                                count_ap = 0;
                                                                nilai_ap = 0;
                                                                jumlah_nilai_ap = 0;
                                                                foreach (var item_nilai_kd in lst_nilai_kd)
                                                                {
                                                                    if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                    {
                                                                        nilai_ap += Math.Round((item_rapor_struktur_nilai_ap.BobotRapor / 100) * item_nilai_kd, 2, MidpointRounding.AwayFromZero);
                                                                    }
                                                                    else if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                    {
                                                                        jumlah_nilai_ap += item_nilai_kd;
                                                                    }
                                                                    count_ap++;
                                                                }
                                                                if (count_ap > 0)
                                                                {
                                                                    if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                    {
                                                                        nilai_ap = Math.Round(jumlah_nilai_ap / count_ap, 2, MidpointRounding.AwayFromZero);
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    nilai_ap = 0;
                                                                }
                                                                nilai_ap = Math.Round(nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                                lst_nilai_ap.Add(nilai_ap);
                                                                lst_nilai_ap_bobot.Add(item_rapor_struktur_nilai_ap.BobotRapor);
                                                                //end get nilai ap

                                                            }
                                                            //end get struktur nilai det AP

                                                            //get nilai rapor
                                                            nilai_rapor = 0;
                                                            jumlah_nilai_rapor = 0;
                                                            count_nilai_rapor = 0;
                                                            foreach (var item_nilai_ap in lst_nilai_ap)
                                                            {
                                                                if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                {
                                                                    nilai_rapor += Math.Round((lst_nilai_ap_bobot[Convert.ToInt16(count_nilai_rapor)] / 100) * item_nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                                else if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    jumlah_nilai_rapor += item_nilai_ap;
                                                                }
                                                                count_nilai_rapor++;
                                                            }
                                                            if (count_nilai_rapor > 0)
                                                            {
                                                                if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_rapor = 0;
                                                            }
                                                            nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);
                                                            nilai_rapor_keterampilan_sm1 = nilai_rapor;
                                                        }
                                                        //end jika semester 2 get semester 1

                                                        //get struktur nilai det AP
                                                        lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeaderByJenisAspekPenilaian_Entity(
                                                                m_struktur_nilai.Kode.ToString(), DAO_Rapor_StrukturNilai_AP.JenisAspekPenilaian.Keterampilan
                                                            );
                                                        lst_nilai_ap.Clear();
                                                        lst_nilai_ap_bobot.Clear();
                                                        jumlah_nilai_ap = 0;
                                                        nilai_ap = 0;
                                                        count_ap = 0;
                                                        foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                        {

                                                            //get struktur nilai det KD
                                                            lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                );
                                                            lst_nilai_kd.Clear();
                                                            foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                            {

                                                                //get struktur nilai det KP
                                                                List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                );
                                                                decimal jumlah_nilai_kd = 0;
                                                                decimal nilai_kd = 0;
                                                                int count_kd = 0;
                                                                foreach (var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp)
                                                                {
                                                                    Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString());
                                                                    if (m_kp != null)
                                                                    {

                                                                        Rapor_NilaiSiswa_Det m_nilai_det = lst_nilai_siswa_det.FindAll(
                                                                            m => m.Rel_Siswa.ToString().Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_AP.Trim().ToUpper() == item_rapor_struktur_nilai_ap.Kode.ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KD.Trim().ToUpper() == item_rapor_struktur_nilai_kd.Kode.ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KP.Trim().ToUpper() == item_rapor_struktur_nilai_kp.Kode.ToString().ToUpper()
                                                                        ).FirstOrDefault();

                                                                        if (m_nilai_det != null)
                                                                        {
                                                                            if (m_nilai_det.Nilai.Trim() != "")
                                                                            {
                                                                                if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                                {
                                                                                    nilai_kd += Math.Round((item_rapor_struktur_nilai_kp.BobotNK / 100) * Libs.GetStringToDecimal(m_nilai_det.Nilai), 2, MidpointRounding.AwayFromZero);
                                                                                }
                                                                                else if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                                {
                                                                                    jumlah_nilai_kd += Libs.GetStringToDecimal(m_nilai_det.Nilai);
                                                                                }
                                                                                count_kd++;
                                                                            }
                                                                        }

                                                                    }

                                                                }

                                                                if (count_kd > 0)
                                                                {
                                                                    if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                    {
                                                                        nilai_kd = Math.Round(jumlah_nilai_kd / count_kd, 2, MidpointRounding.AwayFromZero);
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    nilai_kd = 0;
                                                                }

                                                                //load nilai manual
                                                                Rapor_NilaiSiswa_AP_or_KD m_nilai_manual = DAO_Rapor_NilaiSiswa_AP_or_KD.GetAllByTABySMByKelasByMapelBySiswaByStruktur_Entity(
                                                                        tahun_ajaran, semester, rel_kelas_det, m_siswa.Kode.ToString(), item.Rel_Mapel,
                                                                        item_rapor_struktur_nilai_kd.Kode.ToString().Trim().ToUpper()

                                                                    ).FirstOrDefault();
                                                                if (m_nilai_manual != null)
                                                                {
                                                                    if (m_nilai_manual.Nilai != null)
                                                                    {
                                                                        nilai_kd = Libs.GetStringToDecimal(m_nilai_manual.Nilai);
                                                                    }
                                                                }
                                                                //end load nilai manual

                                                                nilai_kd = Math.Round(nilai_kd, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);
                                                                lst_nilai_kd.Add(nilai_kd);
                                                                //end get struktur nilai det KP

                                                            }
                                                            //end get struktur nilai det KD

                                                            //get nilai ap
                                                            count_ap = 0;
                                                            nilai_ap = 0;
                                                            jumlah_nilai_ap = 0;
                                                            foreach (var item_nilai_kd in lst_nilai_kd)
                                                            {
                                                                if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                {
                                                                    nilai_ap += Math.Round((item_rapor_struktur_nilai_ap.BobotRapor / 100) * item_nilai_kd, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                                else if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    jumlah_nilai_ap += item_nilai_kd;
                                                                }
                                                                count_ap++;
                                                            }
                                                            if (count_ap > 0)
                                                            {
                                                                if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_ap = Math.Round(jumlah_nilai_ap / count_ap, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_ap = 0;
                                                            }
                                                            nilai_ap = Math.Round(nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                            lst_nilai_ap.Add(nilai_ap);
                                                            lst_nilai_ap_bobot.Add(item_rapor_struktur_nilai_ap.BobotRapor);
                                                            //end get nilai ap
                                                            //-----------end nilai keterampilan---------------

                                                        }
                                                        //end get struktur nilai det AP

                                                        //get nilai rapor
                                                        nilai_rapor = 0;
                                                        jumlah_nilai_rapor = 0;
                                                        count_nilai_rapor = 0;
                                                        foreach (var item_nilai_ap in lst_nilai_ap)
                                                        {
                                                            if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                            {
                                                                nilai_rapor += Math.Round((lst_nilai_ap_bobot[Convert.ToInt16(count_nilai_rapor)] / 100) * item_nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                            }
                                                            else if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                jumlah_nilai_rapor += item_nilai_ap;
                                                            }
                                                            count_nilai_rapor++;
                                                        }
                                                        if (count_nilai_rapor > 0)
                                                        {
                                                            if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            nilai_rapor = 0;
                                                        }
                                                        nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);
                                                        nilai_rapor_keterampilan = nilai_rapor;
                                                        lst_all_nilai_rapor.Add(new NilaiWithKey
                                                        {
                                                            Key = (id_kolom_ledger).ToString(),
                                                            Nilai = nilai_rapor_keterampilan
                                                        });
                                                        id_kolom_ledger++;
                                                        //end get nilai rapor
                                                    }
                                                    else
                                                    {
                                                        id_kolom_ledger++;
                                                        List<FormatNilai> lst_format_nilai = new List<FormatNilai>();
                                                        List<Rapor_StrukturNilai_AP> lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeader_Entity(
                                                                m_struktur_nilai.Kode.ToString()
                                                            );
                                                        foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                        {

                                                            List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                );

                                                            foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                            {

                                                                List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                );
                                                                foreach (
                                                                    var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp.FindAll(
                                                                        m => (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == DAO_Rapor_StrukturNilai.Arr_KP_Quran[0]) ||
                                                                             (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == DAO_Rapor_StrukturNilai.Arr_KP_Quran[1]) ||
                                                                             (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == DAO_Rapor_StrukturNilai.Arr_KP_Quran[2])
                                                                        )
                                                                )
                                                                {

                                                                    if (
                                                                        lst_format_nilai.FindAll(
                                                                                m => m.Rel_StrukturNilai_AP == item_rapor_struktur_nilai_ap.Kode.ToString() &&
                                                                                     m.Rel_KP == item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                            ).Count == 0
                                                                    )
                                                                    {
                                                                        lst_format_nilai.Add(new FormatNilai
                                                                        {
                                                                            Rel_StrukturNilai_AP = item_rapor_struktur_nilai_ap.Kode.ToString(),
                                                                            Rel_KP = item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                        });
                                                                    }

                                                                }
                                                            }

                                                        }

                                                        List<FormatNilai> lst_format_nilai2 = new List<FormatNilai>();
                                                        foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                        {

                                                            List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                );

                                                            foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                            {

                                                                List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                );
                                                                foreach (
                                                                    var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp.FindAll(
                                                                        m => (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() != DAO_Rapor_StrukturNilai.Arr_KP_Quran[0]) &&
                                                                             (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() != DAO_Rapor_StrukturNilai.Arr_KP_Quran[1]) &&
                                                                             (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() != DAO_Rapor_StrukturNilai.Arr_KP_Quran[2])
                                                                        )
                                                                )
                                                                {

                                                                    if (
                                                                        lst_format_nilai2.FindAll(
                                                                                m => m.Rel_StrukturNilai_AP == item_rapor_struktur_nilai_ap.Kode.ToString() &&
                                                                                     m.Rel_KP == item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                            ).Count == 0
                                                                    )
                                                                    {
                                                                        lst_format_nilai2.Add(new FormatNilai
                                                                        {
                                                                            Rel_StrukturNilai_AP = item_rapor_struktur_nilai_ap.Kode.ToString(),
                                                                            Rel_KP = item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                        });
                                                                    }

                                                                }
                                                            }

                                                        }

                                                        List<FormatNilaiWithNilai> lst_formatnilai_nilai = new List<FormatNilaiWithNilai>();
                                                        //distinct ap
                                                        foreach (string rel_sn_ap in lst_format_nilai.Select(m => m.Rel_StrukturNilai_AP).Distinct())
                                                        {
                                                            foreach (string rel_kp in lst_format_nilai.Select(m => m.Rel_KP).Distinct())
                                                            {

                                                                Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(rel_kp);
                                                                if (m_kp != null)
                                                                {
                                                                    if (m_kp.Nama != null)
                                                                    {

                                                                        double nilai = lst_nilai_siswa_det.Where(
                                                                            m => m.Rel_Rapor_StrukturNilai_AP.ToString().Trim().ToUpper() == rel_sn_ap.Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == rel_kp.Trim().ToUpper() &&
                                                                                 m.Rel_Siswa.Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper()
                                                                        ).Select(m => Libs.GetStringToDouble(m.Nilai)).DefaultIfEmpty().Average();

                                                                        lst_formatnilai_nilai.Add(new FormatNilaiWithNilai
                                                                        {
                                                                            Nama_KP = m_kp.Nama,
                                                                            Nilai = nilai.ToString(),
                                                                            Rel_KP = rel_kp,
                                                                            Rel_StrukturNilai_AP = rel_sn_ap
                                                                        });

                                                                    }
                                                                }

                                                            }
                                                        }

                                                        List<FormatNilaiWithNilai> lst_formatnilai_nilai2 = new List<FormatNilaiWithNilai>();
                                                        //distinct ap
                                                        foreach (string rel_sn_ap in lst_format_nilai2.Select(m => m.Rel_StrukturNilai_AP).Distinct())
                                                        {
                                                            foreach (string rel_kp in lst_format_nilai2.Select(m => m.Rel_KP).Distinct())
                                                            {

                                                                Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(rel_kp);
                                                                if (m_kp != null)
                                                                {
                                                                    if (m_kp.Nama != null)
                                                                    {

                                                                        double nilai = lst_nilai_siswa_det.Where(
                                                                            m => m.Rel_Rapor_StrukturNilai_AP.ToString().Trim().ToUpper() == rel_sn_ap.Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == rel_kp.Trim().ToUpper() &&
                                                                                 m.Rel_Siswa.Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper()
                                                                        ).Select(m => Libs.GetStringToDouble(m.Nilai)).DefaultIfEmpty().Average();

                                                                        lst_formatnilai_nilai2.Add(new FormatNilaiWithNilai
                                                                        {
                                                                            Nama_KP = m_kp.Nama,
                                                                            Nilai = nilai.ToString(),
                                                                            Rel_KP = rel_kp,
                                                                            Rel_StrukturNilai_AP = rel_sn_ap
                                                                        });

                                                                    }
                                                                }

                                                            }
                                                        }

                                                        //get nilai rapor                                                        
                                                        List<NilaiWithKey> lst_nilai = new List<NilaiWithKey>();
                                                        lst_nilai.Clear();
                                                        foreach (string rel_kp in lst_formatnilai_nilai.Select(m => m.Rel_KP).Distinct())
                                                        {

                                                            nilai_rapor = 0;
                                                            jumlah_nilai_rapor = 0;
                                                            count_nilai_rapor = 0;
                                                            foreach (var m_formatnilai_nilai in lst_formatnilai_nilai.FindAll(m => m.Rel_KP == rel_kp))
                                                            {
                                                                Rapor_StrukturNilai_AP m_rel_sn_ap = DAO_Rapor_StrukturNilai_AP.GetByID_Entity(m_formatnilai_nilai.Rel_StrukturNilai_AP);
                                                                if (m_rel_sn_ap != null)
                                                                {
                                                                    if (m_rel_sn_ap.JenisPerhitungan != null)
                                                                    {

                                                                        if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                        {
                                                                            nilai_rapor += Math.Round((m_rel_sn_ap.BobotRapor / 100) * Libs.GetStringToDecimal(m_formatnilai_nilai.Nilai), 3, MidpointRounding.AwayFromZero);
                                                                        }
                                                                        else if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                        {
                                                                            jumlah_nilai_rapor += m_rel_sn_ap.BobotRapor;
                                                                        }
                                                                        count_nilai_rapor++;

                                                                    }
                                                                }
                                                            }

                                                            if (count_nilai_rapor > 0)
                                                            {
                                                                if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_rapor = 0;
                                                            }
                                                            nilai_rapor = Math.Round(nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                            lst_nilai.Add(new NilaiWithKey
                                                            {
                                                                Key = rel_kp,
                                                                Nilai = nilai_rapor
                                                            });
                                                        }

                                                        nilai_rapor = 0;
                                                        jumlah_nilai_rapor = 0;
                                                        count_nilai_rapor = 0;
                                                        List<Rapor_StrukturNilai_KPKelompok> lst_kpkelompok = DAO_Rapor_StrukturNilai_KPKelompok.GetAllByHeader_Entity(
                                                                m_struktur_nilai.Kode.ToString()
                                                            );
                                                        foreach (var item_nilai in lst_nilai)
                                                        {
                                                            Rapor_StrukturNilai_KPKelompok m_kpkelompok = lst_kpkelompok.FindAll(
                                                                    m => m.Rel_Rapor_KomponenPenilaian == new Guid(item_nilai.Key)
                                                                ).FirstOrDefault();
                                                            if (m_kpkelompok != null)
                                                            {
                                                                if (m_kpkelompok.Rel_Rapor_StrukturNilai != null)
                                                                {
                                                                    nilai_rapor += Math.Round((m_kpkelompok.Bobot / 100) * item_nilai.Nilai, 3, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                        }

                                                        decimal nilai_non_q = 0;
                                                        if (lst_formatnilai_nilai2.Count > 0)
                                                        {
                                                            nilai_non_q = lst_formatnilai_nilai2.Select(m => Libs.GetStringToDecimal(m.Nilai)).DefaultIfEmpty().Average();
                                                        }
                                                        if (nilai_non_q > 0)
                                                        {
                                                            nilai_rapor = Math.Round((nilai_rapor + nilai_non_q) / 2, 3, MidpointRounding.AwayFromZero);
                                                        }
                                                        nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);
                                                        nilai_rapor_pengetahuan = nilai_rapor;
                                                        jumlah_keseluruhan += nilai_rapor;
                                                        jumlah_mapel_rapor++;
                                                        lst_all_nilai_rapor.Add(new NilaiWithKey
                                                        {
                                                            Key = (id_kolom_ledger).ToString(),
                                                            Nilai = nilai_rapor_pengetahuan
                                                        });
                                                        //end get nilai rapor
                                                        //end distinct ap
                                                        id_kolom_ledger++;
                                                    }

                                                    jumlah_mapel_rapor++;
                                                }
                                            }
                                            //end get struktur nilai

                                            html_row_body_siswa += "<td style=\"" + css_cell_body + " text-align: center; " + (nilai_rapor_pengetahuan < m_struktur_nilai.KKM ? " font-weight: bold; color: #9C0006; background-color: #FFC7CE; " : "") + "\">" +
                                                                        nilai_rapor_pengetahuan.ToString() +
                                                                   "</td>" +
                                                                   "<td style=\"" + css_cell_body + " text-align: center; " + (nilai_rapor_pengetahuan < m_struktur_nilai.KKM ? " font-weight: bold; color: #9C0006; background-color: #FFC7CE; " : "") + "\">" +
                                                                        GetPredikatRapor(nilai_rapor_pengetahuan) +
                                                                   "</td>";
                                            html_row_body_siswa += "<td style=\"" + css_cell_body + " text-align: center; " + (nilai_rapor_keterampilan < m_struktur_nilai.KKM ? " font-weight: bold; color: #9C0006; background-color: #FFC7CE; " : "") + "\">" +
                                                                        nilai_rapor_keterampilan.ToString() +
                                                                   "</td>" +
                                                                   "<td style=\"" + css_cell_body + " text-align: center; " + (nilai_rapor_keterampilan < m_struktur_nilai.KKM ? " font-weight: bold; color: #9C0006; background-color: #FFC7CE; " : "") + "\">" +
                                                                        GetPredikatRapor(nilai_rapor_keterampilan) +
                                                                   "</td>";
                                        }

                                    }
                                    //end rapor non mulok

                                    id_mulai_looping_rata_rata = id_kolom_ledger + 1;
                                    id_mulai_looping_kkm = jumlah_mapel_rapor + 1;

                                    //rapor mulok
                                    lst_rapor_desain_det = DAO_Rapor_Desain_Det.GetAllByHeader_Entity(rapor_desain.Kode.ToString()).FindAll(m => m.Nomor.Trim() == "" && m.Rel_Mapel.Trim() != "");
                                    foreach (Rapor_Desain_Det item in lst_rapor_desain_det.FindAll(m => m.Rel_Mapel.Trim() != ""))
                                    {

                                        if (item.Rel_Mapel.Trim() != "")
                                        {

                                            lst_nilai_siswa_det = lst_nilai_siswa_det_by_periode.FindAll(
                                                    m => m.Rel_Mapel == item.Rel_Mapel &&
                                                         m.Rel_Siswa == m.Rel_Siswa
                                                );
                                            lst_nilai_siswa_det_sm1 = lst_nilai_siswa_det_by_periode_sm1.FindAll(
                                                    m => m.Rel_Mapel == item.Rel_Mapel &&
                                                         m.Rel_Siswa == m.Rel_Siswa
                                                );

                                            //get struktur nilainya
                                            Rapor_StrukturNilai m_struktur_nilai_sm1 = DAO_Rapor_StrukturNilai.GetATop1ByTABySMByKelasByMapel_Entity(
                                                    tahun_ajaran, "1", m_kelas.Kode.ToString(), item.Rel_Mapel
                                                );

                                            Rapor_StrukturNilai m_struktur_nilai = DAO_Rapor_StrukturNilai.GetATop1ByTABySMByKelasByMapel_Entity(
                                                    tahun_ajaran, semester, m_kelas.Kode.ToString(), item.Rel_Mapel
                                                );

                                            decimal nilai_rapor = 0;
                                            decimal nilai_rapor_mulok_sm1 = 0;
                                            decimal jumlah_nilai_rapor = 0;
                                            decimal count_nilai_rapor = 0;

                                            decimal nilai_rapor_pengetahuan = 0;
                                            if (m_struktur_nilai != null)
                                            {
                                                if (m_struktur_nilai.TahunAjaran != null)
                                                {

                                                    lst_kkm_nilai_rapor.Add(new NilaiWithKey
                                                    {
                                                        Key = (jumlah_mapel_rapor + 1).ToString(),
                                                        Nilai = m_struktur_nilai.KKM
                                                    });
                                                    if (!(m_struktur_nilai.IsKelompokanKP && m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString()))
                                                    {
                                                        decimal jumlah_nilai_ap = 0;
                                                        decimal nilai_ap = 0;
                                                        int count_ap = 0;
                                                        nilai_rapor = 0;
                                                        nilai_rapor_mulok_sm1 = 0;
                                                        List<Rapor_StrukturNilai_AP> lst_rapor_struktur_nilai_ap = new List<Rapor_StrukturNilai_AP>();
                                                        //jika semester 2 get nilai semester 1
                                                        if (m_struktur_nilai.Semester == "2")
                                                        {
                                                            //get struktur nilai det AP
                                                            lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeader_Entity(
                                                                    m_struktur_nilai_sm1.Kode.ToString()
                                                                );
                                                            lst_nilai_ap.Clear();
                                                            lst_nilai_ap_bobot.Clear();
                                                            foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                            {

                                                                //get struktur nilai det KD
                                                                List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                        item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                    );
                                                                lst_nilai_kd.Clear();
                                                                foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                                {

                                                                    //get struktur nilai det KP
                                                                    List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                        item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                    );
                                                                    decimal jumlah_nilai_kd = 0;
                                                                    decimal nilai_kd = 0;
                                                                    int count_kd = 0;
                                                                    foreach (var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp)
                                                                    {
                                                                        Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString());
                                                                        if (m_kp != null)
                                                                        {

                                                                            Rapor_NilaiSiswa_Det m_nilai_det = lst_nilai_siswa_det_sm1.FindAll(
                                                                                m => m.Rel_Siswa.ToString().Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                     m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai_sm1.Rel_Mapel.ToString().Trim().ToUpper() &&
                                                                                     m.Rel_Rapor_StrukturNilai_AP.Trim().ToUpper() == item_rapor_struktur_nilai_ap.Kode.ToString().ToUpper() &&
                                                                                     m.Rel_Rapor_StrukturNilai_KD.Trim().ToUpper() == item_rapor_struktur_nilai_kd.Kode.ToString().ToUpper() &&
                                                                                     m.Rel_Rapor_StrukturNilai_KP.Trim().ToUpper() == item_rapor_struktur_nilai_kp.Kode.ToString().ToUpper()
                                                                            ).FirstOrDefault();

                                                                            if (m_nilai_det != null)
                                                                            {
                                                                                if (m_nilai_det.Nilai.Trim() != "")
                                                                                {
                                                                                    if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                                    {
                                                                                        nilai_kd += Math.Round((item_rapor_struktur_nilai_kp.BobotNK / 100) * Libs.GetStringToDecimal(m_nilai_det.Nilai), 2, MidpointRounding.AwayFromZero);
                                                                                    }
                                                                                    else if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                                    {
                                                                                        jumlah_nilai_kd += Libs.GetStringToDecimal(m_nilai_det.Nilai);
                                                                                    }
                                                                                    count_kd++;
                                                                                }
                                                                            }

                                                                        }

                                                                    }

                                                                    if (count_kd > 0)
                                                                    {
                                                                        if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                        {
                                                                            nilai_kd = Math.Round(jumlah_nilai_kd / count_kd, 2, MidpointRounding.AwayFromZero);
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        nilai_kd = 0;
                                                                    }

                                                                    //load nilai manual
                                                                    Rapor_NilaiSiswa_AP_or_KD m_nilai_manual = DAO_Rapor_NilaiSiswa_AP_or_KD.GetAllByTABySMByKelasByMapelBySiswaByStruktur_Entity(
                                                                            tahun_ajaran, m_struktur_nilai_sm1.Semester, rel_kelas_det, m_siswa.Kode.ToString(), item.Rel_Mapel,
                                                                            item_rapor_struktur_nilai_kd.Kode.ToString().Trim().ToUpper()

                                                                        ).FirstOrDefault();
                                                                    if (m_nilai_manual != null)
                                                                    {
                                                                        if (m_nilai_manual.Nilai != null)
                                                                        {
                                                                            nilai_kd = Libs.GetStringToDecimal(m_nilai_manual.Nilai);
                                                                        }
                                                                    }
                                                                    //end load nilai manual

                                                                    nilai_kd = Math.Round(nilai_kd, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);
                                                                    lst_nilai_kd.Add(nilai_kd);
                                                                    //end get struktur nilai det KP

                                                                }
                                                                //end get struktur nilai det KD

                                                                //get nilai ap
                                                                count_ap = 0;
                                                                nilai_ap = 0;
                                                                jumlah_nilai_ap = 0;
                                                                foreach (var item_nilai_kd in lst_nilai_kd)
                                                                {
                                                                    if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                    {
                                                                        nilai_ap += Math.Round((item_rapor_struktur_nilai_ap.BobotRapor / 100) * item_nilai_kd, 2, MidpointRounding.AwayFromZero);
                                                                    }
                                                                    else if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                    {
                                                                        jumlah_nilai_ap += item_nilai_kd;
                                                                    }
                                                                    count_ap++;
                                                                }
                                                                if (count_ap > 0)
                                                                {
                                                                    if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                    {
                                                                        nilai_ap = Math.Round(jumlah_nilai_ap / count_ap, 2, MidpointRounding.AwayFromZero);
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    nilai_ap = 0;
                                                                }
                                                                nilai_ap = Math.Round(nilai_ap, 0, MidpointRounding.AwayFromZero);
                                                                lst_nilai_ap.Add(nilai_ap);
                                                                lst_nilai_ap_bobot.Add(item_rapor_struktur_nilai_ap.BobotRapor);
                                                                //end get nilai ap

                                                            }
                                                            //end get struktur nilai det AP

                                                            //get nilai rapor
                                                            nilai_rapor = 0;
                                                            jumlah_nilai_rapor = 0;
                                                            count_nilai_rapor = 0;
                                                            foreach (var item_nilai_ap in lst_nilai_ap)
                                                            {
                                                                if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                {
                                                                    nilai_rapor += Math.Round((lst_nilai_ap_bobot[Convert.ToInt16(count_nilai_rapor)] / 100) * item_nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                                else if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    jumlah_nilai_rapor += item_nilai_ap;
                                                                }
                                                                count_nilai_rapor++;
                                                            }
                                                            if (count_nilai_rapor > 0)
                                                            {
                                                                if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_rapor = 0;
                                                            }
                                                            nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);
                                                            nilai_rapor_mulok_sm1 = nilai_rapor;
                                                            //end get nilai rapor
                                                        }
                                                        //end get nilai semester 1

                                                        //-----------nilai pengetahuan---------------
                                                        id_kolom_ledger++;
                                                        //get struktur nilai det AP
                                                        lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeader_Entity(
                                                                m_struktur_nilai.Kode.ToString()
                                                            );
                                                        lst_nilai_ap.Clear();
                                                        lst_nilai_ap_bobot.Clear();
                                                        jumlah_nilai_ap = 0;
                                                        nilai_ap = 0;
                                                        count_ap = 0;
                                                        foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                        {

                                                            //get struktur nilai det KD
                                                            List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                );
                                                            lst_nilai_kd.Clear();
                                                            foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                            {

                                                                //get struktur nilai det KP
                                                                List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                );
                                                                decimal jumlah_nilai_kd = 0;
                                                                decimal nilai_kd = 0;
                                                                int count_kd = 0;
                                                                foreach (var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp)
                                                                {
                                                                    Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString());
                                                                    if (m_kp != null)
                                                                    {

                                                                        Rapor_NilaiSiswa_Det m_nilai_det = lst_nilai_siswa_det.FindAll(
                                                                            m => m.Rel_Siswa.ToString().Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_AP.Trim().ToUpper() == item_rapor_struktur_nilai_ap.Kode.ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KD.Trim().ToUpper() == item_rapor_struktur_nilai_kd.Kode.ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KP.Trim().ToUpper() == item_rapor_struktur_nilai_kp.Kode.ToString().ToUpper()
                                                                        ).FirstOrDefault();

                                                                        if (m_nilai_det != null)
                                                                        {
                                                                            if (m_nilai_det.Nilai.Trim() != "")
                                                                            {
                                                                                if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                                {
                                                                                    nilai_kd += Math.Round((item_rapor_struktur_nilai_kp.BobotNK / 100) * Libs.GetStringToDecimal(m_nilai_det.Nilai), 2, MidpointRounding.AwayFromZero);
                                                                                }
                                                                                else if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                                {
                                                                                    jumlah_nilai_kd += Libs.GetStringToDecimal(m_nilai_det.Nilai);
                                                                                }
                                                                                count_kd++;
                                                                            }
                                                                        }

                                                                    }

                                                                }

                                                                if (count_kd > 0)
                                                                {
                                                                    if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                    {
                                                                        nilai_kd = Math.Round(jumlah_nilai_kd / count_kd, 2, MidpointRounding.AwayFromZero);
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    nilai_kd = 0;
                                                                }

                                                                //load nilai manual
                                                                Rapor_NilaiSiswa_AP_or_KD m_nilai_manual = DAO_Rapor_NilaiSiswa_AP_or_KD.GetAllByTABySMByKelasByMapelBySiswaByStruktur_Entity(
                                                                        tahun_ajaran, semester, rel_kelas_det, m_siswa.Kode.ToString(), item.Rel_Mapel,
                                                                        item_rapor_struktur_nilai_kd.Kode.ToString().Trim().ToUpper()

                                                                    ).FirstOrDefault();
                                                                if (m_nilai_manual != null)
                                                                {
                                                                    if (m_nilai_manual.Nilai != null)
                                                                    {
                                                                        nilai_kd = Libs.GetStringToDecimal(m_nilai_manual.Nilai);
                                                                    }
                                                                }
                                                                //end load nilai manual

                                                                nilai_kd = Math.Round(nilai_kd, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);
                                                                lst_nilai_kd.Add(nilai_kd);
                                                                //end get struktur nilai det KP

                                                            }
                                                            //end get struktur nilai det KD

                                                            //get nilai ap
                                                            count_ap = 0;
                                                            nilai_ap = 0;
                                                            jumlah_nilai_ap = 0;
                                                            foreach (var item_nilai_kd in lst_nilai_kd)
                                                            {
                                                                if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                {
                                                                    nilai_ap += Math.Round((item_rapor_struktur_nilai_ap.BobotRapor / 100) * item_nilai_kd, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                                else if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    jumlah_nilai_ap += item_nilai_kd;
                                                                }
                                                                count_ap++;
                                                            }
                                                            if (count_ap > 0)
                                                            {
                                                                if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_ap = Math.Round(jumlah_nilai_ap / count_ap, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_ap = 0;
                                                            }
                                                            nilai_ap = Math.Round(nilai_ap, 0, MidpointRounding.AwayFromZero);
                                                            lst_nilai_ap.Add(nilai_ap);
                                                            lst_nilai_ap_bobot.Add(item_rapor_struktur_nilai_ap.BobotRapor);
                                                            //end get nilai ap

                                                        }
                                                        //end get struktur nilai det AP

                                                        //get nilai rapor
                                                        nilai_rapor = 0;
                                                        jumlah_nilai_rapor = 0;
                                                        count_nilai_rapor = 0;
                                                        foreach (var item_nilai_ap in lst_nilai_ap)
                                                        {
                                                            if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                            {
                                                                nilai_rapor += Math.Round((lst_nilai_ap_bobot[Convert.ToInt16(count_nilai_rapor)] / 100) * item_nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                            }
                                                            else if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                jumlah_nilai_rapor += item_nilai_ap;
                                                            }
                                                            count_nilai_rapor++;
                                                        }
                                                        if (count_nilai_rapor > 0)
                                                        {
                                                            if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            nilai_rapor = 0;
                                                        }
                                                        nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);
                                                        nilai_rapor_pengetahuan = nilai_rapor;
                                                        lst_all_nilai_rapor.Add(new NilaiWithKey
                                                        {
                                                            Key = (id_kolom_ledger).ToString(),
                                                            Nilai = nilai_rapor_pengetahuan
                                                        });
                                                        id_kolom_ledger++;
                                                        //end get nilai rapor
                                                        //-----------end nilai pengetahuan---------------
                                                    }
                                                    else
                                                    {
                                                        nilai_rapor_mulok_sm1 = 0;
                                                        decimal nilai_non_q = 0;
                                                        List<Rapor_StrukturNilai_KPKelompok> lst_kpkelompok = new List<Rapor_StrukturNilai_KPKelompok>();
                                                        List<FormatNilai> lst_format_nilai = new List<FormatNilai>();
                                                        List<Rapor_StrukturNilai_AP> lst_rapor_struktur_nilai_ap = new List<Rapor_StrukturNilai_AP>();
                                                        List<FormatNilai> lst_format_nilai2 = new List<FormatNilai>();
                                                        List<FormatNilaiWithNilai> lst_formatnilai_nilai = new List<FormatNilaiWithNilai>();
                                                        List<FormatNilaiWithNilai> lst_formatnilai_nilai2 = new List<FormatNilaiWithNilai>();
                                                        List<NilaiWithKey> lst_nilai = new List<NilaiWithKey>();

                                                        //jika semester 2 get nilai semester 1
                                                        if (m_struktur_nilai.Semester == "2")
                                                        {
                                                            lst_format_nilai = new List<FormatNilai>();
                                                            lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeader_Entity(
                                                                    m_struktur_nilai_sm1.Kode.ToString()
                                                                );
                                                            foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                            {

                                                                List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                        item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                    );

                                                                foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                                {

                                                                    List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                        item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                    );
                                                                    foreach (
                                                                        var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp.FindAll(
                                                                            m => (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == DAO_Rapor_StrukturNilai.Arr_KP_Quran[0]) ||
                                                                                 (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == DAO_Rapor_StrukturNilai.Arr_KP_Quran[1]) ||
                                                                                 (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == DAO_Rapor_StrukturNilai.Arr_KP_Quran[2])
                                                                            )
                                                                    )
                                                                    {

                                                                        if (
                                                                            lst_format_nilai.FindAll(
                                                                                    m => m.Rel_StrukturNilai_AP == item_rapor_struktur_nilai_ap.Kode.ToString() &&
                                                                                         m.Rel_KP == item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                                ).Count == 0
                                                                        )
                                                                        {
                                                                            lst_format_nilai.Add(new FormatNilai
                                                                            {
                                                                                Rel_StrukturNilai_AP = item_rapor_struktur_nilai_ap.Kode.ToString(),
                                                                                Rel_KP = item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                            });
                                                                        }

                                                                    }
                                                                }

                                                            }

                                                            lst_format_nilai2 = new List<FormatNilai>();
                                                            foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                            {

                                                                List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                        item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                    );

                                                                foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                                {

                                                                    List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                        item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                    );
                                                                    foreach (
                                                                        var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp.FindAll(
                                                                            m => (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() != DAO_Rapor_StrukturNilai.Arr_KP_Quran[0]) &&
                                                                                 (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() != DAO_Rapor_StrukturNilai.Arr_KP_Quran[1]) &&
                                                                                 (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() != DAO_Rapor_StrukturNilai.Arr_KP_Quran[2])
                                                                            )
                                                                    )
                                                                    {

                                                                        if (
                                                                            lst_format_nilai2.FindAll(
                                                                                    m => m.Rel_StrukturNilai_AP == item_rapor_struktur_nilai_ap.Kode.ToString() &&
                                                                                         m.Rel_KP == item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                                ).Count == 0
                                                                        )
                                                                        {
                                                                            lst_format_nilai2.Add(new FormatNilai
                                                                            {
                                                                                Rel_StrukturNilai_AP = item_rapor_struktur_nilai_ap.Kode.ToString(),
                                                                                Rel_KP = item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                            });
                                                                        }

                                                                    }
                                                                }

                                                            }

                                                            lst_formatnilai_nilai = new List<FormatNilaiWithNilai>();
                                                            //distinct ap
                                                            foreach (string rel_sn_ap in lst_format_nilai.Select(m => m.Rel_StrukturNilai_AP).Distinct())
                                                            {
                                                                foreach (string rel_kp in lst_format_nilai.Select(m => m.Rel_KP).Distinct())
                                                                {

                                                                    Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(rel_kp);
                                                                    if (m_kp != null)
                                                                    {
                                                                        if (m_kp.Nama != null)
                                                                        {

                                                                            double nilai = lst_nilai_siswa_det_sm1.Where(
                                                                                m => m.Rel_Rapor_StrukturNilai_AP.ToString().Trim().ToUpper() == rel_sn_ap.Trim().ToUpper() &&
                                                                                     m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == rel_kp.Trim().ToUpper() &&
                                                                                     m.Rel_Siswa.Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                     m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai_sm1.Rel_Mapel.ToString().Trim().ToUpper()
                                                                            ).Select(m => Libs.GetStringToDouble(m.Nilai)).DefaultIfEmpty().Average();

                                                                            lst_formatnilai_nilai.Add(new FormatNilaiWithNilai
                                                                            {
                                                                                Nama_KP = m_kp.Nama,
                                                                                Nilai = nilai.ToString(),
                                                                                Rel_KP = rel_kp,
                                                                                Rel_StrukturNilai_AP = rel_sn_ap
                                                                            });

                                                                        }
                                                                    }

                                                                }
                                                            }

                                                            lst_formatnilai_nilai2 = new List<FormatNilaiWithNilai>();
                                                            //distinct ap
                                                            foreach (string rel_sn_ap in lst_format_nilai2.Select(m => m.Rel_StrukturNilai_AP).Distinct())
                                                            {
                                                                foreach (string rel_kp in lst_format_nilai2.Select(m => m.Rel_KP).Distinct())
                                                                {

                                                                    Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(rel_kp);
                                                                    if (m_kp != null)
                                                                    {
                                                                        if (m_kp.Nama != null)
                                                                        {

                                                                            double nilai = lst_nilai_siswa_det_sm1.Where(
                                                                                m => m.Rel_Rapor_StrukturNilai_AP.ToString().Trim().ToUpper() == rel_sn_ap.Trim().ToUpper() &&
                                                                                     m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == rel_kp.Trim().ToUpper() &&
                                                                                     m.Rel_Siswa.Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                     m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai_sm1.Rel_Mapel.ToString().Trim().ToUpper()
                                                                            ).Select(m => Libs.GetStringToDouble(m.Nilai)).DefaultIfEmpty().Average();

                                                                            lst_formatnilai_nilai2.Add(new FormatNilaiWithNilai
                                                                            {
                                                                                Nama_KP = m_kp.Nama,
                                                                                Nilai = nilai.ToString(),
                                                                                Rel_KP = rel_kp,
                                                                                Rel_StrukturNilai_AP = rel_sn_ap
                                                                            });

                                                                        }
                                                                    }

                                                                }
                                                            }

                                                            //get nilai rapor                                                        
                                                            lst_nilai = new List<NilaiWithKey>();
                                                            lst_nilai.Clear();
                                                            foreach (string rel_kp in lst_formatnilai_nilai.Select(m => m.Rel_KP).Distinct())
                                                            {

                                                                nilai_rapor = 0;
                                                                jumlah_nilai_rapor = 0;
                                                                count_nilai_rapor = 0;
                                                                foreach (var m_formatnilai_nilai in lst_formatnilai_nilai.FindAll(m => m.Rel_KP == rel_kp))
                                                                {
                                                                    Rapor_StrukturNilai_AP m_rel_sn_ap = DAO_Rapor_StrukturNilai_AP.GetByID_Entity(m_formatnilai_nilai.Rel_StrukturNilai_AP);
                                                                    if (m_rel_sn_ap != null)
                                                                    {
                                                                        if (m_rel_sn_ap.JenisPerhitungan != null)
                                                                        {

                                                                            if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                            {
                                                                                nilai_rapor += Math.Round((m_rel_sn_ap.BobotRapor / 100) * Libs.GetStringToDecimal(m_formatnilai_nilai.Nilai), 3, MidpointRounding.AwayFromZero);
                                                                            }
                                                                            else if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                            {
                                                                                jumlah_nilai_rapor += m_rel_sn_ap.BobotRapor;
                                                                            }
                                                                            count_nilai_rapor++;

                                                                        }
                                                                    }
                                                                }

                                                                if (count_nilai_rapor > 0)
                                                                {
                                                                    if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                    {
                                                                        nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    nilai_rapor = 0;
                                                                }
                                                                nilai_rapor = Math.Round(nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                                lst_nilai.Add(new NilaiWithKey
                                                                {
                                                                    Key = rel_kp,
                                                                    Nilai = nilai_rapor
                                                                });
                                                            }

                                                            nilai_rapor = 0;
                                                            jumlah_nilai_rapor = 0;
                                                            count_nilai_rapor = 0;
                                                            lst_kpkelompok = DAO_Rapor_StrukturNilai_KPKelompok.GetAllByHeader_Entity(
                                                                    m_struktur_nilai_sm1.Kode.ToString()
                                                                );
                                                            foreach (var item_nilai in lst_nilai)
                                                            {
                                                                Rapor_StrukturNilai_KPKelompok m_kpkelompok = lst_kpkelompok.FindAll(
                                                                        m => m.Rel_Rapor_KomponenPenilaian == new Guid(item_nilai.Key)
                                                                    ).FirstOrDefault();
                                                                if (m_kpkelompok != null)
                                                                {
                                                                    if (m_kpkelompok.Rel_Rapor_StrukturNilai != null)
                                                                    {
                                                                        nilai_rapor += Math.Round((m_kpkelompok.Bobot / 100) * item_nilai.Nilai, 3, MidpointRounding.AwayFromZero);
                                                                    }
                                                                }
                                                            }

                                                            nilai_non_q = 0;
                                                            if (lst_formatnilai_nilai2.Count > 0)
                                                            {
                                                                nilai_non_q = lst_formatnilai_nilai2.Select(m => Libs.GetStringToDecimal(m.Nilai)).DefaultIfEmpty().Average();
                                                            }
                                                            if (nilai_non_q > 0)
                                                            {
                                                                nilai_rapor = Math.Round((nilai_rapor + nilai_non_q) / 2, 3, MidpointRounding.AwayFromZero);
                                                            }
                                                            nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);
                                                            nilai_rapor_mulok_sm1 = nilai_rapor;
                                                        }
                                                        //end get nilai semester 1

                                                        id_kolom_ledger++;
                                                        lst_format_nilai = new List<FormatNilai>();
                                                        lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeader_Entity(
                                                                m_struktur_nilai.Kode.ToString()
                                                            );
                                                        foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                        {

                                                            List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                );

                                                            foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                            {

                                                                List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                );
                                                                foreach (
                                                                    var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp.FindAll(
                                                                        m => (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == DAO_Rapor_StrukturNilai.Arr_KP_Quran[0]) ||
                                                                             (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == DAO_Rapor_StrukturNilai.Arr_KP_Quran[1]) ||
                                                                             (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == DAO_Rapor_StrukturNilai.Arr_KP_Quran[2])
                                                                        )
                                                                )
                                                                {

                                                                    if (
                                                                        lst_format_nilai.FindAll(
                                                                                m => m.Rel_StrukturNilai_AP == item_rapor_struktur_nilai_ap.Kode.ToString() &&
                                                                                     m.Rel_KP == item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                            ).Count == 0
                                                                    )
                                                                    {
                                                                        lst_format_nilai.Add(new FormatNilai
                                                                        {
                                                                            Rel_StrukturNilai_AP = item_rapor_struktur_nilai_ap.Kode.ToString(),
                                                                            Rel_KP = item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                        });
                                                                    }

                                                                }
                                                            }

                                                        }

                                                        lst_format_nilai2 = new List<FormatNilai>();
                                                        foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                        {

                                                            List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                );

                                                            foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                            {

                                                                List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                );
                                                                foreach (
                                                                    var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp.FindAll(
                                                                        m => (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() != DAO_Rapor_StrukturNilai.Arr_KP_Quran[0]) &&
                                                                             (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() != DAO_Rapor_StrukturNilai.Arr_KP_Quran[1]) &&
                                                                             (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() != DAO_Rapor_StrukturNilai.Arr_KP_Quran[2])
                                                                        )
                                                                )
                                                                {

                                                                    if (
                                                                        lst_format_nilai2.FindAll(
                                                                                m => m.Rel_StrukturNilai_AP == item_rapor_struktur_nilai_ap.Kode.ToString() &&
                                                                                     m.Rel_KP == item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                            ).Count == 0
                                                                    )
                                                                    {
                                                                        lst_format_nilai2.Add(new FormatNilai
                                                                        {
                                                                            Rel_StrukturNilai_AP = item_rapor_struktur_nilai_ap.Kode.ToString(),
                                                                            Rel_KP = item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                        });
                                                                    }

                                                                }
                                                            }

                                                        }

                                                        lst_formatnilai_nilai = new List<FormatNilaiWithNilai>();
                                                        //distinct ap
                                                        foreach (string rel_sn_ap in lst_format_nilai.Select(m => m.Rel_StrukturNilai_AP).Distinct())
                                                        {
                                                            foreach (string rel_kp in lst_format_nilai.Select(m => m.Rel_KP).Distinct())
                                                            {

                                                                Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(rel_kp);
                                                                if (m_kp != null)
                                                                {
                                                                    if (m_kp.Nama != null)
                                                                    {

                                                                        double nilai = lst_nilai_siswa_det.Where(
                                                                            m => m.Rel_Rapor_StrukturNilai_AP.ToString().Trim().ToUpper() == rel_sn_ap.Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == rel_kp.Trim().ToUpper() &&
                                                                                 m.Rel_Siswa.Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper()
                                                                        ).Select(m => Libs.GetStringToDouble(m.Nilai)).DefaultIfEmpty().Average();

                                                                        lst_formatnilai_nilai.Add(new FormatNilaiWithNilai
                                                                        {
                                                                            Nama_KP = m_kp.Nama,
                                                                            Nilai = nilai.ToString(),
                                                                            Rel_KP = rel_kp,
                                                                            Rel_StrukturNilai_AP = rel_sn_ap
                                                                        });

                                                                    }
                                                                }

                                                            }
                                                        }

                                                        lst_formatnilai_nilai2 = new List<FormatNilaiWithNilai>();
                                                        //distinct ap
                                                        foreach (string rel_sn_ap in lst_format_nilai2.Select(m => m.Rel_StrukturNilai_AP).Distinct())
                                                        {
                                                            foreach (string rel_kp in lst_format_nilai2.Select(m => m.Rel_KP).Distinct())
                                                            {

                                                                Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(rel_kp);
                                                                if (m_kp != null)
                                                                {
                                                                    if (m_kp.Nama != null)
                                                                    {

                                                                        double nilai = lst_nilai_siswa_det.Where(
                                                                            m => m.Rel_Rapor_StrukturNilai_AP.ToString().Trim().ToUpper() == rel_sn_ap.Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == rel_kp.Trim().ToUpper() &&
                                                                                 m.Rel_Siswa.Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper()
                                                                        ).Select(m => Libs.GetStringToDouble(m.Nilai)).DefaultIfEmpty().Average();

                                                                        lst_formatnilai_nilai2.Add(new FormatNilaiWithNilai
                                                                        {
                                                                            Nama_KP = m_kp.Nama,
                                                                            Nilai = nilai.ToString(),
                                                                            Rel_KP = rel_kp,
                                                                            Rel_StrukturNilai_AP = rel_sn_ap
                                                                        });

                                                                    }
                                                                }

                                                            }
                                                        }

                                                        //get nilai rapor                                                        
                                                        lst_nilai = new List<NilaiWithKey>();
                                                        lst_nilai.Clear();
                                                        foreach (string rel_kp in lst_formatnilai_nilai.Select(m => m.Rel_KP).Distinct())
                                                        {

                                                            nilai_rapor = 0;
                                                            jumlah_nilai_rapor = 0;
                                                            count_nilai_rapor = 0;
                                                            foreach (var m_formatnilai_nilai in lst_formatnilai_nilai.FindAll(m => m.Rel_KP == rel_kp))
                                                            {
                                                                Rapor_StrukturNilai_AP m_rel_sn_ap = DAO_Rapor_StrukturNilai_AP.GetByID_Entity(m_formatnilai_nilai.Rel_StrukturNilai_AP);
                                                                if (m_rel_sn_ap != null)
                                                                {
                                                                    if (m_rel_sn_ap.JenisPerhitungan != null)
                                                                    {

                                                                        if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                        {
                                                                            nilai_rapor += Math.Round((m_rel_sn_ap.BobotRapor / 100) * Libs.GetStringToDecimal(m_formatnilai_nilai.Nilai), 3, MidpointRounding.AwayFromZero);
                                                                        }
                                                                        else if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                        {
                                                                            jumlah_nilai_rapor += m_rel_sn_ap.BobotRapor;
                                                                        }
                                                                        count_nilai_rapor++;

                                                                    }
                                                                }
                                                            }

                                                            if (count_nilai_rapor > 0)
                                                            {
                                                                if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_rapor = 0;
                                                            }
                                                            nilai_rapor = Math.Round(nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                            lst_nilai.Add(new NilaiWithKey
                                                            {
                                                                Key = rel_kp,
                                                                Nilai = nilai_rapor
                                                            });
                                                        }

                                                        nilai_rapor = 0;
                                                        jumlah_nilai_rapor = 0;
                                                        count_nilai_rapor = 0;
                                                        lst_kpkelompok = DAO_Rapor_StrukturNilai_KPKelompok.GetAllByHeader_Entity(
                                                                m_struktur_nilai.Kode.ToString()
                                                            );
                                                        foreach (var item_nilai in lst_nilai)
                                                        {
                                                            Rapor_StrukturNilai_KPKelompok m_kpkelompok = lst_kpkelompok.FindAll(
                                                                    m => m.Rel_Rapor_KomponenPenilaian == new Guid(item_nilai.Key)
                                                                ).FirstOrDefault();
                                                            if (m_kpkelompok != null)
                                                            {
                                                                if (m_kpkelompok.Rel_Rapor_StrukturNilai != null)
                                                                {
                                                                    nilai_rapor += Math.Round((m_kpkelompok.Bobot / 100) * item_nilai.Nilai, 3, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                        }

                                                        nilai_non_q = 0;
                                                        if (lst_formatnilai_nilai2.Count > 0)
                                                        {
                                                            nilai_non_q = lst_formatnilai_nilai2.Select(m => Libs.GetStringToDecimal(m.Nilai)).DefaultIfEmpty().Average();
                                                        }
                                                        if (nilai_non_q > 0)
                                                        {
                                                            nilai_rapor = Math.Round((nilai_rapor + nilai_non_q) / 2, 3, MidpointRounding.AwayFromZero);
                                                        }
                                                        nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);
                                                        nilai_rapor_pengetahuan = nilai_rapor;
                                                        jumlah_keseluruhan += nilai_rapor;
                                                        jumlah_mapel_rapor++;
                                                        lst_all_nilai_rapor.Add(new NilaiWithKey
                                                        {
                                                            Key = (id_kolom_ledger).ToString(),
                                                            Nilai = nilai_rapor_pengetahuan
                                                        });
                                                        //end get nilai rapor
                                                        //end distinct ap
                                                        id_kolom_ledger++;
                                                    }

                                                    jumlah_mapel_rapor++;
                                                }
                                            }
                                            //end get struktur nilai

                                            html_row_body_siswa += "<td style=\"" + css_cell_body + " text-align: center; " + (nilai_rapor_pengetahuan < m_struktur_nilai.KKM ? " font-weight: bold; color: #9C0006; background-color: #FFC7CE; " : "") + "\">" +
                                                                        nilai_rapor_pengetahuan.ToString() +
                                                                   "</td>" +
                                                                   "<td style=\"" + css_cell_body + " text-align: center; " + (nilai_rapor_pengetahuan < m_struktur_nilai.KKM ? " font-weight: bold; color: #9C0006; background-color: #FFC7CE; " : "") + "\">" +
                                                                        GetPredikatRapor(nilai_rapor_pengetahuan) +
                                                                   "</td>";
                                        }

                                    }
                                    //end rapor mulok

                                    lst_jumlah_nilai_keseluruhan.Add(new NilaiWithKey
                                    {
                                        Key = m_siswa.Kode.ToString(),
                                        Nilai = jumlah_keseluruhan
                                    });

                                    //absen
                                    string s_sakit = "-";
                                    string s_izin = "-";
                                    string s_alpa = "-";
                                    string s_terlambat = "-";

                                    Rapor_Arsip m_rapor_arsip = DAO_Rapor_Arsip.GetAll_Entity().FindAll(
                                            m0 => m0.TahunAjaran == tahun_ajaran &&
                                                  m0.Semester == semester &&
                                                  m0.JenisRapor == "Semester"

                                        ).FirstOrDefault();
                                    List<DAO_SiswaAbsen.AbsenRekapRapor> lst_absen = new List<DAO_SiswaAbsen.AbsenRekapRapor>();
                                    lst_absen = DAO_SiswaAbsen.GetRekapAbsenRaporBySiswaByPeriode_Entity(
                                            m_siswa.Kode.ToString(),
                                            (m_rapor_arsip != null ? m_rapor_arsip.TanggalAwalAbsen : DateTime.MinValue),
                                            (m_rapor_arsip != null ? m_rapor_arsip.TanggalAkhirAbsen : DateTime.MinValue)
                                        );
                                    foreach (var absen in lst_absen)
                                    {
                                        if (absen.Absen == Libs.JENIS_ABSENSI.SAKIT.Substring(0, 1)) s_sakit = absen.Jumlah.ToString();
                                        if (absen.Absen == Libs.JENIS_ABSENSI.IZIN.Substring(0, 1)) s_izin = absen.Jumlah.ToString();
                                        if (absen.Absen == Libs.JENIS_ABSENSI.ALPA.Substring(0, 1)) s_alpa = absen.Jumlah.ToString();
                                        if (absen.Absen == Libs.JENIS_ABSENSI.TERLAMBAT.Substring(0, 1)) s_terlambat = absen.Jumlah.ToString();
                                    }
                                    html_row_body_siswa += "<td style=\"" + css_cell_body + " text-align: center; \">" +
                                                                s_sakit +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + " text-align: center; \">" +
                                                                s_izin +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + " text-align: center; \">" +
                                                                s_alpa +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + " text-align: center; \">" +
                                                                s_terlambat +
                                                           "</td>";
                                    //end absen

                                    html_row_body += "<tr>" +
                                                        html_row_body_siswa +
                                                     "</tr>";

                                    nomor++;
                                }
                                // end foreach siswa

                                for (int i = (jumlah_awal_col_ledger + 1); i <= id_kolom_ledger; i++)
                                {
                                    if (i >= id_mulai_looping_rata_rata)
                                    {
                                        decimal rata_rata = Math.Round(lst_all_nilai_rapor.FindAll(m => m.Key == i.ToString()).Select(m => m.Nilai).DefaultIfEmpty().Average(), Constantas.PEMBULATAN_DESIMAL_NILAI_SD);
                                        html_row_rata_rata += "<td style=\"" + css_cell_body + " text-align: right;\">" +
                                                                    (
                                                                        rata_rata > 0
                                                                        ? Libs.GetFormatBilangan(rata_rata, Constantas.PEMBULATAN_DESIMAL_NILAI_SD)
                                                                        : ""
                                                                    ) +
                                                              "</td>";
                                    }
                                    else
                                    {
                                        decimal rata_rata = Math.Round(lst_all_nilai_rapor.FindAll(m => m.Key == i.ToString()).Select(m => m.Nilai).DefaultIfEmpty().Average(), Constantas.PEMBULATAN_DESIMAL_NILAI_SD);
                                        html_row_rata_rata += "<td style=\"" + css_cell_body + " text-align: right;\">" +
                                                                    (
                                                                        rata_rata > 0
                                                                        ? Libs.GetFormatBilangan(rata_rata, Constantas.PEMBULATAN_DESIMAL_NILAI_SD)
                                                                        : ""
                                                                    ) +
                                                              "</td>";
                                    }
                                }
                                for (int i = 1; i < jumlah_mapel_rapor - 1; i++)
                                {
                                    if (i > id_mulai_looping_kkm)
                                    {
                                        decimal kkm = 0;
                                        NilaiWithKey m_kkm = lst_kkm_nilai_rapor.FindAll(m => m.Key == i.ToString()).FirstOrDefault();
                                        if (m_kkm != null)
                                        {
                                            if (m_kkm.Key != null)
                                            {
                                                kkm = m_kkm.Nilai;
                                            }
                                        }
                                        html_row_kkm += "<td colspan=\"2\" style=\"" + css_cell_body + " text-align: center;\">" +
                                                            Libs.GetFormatBilangan(kkm, Constantas.PEMBULATAN_DESIMAL_NILAI_SD) +
                                                        "</td>";
                                    }
                                    else
                                    {
                                        decimal kkm = 0;
                                        NilaiWithKey m_kkm = lst_kkm_nilai_rapor.FindAll(m => m.Key == i.ToString()).FirstOrDefault();
                                        if (m_kkm != null)
                                        {
                                            if (m_kkm.Key != null)
                                            {
                                                kkm = m_kkm.Nilai;
                                            }
                                        }
                                        html_row_kkm += "<td colspan=\"4\" style=\"" + css_cell_body + " text-align: center;\">" +
                                                            Libs.GetFormatBilangan(kkm, Constantas.PEMBULATAN_DESIMAL_NILAI_SD) +
                                                        "</td>";
                                    }
                                }
                                decimal rata_rata_nilai_keseluruhan = Math.Round(lst_jumlah_nilai_keseluruhan.Select(m => m.Nilai).DefaultIfEmpty().Average(), Constantas.PEMBULATAN_DESIMAL_NILAI_SD);
                                decimal rata_rata_nilai_rata_rata_rapor = Math.Round(lst_nilai_rapor.Select(m => m.Nilai).DefaultIfEmpty().Average(), Constantas.PEMBULATAN_DESIMAL_NILAI_SD);
                                html_row_body += "<tr>" +
                                                    html_row_rata_rata +
                                                 "</tr>" +
                                                 "<tr>" +
                                                    html_row_kkm +
                                                 "</tr>";

                            }

                        }
                    }

                }
            }

            html_row_header = "<tr>" +
                                html_row_header +
                              "</tr>" +
                              "<tr>" +
                                html_row_mapel +
                              "</tr>" +
                              "<tr>" +
                                html_row_jenis_nilai +
                              "</tr>" +
                              html_row_body;

            html = "<table style=\"border-collapse: collapse;\">" +
                        html_row_header +
                   "</table>";

            return html;
        }

        public static string GetHTMLLedger_KURTILAS_2020(
            System.Web.UI.Page page,
            string tahun_ajaran,
            string semester,
            string rel_kelas_det,
            string rel_siswa = ""
        )
        {
            string css_cell_headers = "border-style: solid; border-width: 1px; text-align: center; font-weight: bold; padding: 5px;";
            string css_cell_body = "border-style: solid; border-width: 1px; padding: 3px;";

            string html = "";
            string html_row_header = "<td rowspan=\"3\" style=\"" + css_cell_headers + "\">" +
                                        "No" +
                                     "</td>" +
                                     "<td rowspan=\"3\" style=\"" + css_cell_headers + "\">" +
                                        "NIS" +
                                     "</td>" +
                                     "<td rowspan=\"3\" style=\"" + css_cell_headers + "\">" +
                                        "NAMA LENGKAP" +
                                     "</td>" +
                                     "<td rowspan=\"3\" style=\"" + css_cell_headers + "\">" +
                                        "L/P" +
                                     "</td>";
            string html_row_mapel = "";
            string html_row_jenis_nilai = "";
            string html_row_body = "";

            KelasDet m_kelas_det = DAO_KelasDet.GetByID_Entity(rel_kelas_det);
            if (m_kelas_det != null)
            {
                if (m_kelas_det.Nama != null)
                {

                    Kelas m_kelas = DAO_Kelas.GetByID_Entity(m_kelas_det.Rel_Kelas.ToString());
                    if (m_kelas != null)
                    {
                        if (m_kelas.Nama != null)
                        {

                            Rapor_Desain rapor_desain = DAO_Rapor_Desain.GetByTABySMByKelas_Entity(
                                    tahun_ajaran, semester, rel_kelas_det, DAO_Rapor_Desain.JenisRapor.Semester
                                ).FirstOrDefault();

                            List<Rapor_Desain_Det> lst_rapor_desain_det = DAO_Rapor_Desain_Det.GetAllByHeader_Entity(rapor_desain.Kode.ToString()).FindAll(m => m.Rel_Mapel.Trim() != "");

                            //list cols header
                            int jml_colspan_mapel = 0;
                            int jumlah_mapel = 0;
                            html_row_mapel = "";
                            foreach (Rapor_Desain_Det item_desain_det in lst_rapor_desain_det)
                            {
                                html_row_mapel += "<td colspan=\"4\" style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                    item_desain_det.NamaMapelRapor.Trim().ToUpper() +
                                                  "</td>";
                                html_row_jenis_nilai += "<td style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                                "PENGETAHUAN" +
                                                        "</td>" +
                                                        "<td style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                                "PREDIKAT" +
                                                        "</td>" +
                                                        "<td style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                                "KETERAMPILAN" +
                                                        "</td>" +
                                                        "<td style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                                "PREDIKAT" +
                                                        "</td>";
                                jumlah_mapel++;
                            }
                            jml_colspan_mapel = (jumlah_mapel * 4);

                            html_row_header += "<td colspan=\"" + jml_colspan_mapel.ToString() + "\" style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                    "NILAI MATA PELAJARAN" +
                                               "</td>";
                            html_row_header += "<td colspan=\"4\" style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                    "PRESENSI" +
                                               "</td>";
                            html_row_mapel += "<td rowspan=\"2\" style=\"" + css_cell_headers + " width: 30px; font-size: 8.5px; \">" +
                                                    "S" +
                                              "</td>" +
                                              "<td rowspan=\"2\" style=\"" + css_cell_headers + " width: 30px; font-size: 8.5px; \">" +
                                                    "I" +
                                              "</td>" +
                                              "<td rowspan=\"2\" style=\"" + css_cell_headers + " width: 30px; font-size: 8.5px; \">" +
                                                    "A" +
                                              "</td>" +
                                              "<td rowspan=\"2\" style=\"" + css_cell_headers + " width: 30px; font-size: 8.5px; \">" +
                                                    "T" +
                                              "</td>";
                            //end list cols header
                            if (rapor_desain != null)
                            {

                                List<DAO_Siswa.SiswaDataSimple> lst_siswa = DAO_Siswa.GetAllSiswaDataSimpleByTahunAjaranUnitKelas_Entity(
                                        m_kelas.Rel_Sekolah.ToString(),
                                        rel_kelas_det,
                                        tahun_ajaran,
                                        semester
                                    );
                                List<decimal> lst_nilai_ap = new List<decimal>();
                                List<decimal> lst_nilai_ap_bobot = new List<decimal>();
                                List<decimal> lst_nilai_kd = new List<decimal>();
                                List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT> lst_nilai_siswa_det = new List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT>();
                                List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT> lst_nilai_siswa_det_by_periode = new List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT>();
                                List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT> lst_nilai_siswa_det_sm1 = new List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT>();
                                List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT> lst_nilai_siswa_det_by_periode_sm1 = new List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT>();

                                lst_nilai_siswa_det_by_periode = DAO_Rapor_NilaiSiswa_Det.GetAllByTABySMByKelasDet_Entity(
                                        tahun_ajaran, semester, rel_kelas_det
                                    );
                                lst_nilai_siswa_det_by_periode_sm1 = DAO_Rapor_NilaiSiswa_Det.GetAllByTABySMByKelasDet_Entity(
                                        tahun_ajaran, "1", rel_kelas_det
                                    );

                                int id_kolom_ledger = 0;
                                int nomor = 1;
                                int jumlah_awal_col_ledger = 3;
                                int jumlah_mapel_rapor = 0;

                                if (rel_siswa.Trim() != "")
                                {
                                    lst_siswa = lst_siswa.FindAll(m0 => (rel_siswa + ";").Trim().ToUpper().IndexOf(m0.Kode.ToString().ToUpper() + ";") >= 0).ToList();
                                }
                                List<NilaiWithKey> lst_all_nilai_rapor = new List<NilaiWithKey>();
                                List<NilaiWithKey> lst_kkm_nilai_rapor = new List<NilaiWithKey>();
                                List<NilaiWithKey> lst_jumlah_nilai_keseluruhan = new List<NilaiWithKey>();
                                List<NilaiWithKey> lst_nilai_rapor = new List<NilaiWithKey>();
                                decimal jumlah_keseluruhan = 0;

                                string html_row_rata_rata = "<td colspan=\"4\" style=\"" + css_cell_body + " font-weight: bold;\">" +
                                                                "RATA-RATA KELAS" +
                                                            "</td>";
                                string html_row_kkm = "<td colspan=\"4\" style=\"" + css_cell_body + " font-weight: bold;\">" +
                                                            "KKM" +
                                                      "</td>";

                                int id_mulai_looping_rata_rata = id_kolom_ledger + 1;
                                int id_mulai_looping_kkm = jumlah_mapel_rapor + 1;

                                foreach (DAO_Siswa.SiswaDataSimple m_siswa in lst_siswa.OrderBy(m => m.Nama))
                                {
                                    jumlah_keseluruhan = 0;
                                    jumlah_mapel_rapor = 0;

                                    string html_row_body_siswa = "";
                                    html_row_body_siswa += "<td style=\"" + css_cell_body + " text-align: center;\">" +
                                                                nomor.ToString() +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + "\">" +
                                                                m_siswa.NISSekolah +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + " white-space: nowrap;\">" +
                                                                Libs.GetPerbaikiEjaanNama(m_siswa.Nama) +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + "\">" +
                                                                m_siswa.JenisKelamin +
                                                           "</td>";

                                    lst_kkm_nilai_rapor.Clear();
                                    id_kolom_ledger = jumlah_awal_col_ledger;

                                    foreach (Rapor_Desain_Det item in DAO_Rapor_Desain_Det.GetAllByHeader_Entity(rapor_desain.Kode.ToString()).FindAll(m => m.Rel_Mapel.Trim() != ""))
                                    {

                                        if (item.Rel_Mapel.Trim() != "")
                                        {

                                            lst_nilai_siswa_det = lst_nilai_siswa_det_by_periode.FindAll(
                                                    m => m.Rel_Mapel == item.Rel_Mapel &&
                                                         m.Rel_Siswa == m.Rel_Siswa
                                                );
                                            lst_nilai_siswa_det_sm1 = lst_nilai_siswa_det_by_periode_sm1.FindAll(
                                                    m => m.Rel_Mapel == item.Rel_Mapel &&
                                                         m.Rel_Siswa == m.Rel_Siswa
                                                );

                                            //get struktur nilainya
                                            Rapor_StrukturNilai m_struktur_nilai_sm1 = DAO_Rapor_StrukturNilai.GetATop1ByTABySMByKelasByMapel_Entity(
                                                    tahun_ajaran, "1", m_kelas.Kode.ToString(), item.Rel_Mapel
                                                );
                                            Rapor_StrukturNilai m_struktur_nilai = DAO_Rapor_StrukturNilai.GetATop1ByTABySMByKelasByMapel_Entity(
                                                    tahun_ajaran, semester, m_kelas.Kode.ToString(), item.Rel_Mapel
                                                );

                                            decimal nilai_rapor = 0;
                                            decimal jumlah_nilai_rapor = 0;
                                            decimal count_nilai_rapor = 0;

                                            decimal nilai_rapor_pengetahuan_sm1 = 0;
                                            decimal nilai_rapor_keterampilan_sm1 = 0;
                                            decimal nilai_rapor_pengetahuan = 0;
                                            decimal nilai_rapor_keterampilan = 0;

                                            Rapor_StrukturNilai_AP m_sn_ap = new Rapor_StrukturNilai_AP();

                                            if (m_struktur_nilai != null)
                                            {
                                                if (m_struktur_nilai.TahunAjaran != null)
                                                {

                                                    lst_kkm_nilai_rapor.Add(new NilaiWithKey
                                                    {
                                                        Key = (jumlah_mapel_rapor + 1).ToString(),
                                                        Nilai = m_struktur_nilai.KKM
                                                    });

                                                    decimal jumlah_nilai_ap = 0;
                                                    decimal nilai_ap = 0;
                                                    int count_ap = 0;
                                                    List<Rapor_StrukturNilai_AP> lst_rapor_struktur_nilai_ap = new List<Rapor_StrukturNilai_AP>();
                                                    List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = new List<Rapor_StrukturNilai_KD>();

                                                    //jika semester 2 get semester 1
                                                    if (semester == "2")
                                                    {
                                                        lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeaderByJenisAspekPenilaian_Entity(
                                                            m_struktur_nilai_sm1.Kode.ToString(), DAO_Rapor_StrukturNilai_AP.JenisAspekPenilaian.Pengetahuan
                                                        );
                                                        lst_nilai_ap.Clear();
                                                        lst_nilai_ap_bobot.Clear();
                                                        jumlah_nilai_ap = 0;
                                                        nilai_ap = 0;
                                                        count_ap = 0;
                                                        m_sn_ap = new Rapor_StrukturNilai_AP();
                                                        foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                        {

                                                            //get struktur nilai det KD
                                                            lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                );
                                                            lst_nilai_kd.Clear();
                                                            foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                            {

                                                                //get struktur nilai det KP
                                                                List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                );
                                                                decimal jumlah_nilai_kd = 0;
                                                                decimal nilai_kd = 0;
                                                                int count_kd = 0;
                                                                foreach (var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp)
                                                                {
                                                                    Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString());
                                                                    if (m_kp != null)
                                                                    {

                                                                        Rapor_NilaiSiswa_Det m_nilai_det = lst_nilai_siswa_det_sm1.FindAll(
                                                                            m => m.Rel_Siswa.ToString().Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai_sm1.Rel_Mapel.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_AP.Trim().ToUpper() == item_rapor_struktur_nilai_ap.Kode.ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KD.Trim().ToUpper() == item_rapor_struktur_nilai_kd.Kode.ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KP.Trim().ToUpper() == item_rapor_struktur_nilai_kp.Kode.ToString().ToUpper()
                                                                        ).FirstOrDefault();

                                                                        if (m_nilai_det != null)
                                                                        {
                                                                            if (m_nilai_det.Nilai.Trim() != "")
                                                                            {
                                                                                if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                                {
                                                                                    nilai_kd += Math.Round((item_rapor_struktur_nilai_kp.BobotNK / 100) * Libs.GetStringToDecimal(m_nilai_det.Nilai), 2, MidpointRounding.AwayFromZero);
                                                                                }
                                                                                else if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                                {
                                                                                    jumlah_nilai_kd += Libs.GetStringToDecimal(m_nilai_det.Nilai);
                                                                                }
                                                                                count_kd++;
                                                                            }
                                                                        }

                                                                    }

                                                                }

                                                                if (count_kd > 0)
                                                                {
                                                                    if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                    {
                                                                        nilai_kd = Math.Round(jumlah_nilai_kd / count_kd, 2, MidpointRounding.AwayFromZero);
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    nilai_kd = 0;
                                                                }

                                                                //load nilai manual
                                                                Rapor_NilaiSiswa_AP_or_KD m_nilai_manual = DAO_Rapor_NilaiSiswa_AP_or_KD.GetAllByTABySMByKelasByMapelBySiswaByStruktur_Entity(
                                                                        tahun_ajaran, m_struktur_nilai_sm1.Semester, rel_kelas_det, m_siswa.Kode.ToString(), item.Rel_Mapel,
                                                                        item_rapor_struktur_nilai_kd.Kode.ToString().Trim().ToUpper()

                                                                    ).FirstOrDefault();
                                                                if (m_nilai_manual != null)
                                                                {
                                                                    if (m_nilai_manual.Nilai != null)
                                                                    {
                                                                        nilai_kd = Libs.GetStringToDecimal(m_nilai_manual.Nilai);
                                                                    }
                                                                }
                                                                //end load nilai manual

                                                                nilai_kd = Math.Round(nilai_kd, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);
                                                                lst_nilai_kd.Add(nilai_kd);
                                                                //end get struktur nilai det KP

                                                            }
                                                            //end get struktur nilai det KD

                                                            //get nilai ap
                                                            count_ap = 0;
                                                            nilai_ap = 0;
                                                            jumlah_nilai_ap = 0;
                                                            foreach (var item_nilai_kd in lst_nilai_kd)
                                                            {
                                                                if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                {
                                                                    nilai_ap += Math.Round((item_rapor_struktur_nilai_ap.BobotRapor / 100) * item_nilai_kd, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                                else if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    jumlah_nilai_ap += item_nilai_kd;
                                                                }
                                                                count_ap++;
                                                            }
                                                            if (count_ap > 0)
                                                            {
                                                                if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_ap = Math.Round(jumlah_nilai_ap / count_ap, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_ap = 0;
                                                            }
                                                            nilai_ap = Math.Round(nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                            lst_nilai_ap.Add(nilai_ap);
                                                            lst_nilai_ap_bobot.Add(item_rapor_struktur_nilai_ap.BobotRapor);
                                                            //end get nilai ap

                                                        }
                                                        //end get struktur nilai det AP

                                                        //get nilai rapor
                                                        nilai_rapor = 0;
                                                        jumlah_nilai_rapor = 0;
                                                        count_nilai_rapor = 0;
                                                        foreach (var item_nilai_ap in lst_nilai_ap)
                                                        {
                                                            if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                            {
                                                                nilai_rapor += Math.Round((lst_nilai_ap_bobot[Convert.ToInt16(count_nilai_rapor)] / 100) * item_nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                            }
                                                            else if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                jumlah_nilai_rapor += item_nilai_ap;
                                                            }
                                                            count_nilai_rapor++;
                                                        }
                                                        if (count_nilai_rapor > 0)
                                                        {
                                                            if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            nilai_rapor = 0;
                                                        }
                                                        nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);
                                                        nilai_rapor_pengetahuan_sm1 = nilai_rapor;
                                                    }
                                                    //end jika semester 2 get semester 1

                                                    //-----------nilai pengetahuan---------------
                                                    id_kolom_ledger++;
                                                    //get struktur nilai det AP
                                                    lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeaderByJenisAspekPenilaian_Entity(
                                                            m_struktur_nilai.Kode.ToString(), DAO_Rapor_StrukturNilai_AP.JenisAspekPenilaian.Pengetahuan
                                                        );
                                                    lst_nilai_ap.Clear();
                                                    lst_nilai_ap_bobot.Clear();
                                                    jumlah_nilai_ap = 0;
                                                    nilai_ap = 0;
                                                    count_ap = 0;
                                                    m_sn_ap = new Rapor_StrukturNilai_AP();
                                                    foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                    {

                                                        //get struktur nilai det KD
                                                        lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                item_rapor_struktur_nilai_ap.Kode.ToString()
                                                            );
                                                        lst_nilai_kd.Clear();
                                                        foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                        {

                                                            //get struktur nilai det KP
                                                            List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                item_rapor_struktur_nilai_kd.Kode.ToString()
                                                            );
                                                            decimal jumlah_nilai_kd = 0;
                                                            decimal nilai_kd = 0;
                                                            int count_kd = 0;
                                                            foreach (var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp)
                                                            {
                                                                Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString());
                                                                if (m_kp != null)
                                                                {

                                                                    Rapor_NilaiSiswa_Det m_nilai_det = lst_nilai_siswa_det.FindAll(
                                                                        m => m.Rel_Siswa.ToString().Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                             m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper() &&
                                                                             m.Rel_Rapor_StrukturNilai_AP.Trim().ToUpper() == item_rapor_struktur_nilai_ap.Kode.ToString().ToUpper() &&
                                                                             m.Rel_Rapor_StrukturNilai_KD.Trim().ToUpper() == item_rapor_struktur_nilai_kd.Kode.ToString().ToUpper() &&
                                                                             m.Rel_Rapor_StrukturNilai_KP.Trim().ToUpper() == item_rapor_struktur_nilai_kp.Kode.ToString().ToUpper()
                                                                    ).FirstOrDefault();

                                                                    if (m_nilai_det != null)
                                                                    {
                                                                        if (m_nilai_det.Nilai.Trim() != "")
                                                                        {
                                                                            if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                            {
                                                                                nilai_kd += Math.Round((item_rapor_struktur_nilai_kp.BobotNK / 100) * Libs.GetStringToDecimal(m_nilai_det.Nilai), 2, MidpointRounding.AwayFromZero);
                                                                            }
                                                                            else if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                            {
                                                                                jumlah_nilai_kd += Libs.GetStringToDecimal(m_nilai_det.Nilai);
                                                                            }
                                                                            count_kd++;
                                                                        }
                                                                    }

                                                                }

                                                            }

                                                            if (count_kd > 0)
                                                            {
                                                                if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_kd = Math.Round(jumlah_nilai_kd / count_kd, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_kd = 0;
                                                            }

                                                            //load nilai manual
                                                            Rapor_NilaiSiswa_AP_or_KD m_nilai_manual = DAO_Rapor_NilaiSiswa_AP_or_KD.GetAllByTABySMByKelasByMapelBySiswaByStruktur_Entity(
                                                                    tahun_ajaran, semester, rel_kelas_det, m_siswa.Kode.ToString(), item.Rel_Mapel,
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString().Trim().ToUpper()

                                                                ).FirstOrDefault();
                                                            if (m_nilai_manual != null)
                                                            {
                                                                if (m_nilai_manual.Nilai != null)
                                                                {
                                                                    nilai_kd = Libs.GetStringToDecimal(m_nilai_manual.Nilai);
                                                                }
                                                            }
                                                            //end load nilai manual

                                                            nilai_kd = Math.Round(nilai_kd, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);
                                                            lst_nilai_kd.Add(nilai_kd);
                                                            //end get struktur nilai det KP

                                                        }
                                                        //end get struktur nilai det KD

                                                        //get nilai ap
                                                        count_ap = 0;
                                                        nilai_ap = 0;
                                                        jumlah_nilai_ap = 0;
                                                        foreach (var item_nilai_kd in lst_nilai_kd)
                                                        {
                                                            if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                            {
                                                                nilai_ap += Math.Round((item_rapor_struktur_nilai_ap.BobotRapor / 100) * item_nilai_kd, 2, MidpointRounding.AwayFromZero);
                                                            }
                                                            else if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                jumlah_nilai_ap += item_nilai_kd;
                                                            }
                                                            count_ap++;
                                                        }
                                                        if (count_ap > 0)
                                                        {
                                                            if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                nilai_ap = Math.Round(jumlah_nilai_ap / count_ap, 2, MidpointRounding.AwayFromZero);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            nilai_ap = 0;
                                                        }
                                                        nilai_ap = Math.Round(nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                        lst_nilai_ap.Add(nilai_ap);
                                                        //end get nilai ap

                                                        m_sn_ap = item_rapor_struktur_nilai_ap;
                                                    }
                                                    //end get struktur nilai det AP

                                                    //get nilai rapor
                                                    nilai_rapor = 0;
                                                    jumlah_nilai_rapor = 0;
                                                    count_nilai_rapor = 0;
                                                    foreach (var item_nilai_ap in lst_nilai_ap)
                                                    {
                                                        if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                        {
                                                            nilai_rapor += Math.Round((lst_nilai_ap_bobot[Convert.ToInt16(count_nilai_rapor)] / 100) * item_nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                        }
                                                        else if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                        {
                                                            jumlah_nilai_rapor += item_nilai_ap;
                                                        }
                                                        count_nilai_rapor++;
                                                    }
                                                    if (count_nilai_rapor > 0)
                                                    {
                                                        if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                        {
                                                            nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                        }
                                                    }
                                                    else
                                                    {
                                                        nilai_rapor = 0;
                                                    }
                                                    nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);

                                                    //jika ada PAT atau UKK
                                                    if (m_sn_ap.IsAdaPAT_UKK)
                                                    {
                                                        Rapor_NilaiSiswa_Det m_nilai_det = lst_nilai_siswa_det.FindAll(
                                                                        m => m.Rel_Siswa.ToString().Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                             m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper() &&
                                                                             m.Rel_Rapor_StrukturNilai_AP.Trim().ToUpper() == (Constantas.SD.GetKode_NK_KD_UKKPAT(m_sn_ap.Kode.ToString())).ToString().ToUpper() &&
                                                                             m.Rel_Rapor_StrukturNilai_KD.Trim().ToUpper() == (Constantas.SD.GetKode_NK_KD_UKKPAT(m_sn_ap.Kode.ToString())).ToString().ToUpper() &&
                                                                             m.Rel_Rapor_StrukturNilai_KP.Trim().ToUpper() == (Constantas.SD.GetKode_NK_KD_UKKPAT(m_sn_ap.Kode.ToString())).ToString().ToUpper()
                                                                    ).FirstOrDefault();

                                                        string s_nilai_pat_ukk = "0";
                                                        if (m_nilai_det != null)
                                                        {
                                                            if (m_nilai_det.Nilai.Trim() != "")
                                                            {
                                                                s_nilai_pat_ukk = m_nilai_det.Nilai;
                                                            }
                                                        }

                                                        nilai_rapor = Math.Round(
                                                                        Libs.GetStringToDecimal(s_nilai_pat_ukk) * (m_sn_ap.Bobot_PAT_UKK / 100), 2
                                                                      ) +
                                                                        Math.Round(
                                                                        nilai_rapor * (m_sn_ap.Bobot_Non_PAT_UKK / 100), 2
                                                                      );

                                                        nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);
                                                    }
                                                    //jika ada PAT atau UKK

                                                    nilai_rapor_pengetahuan = nilai_rapor;
                                                    lst_all_nilai_rapor.Add(new NilaiWithKey
                                                    {
                                                        Key = (id_kolom_ledger).ToString(),
                                                        Nilai = nilai_rapor_pengetahuan
                                                    });
                                                    id_kolom_ledger += 2;
                                                    //end get nilai rapor
                                                    //-----------end nilai pengetahuan---------------

                                                    //-----------nilai keterampilan---------------
                                                    if (semester == "2")
                                                    {
                                                        lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeaderByJenisAspekPenilaian_Entity(
                                                            m_struktur_nilai_sm1.Kode.ToString(), DAO_Rapor_StrukturNilai_AP.JenisAspekPenilaian.Keterampilan
                                                        );
                                                        lst_nilai_ap.Clear();
                                                        lst_nilai_ap_bobot.Clear();
                                                        jumlah_nilai_ap = 0;
                                                        nilai_ap = 0;
                                                        count_ap = 0;
                                                        m_sn_ap = new Rapor_StrukturNilai_AP();
                                                        foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                        {

                                                            //get struktur nilai det KD
                                                            lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                );
                                                            lst_nilai_kd.Clear();
                                                            foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                            {

                                                                //get struktur nilai det KP
                                                                List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                );
                                                                decimal jumlah_nilai_kd = 0;
                                                                decimal nilai_kd = 0;
                                                                int count_kd = 0;
                                                                foreach (var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp)
                                                                {
                                                                    Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString());
                                                                    if (m_kp != null)
                                                                    {

                                                                        Rapor_NilaiSiswa_Det m_nilai_det = lst_nilai_siswa_det_sm1.FindAll(
                                                                            m => m.Rel_Siswa.ToString().Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai_sm1.Rel_Mapel.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_AP.Trim().ToUpper() == item_rapor_struktur_nilai_ap.Kode.ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KD.Trim().ToUpper() == item_rapor_struktur_nilai_kd.Kode.ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KP.Trim().ToUpper() == item_rapor_struktur_nilai_kp.Kode.ToString().ToUpper()
                                                                        ).FirstOrDefault();

                                                                        if (m_nilai_det != null)
                                                                        {
                                                                            if (m_nilai_det.Nilai.Trim() != "")
                                                                            {
                                                                                if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                                {
                                                                                    nilai_kd += Math.Round((item_rapor_struktur_nilai_kp.BobotNK / 100) * Libs.GetStringToDecimal(m_nilai_det.Nilai), 2, MidpointRounding.AwayFromZero);
                                                                                }
                                                                                else if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                                {
                                                                                    jumlah_nilai_kd += Libs.GetStringToDecimal(m_nilai_det.Nilai);
                                                                                }
                                                                                count_kd++;
                                                                            }
                                                                        }

                                                                    }

                                                                }

                                                                if (count_kd > 0)
                                                                {
                                                                    if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                    {
                                                                        nilai_kd = Math.Round(jumlah_nilai_kd / count_kd, 2, MidpointRounding.AwayFromZero);
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    nilai_kd = 0;
                                                                }

                                                                //load nilai manual
                                                                Rapor_NilaiSiswa_AP_or_KD m_nilai_manual = DAO_Rapor_NilaiSiswa_AP_or_KD.GetAllByTABySMByKelasByMapelBySiswaByStruktur_Entity(
                                                                        tahun_ajaran, semester, rel_kelas_det, m_siswa.Kode.ToString(), item.Rel_Mapel,
                                                                        item_rapor_struktur_nilai_kd.Kode.ToString().Trim().ToUpper()

                                                                    ).FirstOrDefault();
                                                                if (m_nilai_manual != null)
                                                                {
                                                                    if (m_nilai_manual.Nilai != null)
                                                                    {
                                                                        nilai_kd = Libs.GetStringToDecimal(m_nilai_manual.Nilai);
                                                                    }
                                                                }
                                                                //end load nilai manual

                                                                nilai_kd = Math.Round(nilai_kd, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);
                                                                lst_nilai_kd.Add(nilai_kd);
                                                                //end get struktur nilai det KP

                                                            }
                                                            //end get struktur nilai det KD

                                                            //get nilai ap
                                                            count_ap = 0;
                                                            nilai_ap = 0;
                                                            jumlah_nilai_ap = 0;
                                                            foreach (var item_nilai_kd in lst_nilai_kd)
                                                            {
                                                                if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                {
                                                                    nilai_ap += Math.Round((item_rapor_struktur_nilai_ap.BobotRapor / 100) * item_nilai_kd, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                                else if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    jumlah_nilai_ap += item_nilai_kd;
                                                                }
                                                                count_ap++;
                                                            }
                                                            if (count_ap > 0)
                                                            {
                                                                if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_ap = Math.Round(jumlah_nilai_ap / count_ap, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_ap = 0;
                                                            }
                                                            nilai_ap = Math.Round(nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                            lst_nilai_ap.Add(nilai_ap);
                                                            lst_nilai_ap_bobot.Add(item_rapor_struktur_nilai_ap.BobotRapor);
                                                            //end get nilai ap

                                                        }
                                                        //end get struktur nilai det AP

                                                        //get nilai rapor
                                                        nilai_rapor = 0;
                                                        jumlah_nilai_rapor = 0;
                                                        count_nilai_rapor = 0;
                                                        foreach (var item_nilai_ap in lst_nilai_ap)
                                                        {
                                                            if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                            {
                                                                nilai_rapor += Math.Round((lst_nilai_ap_bobot[Convert.ToInt16(count_nilai_rapor)] / 100) * item_nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                            }
                                                            else if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                jumlah_nilai_rapor += item_nilai_ap;
                                                            }
                                                            count_nilai_rapor++;
                                                        }
                                                        if (count_nilai_rapor > 0)
                                                        {
                                                            if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            nilai_rapor = 0;
                                                        }
                                                        nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);
                                                        nilai_rapor_keterampilan_sm1 = nilai_rapor;
                                                    }
                                                    //end jika semester 2 get semester 1

                                                    //get struktur nilai det AP
                                                    lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeaderByJenisAspekPenilaian_Entity(
                                                            m_struktur_nilai.Kode.ToString(), DAO_Rapor_StrukturNilai_AP.JenisAspekPenilaian.Keterampilan
                                                        );
                                                    lst_nilai_ap.Clear();
                                                    lst_nilai_ap_bobot.Clear();
                                                    jumlah_nilai_ap = 0;
                                                    nilai_ap = 0;
                                                    count_ap = 0;
                                                    foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                    {

                                                        //get struktur nilai det KD
                                                        lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                item_rapor_struktur_nilai_ap.Kode.ToString()
                                                            );
                                                        lst_nilai_kd.Clear();
                                                        foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                        {

                                                            //get struktur nilai det KP
                                                            List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                item_rapor_struktur_nilai_kd.Kode.ToString()
                                                            );
                                                            decimal jumlah_nilai_kd = 0;
                                                            decimal nilai_kd = 0;
                                                            int count_kd = 0;
                                                            foreach (var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp)
                                                            {
                                                                Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString());
                                                                if (m_kp != null)
                                                                {

                                                                    Rapor_NilaiSiswa_Det m_nilai_det = lst_nilai_siswa_det.FindAll(
                                                                        m => m.Rel_Siswa.ToString().Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                             m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper() &&
                                                                             m.Rel_Rapor_StrukturNilai_AP.Trim().ToUpper() == item_rapor_struktur_nilai_ap.Kode.ToString().ToUpper() &&
                                                                             m.Rel_Rapor_StrukturNilai_KD.Trim().ToUpper() == item_rapor_struktur_nilai_kd.Kode.ToString().ToUpper() &&
                                                                             m.Rel_Rapor_StrukturNilai_KP.Trim().ToUpper() == item_rapor_struktur_nilai_kp.Kode.ToString().ToUpper()
                                                                    ).FirstOrDefault();

                                                                    if (m_nilai_det != null)
                                                                    {
                                                                        if (m_nilai_det.Nilai.Trim() != "")
                                                                        {
                                                                            if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                            {
                                                                                nilai_kd += Math.Round((item_rapor_struktur_nilai_kp.BobotNK / 100) * Libs.GetStringToDecimal(m_nilai_det.Nilai), 2, MidpointRounding.AwayFromZero);
                                                                            }
                                                                            else if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                            {
                                                                                jumlah_nilai_kd += Libs.GetStringToDecimal(m_nilai_det.Nilai);
                                                                            }
                                                                            count_kd++;
                                                                        }
                                                                    }

                                                                }

                                                            }

                                                            if (count_kd > 0)
                                                            {
                                                                if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_kd = Math.Round(jumlah_nilai_kd / count_kd, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_kd = 0;
                                                            }

                                                            //load nilai manual
                                                            Rapor_NilaiSiswa_AP_or_KD m_nilai_manual = DAO_Rapor_NilaiSiswa_AP_or_KD.GetAllByTABySMByKelasByMapelBySiswaByStruktur_Entity(
                                                                    tahun_ajaran, semester, rel_kelas_det, m_siswa.Kode.ToString(), item.Rel_Mapel,
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString().Trim().ToUpper()

                                                                ).FirstOrDefault();
                                                            if (m_nilai_manual != null)
                                                            {
                                                                if (m_nilai_manual.Nilai != null)
                                                                {
                                                                    nilai_kd = Libs.GetStringToDecimal(m_nilai_manual.Nilai);
                                                                }
                                                            }
                                                            //end load nilai manual

                                                            nilai_kd = Math.Round(nilai_kd, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);
                                                            lst_nilai_kd.Add(nilai_kd);
                                                            //end get struktur nilai det KP

                                                        }
                                                        //end get struktur nilai det KD

                                                        //get nilai ap
                                                        count_ap = 0;
                                                        nilai_ap = 0;
                                                        jumlah_nilai_ap = 0;
                                                        foreach (var item_nilai_kd in lst_nilai_kd)
                                                        {
                                                            if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                            {
                                                                nilai_ap += Math.Round((item_rapor_struktur_nilai_ap.BobotRapor / 100) * item_nilai_kd, 2, MidpointRounding.AwayFromZero);
                                                            }
                                                            else if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                jumlah_nilai_ap += item_nilai_kd;
                                                            }
                                                            count_ap++;
                                                        }
                                                        if (count_ap > 0)
                                                        {
                                                            if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                nilai_ap = Math.Round(jumlah_nilai_ap / count_ap, 2, MidpointRounding.AwayFromZero);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            nilai_ap = 0;
                                                        }
                                                        nilai_ap = Math.Round(nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                        lst_nilai_ap.Add(nilai_ap);
                                                        lst_nilai_ap_bobot.Add(item_rapor_struktur_nilai_ap.BobotRapor);
                                                        //end get nilai ap
                                                        //-----------end nilai keterampilan---------------

                                                    }
                                                    //end get struktur nilai det AP

                                                    //get nilai rapor
                                                    nilai_rapor = 0;
                                                    jumlah_nilai_rapor = 0;
                                                    count_nilai_rapor = 0;
                                                    foreach (var item_nilai_ap in lst_nilai_ap)
                                                    {
                                                        if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                        {
                                                            nilai_rapor += Math.Round((lst_nilai_ap_bobot[Convert.ToInt16(count_nilai_rapor)] / 100) * item_nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                        }
                                                        else if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                        {
                                                            jumlah_nilai_rapor += item_nilai_ap;
                                                        }
                                                        count_nilai_rapor++;
                                                    }
                                                    if (count_nilai_rapor > 0)
                                                    {
                                                        if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                        {
                                                            nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                        }
                                                    }
                                                    else
                                                    {
                                                        nilai_rapor = 0;
                                                    }
                                                    nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);
                                                    nilai_rapor_keterampilan = nilai_rapor;
                                                    lst_all_nilai_rapor.Add(new NilaiWithKey
                                                    {
                                                        Key = (id_kolom_ledger).ToString(),
                                                        Nilai = nilai_rapor_keterampilan
                                                    });
                                                    id_kolom_ledger++;
                                                    //end get nilai rapor

                                                    jumlah_mapel_rapor++;
                                                }
                                            }
                                            //end get struktur nilai

                                            html_row_body_siswa += "<td style=\"" + css_cell_body + " text-align: center; " + (nilai_rapor_pengetahuan < m_struktur_nilai.KKM ? " font-weight: bold; color: #9C0006; background-color: #FFC7CE; " : "") + "\">" +
                                                                        nilai_rapor_pengetahuan.ToString() +
                                                                   "</td>" +
                                                                   "<td style=\"" + css_cell_body + " text-align: center; " + (nilai_rapor_pengetahuan < m_struktur_nilai.KKM ? " font-weight: bold; color: #9C0006; background-color: #FFC7CE; " : "") + "\">" +
                                                                        GetPredikatRapor(nilai_rapor_pengetahuan) +
                                                                   "</td>";
                                            html_row_body_siswa += "<td style=\"" + css_cell_body + " text-align: center; " + (nilai_rapor_keterampilan < m_struktur_nilai.KKM ? " font-weight: bold; color: #9C0006; background-color: #FFC7CE; " : "") + "\">" +
                                                                        nilai_rapor_keterampilan.ToString() +
                                                                   "</td>" +
                                                                   "<td style=\"" + css_cell_body + " text-align: center; " + (nilai_rapor_keterampilan < m_struktur_nilai.KKM ? " font-weight: bold; color: #9C0006; background-color: #FFC7CE; " : "") + "\">" +
                                                                        GetPredikatRapor(nilai_rapor_keterampilan) +
                                                                   "</td>";
                                        }

                                    }

                                    id_mulai_looping_rata_rata = id_kolom_ledger + 1;
                                    id_mulai_looping_kkm = jumlah_mapel_rapor + 1;
                                    
                                    lst_jumlah_nilai_keseluruhan.Add(new NilaiWithKey
                                    {
                                        Key = m_siswa.Kode.ToString(),
                                        Nilai = jumlah_keseluruhan
                                    });

                                    //absen
                                    string s_sakit = "-";
                                    string s_izin = "-";
                                    string s_alpa = "-";
                                    string s_terlambat = "-";

                                    Rapor_Arsip m_rapor_arsip = DAO_Rapor_Arsip.GetAll_Entity().FindAll(
                                            m0 => m0.TahunAjaran == tahun_ajaran &&
                                                  m0.Semester == semester &&
                                                  m0.JenisRapor == "Semester"

                                        ).FirstOrDefault();
                                    List<DAO_SiswaAbsen.AbsenRekapRapor> lst_absen = new List<DAO_SiswaAbsen.AbsenRekapRapor>();
                                    lst_absen = DAO_SiswaAbsen.GetRekapAbsenRaporBySiswaByPeriode_Entity(
                                            m_siswa.Kode.ToString(),
                                            (m_rapor_arsip != null ? m_rapor_arsip.TanggalAwalAbsen : DateTime.MinValue),
                                            (m_rapor_arsip != null ? m_rapor_arsip.TanggalAkhirAbsen : DateTime.MinValue)
                                        );
                                    foreach (var absen in lst_absen)
                                    {
                                        if (absen.Absen == Libs.JENIS_ABSENSI.SAKIT.Substring(0, 1)) s_sakit = absen.Jumlah.ToString();
                                        if (absen.Absen == Libs.JENIS_ABSENSI.IZIN.Substring(0, 1)) s_izin = absen.Jumlah.ToString();
                                        if (absen.Absen == Libs.JENIS_ABSENSI.ALPA.Substring(0, 1)) s_alpa = absen.Jumlah.ToString();
                                        if (absen.Absen == Libs.JENIS_ABSENSI.TERLAMBAT.Substring(0, 1)) s_terlambat = absen.Jumlah.ToString();
                                    }
                                    html_row_body_siswa += "<td style=\"" + css_cell_body + " text-align: center; \">" +
                                                                s_sakit +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + " text-align: center; \">" +
                                                                s_izin +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + " text-align: center; \">" +
                                                                s_alpa +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + " text-align: center; \">" +
                                                                s_terlambat +
                                                           "</td>";
                                    //end absen

                                    html_row_body += "<tr>" +
                                                        html_row_body_siswa +
                                                     "</tr>";

                                    nomor++;
                                }
                                // end foreach siswa

                                for (int i = (jumlah_awal_col_ledger + 1); i <= id_kolom_ledger; i++)
                                {
                                    if (i >= id_mulai_looping_rata_rata)
                                    {
                                        decimal rata_rata = Math.Round(lst_all_nilai_rapor.FindAll(m => m.Key == i.ToString()).Select(m => m.Nilai).DefaultIfEmpty().Average(), Constantas.PEMBULATAN_DESIMAL_NILAI_SD);
                                        html_row_rata_rata += "<td style=\"" + css_cell_body + " text-align: right;\">" +
                                                                    (
                                                                        rata_rata > 0
                                                                        ? Libs.GetFormatBilangan(rata_rata, Constantas.PEMBULATAN_DESIMAL_NILAI_SD)
                                                                        : ""
                                                                    ) +
                                                              "</td>";
                                    }
                                    else
                                    {
                                        decimal rata_rata = Math.Round(lst_all_nilai_rapor.FindAll(m => m.Key == i.ToString()).Select(m => m.Nilai).DefaultIfEmpty().Average(), Constantas.PEMBULATAN_DESIMAL_NILAI_SD);
                                        html_row_rata_rata += "<td style=\"" + css_cell_body + " text-align: right;\">" +
                                                                    (
                                                                        rata_rata > 0
                                                                        ? Libs.GetFormatBilangan(rata_rata, Constantas.PEMBULATAN_DESIMAL_NILAI_SD)
                                                                        : ""
                                                                    ) +
                                                              "</td>";
                                    }
                                }
                                for (int i = 1; i <= jumlah_mapel_rapor; i++)
                                {
                                    decimal kkm = 0;
                                    NilaiWithKey m_kkm = lst_kkm_nilai_rapor.FindAll(m => m.Key == i.ToString()).FirstOrDefault();
                                    if (m_kkm != null)
                                    {
                                        if (m_kkm.Key != null)
                                        {
                                            kkm = m_kkm.Nilai;
                                        }
                                    }
                                    html_row_kkm += "<td colspan=\"4\" style=\"" + css_cell_body + " text-align: center;\">" +
                                                        Libs.GetFormatBilangan(kkm, Constantas.PEMBULATAN_DESIMAL_NILAI_SD) +
                                                    "</td>";
                                }
                                decimal rata_rata_nilai_keseluruhan = Math.Round(lst_jumlah_nilai_keseluruhan.Select(m => m.Nilai).DefaultIfEmpty().Average(), Constantas.PEMBULATAN_DESIMAL_NILAI_SD);
                                decimal rata_rata_nilai_rata_rata_rapor = Math.Round(lst_nilai_rapor.Select(m => m.Nilai).DefaultIfEmpty().Average(), Constantas.PEMBULATAN_DESIMAL_NILAI_SD);
                                html_row_body += "<tr>" +
                                                    html_row_rata_rata +
                                                 "</tr>" +
                                                 "<tr>" +
                                                    html_row_kkm +
                                                 "</tr>";

                            }

                        }
                    }

                }
            }

            html_row_header = "<tr>" +
                                html_row_header +
                              "</tr>" +
                              "<tr>" +
                                html_row_mapel +
                              "</tr>" +
                              "<tr>" +
                                html_row_jenis_nilai +
                              "</tr>" +
                              html_row_body;

            html = "<table style=\"border-collapse: collapse;\">" +
                        html_row_header +
                   "</table>";

            return html;
        }

        public static List<KURTILAS_RaporNilai> GetNilaiRapor_KURTILAS(
            string tahun_ajaran,
            string semester,
            string rel_kelas_det,
            string rel_siswa = ""
        )
        {
            List<KURTILAS_RaporNilai> hasil = new List<KURTILAS_RaporNilai>();
            Rapor_Arsip m_rapor_arsip = DAO_Rapor_Arsip.GetAll_Entity().FindAll(
                m0 => m0.TahunAjaran == tahun_ajaran &&
                        m0.Semester == semester &&
                        m0.JenisRapor == "Semester"

            ).FirstOrDefault();

            KelasDet m_kelas_det = DAO_KelasDet.GetByID_Entity(rel_kelas_det);
            if (m_kelas_det != null)
            {
                if (m_kelas_det.Nama != null)
                {
                    string s_walikelas = "";
                    List<FormasiGuruKelas> lst_formasi_guru_kelas = DAO_FormasiGuruKelas.GetByUnitByTABySM_Entity(
                                GetUnitSekolah().Kode.ToString(), tahun_ajaran, semester
                            ).FindAll(m => m.Rel_KelasDet.ToString().ToUpper() == rel_kelas_det.Trim().ToUpper());
                    if (lst_formasi_guru_kelas != null)
                    {
                        if (lst_formasi_guru_kelas.Count > 0)
                        {
                            FormasiGuruKelas m_guru_kelas = lst_formasi_guru_kelas.FirstOrDefault();
                            if (m_guru_kelas != null)
                            {
                                if (m_guru_kelas.TahunAjaran != null)
                                {
                                    Pegawai m_pegawai = DAO_Pegawai.GetByID_Entity(m_guru_kelas.Rel_GuruKelas);
                                    if (m_pegawai != null)
                                    {
                                        if (m_pegawai.Nama != null)
                                        {
                                            s_walikelas = m_pegawai.Nama;
                                        }
                                    }
                                }
                            }
                        }
                    }

                    Kelas m_kelas = DAO_Kelas.GetByID_Entity(m_kelas_det.Rel_Kelas.ToString());
                    if (m_kelas != null)
                    {
                        if (m_kelas.Nama != null)
                        {

                            Rapor_Desain rapor_desain = DAO_Rapor_Desain.GetByTABySMByKelas_Entity(
                                    tahun_ajaran, semester, rel_kelas_det, DAO_Rapor_Desain.JenisRapor.Semester
                                ).FirstOrDefault();

                            List<Rapor_Desain_Det> lst_rapor_desain_det = DAO_Rapor_Desain_Det.GetAllByHeader_Entity(rapor_desain.Kode.ToString()).FindAll(m => m.Nomor.Trim() != "" && m.Rel_Mapel.Trim() != "");

                            //list cols header
                            if (rapor_desain != null)
                            {

                                List<DAO_Siswa.SiswaDataSimple> lst_siswa = DAO_Siswa.GetAllSiswaDataSimpleByTahunAjaranUnitKelas_Entity(
                                        m_kelas.Rel_Sekolah.ToString(),
                                        rel_kelas_det,
                                        tahun_ajaran,
                                        semester
                                    );
                                List<decimal> lst_nilai_ap = new List<decimal>();
                                List<decimal> lst_nilai_ap_bobot = new List<decimal>();
                                List<decimal> lst_nilai_kd = new List<decimal>();
                                List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT> lst_nilai_siswa_det = new List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT>();
                                List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT> lst_nilai_siswa_det_by_periode = new List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT>();
                                List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT> lst_nilai_siswa_det_sm1 = new List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT>();
                                List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT> lst_nilai_siswa_det_by_periode_sm1 = new List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT>();

                                lst_nilai_siswa_det_by_periode = DAO_Rapor_NilaiSiswa_Det.GetAllByTABySMByKelasDet_Entity(
                                        tahun_ajaran, semester, rel_kelas_det
                                    );
                                lst_nilai_siswa_det_by_periode_sm1 = DAO_Rapor_NilaiSiswa_Det.GetAllByTABySMByKelasDet_Entity(
                                        tahun_ajaran, "1", rel_kelas_det
                                    );
                                if (rel_siswa.Trim() != "")
                                {
                                    lst_siswa = lst_siswa.FindAll(m0 => (rel_siswa + ";").Trim().ToUpper().IndexOf(m0.Kode.ToString().ToUpper() + ";") >= 0).ToList();
                                }

                                foreach (DAO_Siswa.SiswaDataSimple m_siswa in lst_siswa.OrderBy(m => m.Nama))
                                {
                                    //nilai non mulok
                                    foreach (Rapor_Desain_Det item in DAO_Rapor_Desain_Det.GetAllByHeader_Entity(rapor_desain.Kode.ToString()).FindAll(m => m.Nomor.Trim() != "" && m.Rel_Mapel.Trim() != ""))
                                    {

                                        if (item.Rel_Mapel.Trim() != "")
                                        {

                                            lst_nilai_siswa_det = lst_nilai_siswa_det_by_periode.FindAll(
                                                    m => m.Rel_Mapel == item.Rel_Mapel &&
                                                         m.Rel_Siswa == m.Rel_Siswa
                                                );
                                            lst_nilai_siswa_det_sm1 = lst_nilai_siswa_det_by_periode_sm1.FindAll(
                                                    m => m.Rel_Mapel == item.Rel_Mapel &&
                                                         m.Rel_Siswa == m.Rel_Siswa
                                                );

                                            //get struktur nilainya
                                            Rapor_StrukturNilai m_struktur_nilai_sm1 = DAO_Rapor_StrukturNilai.GetATop1ByTABySMByKelasByMapel_Entity(
                                                    tahun_ajaran, "1", m_kelas.Kode.ToString(), item.Rel_Mapel
                                                );

                                            Rapor_StrukturNilai m_struktur_nilai = DAO_Rapor_StrukturNilai.GetATop1ByTABySMByKelasByMapel_Entity(
                                                    tahun_ajaran, semester, m_kelas.Kode.ToString(), item.Rel_Mapel
                                                );

                                            decimal nilai_rapor = 0;
                                            decimal jumlah_nilai_rapor = 0;
                                            decimal count_nilai_rapor = 0;

                                            decimal nilai_rata2_sm1_sm2 = 0;
                                            decimal nilai_rata2_pengetahuan_sm1_sm2 = 0;
                                            decimal nilai_rata2_keterampilan_sm1_sm2 = 0;
                                            decimal nilai_rapor_pengetahuan_sm1 = 0;
                                            decimal nilai_rapor_keterampilan_sm1 = 0;
                                            decimal nilai_rapor_pengetahuan = 0;
                                            decimal nilai_rapor_keterampilan = 0;

                                            Rapor_StrukturNilai_AP m_sn_ap = new Rapor_StrukturNilai_AP();

                                            if (m_struktur_nilai != null)
                                            {
                                                if (m_struktur_nilai.TahunAjaran != null)
                                                {

                                                    if (!(m_struktur_nilai.IsKelompokanKP && m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString()))
                                                    {
                                                        //-----------nilai pengetahuan---------------
                                                        decimal jumlah_nilai_ap = 0;
                                                        decimal nilai_ap = 0;
                                                        int count_ap = 0;
                                                        string guru_kelas = "";
                                                        string tanggal_rapor = Libs.GetTanggalIndonesiaFromDate(DateTime.Now, false);
                                                        List<Rapor_StrukturNilai_AP> lst_rapor_struktur_nilai_ap = new List<Rapor_StrukturNilai_AP>();
                                                        DateTime dt_tanggal_rapor = DateTime.Now;
                                                        Rapor_LTS_MengetahuiGuruKelas m_guru_kelas = new Rapor_LTS_MengetahuiGuruKelas();
                                                        //get struktur nilai det AP

                                                        //jika semester 2 get semester 1
                                                        if (semester == "2")
                                                        {
                                                            lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeaderByJenisAspekPenilaian_Entity(
                                                                m_struktur_nilai_sm1.Kode.ToString(), DAO_Rapor_StrukturNilai_AP.JenisAspekPenilaian.Pengetahuan
                                                            );
                                                            lst_nilai_ap.Clear();
                                                            lst_nilai_ap_bobot.Clear();
                                                            jumlah_nilai_ap = 0;
                                                            nilai_ap = 0;
                                                            count_ap = 0;
                                                            m_sn_ap = new Rapor_StrukturNilai_AP();
                                                            foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                            {

                                                                //get struktur nilai det KD
                                                                List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                        item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                    );
                                                                lst_nilai_kd.Clear();
                                                                foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                                {

                                                                    //get struktur nilai det KP
                                                                    List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                        item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                    );
                                                                    decimal jumlah_nilai_kd = 0;
                                                                    decimal nilai_kd = 0;
                                                                    int count_kd = 0;
                                                                    foreach (var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp)
                                                                    {
                                                                        Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString());
                                                                        if (m_kp != null)
                                                                        {

                                                                            Rapor_NilaiSiswa_Det m_nilai_det = lst_nilai_siswa_det_sm1.FindAll(
                                                                                m => m.Rel_Siswa.ToString().Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                     m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai_sm1.Rel_Mapel.ToString().Trim().ToUpper() &&
                                                                                     m.Rel_Rapor_StrukturNilai_AP.Trim().ToUpper() == item_rapor_struktur_nilai_ap.Kode.ToString().ToUpper() &&
                                                                                     m.Rel_Rapor_StrukturNilai_KD.Trim().ToUpper() == item_rapor_struktur_nilai_kd.Kode.ToString().ToUpper() &&
                                                                                     m.Rel_Rapor_StrukturNilai_KP.Trim().ToUpper() == item_rapor_struktur_nilai_kp.Kode.ToString().ToUpper()
                                                                            ).FirstOrDefault();

                                                                            if (m_nilai_det != null)
                                                                            {
                                                                                if (m_nilai_det.Nilai.Trim() != "")
                                                                                {
                                                                                    if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                                    {
                                                                                        nilai_kd += Math.Round((item_rapor_struktur_nilai_kp.BobotNK / 100) * Libs.GetStringToDecimal(m_nilai_det.Nilai), 2, MidpointRounding.AwayFromZero);
                                                                                    }
                                                                                    else if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                                    {
                                                                                        jumlah_nilai_kd += Libs.GetStringToDecimal(m_nilai_det.Nilai);
                                                                                    }
                                                                                    count_kd++;
                                                                                }
                                                                            }

                                                                        }

                                                                    }

                                                                    if (count_kd > 0)
                                                                    {
                                                                        if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                        {
                                                                            nilai_kd = Math.Round(jumlah_nilai_kd / count_kd, 2, MidpointRounding.AwayFromZero);
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        nilai_kd = 0;
                                                                    }

                                                                    //load nilai manual
                                                                    Rapor_NilaiSiswa_AP_or_KD m_nilai_manual = DAO_Rapor_NilaiSiswa_AP_or_KD.GetAllByTABySMByKelasByMapelBySiswaByStruktur_Entity(
                                                                            tahun_ajaran, m_struktur_nilai_sm1.Semester, rel_kelas_det, m_siswa.Kode.ToString(), item.Rel_Mapel,
                                                                            item_rapor_struktur_nilai_kd.Kode.ToString().Trim().ToUpper()

                                                                        ).FirstOrDefault();
                                                                    if (m_nilai_manual != null)
                                                                    {
                                                                        if (m_nilai_manual.Nilai != null)
                                                                        {
                                                                            nilai_kd = Libs.GetStringToDecimal(m_nilai_manual.Nilai);
                                                                        }
                                                                    }
                                                                    //end load nilai manual

                                                                    nilai_kd = Math.Round(nilai_kd, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);
                                                                    lst_nilai_kd.Add(nilai_kd);
                                                                    //end get struktur nilai det KP

                                                                }
                                                                //end get struktur nilai det KD

                                                                //get nilai ap
                                                                count_ap = 0;
                                                                nilai_ap = 0;
                                                                jumlah_nilai_ap = 0;
                                                                foreach (var item_nilai_kd in lst_nilai_kd)
                                                                {
                                                                    if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                    {
                                                                        nilai_ap += Math.Round((item_rapor_struktur_nilai_ap.BobotRapor / 100) * item_nilai_kd, 2, MidpointRounding.AwayFromZero);
                                                                    }
                                                                    else if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                    {
                                                                        jumlah_nilai_ap += item_nilai_kd;
                                                                    }
                                                                    count_ap++;
                                                                }
                                                                if (count_ap > 0)
                                                                {
                                                                    if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                    {
                                                                        nilai_ap = Math.Round(jumlah_nilai_ap / count_ap, 2, MidpointRounding.AwayFromZero);
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    nilai_ap = 0;
                                                                }
                                                                nilai_ap = Math.Round(nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                                lst_nilai_ap.Add(nilai_ap);
                                                                lst_nilai_ap_bobot.Add(item_rapor_struktur_nilai_ap.BobotRapor);
                                                                //end get nilai ap

                                                            }
                                                            //end get struktur nilai det AP

                                                            //get nilai rapor
                                                            nilai_rapor = 0;
                                                            jumlah_nilai_rapor = 0;
                                                            count_nilai_rapor = 0;
                                                            foreach (var item_nilai_ap in lst_nilai_ap)
                                                            {
                                                                if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                {
                                                                    nilai_rapor += Math.Round((lst_nilai_ap_bobot[Convert.ToInt16(count_nilai_rapor)] / 100) * item_nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                                else if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    jumlah_nilai_rapor += item_nilai_ap;
                                                                }
                                                                count_nilai_rapor++;
                                                            }
                                                            if (count_nilai_rapor > 0)
                                                            {
                                                                if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_rapor = 0;
                                                            }
                                                            nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);
                                                            nilai_rapor_pengetahuan_sm1 = nilai_rapor;

                                                            if (m_rapor_arsip != null)
                                                            {
                                                                if (m_rapor_arsip.TahunAjaran != null)
                                                                {
                                                                    dt_tanggal_rapor = m_rapor_arsip.TanggalRapor;
                                                                }
                                                            }

                                                            guru_kelas = "";
                                                            tanggal_rapor = Libs.GetTanggalIndonesiaFromDate(dt_tanggal_rapor, false);
                                                            m_guru_kelas = DAO_Rapor_LTS_MengetahuiGuruKelas.GetByTABySMByKelasDet_Entity(
                                                                    tahun_ajaran, semester, rel_kelas_det
                                                                ).FirstOrDefault();
                                                            if (m_guru_kelas != null)
                                                            {
                                                                if (m_guru_kelas.NamaGuru != null)
                                                                {
                                                                    guru_kelas = m_guru_kelas.NamaGuru;
                                                                }
                                                            }
                                                        }
                                                        //end jika semester 2 get semester 1

                                                        lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeaderByJenisAspekPenilaian_Entity(
                                                                m_struktur_nilai.Kode.ToString(), DAO_Rapor_StrukturNilai_AP.JenisAspekPenilaian.Pengetahuan
                                                            );
                                                        lst_nilai_ap.Clear();
                                                        lst_nilai_ap_bobot.Clear();
                                                        jumlah_nilai_ap = 0;
                                                        nilai_ap = 0;
                                                        count_ap = 0;
                                                        foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                        {

                                                            //get struktur nilai det KD
                                                            List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                );
                                                            lst_nilai_kd.Clear();
                                                            foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                            {

                                                                //get struktur nilai det KP
                                                                List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                );
                                                                decimal jumlah_nilai_kd = 0;
                                                                decimal nilai_kd = 0;
                                                                int count_kd = 0;
                                                                foreach (var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp)
                                                                {
                                                                    Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString());
                                                                    if (m_kp != null)
                                                                    {

                                                                        Rapor_NilaiSiswa_Det m_nilai_det = lst_nilai_siswa_det.FindAll(
                                                                            m => m.Rel_Siswa.ToString().Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_AP.Trim().ToUpper() == item_rapor_struktur_nilai_ap.Kode.ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KD.Trim().ToUpper() == item_rapor_struktur_nilai_kd.Kode.ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KP.Trim().ToUpper() == item_rapor_struktur_nilai_kp.Kode.ToString().ToUpper()
                                                                        ).FirstOrDefault();

                                                                        if (m_nilai_det != null)
                                                                        {
                                                                            if (m_nilai_det.Nilai.Trim() != "")
                                                                            {
                                                                                if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                                {
                                                                                    nilai_kd += Math.Round((item_rapor_struktur_nilai_kp.BobotNK / 100) * Libs.GetStringToDecimal(m_nilai_det.Nilai), 2, MidpointRounding.AwayFromZero);
                                                                                }
                                                                                else if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                                {
                                                                                    jumlah_nilai_kd += Libs.GetStringToDecimal(m_nilai_det.Nilai);
                                                                                }
                                                                                count_kd++;
                                                                            }
                                                                        }

                                                                    }

                                                                }

                                                                if (count_kd > 0)
                                                                {
                                                                    if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                    {
                                                                        nilai_kd = Math.Round(jumlah_nilai_kd / count_kd, 2, MidpointRounding.AwayFromZero);
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    nilai_kd = 0;
                                                                }

                                                                //load nilai manual
                                                                Rapor_NilaiSiswa_AP_or_KD m_nilai_manual = DAO_Rapor_NilaiSiswa_AP_or_KD.GetAllByTABySMByKelasByMapelBySiswaByStruktur_Entity(
                                                                        tahun_ajaran, semester, rel_kelas_det, m_siswa.Kode.ToString(), item.Rel_Mapel,
                                                                        item_rapor_struktur_nilai_kd.Kode.ToString().Trim().ToUpper()

                                                                    ).FirstOrDefault();
                                                                if (m_nilai_manual != null)
                                                                {
                                                                    if (m_nilai_manual.Nilai != null)
                                                                    {
                                                                        nilai_kd = Libs.GetStringToDecimal(m_nilai_manual.Nilai);
                                                                    }
                                                                }
                                                                //end load nilai manual

                                                                nilai_kd = Math.Round(nilai_kd, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);
                                                                lst_nilai_kd.Add(nilai_kd);
                                                                //end get struktur nilai det KP

                                                            }

                                                            //end get struktur nilai det KD

                                                            //get nilai ap
                                                            count_ap = 0;
                                                            nilai_ap = 0;
                                                            jumlah_nilai_ap = 0;
                                                            foreach (var item_nilai_kd in lst_nilai_kd)
                                                            {
                                                                if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                {
                                                                    nilai_ap += Math.Round((item_rapor_struktur_nilai_ap.BobotRapor / 100) * item_nilai_kd, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                                else if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    jumlah_nilai_ap += item_nilai_kd;
                                                                }
                                                                count_ap++;
                                                            }
                                                            if (count_ap > 0)
                                                            {
                                                                if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_ap = Math.Round(jumlah_nilai_ap / count_ap, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_ap = 0;
                                                            }
                                                            nilai_ap = Math.Round(nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                            lst_nilai_ap.Add(nilai_ap);
                                                            lst_nilai_ap_bobot.Add(item_rapor_struktur_nilai_ap.BobotRapor);
                                                            //end get nilai ap

                                                            m_sn_ap = item_rapor_struktur_nilai_ap;
                                                        }
                                                        //end get struktur nilai det AP

                                                        //get nilai rapor
                                                        nilai_rapor = 0;
                                                        jumlah_nilai_rapor = 0;
                                                        count_nilai_rapor = 0;
                                                        foreach (var item_nilai_ap in lst_nilai_ap)
                                                        {
                                                            if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                            {
                                                                nilai_rapor += Math.Round((lst_nilai_ap_bobot[Convert.ToInt16(count_nilai_rapor)] / 100) * item_nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                            }
                                                            else if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                jumlah_nilai_rapor += item_nilai_ap;
                                                            }
                                                            count_nilai_rapor++;
                                                        }
                                                        if (count_nilai_rapor > 0)
                                                        {
                                                            if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            nilai_rapor = 0;
                                                        }
                                                        nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);

                                                        //jika ada PAT atau UKK
                                                        if (m_sn_ap.IsAdaPAT_UKK)
                                                        {
                                                            Rapor_NilaiSiswa_Det m_nilai_det = lst_nilai_siswa_det.FindAll(
                                                                            m => m.Rel_Siswa.ToString().Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_AP.Trim().ToUpper() == (Constantas.SD.GetKode_NK_KD_UKKPAT(m_sn_ap.Kode.ToString())).ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KD.Trim().ToUpper() == (Constantas.SD.GetKode_NK_KD_UKKPAT(m_sn_ap.Kode.ToString())).ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KP.Trim().ToUpper() == (Constantas.SD.GetKode_NK_KD_UKKPAT(m_sn_ap.Kode.ToString())).ToString().ToUpper()
                                                                        ).FirstOrDefault();

                                                            string s_nilai_pat_ukk = "0";
                                                            if (m_nilai_det != null)
                                                            {
                                                                if (m_nilai_det.Nilai.Trim() != "")
                                                                {
                                                                    s_nilai_pat_ukk = m_nilai_det.Nilai;
                                                                }
                                                            }

                                                            nilai_rapor = Math.Round(
                                                                            Libs.GetStringToDecimal(s_nilai_pat_ukk) * (m_sn_ap.Bobot_PAT_UKK / 100), 2
                                                                          ) +
                                                                            Math.Round(
                                                                            nilai_rapor * (m_sn_ap.Bobot_Non_PAT_UKK / 100), 2
                                                                          );

                                                            nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);
                                                        }
                                                        //jika ada PAT atau UKK

                                                        nilai_rapor_pengetahuan = nilai_rapor;
                                                        
                                                        dt_tanggal_rapor = DateTime.Now;
                                                        if (m_rapor_arsip != null)
                                                        {
                                                            if (m_rapor_arsip.TahunAjaran != null)
                                                            {
                                                                dt_tanggal_rapor = m_rapor_arsip.TanggalRapor;
                                                            }
                                                        }

                                                        guru_kelas = "";
                                                        tanggal_rapor = Libs.GetTanggalIndonesiaFromDate(dt_tanggal_rapor, false);
                                                        m_guru_kelas = DAO_Rapor_LTS_MengetahuiGuruKelas.GetByTABySMByKelasDet_Entity(
                                                                tahun_ajaran, semester, rel_kelas_det
                                                            ).FirstOrDefault();
                                                        if (m_guru_kelas != null)
                                                        {
                                                            if (m_guru_kelas.NamaGuru != null)
                                                            {
                                                                guru_kelas = m_guru_kelas.NamaGuru;
                                                            }
                                                        }
                                                        //end get nilai rapor
                                                        //-----------end nilai pengetahuan---------------

                                                        //-----------nilai keterampilan---------------
                                                        //get struktur nilai det AP

                                                        //jika semester 2 get semester 1
                                                        if (semester == "2")
                                                        {
                                                            lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeaderByJenisAspekPenilaian_Entity(
                                                                m_struktur_nilai_sm1.Kode.ToString(), DAO_Rapor_StrukturNilai_AP.JenisAspekPenilaian.Keterampilan
                                                            );
                                                            lst_nilai_ap.Clear();
                                                            lst_nilai_ap_bobot.Clear();
                                                            jumlah_nilai_ap = 0;
                                                            nilai_ap = 0;
                                                            count_ap = 0;
                                                            m_sn_ap = new Rapor_StrukturNilai_AP();
                                                            foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                            {

                                                                //get struktur nilai det KD
                                                                List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                        item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                    );
                                                                lst_nilai_kd.Clear();
                                                                foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                                {

                                                                    //get struktur nilai det KP
                                                                    List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                        item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                    );
                                                                    decimal jumlah_nilai_kd = 0;
                                                                    decimal nilai_kd = 0;
                                                                    int count_kd = 0;
                                                                    foreach (var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp)
                                                                    {
                                                                        Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString());
                                                                        if (m_kp != null)
                                                                        {

                                                                            Rapor_NilaiSiswa_Det m_nilai_det = lst_nilai_siswa_det_sm1.FindAll(
                                                                                m => m.Rel_Siswa.ToString().Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                     m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai_sm1.Rel_Mapel.ToString().Trim().ToUpper() &&
                                                                                     m.Rel_Rapor_StrukturNilai_AP.Trim().ToUpper() == item_rapor_struktur_nilai_ap.Kode.ToString().ToUpper() &&
                                                                                     m.Rel_Rapor_StrukturNilai_KD.Trim().ToUpper() == item_rapor_struktur_nilai_kd.Kode.ToString().ToUpper() &&
                                                                                     m.Rel_Rapor_StrukturNilai_KP.Trim().ToUpper() == item_rapor_struktur_nilai_kp.Kode.ToString().ToUpper()
                                                                            ).FirstOrDefault();

                                                                            if (m_nilai_det != null)
                                                                            {
                                                                                if (m_nilai_det.Nilai.Trim() != "")
                                                                                {
                                                                                    if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                                    {
                                                                                        nilai_kd += Math.Round((item_rapor_struktur_nilai_kp.BobotNK / 100) * Libs.GetStringToDecimal(m_nilai_det.Nilai), 2, MidpointRounding.AwayFromZero);
                                                                                    }
                                                                                    else if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                                    {
                                                                                        jumlah_nilai_kd += Libs.GetStringToDecimal(m_nilai_det.Nilai);
                                                                                    }
                                                                                    count_kd++;
                                                                                }
                                                                            }

                                                                        }

                                                                    }

                                                                    if (count_kd > 0)
                                                                    {
                                                                        if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                        {
                                                                            nilai_kd = Math.Round(jumlah_nilai_kd / count_kd, 2, MidpointRounding.AwayFromZero);
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        nilai_kd = 0;
                                                                    }

                                                                    //load nilai manual
                                                                    Rapor_NilaiSiswa_AP_or_KD m_nilai_manual = DAO_Rapor_NilaiSiswa_AP_or_KD.GetAllByTABySMByKelasByMapelBySiswaByStruktur_Entity(
                                                                            tahun_ajaran, semester, rel_kelas_det, m_siswa.Kode.ToString(), item.Rel_Mapel,
                                                                            item_rapor_struktur_nilai_kd.Kode.ToString().Trim().ToUpper()

                                                                        ).FirstOrDefault();
                                                                    if (m_nilai_manual != null)
                                                                    {
                                                                        if (m_nilai_manual.Nilai != null)
                                                                        {
                                                                            nilai_kd = Libs.GetStringToDecimal(m_nilai_manual.Nilai);
                                                                        }
                                                                    }
                                                                    //end load nilai manual

                                                                    nilai_kd = Math.Round(nilai_kd, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);
                                                                    lst_nilai_kd.Add(nilai_kd);
                                                                    //end get struktur nilai det KP

                                                                }
                                                                //end get struktur nilai det KD

                                                                //get nilai ap
                                                                count_ap = 0;
                                                                nilai_ap = 0;
                                                                jumlah_nilai_ap = 0;
                                                                foreach (var item_nilai_kd in lst_nilai_kd)
                                                                {
                                                                    if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                    {
                                                                        nilai_ap += Math.Round((item_rapor_struktur_nilai_ap.BobotRapor / 100) * item_nilai_kd, 2, MidpointRounding.AwayFromZero);
                                                                    }
                                                                    else if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                    {
                                                                        jumlah_nilai_ap += item_nilai_kd;
                                                                    }
                                                                    count_ap++;
                                                                }
                                                                if (count_ap > 0)
                                                                {
                                                                    if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                    {
                                                                        nilai_ap = Math.Round(jumlah_nilai_ap / count_ap, 2, MidpointRounding.AwayFromZero);
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    nilai_ap = 0;
                                                                }
                                                                nilai_ap = Math.Round(nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                                lst_nilai_ap.Add(nilai_ap);
                                                                lst_nilai_ap_bobot.Add(item_rapor_struktur_nilai_ap.BobotRapor);
                                                                //end get nilai ap

                                                            }
                                                            //end get struktur nilai det AP

                                                            //get nilai rapor
                                                            nilai_rapor = 0;
                                                            jumlah_nilai_rapor = 0;
                                                            count_nilai_rapor = 0;
                                                            foreach (var item_nilai_ap in lst_nilai_ap)
                                                            {
                                                                if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                {
                                                                    nilai_rapor += Math.Round((lst_nilai_ap_bobot[Convert.ToInt16(count_nilai_rapor)] / 100) * item_nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                                else if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    jumlah_nilai_rapor += item_nilai_ap;
                                                                }
                                                                count_nilai_rapor++;
                                                            }
                                                            if (count_nilai_rapor > 0)
                                                            {
                                                                if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_rapor = 0;
                                                            }
                                                            nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);
                                                            nilai_rapor_keterampilan_sm1 = nilai_rapor;

                                                            if (m_rapor_arsip != null)
                                                            {
                                                                if (m_rapor_arsip.TahunAjaran != null)
                                                                {
                                                                    dt_tanggal_rapor = m_rapor_arsip.TanggalRapor;
                                                                }
                                                            }

                                                            guru_kelas = "";
                                                            tanggal_rapor = Libs.GetTanggalIndonesiaFromDate(dt_tanggal_rapor, false);
                                                            m_guru_kelas = DAO_Rapor_LTS_MengetahuiGuruKelas.GetByTABySMByKelasDet_Entity(
                                                                    tahun_ajaran, semester, rel_kelas_det
                                                                ).FirstOrDefault();
                                                            if (m_guru_kelas != null)
                                                            {
                                                                if (m_guru_kelas.NamaGuru != null)
                                                                {
                                                                    guru_kelas = m_guru_kelas.NamaGuru;
                                                                }
                                                            }
                                                        }
                                                        //end jika semester 2 get semester 1

                                                        lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeaderByJenisAspekPenilaian_Entity(
                                                                m_struktur_nilai.Kode.ToString(), DAO_Rapor_StrukturNilai_AP.JenisAspekPenilaian.Keterampilan
                                                            );
                                                        lst_nilai_ap.Clear();
                                                        lst_nilai_ap_bobot.Clear();
                                                        jumlah_nilai_ap = 0;
                                                        nilai_ap = 0;
                                                        count_ap = 0;
                                                        m_sn_ap = new Rapor_StrukturNilai_AP();
                                                        foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                        {

                                                            //get struktur nilai det KD
                                                            List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                );
                                                            lst_nilai_kd.Clear();
                                                            foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                            {

                                                                //get struktur nilai det KP
                                                                List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                );
                                                                decimal jumlah_nilai_kd = 0;
                                                                decimal nilai_kd = 0;
                                                                int count_kd = 0;
                                                                foreach (var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp)
                                                                {
                                                                    Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString());
                                                                    if (m_kp != null)
                                                                    {

                                                                        Rapor_NilaiSiswa_Det m_nilai_det = lst_nilai_siswa_det.FindAll(
                                                                            m => m.Rel_Siswa.ToString().Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_AP.Trim().ToUpper() == item_rapor_struktur_nilai_ap.Kode.ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KD.Trim().ToUpper() == item_rapor_struktur_nilai_kd.Kode.ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KP.Trim().ToUpper() == item_rapor_struktur_nilai_kp.Kode.ToString().ToUpper()
                                                                        ).FirstOrDefault();

                                                                        if (m_nilai_det != null)
                                                                        {
                                                                            if (m_nilai_det.Nilai.Trim() != "")
                                                                            {
                                                                                if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                                {
                                                                                    nilai_kd += Math.Round((item_rapor_struktur_nilai_kp.BobotNK / 100) * Libs.GetStringToDecimal(m_nilai_det.Nilai), 2, MidpointRounding.AwayFromZero);
                                                                                }
                                                                                else if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                                {
                                                                                    jumlah_nilai_kd += Libs.GetStringToDecimal(m_nilai_det.Nilai);
                                                                                }
                                                                                count_kd++;
                                                                            }
                                                                        }

                                                                    }

                                                                }

                                                                if (count_kd > 0)
                                                                {
                                                                    if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                    {
                                                                        nilai_kd = Math.Round(jumlah_nilai_kd / count_kd, 2, MidpointRounding.AwayFromZero);
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    nilai_kd = 0;
                                                                }

                                                                //load nilai manual
                                                                Rapor_NilaiSiswa_AP_or_KD m_nilai_manual = DAO_Rapor_NilaiSiswa_AP_or_KD.GetAllByTABySMByKelasByMapelBySiswaByStruktur_Entity(
                                                                        tahun_ajaran, semester, rel_kelas_det, m_siswa.Kode.ToString(), item.Rel_Mapel,
                                                                        item_rapor_struktur_nilai_kd.Kode.ToString().Trim().ToUpper()

                                                                    ).FirstOrDefault();
                                                                if (m_nilai_manual != null)
                                                                {
                                                                    if (m_nilai_manual.Nilai != null)
                                                                    {
                                                                        nilai_kd = Libs.GetStringToDecimal(m_nilai_manual.Nilai);
                                                                    }
                                                                }
                                                                //end load nilai manual

                                                                nilai_kd = Math.Round(nilai_kd, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);
                                                                lst_nilai_kd.Add(nilai_kd);
                                                                //end get struktur nilai det KP

                                                            }
                                                            //end get struktur nilai det KD

                                                            //get nilai ap
                                                            count_ap = 0;
                                                            nilai_ap = 0;
                                                            jumlah_nilai_ap = 0;
                                                            foreach (var item_nilai_kd in lst_nilai_kd)
                                                            {
                                                                if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                {
                                                                    nilai_ap += Math.Round((item_rapor_struktur_nilai_ap.BobotRapor / 100) * item_nilai_kd, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                                else if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    jumlah_nilai_ap += item_nilai_kd;
                                                                }
                                                                count_ap++;
                                                            }
                                                            if (count_ap > 0)
                                                            {
                                                                if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_ap = Math.Round(jumlah_nilai_ap / count_ap, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_ap = 0;
                                                            }
                                                            nilai_ap = Math.Round(nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                            lst_nilai_ap.Add(nilai_ap);
                                                            lst_nilai_ap_bobot.Add(item_rapor_struktur_nilai_ap.BobotRapor);
                                                            //end get nilai ap

                                                            //get nilai rapor
                                                            nilai_rapor = 0;
                                                            jumlah_nilai_rapor = 0;
                                                            count_nilai_rapor = 0;
                                                            foreach (var item_nilai_ap in lst_nilai_ap)
                                                            {
                                                                if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                {
                                                                    nilai_rapor += Math.Round((lst_nilai_ap_bobot[Convert.ToInt16(count_nilai_rapor)] / 100) * item_nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                                else if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    jumlah_nilai_rapor += item_nilai_ap;
                                                                }
                                                                count_nilai_rapor++;
                                                            }
                                                            if (count_nilai_rapor > 0)
                                                            {
                                                                if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_rapor = 0;
                                                            }
                                                            nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);

                                                            //jika ada PAT atau UKK
                                                            if (m_sn_ap.IsAdaPAT_UKK)
                                                            {
                                                                Rapor_NilaiSiswa_Det m_nilai_det = lst_nilai_siswa_det.FindAll(
                                                                                m => m.Rel_Siswa.ToString().Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                     m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper() &&
                                                                                     m.Rel_Rapor_StrukturNilai_AP.Trim().ToUpper() == (Constantas.SD.GetKode_NK_KD_UKKPAT(m_sn_ap.Kode.ToString())).ToString().ToUpper() &&
                                                                                     m.Rel_Rapor_StrukturNilai_KD.Trim().ToUpper() == (Constantas.SD.GetKode_NK_KD_UKKPAT(m_sn_ap.Kode.ToString())).ToString().ToUpper() &&
                                                                                     m.Rel_Rapor_StrukturNilai_KP.Trim().ToUpper() == (Constantas.SD.GetKode_NK_KD_UKKPAT(m_sn_ap.Kode.ToString())).ToString().ToUpper()
                                                                            ).FirstOrDefault();

                                                                string s_nilai_pat_ukk = "0";
                                                                if (m_nilai_det != null)
                                                                {
                                                                    if (m_nilai_det.Nilai.Trim() != "")
                                                                    {
                                                                        s_nilai_pat_ukk = m_nilai_det.Nilai;
                                                                    }
                                                                }

                                                                nilai_rapor = Math.Round(
                                                                                Libs.GetStringToDecimal(s_nilai_pat_ukk) * (m_sn_ap.Bobot_PAT_UKK / 100), 2
                                                                              ) +
                                                                                Math.Round(
                                                                                nilai_rapor * (m_sn_ap.Bobot_Non_PAT_UKK / 100), 2
                                                                              );

                                                                nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);
                                                            }
                                                            //jika ada PAT atau UKK

                                                            nilai_rapor_keterampilan = nilai_rapor;
                                                            //-----------end nilai keterampilan---------------

                                                            m_sn_ap = item_rapor_struktur_nilai_ap;
                                                        }
                                                        //end get struktur nilai det AP

                                                        nilai_rata2_sm1_sm2 = 
                                                            Math.Round(
                                                                (
                                                                    nilai_rapor_pengetahuan +
                                                                    nilai_rapor_keterampilan +
                                                                    nilai_rapor_pengetahuan_sm1 +
                                                                    nilai_rapor_keterampilan_sm1
                                                                ) / 4, 
                                                                0,
                                                                MidpointRounding.AwayFromZero
                                                            );
                                                        nilai_rata2_pengetahuan_sm1_sm2 = Math.Round(
                                                                (
                                                                    nilai_rapor_pengetahuan +
                                                                    nilai_rapor_pengetahuan_sm1 
                                                                ) / 2,
                                                                0,
                                                                MidpointRounding.AwayFromZero
                                                            );
                                                        nilai_rata2_keterampilan_sm1_sm2 = Math.Round(
                                                                (
                                                                    nilai_rapor_keterampilan +
                                                                    nilai_rapor_keterampilan_sm1
                                                                ) / 2,
                                                                0,
                                                                MidpointRounding.AwayFromZero
                                                            );
                                                        hasil.Add(new KURTILAS_RaporNilai
                                                        {
                                                            IDSiswa = m_siswa.Nama.Trim().ToUpper() + "_" + m_siswa.Kode.ToString(),
                                                            TahunAjaran = tahun_ajaran,
                                                            Semester = semester,
                                                            NIS = m_siswa.NISSekolah,
                                                            NISN = m_siswa.NISN,
                                                            Nama = Libs.GetPerbaikiEjaanNama(m_siswa.Nama.ToString()),
                                                            Kelas = DAO_KelasDet.GetKelasForRapor(rel_kelas_det),
                                                            NilaiPengetahuan = nilai_rapor_pengetahuan,
                                                            NilaiKeterampilan = nilai_rapor_keterampilan,
                                                            NamaMapel = item.NamaMapelRapor,
                                                            KKM = m_struktur_nilai.KKM,
                                                            GuruKelas = s_walikelas,
                                                            KepalaSekolah = m_rapor_arsip.KepalaSekolah,
                                                            NilaiRataRataSM1SM2 = nilai_rata2_sm1_sm2,
                                                            PengetahuanRataRataSM1SM2 = nilai_rata2_pengetahuan_sm1_sm2.ToString(),
                                                            KeterampilanRataRataSM1SM2 = nilai_rata2_keterampilan_sm1_sm2.ToString(),
                                                        });

                                                        //get nilai rapor
                                                        nilai_rapor = 0;
                                                        jumlah_nilai_rapor = 0;
                                                        count_nilai_rapor = 0;
                                                        foreach (var item_nilai_ap in lst_nilai_ap)
                                                        {
                                                            if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                            {
                                                                nilai_rapor += Math.Round((lst_nilai_ap_bobot[Convert.ToInt16(count_nilai_rapor)] / 100) * item_nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                            }
                                                            else if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                jumlah_nilai_rapor += item_nilai_ap;
                                                            }
                                                            count_nilai_rapor++;
                                                        }
                                                        if (count_nilai_rapor > 0)
                                                        {
                                                            if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            nilai_rapor = 0;
                                                        }
                                                        nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);
                                                        nilai_rapor_keterampilan = nilai_rapor;
                                                        //end get nilai rapor
                                                    }
                                                    else 
                                                    {
                                                        List<FormatNilai> lst_format_nilai = new List<FormatNilai>();
                                                        List<Rapor_StrukturNilai_AP> lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeader_Entity(
                                                                m_struktur_nilai.Kode.ToString()
                                                            );
                                                        foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                        {

                                                            List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                );

                                                            foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                            {

                                                                List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                );
                                                                foreach (
                                                                    var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp.FindAll(
                                                                        m => (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == DAO_Rapor_StrukturNilai.Arr_KP_Quran[0]) ||
                                                                             (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == DAO_Rapor_StrukturNilai.Arr_KP_Quran[1]) ||
                                                                             (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == DAO_Rapor_StrukturNilai.Arr_KP_Quran[2])
                                                                        )
                                                                )
                                                                {

                                                                    if (
                                                                        lst_format_nilai.FindAll(
                                                                                m => m.Rel_StrukturNilai_AP == item_rapor_struktur_nilai_ap.Kode.ToString() &&
                                                                                     m.Rel_KP == item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                            ).Count == 0
                                                                    )
                                                                    {
                                                                        lst_format_nilai.Add(new FormatNilai
                                                                        {
                                                                            Rel_StrukturNilai_AP = item_rapor_struktur_nilai_ap.Kode.ToString(),
                                                                            Rel_KP = item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                        });
                                                                    }

                                                                }
                                                            }

                                                        }

                                                        List<FormatNilai> lst_format_nilai2 = new List<FormatNilai>();
                                                        foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                        {

                                                            List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                );

                                                            foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                            {

                                                                List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                );
                                                                foreach (
                                                                    var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp.FindAll(
                                                                        m => (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() != DAO_Rapor_StrukturNilai.Arr_KP_Quran[0]) &&
                                                                             (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() != DAO_Rapor_StrukturNilai.Arr_KP_Quran[1]) &&
                                                                             (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() != DAO_Rapor_StrukturNilai.Arr_KP_Quran[2])
                                                                        )
                                                                )
                                                                {

                                                                    if (
                                                                        lst_format_nilai2.FindAll(
                                                                                m => m.Rel_StrukturNilai_AP == item_rapor_struktur_nilai_ap.Kode.ToString() &&
                                                                                     m.Rel_KP == item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                            ).Count == 0
                                                                    )
                                                                    {
                                                                        lst_format_nilai2.Add(new FormatNilai
                                                                        {
                                                                            Rel_StrukturNilai_AP = item_rapor_struktur_nilai_ap.Kode.ToString(),
                                                                            Rel_KP = item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                        });
                                                                    }

                                                                }
                                                            }

                                                        }

                                                        List<FormatNilaiWithNilai> lst_formatnilai_nilai = new List<FormatNilaiWithNilai>();
                                                        //distinct ap
                                                        foreach (string rel_sn_ap in lst_format_nilai.Select(m => m.Rel_StrukturNilai_AP).Distinct())
                                                        {
                                                            foreach (string rel_kp in lst_format_nilai.Select(m => m.Rel_KP).Distinct())
                                                            {

                                                                Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(rel_kp);
                                                                if (m_kp != null)
                                                                {
                                                                    if (m_kp.Nama != null)
                                                                    {

                                                                        double nilai = lst_nilai_siswa_det.Where(
                                                                            m => m.Rel_Rapor_StrukturNilai_AP.ToString().Trim().ToUpper() == rel_sn_ap.Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == rel_kp.Trim().ToUpper() &&
                                                                                 m.Rel_Siswa.Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper()
                                                                        ).Select(m => Libs.GetStringToDouble(m.Nilai)).DefaultIfEmpty().Average();

                                                                        lst_formatnilai_nilai.Add(new FormatNilaiWithNilai
                                                                        {
                                                                            Nama_KP = m_kp.Nama,
                                                                            Nilai = nilai.ToString(),
                                                                            Rel_KP = rel_kp,
                                                                            Rel_StrukturNilai_AP = rel_sn_ap
                                                                        });

                                                                    }
                                                                }

                                                            }
                                                        }

                                                        List<FormatNilaiWithNilai> lst_formatnilai_nilai2 = new List<FormatNilaiWithNilai>();
                                                        //distinct ap
                                                        foreach (string rel_sn_ap in lst_format_nilai2.Select(m => m.Rel_StrukturNilai_AP).Distinct())
                                                        {
                                                            foreach (string rel_kp in lst_format_nilai2.Select(m => m.Rel_KP).Distinct())
                                                            {

                                                                Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(rel_kp);
                                                                if (m_kp != null)
                                                                {
                                                                    if (m_kp.Nama != null)
                                                                    {

                                                                        double nilai = lst_nilai_siswa_det.Where(
                                                                            m => m.Rel_Rapor_StrukturNilai_AP.ToString().Trim().ToUpper() == rel_sn_ap.Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == rel_kp.Trim().ToUpper() &&
                                                                                 m.Rel_Siswa.Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper()
                                                                        ).Select(m => Libs.GetStringToDouble(m.Nilai)).DefaultIfEmpty().Average();

                                                                        lst_formatnilai_nilai2.Add(new FormatNilaiWithNilai
                                                                        {
                                                                            Nama_KP = m_kp.Nama,
                                                                            Nilai = nilai.ToString(),
                                                                            Rel_KP = rel_kp,
                                                                            Rel_StrukturNilai_AP = rel_sn_ap
                                                                        });

                                                                    }
                                                                }

                                                            }
                                                        }

                                                        //get nilai rapor                                                        
                                                        List<NilaiWithKey> lst_nilai = new List<NilaiWithKey>();
                                                        lst_nilai.Clear();
                                                        foreach (string rel_kp in lst_formatnilai_nilai.Select(m => m.Rel_KP).Distinct())
                                                        {

                                                            nilai_rapor = 0;
                                                            jumlah_nilai_rapor = 0;
                                                            count_nilai_rapor = 0;
                                                            foreach (var m_formatnilai_nilai in lst_formatnilai_nilai.FindAll(m => m.Rel_KP == rel_kp))
                                                            {
                                                                Rapor_StrukturNilai_AP m_rel_sn_ap = DAO_Rapor_StrukturNilai_AP.GetByID_Entity(m_formatnilai_nilai.Rel_StrukturNilai_AP);
                                                                if (m_rel_sn_ap != null)
                                                                {
                                                                    if (m_rel_sn_ap.JenisPerhitungan != null)
                                                                    {

                                                                        if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                        {
                                                                            nilai_rapor += Math.Round((m_rel_sn_ap.BobotRapor / 100) * Libs.GetStringToDecimal(m_formatnilai_nilai.Nilai), 3, MidpointRounding.AwayFromZero);
                                                                        }
                                                                        else if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                        {
                                                                            jumlah_nilai_rapor += m_rel_sn_ap.BobotRapor;
                                                                        }
                                                                        count_nilai_rapor++;

                                                                    }
                                                                }
                                                            }

                                                            if (count_nilai_rapor > 0)
                                                            {
                                                                if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_rapor = 0;
                                                            }
                                                            nilai_rapor = Math.Round(nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                            lst_nilai.Add(new NilaiWithKey
                                                            {
                                                                Key = rel_kp,
                                                                Nilai = nilai_rapor
                                                            });
                                                        }

                                                        nilai_rapor = 0;
                                                        jumlah_nilai_rapor = 0;
                                                        count_nilai_rapor = 0;
                                                        List<Rapor_StrukturNilai_KPKelompok> lst_kpkelompok = DAO_Rapor_StrukturNilai_KPKelompok.GetAllByHeader_Entity(
                                                                m_struktur_nilai.Kode.ToString()
                                                            );
                                                        foreach (var item_nilai in lst_nilai)
                                                        {
                                                            Rapor_StrukturNilai_KPKelompok m_kpkelompok = lst_kpkelompok.FindAll(
                                                                    m => m.Rel_Rapor_KomponenPenilaian == new Guid(item_nilai.Key)
                                                                ).FirstOrDefault();
                                                            if (m_kpkelompok != null)
                                                            {
                                                                if (m_kpkelompok.Rel_Rapor_StrukturNilai != null)
                                                                {
                                                                    nilai_rapor += Math.Round((m_kpkelompok.Bobot / 100) * item_nilai.Nilai, 3, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                        }

                                                        decimal nilai_non_q = 0;
                                                        if (lst_formatnilai_nilai2.Count > 0)
                                                        {
                                                            nilai_non_q = lst_formatnilai_nilai2.Select(m => Libs.GetStringToDecimal(m.Nilai)).DefaultIfEmpty().Average();
                                                        }
                                                        if (nilai_non_q > 0)
                                                        {
                                                            nilai_rapor = Math.Round((nilai_rapor + nilai_non_q) / 2, 3, MidpointRounding.AwayFromZero);
                                                        }
                                                        nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);
                                                        nilai_rapor_pengetahuan = nilai_rapor;
                                                        //end get nilai rapor
                                                        //end distinct ap
                                                    }
                                                }
                                            }
                                            //end get struktur nilai
                                        }

                                    }
                                    //end rapor non mulok

                                    //rapor mulok
                                    lst_rapor_desain_det = DAO_Rapor_Desain_Det.GetAllByHeader_Entity(rapor_desain.Kode.ToString()).FindAll(m => m.Nomor.Trim() == "" && m.Rel_Mapel.Trim() != "");
                                    foreach (Rapor_Desain_Det item in lst_rapor_desain_det.FindAll(m => m.Rel_Mapel.Trim() != ""))
                                    {

                                        if (item.Rel_Mapel.Trim() != "")
                                        {

                                            lst_nilai_siswa_det = lst_nilai_siswa_det_by_periode.FindAll(
                                                    m => m.Rel_Mapel == item.Rel_Mapel &&
                                                         m.Rel_Siswa == m.Rel_Siswa
                                                );

                                            //get struktur nilainya
                                            Rapor_StrukturNilai m_struktur_nilai = DAO_Rapor_StrukturNilai.GetATop1ByTABySMByKelasByMapel_Entity(
                                                    tahun_ajaran, semester, m_kelas.Kode.ToString(), item.Rel_Mapel
                                                );

                                            decimal nilai_rapor = 0;
                                            decimal jumlah_nilai_rapor = 0;
                                            decimal count_nilai_rapor = 0;

                                            decimal nilai_rapor_pengetahuan = 0;
                                            if (m_struktur_nilai != null)
                                            {
                                                if (m_struktur_nilai.TahunAjaran != null)
                                                {

                                                    if (!(m_struktur_nilai.IsKelompokanKP && m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString()))
                                                    {
                                                        //-----------nilai pengetahuan---------------
                                                        //get struktur nilai det AP
                                                        List<Rapor_StrukturNilai_AP> lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeader_Entity(
                                                                m_struktur_nilai.Kode.ToString()
                                                            );
                                                        lst_nilai_ap.Clear();
                                                        lst_nilai_ap_bobot.Clear();
                                                        decimal jumlah_nilai_ap = 0;
                                                        decimal nilai_ap = 0;
                                                        int count_ap = 0;
                                                        foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                        {

                                                            //get struktur nilai det KD
                                                            List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                );
                                                            lst_nilai_kd.Clear();
                                                            foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                            {

                                                                //get struktur nilai det KP
                                                                List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                );
                                                                decimal jumlah_nilai_kd = 0;
                                                                decimal nilai_kd = 0;
                                                                int count_kd = 0;
                                                                foreach (var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp)
                                                                {
                                                                    Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString());
                                                                    if (m_kp != null)
                                                                    {

                                                                        Rapor_NilaiSiswa_Det m_nilai_det = lst_nilai_siswa_det.FindAll(
                                                                            m => m.Rel_Siswa.ToString().Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_AP.Trim().ToUpper() == item_rapor_struktur_nilai_ap.Kode.ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KD.Trim().ToUpper() == item_rapor_struktur_nilai_kd.Kode.ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KP.Trim().ToUpper() == item_rapor_struktur_nilai_kp.Kode.ToString().ToUpper()
                                                                        ).FirstOrDefault();

                                                                        if (m_nilai_det != null)
                                                                        {
                                                                            if (m_nilai_det.Nilai.Trim() != "")
                                                                            {
                                                                                if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                                {
                                                                                    nilai_kd += Math.Round((item_rapor_struktur_nilai_kp.BobotNK / 100) * Libs.GetStringToDecimal(m_nilai_det.Nilai), 2, MidpointRounding.AwayFromZero);
                                                                                }
                                                                                else if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                                {
                                                                                    jumlah_nilai_kd += Libs.GetStringToDecimal(m_nilai_det.Nilai);
                                                                                }
                                                                                count_kd++;
                                                                            }
                                                                        }

                                                                    }

                                                                }

                                                                if (count_kd > 0)
                                                                {
                                                                    if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                    {
                                                                        nilai_kd = Math.Round(jumlah_nilai_kd / count_kd, 2, MidpointRounding.AwayFromZero);
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    nilai_kd = 0;
                                                                }

                                                                //load nilai manual
                                                                Rapor_NilaiSiswa_AP_or_KD m_nilai_manual = DAO_Rapor_NilaiSiswa_AP_or_KD.GetAllByTABySMByKelasByMapelBySiswaByStruktur_Entity(
                                                                        tahun_ajaran, semester, rel_kelas_det, m_siswa.Kode.ToString(), item.Rel_Mapel,
                                                                        item_rapor_struktur_nilai_kd.Kode.ToString().Trim().ToUpper()

                                                                    ).FirstOrDefault();
                                                                if (m_nilai_manual != null)
                                                                {
                                                                    if (m_nilai_manual.Nilai != null)
                                                                    {
                                                                        nilai_kd = Libs.GetStringToDecimal(m_nilai_manual.Nilai);
                                                                    }
                                                                }
                                                                //end load nilai manual

                                                                nilai_kd = Math.Round(nilai_kd, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);
                                                                lst_nilai_kd.Add(nilai_kd);
                                                                //end get struktur nilai det KP

                                                            }
                                                            //end get struktur nilai det KD

                                                            //get nilai ap
                                                            count_ap = 0;
                                                            nilai_ap = 0;
                                                            jumlah_nilai_ap = 0;
                                                            foreach (var item_nilai_kd in lst_nilai_kd)
                                                            {
                                                                if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                {
                                                                    nilai_ap += Math.Round((item_rapor_struktur_nilai_ap.BobotRapor / 100) * item_nilai_kd, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                                else if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    jumlah_nilai_ap += item_nilai_kd;
                                                                }
                                                                count_ap++;
                                                            }
                                                            if (count_ap > 0)
                                                            {
                                                                if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_ap = Math.Round(jumlah_nilai_ap / count_ap, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_ap = 0;
                                                            }
                                                            nilai_ap = Math.Round(nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                            lst_nilai_ap.Add(nilai_ap);
                                                            lst_nilai_ap_bobot.Add(item_rapor_struktur_nilai_ap.BobotRapor);
                                                            //end get nilai ap

                                                        }
                                                        //end get struktur nilai det AP

                                                        //get nilai rapor
                                                        nilai_rapor = 0;
                                                        jumlah_nilai_rapor = 0;
                                                        count_nilai_rapor = 0;
                                                        foreach (var item_nilai_ap in lst_nilai_ap)
                                                        {
                                                            if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                            {
                                                                nilai_rapor += Math.Round((lst_nilai_ap_bobot[Convert.ToInt16(count_nilai_rapor)] / 100) * item_nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                            }
                                                            else if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                jumlah_nilai_rapor += item_nilai_ap;
                                                            }
                                                            count_nilai_rapor++;
                                                        }
                                                        if (count_nilai_rapor > 0)
                                                        {
                                                            if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            nilai_rapor = 0;
                                                        }
                                                        nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);
                                                        nilai_rapor_pengetahuan = nilai_rapor;
                                                        //end get nilai rapor
                                                        //-----------end nilai pengetahuan---------------
                                                    }
                                                    else 
                                                    {
                                                        List<FormatNilai> lst_format_nilai = new List<FormatNilai>();
                                                        List<Rapor_StrukturNilai_AP> lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeader_Entity(
                                                                m_struktur_nilai.Kode.ToString()
                                                            );
                                                        foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                        {

                                                            List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                );

                                                            foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                            {

                                                                List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                );
                                                                foreach (
                                                                    var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp.FindAll(
                                                                        m => (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == DAO_Rapor_StrukturNilai.Arr_KP_Quran[0]) ||
                                                                             (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == DAO_Rapor_StrukturNilai.Arr_KP_Quran[1]) ||
                                                                             (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == DAO_Rapor_StrukturNilai.Arr_KP_Quran[2])
                                                                        )
                                                                )
                                                                {

                                                                    if (
                                                                        lst_format_nilai.FindAll(
                                                                                m => m.Rel_StrukturNilai_AP == item_rapor_struktur_nilai_ap.Kode.ToString() &&
                                                                                     m.Rel_KP == item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                            ).Count == 0
                                                                    )
                                                                    {
                                                                        lst_format_nilai.Add(new FormatNilai
                                                                        {
                                                                            Rel_StrukturNilai_AP = item_rapor_struktur_nilai_ap.Kode.ToString(),
                                                                            Rel_KP = item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                        });
                                                                    }

                                                                }
                                                            }

                                                        }

                                                        List<FormatNilai> lst_format_nilai2 = new List<FormatNilai>();
                                                        foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                        {

                                                            List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                );

                                                            foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                            {

                                                                List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                );
                                                                foreach (
                                                                    var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp.FindAll(
                                                                        m => (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() != DAO_Rapor_StrukturNilai.Arr_KP_Quran[0]) &&
                                                                             (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() != DAO_Rapor_StrukturNilai.Arr_KP_Quran[1]) &&
                                                                             (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() != DAO_Rapor_StrukturNilai.Arr_KP_Quran[2])
                                                                        )
                                                                )
                                                                {

                                                                    if (
                                                                        lst_format_nilai2.FindAll(
                                                                                m => m.Rel_StrukturNilai_AP == item_rapor_struktur_nilai_ap.Kode.ToString() &&
                                                                                     m.Rel_KP == item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                            ).Count == 0
                                                                    )
                                                                    {
                                                                        lst_format_nilai2.Add(new FormatNilai
                                                                        {
                                                                            Rel_StrukturNilai_AP = item_rapor_struktur_nilai_ap.Kode.ToString(),
                                                                            Rel_KP = item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                        });
                                                                    }

                                                                }
                                                            }

                                                        }

                                                        List<FormatNilaiWithNilai> lst_formatnilai_nilai = new List<FormatNilaiWithNilai>();
                                                        //distinct ap
                                                        foreach (string rel_sn_ap in lst_format_nilai.Select(m => m.Rel_StrukturNilai_AP).Distinct())
                                                        {
                                                            foreach (string rel_kp in lst_format_nilai.Select(m => m.Rel_KP).Distinct())
                                                            {

                                                                Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(rel_kp);
                                                                if (m_kp != null)
                                                                {
                                                                    if (m_kp.Nama != null)
                                                                    {

                                                                        double nilai = lst_nilai_siswa_det.Where(
                                                                            m => m.Rel_Rapor_StrukturNilai_AP.ToString().Trim().ToUpper() == rel_sn_ap.Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == rel_kp.Trim().ToUpper() &&
                                                                                 m.Rel_Siswa.Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper()
                                                                        ).Select(m => Libs.GetStringToDouble(m.Nilai)).DefaultIfEmpty().Average();

                                                                        lst_formatnilai_nilai.Add(new FormatNilaiWithNilai
                                                                        {
                                                                            Nama_KP = m_kp.Nama,
                                                                            Nilai = nilai.ToString(),
                                                                            Rel_KP = rel_kp,
                                                                            Rel_StrukturNilai_AP = rel_sn_ap
                                                                        });

                                                                    }
                                                                }

                                                            }
                                                        }

                                                        List<FormatNilaiWithNilai> lst_formatnilai_nilai2 = new List<FormatNilaiWithNilai>();
                                                        //distinct ap
                                                        foreach (string rel_sn_ap in lst_format_nilai2.Select(m => m.Rel_StrukturNilai_AP).Distinct())
                                                        {
                                                            foreach (string rel_kp in lst_format_nilai2.Select(m => m.Rel_KP).Distinct())
                                                            {

                                                                Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(rel_kp);
                                                                if (m_kp != null)
                                                                {
                                                                    if (m_kp.Nama != null)
                                                                    {

                                                                        double nilai = lst_nilai_siswa_det.Where(
                                                                            m => m.Rel_Rapor_StrukturNilai_AP.ToString().Trim().ToUpper() == rel_sn_ap.Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == rel_kp.Trim().ToUpper() &&
                                                                                 m.Rel_Siswa.Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper()
                                                                        ).Select(m => Libs.GetStringToDouble(m.Nilai)).DefaultIfEmpty().Average();

                                                                        lst_formatnilai_nilai2.Add(new FormatNilaiWithNilai
                                                                        {
                                                                            Nama_KP = m_kp.Nama,
                                                                            Nilai = nilai.ToString(),
                                                                            Rel_KP = rel_kp,
                                                                            Rel_StrukturNilai_AP = rel_sn_ap
                                                                        });

                                                                    }
                                                                }

                                                            }
                                                        }

                                                        //get nilai rapor                                                        
                                                        List<NilaiWithKey> lst_nilai = new List<NilaiWithKey>();
                                                        lst_nilai.Clear();
                                                        foreach (string rel_kp in lst_formatnilai_nilai.Select(m => m.Rel_KP).Distinct())
                                                        {

                                                            nilai_rapor = 0;
                                                            jumlah_nilai_rapor = 0;
                                                            count_nilai_rapor = 0;
                                                            foreach (var m_formatnilai_nilai in lst_formatnilai_nilai.FindAll(m => m.Rel_KP == rel_kp))
                                                            {
                                                                Rapor_StrukturNilai_AP m_rel_sn_ap = DAO_Rapor_StrukturNilai_AP.GetByID_Entity(m_formatnilai_nilai.Rel_StrukturNilai_AP);
                                                                if (m_rel_sn_ap != null)
                                                                {
                                                                    if (m_rel_sn_ap.JenisPerhitungan != null)
                                                                    {

                                                                        if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                        {
                                                                            nilai_rapor += Math.Round((m_rel_sn_ap.BobotRapor / 100) * Libs.GetStringToDecimal(m_formatnilai_nilai.Nilai), 3, MidpointRounding.AwayFromZero);
                                                                        }
                                                                        else if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                        {
                                                                            jumlah_nilai_rapor += m_rel_sn_ap.BobotRapor;
                                                                        }
                                                                        count_nilai_rapor++;

                                                                    }
                                                                }
                                                            }

                                                            if (count_nilai_rapor > 0)
                                                            {
                                                                if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_rapor = 0;
                                                            }
                                                            nilai_rapor = Math.Round(nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                            lst_nilai.Add(new NilaiWithKey
                                                            {
                                                                Key = rel_kp,
                                                                Nilai = nilai_rapor
                                                            });
                                                        }

                                                        nilai_rapor = 0;
                                                        jumlah_nilai_rapor = 0;
                                                        count_nilai_rapor = 0;
                                                        List<Rapor_StrukturNilai_KPKelompok> lst_kpkelompok = DAO_Rapor_StrukturNilai_KPKelompok.GetAllByHeader_Entity(
                                                                m_struktur_nilai.Kode.ToString()
                                                            );
                                                        foreach (var item_nilai in lst_nilai)
                                                        {
                                                            Rapor_StrukturNilai_KPKelompok m_kpkelompok = lst_kpkelompok.FindAll(
                                                                    m => m.Rel_Rapor_KomponenPenilaian == new Guid(item_nilai.Key)
                                                                ).FirstOrDefault();
                                                            if (m_kpkelompok != null)
                                                            {
                                                                if (m_kpkelompok.Rel_Rapor_StrukturNilai != null)
                                                                {
                                                                    nilai_rapor += Math.Round((m_kpkelompok.Bobot / 100) * item_nilai.Nilai, 3, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                        }

                                                        decimal nilai_non_q = 0;
                                                        if (lst_formatnilai_nilai2.Count > 0)
                                                        {
                                                            nilai_non_q = lst_formatnilai_nilai2.Select(m => Libs.GetStringToDecimal(m.Nilai)).DefaultIfEmpty().Average();
                                                        }
                                                        if (nilai_non_q > 0)
                                                        {
                                                            nilai_rapor = Math.Round((nilai_rapor + nilai_non_q) / 2, 3, MidpointRounding.AwayFromZero);
                                                        }
                                                        nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);
                                                        nilai_rapor_pengetahuan = nilai_rapor;
                                                        //end get nilai rapor
                                                        //end distinct ap
                                                    }
                                                }
                                            }
                                            //end get struktur nilai
                                        }

                                    }
                                    //end rapor mulok
                                }
                                // end foreach siswa

                            }

                        }
                    }

                }
            }

            return hasil;
        }

        public static string GetPredikatDeskripsi(string s_nilai)
        {
            return "";

            if(s_nilai.Trim() == "") return ", (-)";

            decimal nilai = Libs.GetStringToDecimal(s_nilai);

            if (nilai < 70)
            {
                return ", kurang (" + s_nilai + ")";
            }
            else if (nilai >= 70 && nilai < 80)
            {
                return ", cukup (" + s_nilai + ")";
            }
            else if (nilai >= 80 && nilai < 90)
            {
                return ", baik (" + s_nilai + ")";
            }
            else if (nilai >= 90 && nilai <= 100)
            {
                return ", sangat baik (" + s_nilai + ")";
            }

            return "";
        }

        public static List<KURTILAS_RaporNilai> GetNilaiRapor_KURTILAS_2020(
            string tahun_ajaran,
            string semester,
            string rel_kelas_det,
            ref List<RaporLTSCapaianKedisiplinan> ListRaporLTSCapaianKedisiplinan,
            string rel_siswa = "",
            string lokasi_ttd = "",
            bool show_qrcode = true
        )
        {
            ListRaporLTSCapaianKedisiplinan.Clear();
            //List<RaporLTSCapaianKedisiplinan> HasilCapaianKedisiplinan = new List<Application_Entities.Elearning.SD.Reports.RaporLTSCapaianKedisiplinan>();
            
            List<KURTILAS_RaporNilai> hasil = new List<KURTILAS_RaporNilai>();
            Rapor_Arsip m_rapor_arsip = DAO_Rapor_Arsip.GetAll_Entity().FindAll(
                m0 => m0.TahunAjaran == tahun_ajaran &&
                        m0.Semester == semester &&
                        m0.JenisRapor == "Semester"

            ).FirstOrDefault();

            List<Rapor_KompetensiDasar> lst_kd = DAO_Rapor_KompetensiDasar.GetAll_Entity();
            List<Rapor_KomponenPenilaian> lst_kp = DAO_Rapor_KomponenPenilaian.GetAll_Entity();
            List<KelasDet> lst_kelas_det = DAO_KelasDet.GetAll_Entity();

            KelasDet m_kelas_det = DAO_KelasDet.GetByID_Entity(rel_kelas_det);
            if (m_kelas_det != null)
            {
                if (m_kelas_det.Nama != null)
                {
                    System.Drawing.Image img = null;
                    string s_loc = lokasi_ttd;
                    if (File.Exists(s_loc) && s_loc.Trim() != "")
                    {
                        img = System.Drawing.Image.FromFile(s_loc);
                    }
                    byte[] img_ttd_guru = (byte[])(new ImageConverter()).ConvertTo(img, typeof(byte[]));

                    string s_walikelas = "";
                    List<FormasiGuruKelas> lst_formasi_guru_kelas = DAO_FormasiGuruKelas.GetByUnitByTABySM_Entity(
                                GetUnitSekolah().Kode.ToString(), tahun_ajaran, semester
                            ).FindAll(m => m.Rel_KelasDet.ToString().ToUpper() == rel_kelas_det.Trim().ToUpper());
                    if (lst_formasi_guru_kelas != null)
                    {
                        if (lst_formasi_guru_kelas.Count > 0)
                        {
                            FormasiGuruKelas m_guru_kelas = lst_formasi_guru_kelas.FirstOrDefault();
                            if (m_guru_kelas != null)
                            {
                                if (m_guru_kelas.TahunAjaran != null)
                                {
                                    Pegawai m_pegawai = DAO_Pegawai.GetByID_Entity(m_guru_kelas.Rel_GuruKelas);
                                    if (m_pegawai != null)
                                    {
                                        if (m_pegawai.Nama != null)
                                        {
                                            s_walikelas = m_pegawai.Nama;
                                        }
                                    }
                                }
                            }
                        }
                    }

                    Kelas m_kelas = DAO_Kelas.GetByID_Entity(m_kelas_det.Rel_Kelas.ToString());
                    if (m_kelas != null)
                    {
                        if (m_kelas.Nama != null)
                        {
                            Rapor_Desain rapor_desain = DAO_Rapor_Desain.GetByTABySMByKelas_Entity(
                                    tahun_ajaran, semester, rel_kelas_det, DAO_Rapor_Desain.JenisRapor.Semester
                                ).FirstOrDefault();

                            List<Rapor_Desain_Det> lst_rapor_desain_det = DAO_Rapor_Desain_Det.GetAllByHeader_Entity(rapor_desain.Kode.ToString()).FindAll(m => m.Nomor.Trim() != "" && m.Rel_Mapel.Trim() != "");

                            //list cols header
                            if (rapor_desain != null)
                            {

                                List<DAO_Siswa.SiswaDataSimple> lst_siswa = DAO_Siswa.GetAllSiswaDataSimpleByTahunAjaranUnitKelas_Entity(
                                        m_kelas.Rel_Sekolah.ToString(),
                                        rel_kelas_det,
                                        tahun_ajaran,
                                        semester
                                    );
                                List<decimal> lst_nilai_ap = new List<decimal>();
                                List<decimal> lst_nilai_ap_bobot = new List<decimal>();
                                List<decimal> lst_nilai_kd = new List<decimal>();
                                List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT> lst_nilai_siswa_det = new List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT>();
                                List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT> lst_nilai_siswa_det_by_periode = new List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT>();
                                List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT> lst_nilai_siswa_det_sm1 = new List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT>();
                                List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT> lst_nilai_siswa_det_by_periode_sm1 = new List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT>();

                                lst_nilai_siswa_det_by_periode = DAO_Rapor_NilaiSiswa_Det.GetAllByTABySMByKelasDet_Entity(
                                        tahun_ajaran, semester, rel_kelas_det
                                    );
                                lst_nilai_siswa_det_by_periode_sm1 = DAO_Rapor_NilaiSiswa_Det.GetAllByTABySMByKelasDet_Entity(
                                        tahun_ajaran, "1", rel_kelas_det
                                    );
                                if (rel_siswa.Trim() != "")
                                {
                                    lst_siswa = lst_siswa.FindAll(m0 => (rel_siswa + ";").Trim().ToUpper().IndexOf(m0.Kode.ToString().ToUpper() + ";") >= 0).ToList();
                                }

                                List<Rapor_NilaiSiswa> lst_nilaisiswa =
                                    DAO_Rapor_NilaiSiswa.GetAllByTABySMByKelasDet_ForReport_Entity(tahun_ajaran, semester, rel_kelas_det);

                                List<Rapor_Nilai> lst_rpor_nilai = DAO_Rapor_Nilai.GetAllByTABySMByKelasDet_Entity(tahun_ajaran, semester, rel_kelas_det);

                                string tanggal_rapor = "";
                                foreach (DAO_Siswa.SiswaDataSimple m_siswa in lst_siswa.OrderBy(m => m.Nama))
                                {
                                    //HasilCapaianKedisiplinan.Clear();

                                    bool is_naik_kelas = true;
                                    string naik_ke_kelas = "";
                                    KenaikanKelas kenaikan_kelas = DAO_KenaikanKelas.GetByTAByKelasBySiswa_Entity(tahun_ajaran, rel_kelas_det, m_siswa.Kode.ToString());
                                    if (kenaikan_kelas != null)
                                    {
                                        if (kenaikan_kelas.TahunAjaran != null)
                                        {
                                            is_naik_kelas = kenaikan_kelas.IsNaik;
                                        }
                                    }
                                    Kelas kelas_naik = DAO_Kelas.GetKelasNext(m_kelas.Rel_Sekolah.ToString(), m_kelas.Kode.ToString());
                                    if (is_naik_kelas)
                                    {
                                        naik_ke_kelas = kelas_naik.Nama;
                                    }
                                    else
                                    {
                                        naik_ke_kelas = m_kelas.Nama;
                                    }

                                    string s_kelas = lst_kelas_det.FindAll(m0 => m0.Kode.ToString().Trim().ToUpper().Trim() == rel_kelas_det.ToUpper().Trim()).FirstOrDefault().Nama;
                                    string s_info_qr = "";
                                    s_info_qr = "NIS = " + m_siswa.NISSekolah + ", " +
                                                "Nama = " + m_siswa.Nama.Trim().ToUpper() + ", " +
                                                "Unit = SD, " +
                                                "Tahun Pelajaran & Semester = " + tahun_ajaran + " & " + semester + ", " +
                                                "Kelas = " + s_kelas;
                                    byte[] qr_code =
                                        (show_qrcode
                                            ? (byte[])(new ImageConverter()).ConvertTo(QRCodeGenerator.GetQRCode(s_info_qr, 20), typeof(byte[]))
                                            : null
                                        );

                                    int nomor_mapel = 0;
                                    int urut_mapel = 0;
                                    int jumlah_tematik = 0;
                                    bool ada_tematik = false;
                                    string rel_rapornilaisiswa = "";

                                    //nilai non mulok
                                    foreach (Rapor_Desain_Det item in DAO_Rapor_Desain_Det.GetAllByHeader_Entity(rapor_desain.Kode.ToString()))
                                    {
                                        rel_rapornilaisiswa = "";

                                        if (item.Rel_Mapel.Trim() != "")
                                        {

                                            lst_nilai_siswa_det = lst_nilai_siswa_det_by_periode.FindAll(
                                                    m => m.Rel_Mapel == item.Rel_Mapel &&
                                                         m.Rel_Siswa == m.Rel_Siswa
                                                );
                                            lst_nilai_siswa_det_sm1 = lst_nilai_siswa_det_by_periode_sm1.FindAll(
                                                    m => m.Rel_Mapel == item.Rel_Mapel &&
                                                         m.Rel_Siswa == m.Rel_Siswa
                                                );

                                            //get struktur nilainya
                                            Rapor_StrukturNilai m_struktur_nilai_sm1 = DAO_Rapor_StrukturNilai.GetATop1ByTABySMByKelasByMapel_Entity(
                                                    tahun_ajaran, "1", m_kelas.Kode.ToString(), item.Rel_Mapel
                                                );

                                            Rapor_StrukturNilai m_struktur_nilai = DAO_Rapor_StrukturNilai.GetATop1ByTABySMByKelasByMapel_Entity(
                                                    tahun_ajaran, semester, m_kelas.Kode.ToString(), item.Rel_Mapel
                                                );

                                            decimal nilai_rapor = 0;
                                            decimal jumlah_nilai_rapor = 0;
                                            decimal count_nilai_rapor = 0;

                                            decimal nilai_rata2_sm1_sm2 = 0;
                                            decimal nilai_rata2_pengetahuan_sm1_sm2 = 0;
                                            decimal nilai_rata2_keterampilan_sm1_sm2 = 0;
                                            decimal nilai_rapor_pengetahuan_sm1 = 0;
                                            decimal nilai_rapor_keterampilan_sm1 = 0;
                                            decimal nilai_rapor_pengetahuan = 0;
                                            decimal nilai_rapor_keterampilan = 0;

                                            Rapor_StrukturNilai_AP m_sn_ap = new Rapor_StrukturNilai_AP();

                                            if (m_struktur_nilai != null)
                                            {
                                                if (m_struktur_nilai.TahunAjaran != null)
                                                {
                                                    string s_deskripsi_pengetahuan = "";
                                                    string s_deskripsi_keterampilan = "";

                                                    //-----------nilai pengetahuan---------------
                                                    decimal jumlah_nilai_ap = 0;
                                                    decimal nilai_ap = 0;
                                                    int count_ap = 0;
                                                    string guru_kelas = "";
                                                    tanggal_rapor = Libs.GetTanggalIndonesiaFromDate(DateTime.Now, false);
                                                    List<Rapor_StrukturNilai_AP> lst_rapor_struktur_nilai_ap = new List<Rapor_StrukturNilai_AP>();
                                                    DateTime dt_tanggal_rapor = DateTime.Now;
                                                    Rapor_LTS_MengetahuiGuruKelas m_guru_kelas = new Rapor_LTS_MengetahuiGuruKelas();
                                                    //get struktur nilai det AP

                                                    //jika semester 2 get semester 1
                                                    if (semester == "2")
                                                    {
                                                        lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeaderByJenisAspekPenilaian_Entity(
                                                            m_struktur_nilai_sm1.Kode.ToString(), DAO_Rapor_StrukturNilai_AP.JenisAspekPenilaian.Pengetahuan
                                                        );
                                                        lst_nilai_ap.Clear();
                                                        lst_nilai_ap_bobot.Clear();
                                                        jumlah_nilai_ap = 0;
                                                        nilai_ap = 0;
                                                        count_ap = 0;
                                                        m_sn_ap = new Rapor_StrukturNilai_AP();
                                                        foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                        {

                                                            //get struktur nilai det KD
                                                            List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                );
                                                            lst_nilai_kd.Clear();
                                                            foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                            {

                                                                //get struktur nilai det KP
                                                                List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                );
                                                                decimal jumlah_nilai_kd = 0;
                                                                decimal nilai_kd = 0;
                                                                int count_kd = 0;
                                                                foreach (var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp)
                                                                {
                                                                    Rapor_KomponenPenilaian m_kp = lst_kp.FindAll(m0 => m0.Kode.ToString().ToUpper().Trim() == item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString().ToUpper().Trim()).FirstOrDefault();
                                                                    if (m_kp != null)
                                                                    {

                                                                        Rapor_NilaiSiswa_Det m_nilai_det = lst_nilai_siswa_det_sm1.FindAll(
                                                                            m => m.Rel_Siswa.ToString().Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai_sm1.Rel_Mapel.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_AP.Trim().ToUpper() == item_rapor_struktur_nilai_ap.Kode.ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KD.Trim().ToUpper() == item_rapor_struktur_nilai_kd.Kode.ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KP.Trim().ToUpper() == item_rapor_struktur_nilai_kp.Kode.ToString().ToUpper()
                                                                        ).FirstOrDefault();

                                                                        if (m_nilai_det != null)
                                                                        {
                                                                            if (m_nilai_det.Nilai.Trim() != "")
                                                                            {
                                                                                rel_rapornilaisiswa = m_nilai_det.Rel_Rapor_NilaiSiswa.ToString();
                                                                                if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                                {
                                                                                    nilai_kd += Math.Round((item_rapor_struktur_nilai_kp.BobotNK / 100) * Libs.GetStringToDecimal(m_nilai_det.Nilai), 2, MidpointRounding.AwayFromZero);
                                                                                }
                                                                                else if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                                {
                                                                                    jumlah_nilai_kd += Libs.GetStringToDecimal(m_nilai_det.Nilai);
                                                                                }
                                                                                count_kd++;
                                                                            }
                                                                        }

                                                                    }

                                                                }

                                                                if (count_kd > 0)
                                                                {
                                                                    if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                    {
                                                                        nilai_kd = Math.Round(jumlah_nilai_kd / count_kd, 2, MidpointRounding.AwayFromZero);
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    nilai_kd = 0;
                                                                }

                                                                //load nilai manual
                                                                Rapor_NilaiSiswa_AP_or_KD m_nilai_manual = DAO_Rapor_NilaiSiswa_AP_or_KD.GetAllByTABySMByKelasByMapelBySiswaByStruktur_Entity(
                                                                        tahun_ajaran, m_struktur_nilai_sm1.Semester, rel_kelas_det, m_siswa.Kode.ToString(), item.Rel_Mapel,
                                                                        item_rapor_struktur_nilai_kd.Kode.ToString().Trim().ToUpper()

                                                                    ).FirstOrDefault();
                                                                if (m_nilai_manual != null)
                                                                {
                                                                    if (m_nilai_manual.Nilai != null)
                                                                    {
                                                                        nilai_kd = Libs.GetStringToDecimal(m_nilai_manual.Nilai);
                                                                    }
                                                                }
                                                                //end load nilai manual

                                                                nilai_kd = Math.Round(nilai_kd, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);
                                                                lst_nilai_kd.Add(nilai_kd);
                                                                //end get struktur nilai det KP

                                                            }
                                                            //end get struktur nilai det KD

                                                            //get nilai ap
                                                            count_ap = 0;
                                                            nilai_ap = 0;
                                                            jumlah_nilai_ap = 0;
                                                            foreach (var item_nilai_kd in lst_nilai_kd)
                                                            {
                                                                if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                {
                                                                    nilai_ap += Math.Round((item_rapor_struktur_nilai_ap.BobotRapor / 100) * item_nilai_kd, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                                else if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    jumlah_nilai_ap += item_nilai_kd;
                                                                }
                                                                count_ap++;
                                                            }
                                                            if (count_ap > 0)
                                                            {
                                                                if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_ap = Math.Round(jumlah_nilai_ap / count_ap, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_ap = 0;
                                                            }
                                                            nilai_ap = Math.Round(nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                            lst_nilai_ap.Add(nilai_ap);
                                                            lst_nilai_ap_bobot.Add(item_rapor_struktur_nilai_ap.BobotRapor);
                                                            //end get nilai ap

                                                        }
                                                        //end get struktur nilai det AP

                                                        //get nilai rapor
                                                        nilai_rapor = 0;
                                                        jumlah_nilai_rapor = 0;
                                                        count_nilai_rapor = 0;
                                                        foreach (var item_nilai_ap in lst_nilai_ap)
                                                        {
                                                            if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                            {
                                                                nilai_rapor += Math.Round((lst_nilai_ap_bobot[Convert.ToInt16(count_nilai_rapor)] / 100) * item_nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                            }
                                                            else if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                jumlah_nilai_rapor += item_nilai_ap;
                                                            }
                                                            count_nilai_rapor++;
                                                        }
                                                        if (count_nilai_rapor > 0)
                                                        {
                                                            if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            nilai_rapor = 0;
                                                        }
                                                        nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);
                                                        nilai_rapor_pengetahuan_sm1 = nilai_rapor;

                                                        if (m_rapor_arsip != null)
                                                        {
                                                            if (m_rapor_arsip.TahunAjaran != null)
                                                            {
                                                                dt_tanggal_rapor = m_rapor_arsip.TanggalRapor;
                                                            }
                                                        }

                                                        guru_kelas = "";
                                                        tanggal_rapor = Libs.GetTanggalIndonesiaFromDate(dt_tanggal_rapor, false);
                                                        m_guru_kelas = DAO_Rapor_LTS_MengetahuiGuruKelas.GetByTABySMByKelasDet_Entity(
                                                                tahun_ajaran, semester, rel_kelas_det
                                                            ).FirstOrDefault();
                                                        if (m_guru_kelas != null)
                                                        {
                                                            if (m_guru_kelas.NamaGuru != null)
                                                            {
                                                                guru_kelas = m_guru_kelas.NamaGuru;
                                                            }
                                                        }
                                                    }
                                                    //end jika semester 2 get semester 1

                                                    lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeaderByJenisAspekPenilaian_Entity(
                                                            m_struktur_nilai.Kode.ToString(), DAO_Rapor_StrukturNilai_AP.JenisAspekPenilaian.Pengetahuan
                                                        );
                                                    lst_nilai_ap.Clear();
                                                    lst_nilai_ap_bobot.Clear();
                                                    jumlah_nilai_ap = 0;
                                                    nilai_ap = 0;
                                                    count_ap = 0;
                                                    foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                    {

                                                        //get struktur nilai det KD
                                                        List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                item_rapor_struktur_nilai_ap.Kode.ToString()
                                                            );
                                                        lst_nilai_kd.Clear();
                                                        foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                        {

                                                            //get struktur nilai det KP
                                                            List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                item_rapor_struktur_nilai_kd.Kode.ToString()
                                                            );
                                                            decimal jumlah_nilai_kd = 0;
                                                            decimal nilai_kd = 0;
                                                            int count_kd = 0;
                                                            foreach (var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp)
                                                            {
                                                                Rapor_KomponenPenilaian m_kp = lst_kp.FindAll(m0 => m0.Kode.ToString().ToUpper().Trim() == item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString().ToUpper().Trim()).FirstOrDefault();
                                                                    
                                                                if (m_kp != null)
                                                                {
                                                                    Rapor_NilaiSiswa_Det m_nilai_det = lst_nilai_siswa_det.FindAll(
                                                                        m => m.Rel_Siswa.ToString().Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                             m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper() &&
                                                                             m.Rel_Rapor_StrukturNilai_AP.Trim().ToUpper() == item_rapor_struktur_nilai_ap.Kode.ToString().ToUpper() &&
                                                                             m.Rel_Rapor_StrukturNilai_KD.Trim().ToUpper() == item_rapor_struktur_nilai_kd.Kode.ToString().ToUpper() &&
                                                                             m.Rel_Rapor_StrukturNilai_KP.Trim().ToUpper() == item_rapor_struktur_nilai_kp.Kode.ToString().ToUpper()
                                                                    ).FirstOrDefault();

                                                                    if (m_nilai_det != null)
                                                                    {
                                                                        if (m_nilai_det.Nilai.Trim() != "")
                                                                        {
                                                                            rel_rapornilaisiswa = m_nilai_det.Rel_Rapor_NilaiSiswa.ToString();
                                                                            if (lst_kd.FindAll(m0 => m0.Kode.ToString().ToUpper().Trim() == item_rapor_struktur_nilai_kd.Rel_Rapor_KompetensiDasar.ToString().ToUpper().Trim()).Count > 0)
                                                                            {
                                                                                s_deskripsi_pengetahuan += (
                                                                                        s_deskripsi_pengetahuan.Trim() != "" &&
                                                                                        Libs.GetHTMLSimpleText2(lst_kd.FindAll(m0 => m0.Kode.ToString().ToUpper().Trim() == item_rapor_struktur_nilai_kd.Rel_Rapor_KompetensiDasar.ToString().ToUpper().Trim()).FirstOrDefault().Nama.Trim()).Trim() != ""
                                                                                        ? "; " 
                                                                                        : ""
                                                                                    ) +
                                                                                    Libs.GetHTMLSimpleText2(lst_kd.FindAll(m0 => m0.Kode.ToString().ToUpper().Trim() == item_rapor_struktur_nilai_kd.Rel_Rapor_KompetensiDasar.ToString().ToUpper().Trim()).FirstOrDefault().Nama.Trim()) +
                                                                                    GetPredikatDeskripsi(m_nilai_det.Nilai);
                                                                            }

                                                                            if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                            {
                                                                                nilai_kd += Math.Round((item_rapor_struktur_nilai_kp.BobotNK / 100) * Libs.GetStringToDecimal(m_nilai_det.Nilai), 2, MidpointRounding.AwayFromZero);
                                                                            }
                                                                            else if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                            {
                                                                                jumlah_nilai_kd += Libs.GetStringToDecimal(m_nilai_det.Nilai);
                                                                            }
                                                                            count_kd++;
                                                                        }
                                                                        else
                                                                        {
                                                                            if (lst_kd.FindAll(m0 => m0.Kode.ToString().ToUpper().Trim() == item_rapor_struktur_nilai_kd.Rel_Rapor_KompetensiDasar.ToString().ToUpper().Trim()).Count > 0)
                                                                            {
                                                                                s_deskripsi_pengetahuan += (
                                                                                        s_deskripsi_pengetahuan.Trim() != "" &&
                                                                                        Libs.GetHTMLSimpleText2(lst_kd.FindAll(m0 => m0.Kode.ToString().ToUpper().Trim() == item_rapor_struktur_nilai_kd.Rel_Rapor_KompetensiDasar.ToString().ToUpper().Trim()).FirstOrDefault().Nama.Trim()).Trim() != ""
                                                                                        ? "; " 
                                                                                        : ""
                                                                                    ) +
                                                                                    Libs.GetHTMLSimpleText2(lst_kd.FindAll(m0 => m0.Kode.ToString().ToUpper().Trim() == item_rapor_struktur_nilai_kd.Rel_Rapor_KompetensiDasar.ToString().ToUpper().Trim()).FirstOrDefault().Nama.Trim()) +
                                                                                    GetPredikatDeskripsi("");
                                                                            }
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        if (lst_kd.FindAll(m0 => m0.Kode.ToString().ToUpper().Trim() == item_rapor_struktur_nilai_kd.Rel_Rapor_KompetensiDasar.ToString().ToUpper().Trim()).Count > 0)
                                                                        {
                                                                            s_deskripsi_pengetahuan += (s_deskripsi_pengetahuan.Trim() != "" ? "; " : "") +
                                                                                                       Libs.GetHTMLSimpleText2(lst_kd.FindAll(m0 => m0.Kode.ToString().ToUpper().Trim() == item_rapor_struktur_nilai_kd.Rel_Rapor_KompetensiDasar.ToString().ToUpper().Trim()).FirstOrDefault().Nama.Trim()) +
                                                                                                       GetPredikatDeskripsi("");
                                                                        }
                                                                    }
                                                                }

                                                            }

                                                            if (count_kd > 0)
                                                            {
                                                                if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_kd = Math.Round(jumlah_nilai_kd / count_kd, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_kd = 0;
                                                            }

                                                            //load nilai manual
                                                            Rapor_NilaiSiswa_AP_or_KD m_nilai_manual = DAO_Rapor_NilaiSiswa_AP_or_KD.GetAllByTABySMByKelasByMapelBySiswaByStruktur_Entity(
                                                                    tahun_ajaran, semester, rel_kelas_det, m_siswa.Kode.ToString(), item.Rel_Mapel,
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString().Trim().ToUpper()

                                                                ).FirstOrDefault();
                                                            if (m_nilai_manual != null)
                                                            {
                                                                if (m_nilai_manual.Nilai != null)
                                                                {
                                                                    nilai_kd = Libs.GetStringToDecimal(m_nilai_manual.Nilai);
                                                                }
                                                            }
                                                            //end load nilai manual

                                                            nilai_kd = Math.Round(nilai_kd, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);
                                                            lst_nilai_kd.Add(nilai_kd);
                                                            //end get struktur nilai det KP

                                                        }

                                                        //end get struktur nilai det KD

                                                        //get nilai ap
                                                        count_ap = 0;
                                                        nilai_ap = 0;
                                                        jumlah_nilai_ap = 0;
                                                        foreach (var item_nilai_kd in lst_nilai_kd)
                                                        {
                                                            if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                            {
                                                                nilai_ap += Math.Round((item_rapor_struktur_nilai_ap.BobotRapor / 100) * item_nilai_kd, 2, MidpointRounding.AwayFromZero);
                                                            }
                                                            else if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                jumlah_nilai_ap += item_nilai_kd;
                                                            }
                                                            count_ap++;
                                                        }
                                                        if (count_ap > 0)
                                                        {
                                                            if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                nilai_ap = Math.Round(jumlah_nilai_ap / count_ap, 2, MidpointRounding.AwayFromZero);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            nilai_ap = 0;
                                                        }
                                                        nilai_ap = Math.Round(nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                        lst_nilai_ap.Add(nilai_ap);
                                                        lst_nilai_ap_bobot.Add(item_rapor_struktur_nilai_ap.BobotRapor);
                                                        //end get nilai ap

                                                        m_sn_ap = item_rapor_struktur_nilai_ap;
                                                    }
                                                    //end get struktur nilai det AP

                                                    //get nilai rapor
                                                    nilai_rapor = 0;
                                                    jumlah_nilai_rapor = 0;
                                                    count_nilai_rapor = 0;
                                                    foreach (var item_nilai_ap in lst_nilai_ap)
                                                    {
                                                        if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                        {
                                                            nilai_rapor += Math.Round((lst_nilai_ap_bobot[Convert.ToInt16(count_nilai_rapor)] / 100) * item_nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                        }
                                                        else if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                        {
                                                            jumlah_nilai_rapor += item_nilai_ap;
                                                        }
                                                        count_nilai_rapor++;
                                                    }
                                                    if (count_nilai_rapor > 0)
                                                    {
                                                        if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                        {
                                                            nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                        }
                                                    }
                                                    else
                                                    {
                                                        nilai_rapor = 0;
                                                    }
                                                    nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);

                                                    //jika ada PAT atau UKK
                                                    if (m_sn_ap.IsAdaPAT_UKK)
                                                    {
                                                        Rapor_NilaiSiswa_Det m_nilai_det = lst_nilai_siswa_det.FindAll(
                                                                        m => m.Rel_Siswa.ToString().Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                             m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper() &&
                                                                             m.Rel_Rapor_StrukturNilai_AP.Trim().ToUpper() == (Constantas.SD.GetKode_NK_KD_UKKPAT(m_sn_ap.Kode.ToString())).ToString().ToUpper() &&
                                                                             m.Rel_Rapor_StrukturNilai_KD.Trim().ToUpper() == (Constantas.SD.GetKode_NK_KD_UKKPAT(m_sn_ap.Kode.ToString())).ToString().ToUpper() &&
                                                                             m.Rel_Rapor_StrukturNilai_KP.Trim().ToUpper() == (Constantas.SD.GetKode_NK_KD_UKKPAT(m_sn_ap.Kode.ToString())).ToString().ToUpper()
                                                                    ).FirstOrDefault();

                                                        string s_nilai_pat_ukk = "0";
                                                        if (m_nilai_det != null)
                                                        {
                                                            if (m_nilai_det.Nilai.Trim() != "")
                                                            {
                                                                rel_rapornilaisiswa = m_nilai_det.Rel_Rapor_NilaiSiswa.ToString();
                                                                s_nilai_pat_ukk = m_nilai_det.Nilai;
                                                            }
                                                        }

                                                        nilai_rapor = Math.Round(
                                                                        Libs.GetStringToDecimal(s_nilai_pat_ukk) * (m_sn_ap.Bobot_PAT_UKK / 100), 2
                                                                      ) +
                                                                        Math.Round(
                                                                        nilai_rapor * (m_sn_ap.Bobot_Non_PAT_UKK / 100), 2
                                                                      );

                                                        nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);
                                                    }
                                                    //jika ada PAT atau UKK

                                                    nilai_rapor_pengetahuan = nilai_rapor;

                                                    dt_tanggal_rapor = DateTime.Now;
                                                    if (m_rapor_arsip != null)
                                                    {
                                                        if (m_rapor_arsip.TahunAjaran != null)
                                                        {
                                                            dt_tanggal_rapor = m_rapor_arsip.TanggalRapor;
                                                        }
                                                    }

                                                    guru_kelas = "";
                                                    tanggal_rapor = Libs.GetTanggalIndonesiaFromDate(dt_tanggal_rapor, false);
                                                    m_guru_kelas = DAO_Rapor_LTS_MengetahuiGuruKelas.GetByTABySMByKelasDet_Entity(
                                                            tahun_ajaran, semester, rel_kelas_det
                                                        ).FirstOrDefault();
                                                    if (m_guru_kelas != null)
                                                    {
                                                        if (m_guru_kelas.NamaGuru != null)
                                                        {
                                                            guru_kelas = m_guru_kelas.NamaGuru;
                                                        }
                                                    }
                                                    //end get nilai rapor
                                                    //-----------end nilai pengetahuan---------------

                                                    //-----------nilai keterampilan---------------
                                                    //get struktur nilai det AP

                                                    //jika semester 2 get semester 1
                                                    if (semester == "2")
                                                    {
                                                        lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeaderByJenisAspekPenilaian_Entity(
                                                            m_struktur_nilai_sm1.Kode.ToString(), DAO_Rapor_StrukturNilai_AP.JenisAspekPenilaian.Keterampilan
                                                        );
                                                        lst_nilai_ap.Clear();
                                                        lst_nilai_ap_bobot.Clear();
                                                        jumlah_nilai_ap = 0;
                                                        nilai_ap = 0;
                                                        count_ap = 0;
                                                        m_sn_ap = new Rapor_StrukturNilai_AP();
                                                        foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                        {

                                                            //get struktur nilai det KD
                                                            List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                );
                                                            lst_nilai_kd.Clear();
                                                            foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                            {

                                                                //get struktur nilai det KP
                                                                List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                );
                                                                decimal jumlah_nilai_kd = 0;
                                                                decimal nilai_kd = 0;
                                                                int count_kd = 0;
                                                                foreach (var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp)
                                                                {
                                                                    Rapor_KomponenPenilaian m_kp = lst_kp.FindAll(m0 => m0.Kode.ToString().ToUpper().Trim() == item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString().ToUpper().Trim()).FirstOrDefault();

                                                                    if (m_kp != null)
                                                                    {

                                                                        Rapor_NilaiSiswa_Det m_nilai_det = lst_nilai_siswa_det_sm1.FindAll(
                                                                            m => m.Rel_Siswa.ToString().Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai_sm1.Rel_Mapel.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_AP.Trim().ToUpper() == item_rapor_struktur_nilai_ap.Kode.ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KD.Trim().ToUpper() == item_rapor_struktur_nilai_kd.Kode.ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KP.Trim().ToUpper() == item_rapor_struktur_nilai_kp.Kode.ToString().ToUpper()
                                                                        ).FirstOrDefault();

                                                                        if (m_nilai_det != null)
                                                                        {
                                                                            if (m_nilai_det.Nilai.Trim() != "")
                                                                            {
                                                                                rel_rapornilaisiswa = m_nilai_det.Rel_Rapor_NilaiSiswa.ToString();
                                                                                if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                                {
                                                                                    nilai_kd += Math.Round((item_rapor_struktur_nilai_kp.BobotNK / 100) * Libs.GetStringToDecimal(m_nilai_det.Nilai), 2, MidpointRounding.AwayFromZero);
                                                                                }
                                                                                else if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                                {
                                                                                    jumlah_nilai_kd += Libs.GetStringToDecimal(m_nilai_det.Nilai);
                                                                                }
                                                                                count_kd++;
                                                                            }
                                                                        }

                                                                    }

                                                                }

                                                                if (count_kd > 0)
                                                                {
                                                                    if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                    {
                                                                        nilai_kd = Math.Round(jumlah_nilai_kd / count_kd, 2, MidpointRounding.AwayFromZero);
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    nilai_kd = 0;
                                                                }

                                                                //load nilai manual
                                                                Rapor_NilaiSiswa_AP_or_KD m_nilai_manual = DAO_Rapor_NilaiSiswa_AP_or_KD.GetAllByTABySMByKelasByMapelBySiswaByStruktur_Entity(
                                                                        tahun_ajaran, semester, rel_kelas_det, m_siswa.Kode.ToString(), item.Rel_Mapel,
                                                                        item_rapor_struktur_nilai_kd.Kode.ToString().Trim().ToUpper()

                                                                    ).FirstOrDefault();
                                                                if (m_nilai_manual != null)
                                                                {
                                                                    if (m_nilai_manual.Nilai != null)
                                                                    {
                                                                        nilai_kd = Libs.GetStringToDecimal(m_nilai_manual.Nilai);
                                                                    }
                                                                }
                                                                //end load nilai manual

                                                                nilai_kd = Math.Round(nilai_kd, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);
                                                                lst_nilai_kd.Add(nilai_kd);
                                                                //end get struktur nilai det KP

                                                            }
                                                            //end get struktur nilai det KD

                                                            //get nilai ap
                                                            count_ap = 0;
                                                            nilai_ap = 0;
                                                            jumlah_nilai_ap = 0;
                                                            foreach (var item_nilai_kd in lst_nilai_kd)
                                                            {
                                                                if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                {
                                                                    nilai_ap += Math.Round((item_rapor_struktur_nilai_ap.BobotRapor / 100) * item_nilai_kd, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                                else if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    jumlah_nilai_ap += item_nilai_kd;
                                                                }
                                                                count_ap++;
                                                            }
                                                            if (count_ap > 0)
                                                            {
                                                                if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_ap = Math.Round(jumlah_nilai_ap / count_ap, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_ap = 0;
                                                            }
                                                            nilai_ap = Math.Round(nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                            lst_nilai_ap.Add(nilai_ap);
                                                            lst_nilai_ap_bobot.Add(item_rapor_struktur_nilai_ap.BobotRapor);
                                                            //end get nilai ap

                                                        }
                                                        //end get struktur nilai det AP

                                                        //get nilai rapor
                                                        nilai_rapor = 0;
                                                        jumlah_nilai_rapor = 0;
                                                        count_nilai_rapor = 0;
                                                        foreach (var item_nilai_ap in lst_nilai_ap)
                                                        {
                                                            if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                            {
                                                                nilai_rapor += Math.Round((lst_nilai_ap_bobot[Convert.ToInt16(count_nilai_rapor)] / 100) * item_nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                            }
                                                            else if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                jumlah_nilai_rapor += item_nilai_ap;
                                                            }
                                                            count_nilai_rapor++;
                                                        }
                                                        if (count_nilai_rapor > 0)
                                                        {
                                                            if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            nilai_rapor = 0;
                                                        }
                                                        nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);
                                                        nilai_rapor_keterampilan_sm1 = nilai_rapor;

                                                        if (m_rapor_arsip != null)
                                                        {
                                                            if (m_rapor_arsip.TahunAjaran != null)
                                                            {
                                                                dt_tanggal_rapor = m_rapor_arsip.TanggalRapor;
                                                            }
                                                        }

                                                        guru_kelas = "";
                                                        tanggal_rapor = Libs.GetTanggalIndonesiaFromDate(dt_tanggal_rapor, false);
                                                        m_guru_kelas = DAO_Rapor_LTS_MengetahuiGuruKelas.GetByTABySMByKelasDet_Entity(
                                                                tahun_ajaran, semester, rel_kelas_det
                                                            ).FirstOrDefault();
                                                        if (m_guru_kelas != null)
                                                        {
                                                            if (m_guru_kelas.NamaGuru != null)
                                                            {
                                                                guru_kelas = m_guru_kelas.NamaGuru;
                                                            }
                                                        }
                                                    }
                                                    //end jika semester 2 get semester 1

                                                    lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeaderByJenisAspekPenilaian_Entity(
                                                            m_struktur_nilai.Kode.ToString(), DAO_Rapor_StrukturNilai_AP.JenisAspekPenilaian.Keterampilan
                                                        );
                                                    lst_nilai_ap.Clear();
                                                    lst_nilai_ap_bobot.Clear();
                                                    jumlah_nilai_ap = 0;
                                                    nilai_ap = 0;
                                                    count_ap = 0;
                                                    m_sn_ap = new Rapor_StrukturNilai_AP();
                                                    foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                    {

                                                        //get struktur nilai det KD
                                                        List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                item_rapor_struktur_nilai_ap.Kode.ToString()
                                                            );
                                                        lst_nilai_kd.Clear();
                                                        foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                        {

                                                            //get struktur nilai det KP
                                                            List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                item_rapor_struktur_nilai_kd.Kode.ToString()
                                                            );
                                                            decimal jumlah_nilai_kd = 0;
                                                            decimal nilai_kd = 0;
                                                            int count_kd = 0;
                                                            foreach (var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp)
                                                            {
                                                                Rapor_KomponenPenilaian m_kp = lst_kp.FindAll(m0 => m0.Kode.ToString().ToUpper().Trim() == item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString().ToUpper().Trim()).FirstOrDefault();
                                                                if (m_kp != null)
                                                                {

                                                                    Rapor_NilaiSiswa_Det m_nilai_det = lst_nilai_siswa_det.FindAll(
                                                                        m => m.Rel_Siswa.ToString().Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                             m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper() &&
                                                                             m.Rel_Rapor_StrukturNilai_AP.Trim().ToUpper() == item_rapor_struktur_nilai_ap.Kode.ToString().ToUpper() &&
                                                                             m.Rel_Rapor_StrukturNilai_KD.Trim().ToUpper() == item_rapor_struktur_nilai_kd.Kode.ToString().ToUpper() &&
                                                                             m.Rel_Rapor_StrukturNilai_KP.Trim().ToUpper() == item_rapor_struktur_nilai_kp.Kode.ToString().ToUpper()
                                                                    ).FirstOrDefault();

                                                                    if (m_nilai_det != null)
                                                                    {
                                                                        if (m_nilai_det.Nilai.Trim() != "")
                                                                        {
                                                                            rel_rapornilaisiswa = m_nilai_det.Rel_Rapor_NilaiSiswa.ToString();
                                                                            if (lst_kd.FindAll(m0 => m0.Kode.ToString().ToUpper().Trim() == item_rapor_struktur_nilai_kd.Rel_Rapor_KompetensiDasar.ToString().ToUpper().Trim()).Count > 0)
                                                                            {
                                                                                s_deskripsi_keterampilan += (s_deskripsi_keterampilan.Trim() != "" ? "; " : "") +
                                                                                                           Libs.GetHTMLSimpleText2(lst_kd.FindAll(m0 => m0.Kode.ToString().ToUpper().Trim() == item_rapor_struktur_nilai_kd.Rel_Rapor_KompetensiDasar.ToString().ToUpper().Trim()).FirstOrDefault().Nama.Trim()) +
                                                                                                           GetPredikatDeskripsi(m_nilai_det.Nilai);
                                                                            }

                                                                            if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                            {
                                                                                nilai_kd += Math.Round((item_rapor_struktur_nilai_kp.BobotNK / 100) * Libs.GetStringToDecimal(m_nilai_det.Nilai), 2, MidpointRounding.AwayFromZero);
                                                                            }
                                                                            else if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                            {
                                                                                jumlah_nilai_kd += Libs.GetStringToDecimal(m_nilai_det.Nilai);
                                                                            }
                                                                            count_kd++;
                                                                        }
                                                                        else
                                                                        {
                                                                            if (lst_kd.FindAll(m0 => m0.Kode.ToString().ToUpper().Trim() == item_rapor_struktur_nilai_kd.Rel_Rapor_KompetensiDasar.ToString().ToUpper().Trim()).Count > 0)
                                                                            {
                                                                                s_deskripsi_keterampilan += (s_deskripsi_keterampilan.Trim() != "" ? "; " : "") +
                                                                                                           Libs.GetHTMLSimpleText2(lst_kd.FindAll(m0 => m0.Kode.ToString().ToUpper().Trim() == item_rapor_struktur_nilai_kd.Rel_Rapor_KompetensiDasar.ToString().ToUpper().Trim()).FirstOrDefault().Nama.Trim()) +
                                                                                                           GetPredikatDeskripsi("");
                                                                            }
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        if (lst_kd.FindAll(m0 => m0.Kode.ToString().ToUpper().Trim() == item_rapor_struktur_nilai_kd.Rel_Rapor_KompetensiDasar.ToString().ToUpper().Trim()).Count > 0)
                                                                        {
                                                                            s_deskripsi_keterampilan += (s_deskripsi_keterampilan.Trim() != "" ? "; " : "") +
                                                                                                       Libs.GetHTMLSimpleText2(lst_kd.FindAll(m0 => m0.Kode.ToString().ToUpper().Trim() == item_rapor_struktur_nilai_kd.Rel_Rapor_KompetensiDasar.ToString().ToUpper().Trim()).FirstOrDefault().Nama.Trim()) +
                                                                                                       GetPredikatDeskripsi("");
                                                                        }
                                                                    }
                                                                }

                                                            }

                                                            if (count_kd > 0)
                                                            {
                                                                if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_kd = Math.Round(jumlah_nilai_kd / count_kd, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_kd = 0;
                                                            }

                                                            //load nilai manual
                                                            Rapor_NilaiSiswa_AP_or_KD m_nilai_manual = DAO_Rapor_NilaiSiswa_AP_or_KD.GetAllByTABySMByKelasByMapelBySiswaByStruktur_Entity(
                                                                    tahun_ajaran, semester, rel_kelas_det, m_siswa.Kode.ToString(), item.Rel_Mapel,
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString().Trim().ToUpper()

                                                                ).FirstOrDefault();
                                                            if (m_nilai_manual != null)
                                                            {
                                                                if (m_nilai_manual.Nilai != null)
                                                                {
                                                                    nilai_kd = Libs.GetStringToDecimal(m_nilai_manual.Nilai);
                                                                }
                                                            }
                                                            //end load nilai manual

                                                            nilai_kd = Math.Round(nilai_kd, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);
                                                            lst_nilai_kd.Add(nilai_kd);
                                                            //end get struktur nilai det KP

                                                        }
                                                        //end get struktur nilai det KD

                                                        //get nilai ap
                                                        count_ap = 0;
                                                        nilai_ap = 0;
                                                        jumlah_nilai_ap = 0;
                                                        foreach (var item_nilai_kd in lst_nilai_kd)
                                                        {
                                                            if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                            {
                                                                nilai_ap += Math.Round((item_rapor_struktur_nilai_ap.BobotRapor / 100) * item_nilai_kd, 2, MidpointRounding.AwayFromZero);
                                                            }
                                                            else if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                jumlah_nilai_ap += item_nilai_kd;
                                                            }
                                                            count_ap++;
                                                        }
                                                        if (count_ap > 0)
                                                        {
                                                            if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                nilai_ap = Math.Round(jumlah_nilai_ap / count_ap, 2, MidpointRounding.AwayFromZero);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            nilai_ap = 0;
                                                        }
                                                        nilai_ap = Math.Round(nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                        lst_nilai_ap.Add(nilai_ap);
                                                        lst_nilai_ap_bobot.Add(item_rapor_struktur_nilai_ap.BobotRapor);
                                                        //end get nilai ap

                                                        //get nilai rapor
                                                        nilai_rapor = 0;
                                                        jumlah_nilai_rapor = 0;
                                                        count_nilai_rapor = 0;
                                                        foreach (var item_nilai_ap in lst_nilai_ap)
                                                        {
                                                            if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                            {
                                                                nilai_rapor += Math.Round((lst_nilai_ap_bobot[Convert.ToInt16(count_nilai_rapor)] / 100) * item_nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                            }
                                                            else if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                jumlah_nilai_rapor += item_nilai_ap;
                                                            }
                                                            count_nilai_rapor++;
                                                        }
                                                        if (count_nilai_rapor > 0)
                                                        {
                                                            if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            nilai_rapor = 0;
                                                        }
                                                        nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);

                                                        //jika ada PAT atau UKK
                                                        if (m_sn_ap.IsAdaPAT_UKK)
                                                        {
                                                            Rapor_NilaiSiswa_Det m_nilai_det = lst_nilai_siswa_det.FindAll(
                                                                            m => m.Rel_Siswa.ToString().Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_AP.Trim().ToUpper() == (Constantas.SD.GetKode_NK_KD_UKKPAT(m_sn_ap.Kode.ToString())).ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KD.Trim().ToUpper() == (Constantas.SD.GetKode_NK_KD_UKKPAT(m_sn_ap.Kode.ToString())).ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KP.Trim().ToUpper() == (Constantas.SD.GetKode_NK_KD_UKKPAT(m_sn_ap.Kode.ToString())).ToString().ToUpper()
                                                                        ).FirstOrDefault();

                                                            string s_nilai_pat_ukk = "0";
                                                            if (m_nilai_det != null)
                                                            {
                                                                if (m_nilai_det.Nilai.Trim() != "")
                                                                {
                                                                    rel_rapornilaisiswa = m_nilai_det.Rel_Rapor_NilaiSiswa.ToString();
                                                                    s_nilai_pat_ukk = m_nilai_det.Nilai;
                                                                }
                                                            }

                                                            nilai_rapor = Math.Round(
                                                                            Libs.GetStringToDecimal(s_nilai_pat_ukk) * (m_sn_ap.Bobot_PAT_UKK / 100), 2
                                                                          ) +
                                                                            Math.Round(
                                                                            nilai_rapor * (m_sn_ap.Bobot_Non_PAT_UKK / 100), 2
                                                                          );

                                                            nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);
                                                        }
                                                        //jika ada PAT atau UKK

                                                        nilai_rapor_keterampilan = nilai_rapor;
                                                        //-----------end nilai keterampilan---------------

                                                        m_sn_ap = item_rapor_struktur_nilai_ap;
                                                    }
                                                    //end get struktur nilai det AP

                                                    nilai_rata2_sm1_sm2 =
                                                        Math.Round(
                                                            (
                                                                nilai_rapor_pengetahuan +
                                                                nilai_rapor_keterampilan +
                                                                nilai_rapor_pengetahuan_sm1 +
                                                                nilai_rapor_keterampilan_sm1
                                                            ) / 4,
                                                            0,
                                                            MidpointRounding.AwayFromZero
                                                        );
                                                    nilai_rata2_pengetahuan_sm1_sm2 = Math.Round(
                                                            (
                                                                nilai_rapor_pengetahuan +
                                                                nilai_rapor_pengetahuan_sm1
                                                            ) / 2,
                                                            0,
                                                            MidpointRounding.AwayFromZero
                                                        );
                                                    nilai_rata2_keterampilan_sm1_sm2 = Math.Round(
                                                            (
                                                                nilai_rapor_keterampilan +
                                                                nilai_rapor_keterampilan_sm1
                                                            ) / 2,
                                                            0,
                                                            MidpointRounding.AwayFromZero
                                                        );

                                                    
                                                    //pengetahuan
                                                    hasil.Add(new KURTILAS_RaporNilai
                                                    {
                                                        IDSiswa = m_siswa.Nama.Trim().ToUpper() + "_" + m_siswa.Kode.ToString(),
                                                        TahunAjaran = tahun_ajaran,
                                                        Semester = semester,
                                                        NIS = m_siswa.NISSekolah,
                                                        NISN = m_siswa.NISN,
                                                        Nama = Libs.GetPerbaikiEjaanNama(m_siswa.Nama.ToString()),
                                                        Kelas = s_kelas,
                                                        NilaiPengetahuan = nilai_rapor_pengetahuan,
                                                        NilaiKeterampilan = nilai_rapor_keterampilan,
                                                        NamaMapel = (item.Poin.Trim() != "" ? item.Poin.Trim() + "   " : "") + item.NamaMapelRapor,
                                                        KKM = Math.Round(m_struktur_nilai.KKM, 0),
                                                        GuruKelas = s_walikelas,
                                                        KepalaSekolah = m_rapor_arsip.KepalaSekolah,
                                                        NilaiRataRataSM1SM2 = nilai_rata2_sm1_sm2,
                                                        PengetahuanRataRataSM1SM2 = nilai_rata2_pengetahuan_sm1_sm2.ToString(),
                                                        KeterampilanRataRataSM1SM2 = nilai_rata2_keterampilan_sm1_sm2.ToString(),
                                                        TanggalRapor = tanggal_rapor,
                                                        JenisNilai = "PENGETAHUAN",
                                                        Deskripsi = s_deskripsi_pengetahuan.Replace("<p>", "").Replace("</p>", ""),
                                                        Nilai = Math.Round(nilai_rapor_pengetahuan, 0),
                                                        Predikat = "",
                                                        NomorMapel = item.Nomor,
                                                        TTDGuru = img_ttd_guru,
                                                        TTDKepsek = null,
                                                        QRCode = qr_code,
                                                        StatusKenaikanKelas = (is_naik_kelas ? "1" : "0"),
                                                        StatusKenaikanKelasKeKelas = naik_ke_kelas
                                                    });
                                                    //end pengetahuan

                                                    //keterampilan
                                                    hasil.Add(new KURTILAS_RaporNilai
                                                    {
                                                        IDSiswa = m_siswa.Nama.Trim().ToUpper() + "_" + m_siswa.Kode.ToString(),
                                                        TahunAjaran = tahun_ajaran,
                                                        Semester = semester,
                                                        NIS = m_siswa.NISSekolah,
                                                        NISN = m_siswa.NISN,
                                                        Nama = Libs.GetPerbaikiEjaanNama(m_siswa.Nama.ToString()),
                                                        Kelas = s_kelas,
                                                        NilaiPengetahuan = nilai_rapor_pengetahuan,
                                                        NilaiKeterampilan = nilai_rapor_keterampilan,
                                                        NamaMapel = (item.Poin.Trim() != "" ? item.Poin.Trim() + "   " : "") + item.NamaMapelRapor,
                                                        KKM = Math.Round(m_struktur_nilai.KKM, 0),
                                                        GuruKelas = s_walikelas,
                                                        KepalaSekolah = m_rapor_arsip.KepalaSekolah,
                                                        NilaiRataRataSM1SM2 = nilai_rata2_sm1_sm2,
                                                        PengetahuanRataRataSM1SM2 = nilai_rata2_pengetahuan_sm1_sm2.ToString(),
                                                        KeterampilanRataRataSM1SM2 = nilai_rata2_keterampilan_sm1_sm2.ToString(),
                                                        TanggalRapor = tanggal_rapor,
                                                        JenisNilai = "KETERAMPILAN",
                                                        Deskripsi = s_deskripsi_keterampilan.Replace("<p>", "").Replace("</p>", ""),
                                                        Nilai = Math.Round(nilai_rapor_keterampilan, 0),
                                                        Predikat = "",
                                                        NomorMapel = item.Nomor,
                                                        TTDGuru = img_ttd_guru,
                                                        TTDKepsek = null,
                                                        QRCode = qr_code,
                                                        StatusKenaikanKelas = (is_naik_kelas ? "1" : "0"),
                                                        StatusKenaikanKelasKeKelas = naik_ke_kelas
                                                    });
                                                    //end keterampilan

                                                    //get nilai rapor
                                                    nilai_rapor = 0;
                                                    jumlah_nilai_rapor = 0;
                                                    count_nilai_rapor = 0;
                                                    foreach (var item_nilai_ap in lst_nilai_ap)
                                                    {
                                                        if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                        {
                                                            nilai_rapor += Math.Round((lst_nilai_ap_bobot[Convert.ToInt16(count_nilai_rapor)] / 100) * item_nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                        }
                                                        else if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                        {
                                                            jumlah_nilai_rapor += item_nilai_ap;
                                                        }
                                                        count_nilai_rapor++;
                                                    }
                                                    if (count_nilai_rapor > 0)
                                                    {
                                                        if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                        {
                                                            nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                        }
                                                    }
                                                    else
                                                    {
                                                        nilai_rapor = 0;
                                                    }
                                                    nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);
                                                    nilai_rapor_keterampilan = nilai_rapor;
                                                    //end get nilai rapor
                                                }
                                            }
                                            //end get struktur nilai
                                        }
                                        else
                                        {
                                            //pengetahuan
                                            hasil.Add(new KURTILAS_RaporNilai
                                            {
                                                IDSiswa = m_siswa.Nama.Trim().ToUpper() + "_" + m_siswa.Kode.ToString(),
                                                TahunAjaran = tahun_ajaran,
                                                Semester = semester,
                                                NIS = m_siswa.NISSekolah,
                                                NISN = m_siswa.NISN,
                                                Nama = Libs.GetPerbaikiEjaanNama(m_siswa.Nama.ToString()),
                                                Kelas = s_kelas,
                                                NilaiPengetahuan = 0,
                                                NilaiKeterampilan = 0,
                                                NamaMapel = (item.Poin.Trim() != "" ? item.Poin.Trim() + "   " : "") + item.NamaMapelRapor,
                                                KKM = 70,
                                                GuruKelas = s_walikelas,
                                                KepalaSekolah = m_rapor_arsip.KepalaSekolah,
                                                NilaiRataRataSM1SM2 = 0,
                                                PengetahuanRataRataSM1SM2 = "",
                                                KeterampilanRataRataSM1SM2 = "",
                                                TanggalRapor = tanggal_rapor,
                                                JenisNilai = "PENGETAHUAN",
                                                Deskripsi = "",
                                                Nilai = 0,
                                                Predikat = "",
                                                NomorMapel = item.Nomor,
                                                TTDGuru = img_ttd_guru,
                                                TTDKepsek = null,
                                                QRCode = qr_code,
                                                StatusKenaikanKelas = (is_naik_kelas ? "1" : "0"),
                                                StatusKenaikanKelasKeKelas = naik_ke_kelas
                                            });
                                            //end pengetahuan

                                            //keterampilan
                                            hasil.Add(new KURTILAS_RaporNilai
                                            {
                                                IDSiswa = m_siswa.Nama.Trim().ToUpper() + "_" + m_siswa.Kode.ToString(),
                                                TahunAjaran = tahun_ajaran,
                                                Semester = semester,
                                                NIS = m_siswa.NISSekolah,
                                                NISN = m_siswa.NISN,
                                                Nama = Libs.GetPerbaikiEjaanNama(m_siswa.Nama.ToString()),
                                                Kelas = s_kelas,
                                                NilaiPengetahuan = 0,
                                                NilaiKeterampilan = 0,
                                                NamaMapel = (item.Poin.Trim() != "" ? item.Poin.Trim() + "   " : "") + item.NamaMapelRapor,
                                                KKM = 70,
                                                GuruKelas = s_walikelas,
                                                KepalaSekolah = m_rapor_arsip.KepalaSekolah,
                                                NilaiRataRataSM1SM2 = 0,
                                                PengetahuanRataRataSM1SM2 = "",
                                                KeterampilanRataRataSM1SM2 = "",
                                                TanggalRapor = tanggal_rapor,
                                                JenisNilai = "KETERAMPILAN",
                                                Deskripsi = "",
                                                Nilai = 0,
                                                Predikat = "",
                                                NomorMapel = item.Nomor,
                                                TTDGuru = img_ttd_guru,
                                                TTDKepsek = null,
                                                QRCode = qr_code,
                                                StatusKenaikanKelas = (is_naik_kelas ? "1" : "0"),
                                                StatusKenaikanKelasKeKelas = naik_ke_kelas
                                            });
                                            //end keterampilan
                                        }
                                        
                                        //capaian kedisiplinan
                                        Rapor_NilaiSiswa m_nilaisiswa = lst_nilaisiswa.FindAll(
                                                    m0 => m0.Kode.ToString().ToUpper().Trim() == rel_rapornilaisiswa.ToUpper().Trim()
                                                ).FirstOrDefault();
                                        bool ada_nilai = false;
                                        RaporLTSCapaianKedisiplinan m_rapor_capaian_kedisiplinan = new RaporLTSCapaianKedisiplinan();

                                        if (m_nilaisiswa != null)
                                        {
                                            if (m_nilaisiswa.Rel_Siswa != null)
                                            {
                                                ada_nilai = true;

                                                if (AI_ERP.Application_Libs.Reports_SD.ReportLibs.IsTematik(item.NamaMapelRapor))
                                                {
                                                    if (!ada_tematik)
                                                    {
                                                        urut_mapel++;
                                                        nomor_mapel++;
                                                        ada_tematik = true;

                                                        m_rapor_capaian_kedisiplinan.Rel_Siswa = m_siswa.Nama.Trim().ToUpper() + "_" + m_siswa.Kode.ToString();
                                                        m_rapor_capaian_kedisiplinan.KodeKelompokMapel = "";
                                                        m_rapor_capaian_kedisiplinan.KelompokMapel = "tematik";
                                                        m_rapor_capaian_kedisiplinan.NomorMapel = nomor_mapel.ToString();
                                                        m_rapor_capaian_kedisiplinan.Rel_Mapel = "";
                                                        m_rapor_capaian_kedisiplinan.NamaMapel = "Tematik:";
                                                        m_rapor_capaian_kedisiplinan.Kehadiran = "";
                                                        m_rapor_capaian_kedisiplinan.KetepatanWaktu = "";
                                                        m_rapor_capaian_kedisiplinan.PenggunaanSeragam = "";
                                                        m_rapor_capaian_kedisiplinan.PenggunaanKamera = "";
                                                        m_rapor_capaian_kedisiplinan.UrutanMapel = urut_mapel;
                                                        //HasilCapaianKedisiplinan.Add(m_rapor_lts_capaian_kedisiplinan);
                                                        ListRaporLTSCapaianKedisiplinan.Add(m_rapor_capaian_kedisiplinan);
                                                    }

                                                    jumlah_tematik++;
                                                    urut_mapel++;

                                                    m_rapor_capaian_kedisiplinan = new RaporLTSCapaianKedisiplinan();
                                                    m_rapor_capaian_kedisiplinan.Rel_Siswa = m_siswa.Nama.Trim().ToUpper() + "_" + m_siswa.Kode.ToString();
                                                    m_rapor_capaian_kedisiplinan.KodeKelompokMapel = "";
                                                    m_rapor_capaian_kedisiplinan.KelompokMapel = "tematik";
                                                    m_rapor_capaian_kedisiplinan.NomorMapel = "";
                                                    m_rapor_capaian_kedisiplinan.Rel_Mapel = item.Rel_Mapel;
                                                    m_rapor_capaian_kedisiplinan.NamaMapel = (
                                                                                                    jumlah_tematik <= Application_Libs.Constantas.ALFABET.Length
                                                                                                    ? Application_Libs.Constantas.ALFABET.ToLower().Substring(jumlah_tematik - 1, 1) + ". "
                                                                                                    : ""
                                                                                                 ) + item.NamaMapelRapor;
                                                    if (tahun_ajaran == "2020/2021" && semester == "2")
                                                    {
                                                        m_rapor_capaian_kedisiplinan.Kehadiran = m_nilaisiswa.LTS_CK_KEHADIRAN;
                                                        m_rapor_capaian_kedisiplinan.KetepatanWaktu = m_nilaisiswa.LTS_CK_KETEPATAN_WKT;
                                                        m_rapor_capaian_kedisiplinan.PenggunaanSeragam = m_nilaisiswa.LTS_CK_PENGGUNAAN_SRGM;
                                                        m_rapor_capaian_kedisiplinan.PenggunaanKamera = m_nilaisiswa.LTS_CK_PENGGUNAAN_KMR;
                                                    }
                                                    else
                                                    {
                                                        m_rapor_capaian_kedisiplinan.Kehadiran = m_nilaisiswa.SM_CK_KEHADIRAN;
                                                        m_rapor_capaian_kedisiplinan.KetepatanWaktu = m_nilaisiswa.SM_CK_KETEPATAN_WKT;
                                                        m_rapor_capaian_kedisiplinan.PenggunaanSeragam = m_nilaisiswa.SM_CK_PENGGUNAAN_SRGM;
                                                        m_rapor_capaian_kedisiplinan.PenggunaanKamera = m_nilaisiswa.SM_CK_PENGGUNAAN_KMR;
                                                    }
                                                    m_rapor_capaian_kedisiplinan.UrutanMapel = urut_mapel;
                                                    //HasilCapaianKedisiplinan.Add(m_rapor_lts_capaian_kedisiplinan);
                                                    ListRaporLTSCapaianKedisiplinan.Add(m_rapor_capaian_kedisiplinan);
                                                }
                                                else
                                                {
                                                    urut_mapel++;
                                                    if (item.Poin.Trim() == "") nomor_mapel++;

                                                    m_rapor_capaian_kedisiplinan.Rel_Siswa = m_siswa.Nama.Trim().ToUpper() + "_" + m_siswa.Kode.ToString();
                                                    m_rapor_capaian_kedisiplinan.KodeKelompokMapel = "";
                                                    m_rapor_capaian_kedisiplinan.KelompokMapel = "";
                                                    m_rapor_capaian_kedisiplinan.NomorMapel = (item.Poin.Trim() != "" ? "" : nomor_mapel.ToString());
                                                    m_rapor_capaian_kedisiplinan.Rel_Mapel = item.Rel_Mapel;
                                                    m_rapor_capaian_kedisiplinan.NamaMapel = (item.Poin.Trim() != "" ? item.Poin + " " : "") + item.NamaMapelRapor;
                                                    if (tahun_ajaran == "2020/2021" && semester == "2")
                                                    {
                                                        m_rapor_capaian_kedisiplinan.Kehadiran = m_nilaisiswa.LTS_CK_KEHADIRAN;
                                                        m_rapor_capaian_kedisiplinan.KetepatanWaktu = m_nilaisiswa.LTS_CK_KETEPATAN_WKT;
                                                        m_rapor_capaian_kedisiplinan.PenggunaanSeragam = m_nilaisiswa.LTS_CK_PENGGUNAAN_SRGM;
                                                        m_rapor_capaian_kedisiplinan.PenggunaanKamera = m_nilaisiswa.LTS_CK_PENGGUNAAN_KMR;
                                                    }
                                                    else
                                                    {
                                                        m_rapor_capaian_kedisiplinan.Kehadiran = m_nilaisiswa.SM_CK_KEHADIRAN;
                                                        m_rapor_capaian_kedisiplinan.KetepatanWaktu = m_nilaisiswa.SM_CK_KETEPATAN_WKT;
                                                        m_rapor_capaian_kedisiplinan.PenggunaanSeragam = m_nilaisiswa.SM_CK_PENGGUNAAN_SRGM;
                                                        m_rapor_capaian_kedisiplinan.PenggunaanKamera = m_nilaisiswa.SM_CK_PENGGUNAAN_KMR;
                                                    }
                                                    m_rapor_capaian_kedisiplinan.UrutanMapel = urut_mapel;
                                                    //HasilCapaianKedisiplinan.Add(m_rapor_lts_capaian_kedisiplinan);
                                                    ListRaporLTSCapaianKedisiplinan.Add(m_rapor_capaian_kedisiplinan);
                                                }
                                            }
                                        }
                                        if (!ada_nilai)
                                        {
                                            ada_nilai = true;

                                            if (AI_ERP.Application_Libs.Reports_SD.ReportLibs.IsTematik(item.NamaMapelRapor))
                                            {
                                                if (!ada_tematik)
                                                {
                                                    urut_mapel++;
                                                    nomor_mapel++;
                                                    ada_tematik = true;

                                                    m_rapor_capaian_kedisiplinan.Rel_Siswa = m_siswa.Nama.Trim().ToUpper() + "_" + m_siswa.Kode.ToString();
                                                    m_rapor_capaian_kedisiplinan.KodeKelompokMapel = "";
                                                    m_rapor_capaian_kedisiplinan.KelompokMapel = "tematik";
                                                    m_rapor_capaian_kedisiplinan.NomorMapel = nomor_mapel.ToString();
                                                    m_rapor_capaian_kedisiplinan.Rel_Mapel = "";
                                                    m_rapor_capaian_kedisiplinan.NamaMapel = "Tematik:";
                                                    m_rapor_capaian_kedisiplinan.Kehadiran = "";
                                                    m_rapor_capaian_kedisiplinan.KetepatanWaktu = "";
                                                    m_rapor_capaian_kedisiplinan.PenggunaanSeragam = "";
                                                    m_rapor_capaian_kedisiplinan.PenggunaanKamera = "";
                                                    m_rapor_capaian_kedisiplinan.UrutanMapel = urut_mapel;
                                                    //HasilCapaianKedisiplinan.Add(m_rapor_lts_capaian_kedisiplinan);
                                                    ListRaporLTSCapaianKedisiplinan.Add(m_rapor_capaian_kedisiplinan);
                                                }

                                                jumlah_tematik++;
                                                urut_mapel++;

                                                m_rapor_capaian_kedisiplinan = new RaporLTSCapaianKedisiplinan();
                                                m_rapor_capaian_kedisiplinan.Rel_Siswa = m_siswa.Nama.Trim().ToUpper() + "_" + m_siswa.Kode.ToString();
                                                m_rapor_capaian_kedisiplinan.KodeKelompokMapel = "";
                                                m_rapor_capaian_kedisiplinan.KelompokMapel = "tematik";
                                                m_rapor_capaian_kedisiplinan.NomorMapel = "";
                                                m_rapor_capaian_kedisiplinan.Rel_Mapel = item.Rel_Mapel;
                                                m_rapor_capaian_kedisiplinan.NamaMapel = (
                                                                                                jumlah_tematik <= Application_Libs.Constantas.ALFABET.Length
                                                                                                ? Application_Libs.Constantas.ALFABET.ToLower().Substring(jumlah_tematik - 1, 1) + ". "
                                                                                                : ""
                                                                                             ) + item.NamaMapelRapor;
                                                m_rapor_capaian_kedisiplinan.Kehadiran = "";
                                                m_rapor_capaian_kedisiplinan.KetepatanWaktu = "";
                                                m_rapor_capaian_kedisiplinan.PenggunaanSeragam = "";
                                                m_rapor_capaian_kedisiplinan.PenggunaanKamera = "";
                                                m_rapor_capaian_kedisiplinan.UrutanMapel = urut_mapel;
                                                //HasilCapaianKedisiplinan.Add(m_rapor_lts_capaian_kedisiplinan);
                                                ListRaporLTSCapaianKedisiplinan.Add(m_rapor_capaian_kedisiplinan);
                                            }
                                            else
                                            {
                                                urut_mapel++;
                                                if (item.Poin.Trim() == "") nomor_mapel++;

                                                m_rapor_capaian_kedisiplinan.Rel_Siswa = m_siswa.Nama.Trim().ToUpper() + "_" + m_siswa.Kode.ToString();
                                                m_rapor_capaian_kedisiplinan.KodeKelompokMapel = "";
                                                m_rapor_capaian_kedisiplinan.KelompokMapel = "";
                                                m_rapor_capaian_kedisiplinan.NomorMapel = (item.Poin.Trim() != "" ? "" : nomor_mapel.ToString());
                                                m_rapor_capaian_kedisiplinan.Rel_Mapel = item.Rel_Mapel;
                                                m_rapor_capaian_kedisiplinan.NamaMapel = (item.Poin.Trim() != "" ? item.Poin + " " : "") +
                                                                                             (
                                                                                                item.Rel_Mapel.Trim() == ""
                                                                                                ? item.NamaMapelRapor.Replace(":", "") + ":"
                                                                                                : item.NamaMapelRapor
                                                                                             );
                                                m_rapor_capaian_kedisiplinan.Kehadiran = "";
                                                m_rapor_capaian_kedisiplinan.KetepatanWaktu = "";
                                                m_rapor_capaian_kedisiplinan.PenggunaanSeragam = "";
                                                m_rapor_capaian_kedisiplinan.PenggunaanKamera = "";
                                                m_rapor_capaian_kedisiplinan.UrutanMapel = urut_mapel;
                                                //HasilCapaianKedisiplinan.Add(m_rapor_lts_capaian_kedisiplinan);
                                                ListRaporLTSCapaianKedisiplinan.Add(m_rapor_capaian_kedisiplinan);
                                            }
                                        }
                                        //end capaian kedisiplinan

                                        //hasil.FindAll(
                                        //        m0 => m0.IDSiswa == m_siswa.Nama.Trim().ToUpper() + "_" + m_siswa.Kode.ToString() &&
                                        //              m0.JenisNilai == "PENGETAHUAN" &&
                                        //              m0.NamaMapel == (item.Poin.Trim() != "" ? item.Poin.Trim() + "   " : "") + item.NamaMapelRapor
                                        //    ).ForEach(m => m.HasilCapaianKedisiplinan = HasilCapaianKedisiplinan);
                                        //hasil.FindAll(
                                        //        m0 => m0.IDSiswa == m_siswa.Nama.Trim().ToUpper() + "_" + m_siswa.Kode.ToString() &&
                                        //              m0.JenisNilai == "KETERAMPILAN" &&
                                        //              m0.NamaMapel == (item.Poin.Trim() != "" ? item.Poin.Trim() + "   " : "") + item.NamaMapelRapor
                                        //    ).ForEach(m => m.HasilCapaianKedisiplinan = HasilCapaianKedisiplinan);
                                    }
                                    //end rapor non mulok
                                }
                                // end foreach siswa

                            }

                        }
                    }

                }
            }

            return hasil;
        }

        public static List<KURTILAS_RaporMulok> GetNilaiMulok_KURTILAS(
            string tahun_ajaran,
            string semester,
            string rel_kelas_det,
            string rel_siswa = ""
        )
        {
            List<KURTILAS_RaporMulok> hasil = new List<KURTILAS_RaporMulok>();
            Rapor_Arsip m_rapor_arsip = DAO_Rapor_Arsip.GetAll_Entity().FindAll(
                m0 => m0.TahunAjaran == tahun_ajaran &&
                        m0.Semester == semester &&
                        m0.JenisRapor == "Semester"

            ).FirstOrDefault();

            KelasDet m_kelas_det = DAO_KelasDet.GetByID_Entity(rel_kelas_det);
            if (m_kelas_det != null)
            {
                if (m_kelas_det.Nama != null)
                {

                    Kelas m_kelas = DAO_Kelas.GetByID_Entity(m_kelas_det.Rel_Kelas.ToString());
                    if (m_kelas != null)
                    {
                        if (m_kelas.Nama != null)
                        {

                            Rapor_Desain rapor_desain = DAO_Rapor_Desain.GetByTABySMByKelas_Entity(
                                    tahun_ajaran, semester, rel_kelas_det, DAO_Rapor_Desain.JenisRapor.Semester
                                ).FirstOrDefault();

                            List<Rapor_Desain_Det> lst_rapor_desain_det = DAO_Rapor_Desain_Det.GetAllByHeader_Entity(rapor_desain.Kode.ToString()).FindAll(m => m.Nomor.Trim() != "" && m.Rel_Mapel.Trim() != "");

                            //list cols header
                            if (rapor_desain != null)
                            {

                                List<DAO_Siswa.SiswaDataSimple> lst_siswa = DAO_Siswa.GetAllSiswaDataSimpleByTahunAjaranUnitKelas_Entity(
                                        m_kelas.Rel_Sekolah.ToString(),
                                        rel_kelas_det,
                                        tahun_ajaran,
                                        semester
                                    );
                                List<decimal> lst_nilai_ap = new List<decimal>();
                                List<decimal> lst_nilai_ap_bobot = new List<decimal>(); 
                                List<decimal> lst_nilai_kd = new List<decimal>();
                                List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT> lst_nilai_siswa_det = new List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT>();
                                List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT> lst_nilai_siswa_det_by_periode = new List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT>();
                                List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT> lst_nilai_siswa_det_sm1 = new List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT>();
                                List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT> lst_nilai_siswa_det_by_periode_sm1 = new List<DAO_Rapor_NilaiSiswa_Det.Rapor_NilaiSiswa_Det_EXT>();

                                lst_nilai_siswa_det_by_periode_sm1 = DAO_Rapor_NilaiSiswa_Det.GetAllByTABySMByKelasDet_Entity(
                                        tahun_ajaran, "1", rel_kelas_det
                                    );
                                lst_nilai_siswa_det_by_periode = DAO_Rapor_NilaiSiswa_Det.GetAllByTABySMByKelasDet_Entity(
                                        tahun_ajaran, semester, rel_kelas_det
                                    );                                

                                int nomor = 1;
                                if (rel_siswa.Trim() != "")
                                {
                                    lst_siswa = lst_siswa.FindAll(m0 => (rel_siswa + ";").Trim().ToUpper().IndexOf(m0.Kode.ToString().ToUpper() + ";") >= 0).ToList();
                                }
                                List<NilaiWithKey> lst_nilai_rapor = new List<NilaiWithKey>();
                                
                                foreach (DAO_Siswa.SiswaDataSimple m_siswa in lst_siswa.OrderBy(m => m.Nama))
                                {
                                    //rapor mulok
                                    lst_rapor_desain_det = DAO_Rapor_Desain_Det.GetAllByHeader_Entity(rapor_desain.Kode.ToString()).FindAll(m => m.Nomor.Trim() == "" && m.Rel_Mapel.Trim() != "");
                                    foreach (Rapor_Desain_Det item in lst_rapor_desain_det.FindAll(m => m.Rel_Mapel.Trim() != ""))
                                    {

                                        if (item.Rel_Mapel.Trim() != "")
                                        {

                                            lst_nilai_siswa_det_sm1 = lst_nilai_siswa_det_by_periode_sm1.FindAll(
                                                    m => m.Rel_Mapel == item.Rel_Mapel &&
                                                         m.Rel_Siswa == m.Rel_Siswa
                                                );
                                            lst_nilai_siswa_det = lst_nilai_siswa_det_by_periode.FindAll(
                                                    m => m.Rel_Mapel == item.Rel_Mapel &&
                                                         m.Rel_Siswa == m.Rel_Siswa
                                                );

                                            //get struktur nilainya
                                            Rapor_StrukturNilai m_struktur_nilai_sm1 = DAO_Rapor_StrukturNilai.GetATop1ByTABySMByKelasByMapel_Entity(
                                                    tahun_ajaran, "1", m_kelas.Kode.ToString(), item.Rel_Mapel
                                                );

                                            Rapor_StrukturNilai m_struktur_nilai = DAO_Rapor_StrukturNilai.GetATop1ByTABySMByKelasByMapel_Entity(
                                                    tahun_ajaran, semester, m_kelas.Kode.ToString(), item.Rel_Mapel
                                                );

                                            decimal nilai_rapor = 0;                                            
                                            decimal jumlah_nilai_rapor = 0;
                                            decimal count_nilai_rapor = 0;

                                            decimal nilai_rapor_mulok = 0;
                                            decimal nilai_rapor_mulok_sm1 = 0;
                                            if (m_struktur_nilai != null)
                                            {
                                                if (m_struktur_nilai.TahunAjaran != null)
                                                {

                                                    if (!(m_struktur_nilai.IsKelompokanKP && m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString()))
                                                    {
                                                        decimal jumlah_nilai_ap = 0;
                                                        decimal nilai_ap = 0;
                                                        int count_ap = 0;
                                                        nilai_rapor = 0;
                                                        nilai_rapor_mulok_sm1 = 0;
                                                        List<Rapor_StrukturNilai_AP> lst_rapor_struktur_nilai_ap = new List<Rapor_StrukturNilai_AP>();
                                                        //jika semester 2 get nilai semester 1
                                                        if (m_struktur_nilai.Semester == "2")
                                                        {
                                                            //get struktur nilai det AP
                                                            lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeader_Entity(
                                                                    m_struktur_nilai_sm1.Kode.ToString()
                                                                );
                                                            lst_nilai_ap.Clear();
                                                            lst_nilai_ap_bobot.Clear();                                                            
                                                            foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                            {

                                                                //get struktur nilai det KD
                                                                List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                        item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                    );
                                                                lst_nilai_kd.Clear();
                                                                foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                                {

                                                                    //get struktur nilai det KP
                                                                    List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                        item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                    );
                                                                    decimal jumlah_nilai_kd = 0;
                                                                    decimal nilai_kd = 0;
                                                                    int count_kd = 0;
                                                                    foreach (var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp)
                                                                    {
                                                                        Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString());
                                                                        if (m_kp != null)
                                                                        {

                                                                            Rapor_NilaiSiswa_Det m_nilai_det = lst_nilai_siswa_det_sm1.FindAll(
                                                                                m => m.Rel_Siswa.ToString().Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                     m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai_sm1.Rel_Mapel.ToString().Trim().ToUpper() &&
                                                                                     m.Rel_Rapor_StrukturNilai_AP.Trim().ToUpper() == item_rapor_struktur_nilai_ap.Kode.ToString().ToUpper() &&
                                                                                     m.Rel_Rapor_StrukturNilai_KD.Trim().ToUpper() == item_rapor_struktur_nilai_kd.Kode.ToString().ToUpper() &&
                                                                                     m.Rel_Rapor_StrukturNilai_KP.Trim().ToUpper() == item_rapor_struktur_nilai_kp.Kode.ToString().ToUpper()
                                                                            ).FirstOrDefault();

                                                                            if (m_nilai_det != null)
                                                                            {
                                                                                if (m_nilai_det.Nilai.Trim() != "")
                                                                                {
                                                                                    if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                                    {
                                                                                        nilai_kd += Math.Round((item_rapor_struktur_nilai_kp.BobotNK / 100) * Libs.GetStringToDecimal(m_nilai_det.Nilai), 2, MidpointRounding.AwayFromZero);
                                                                                    }
                                                                                    else if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                                    {
                                                                                        jumlah_nilai_kd += Libs.GetStringToDecimal(m_nilai_det.Nilai);
                                                                                    }
                                                                                    count_kd++;
                                                                                }
                                                                            }

                                                                        }

                                                                    }

                                                                    if (count_kd > 0)
                                                                    {
                                                                        if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                        {
                                                                            nilai_kd = Math.Round(jumlah_nilai_kd / count_kd, 2, MidpointRounding.AwayFromZero);
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        nilai_kd = 0;
                                                                    }

                                                                    //load nilai manual
                                                                    Rapor_NilaiSiswa_AP_or_KD m_nilai_manual = DAO_Rapor_NilaiSiswa_AP_or_KD.GetAllByTABySMByKelasByMapelBySiswaByStruktur_Entity(
                                                                            tahun_ajaran, m_struktur_nilai_sm1.Semester, rel_kelas_det, m_siswa.Kode.ToString(), item.Rel_Mapel,
                                                                            item_rapor_struktur_nilai_kd.Kode.ToString().Trim().ToUpper()

                                                                        ).FirstOrDefault();
                                                                    if (m_nilai_manual != null)
                                                                    {
                                                                        if (m_nilai_manual.Nilai != null)
                                                                        {
                                                                            nilai_kd = Libs.GetStringToDecimal(m_nilai_manual.Nilai);
                                                                        }
                                                                    }
                                                                    //end load nilai manual

                                                                    nilai_kd = Math.Round(nilai_kd, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);
                                                                    lst_nilai_kd.Add(nilai_kd);
                                                                    //end get struktur nilai det KP

                                                                }
                                                                //end get struktur nilai det KD

                                                                //get nilai ap
                                                                count_ap = 0;
                                                                nilai_ap = 0;
                                                                jumlah_nilai_ap = 0;
                                                                foreach (var item_nilai_kd in lst_nilai_kd)
                                                                {
                                                                    if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                    {
                                                                        nilai_ap += Math.Round((item_rapor_struktur_nilai_ap.BobotRapor / 100) * item_nilai_kd, 2, MidpointRounding.AwayFromZero);
                                                                    }
                                                                    else if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                    {
                                                                        jumlah_nilai_ap += item_nilai_kd;
                                                                    }
                                                                    count_ap++;
                                                                }
                                                                if (count_ap > 0)
                                                                {
                                                                    if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                    {
                                                                        nilai_ap = Math.Round(jumlah_nilai_ap / count_ap, 2, MidpointRounding.AwayFromZero);
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    nilai_ap = 0;
                                                                }
                                                                nilai_ap = Math.Round(nilai_ap, 0, MidpointRounding.AwayFromZero);
                                                                lst_nilai_ap.Add(nilai_ap);
                                                                lst_nilai_ap_bobot.Add(item_rapor_struktur_nilai_ap.BobotRapor);
                                                                //end get nilai ap

                                                            }
                                                            //end get struktur nilai det AP

                                                            //get nilai rapor
                                                            nilai_rapor = 0;
                                                            jumlah_nilai_rapor = 0;
                                                            count_nilai_rapor = 0;
                                                            foreach (var item_nilai_ap in lst_nilai_ap)
                                                            {
                                                                if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                {
                                                                    nilai_rapor += Math.Round((lst_nilai_ap_bobot[Convert.ToInt16(count_nilai_rapor)] / 100) * item_nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                                else if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    jumlah_nilai_rapor += item_nilai_ap;
                                                                }
                                                                count_nilai_rapor++;
                                                            }
                                                            if (count_nilai_rapor > 0)
                                                            {
                                                                if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_rapor = 0;
                                                            }
                                                            nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);
                                                            nilai_rapor_mulok_sm1 = nilai_rapor;
                                                            //end get nilai rapor
                                                        }
                                                        //end get nilai semester 1

                                                        //get struktur nilai det AP
                                                        lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeader_Entity(
                                                                m_struktur_nilai.Kode.ToString()
                                                            );
                                                        lst_nilai_ap.Clear();
                                                        lst_nilai_ap_bobot.Clear();
                                                        jumlah_nilai_ap = 0;
                                                        nilai_ap = 0;
                                                        count_ap = 0;
                                                        nilai_rapor = 0;
                                                        foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                        {

                                                            //get struktur nilai det KD
                                                            List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                );
                                                            lst_nilai_kd.Clear();
                                                            foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                            {

                                                                //get struktur nilai det KP
                                                                List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                );
                                                                decimal jumlah_nilai_kd = 0;
                                                                decimal nilai_kd = 0;
                                                                int count_kd = 0;
                                                                foreach (var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp)
                                                                {
                                                                    Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString());
                                                                    if (m_kp != null)
                                                                    {

                                                                        Rapor_NilaiSiswa_Det m_nilai_det = lst_nilai_siswa_det.FindAll(
                                                                            m => m.Rel_Siswa.ToString().Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_AP.Trim().ToUpper() == item_rapor_struktur_nilai_ap.Kode.ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KD.Trim().ToUpper() == item_rapor_struktur_nilai_kd.Kode.ToString().ToUpper() &&
                                                                                 m.Rel_Rapor_StrukturNilai_KP.Trim().ToUpper() == item_rapor_struktur_nilai_kp.Kode.ToString().ToUpper()
                                                                        ).FirstOrDefault();

                                                                        if (m_nilai_det != null)
                                                                        {
                                                                            if (m_nilai_det.Nilai.Trim() != "")
                                                                            {
                                                                                if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                                {
                                                                                    nilai_kd += Math.Round((item_rapor_struktur_nilai_kp.BobotNK / 100) * Libs.GetStringToDecimal(m_nilai_det.Nilai), 2, MidpointRounding.AwayFromZero);
                                                                                }
                                                                                else if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                                {
                                                                                    jumlah_nilai_kd += Libs.GetStringToDecimal(m_nilai_det.Nilai);
                                                                                }
                                                                                count_kd++;
                                                                            }
                                                                        }

                                                                    }

                                                                }

                                                                if (count_kd > 0)
                                                                {
                                                                    if (item_rapor_struktur_nilai_kd.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                    {
                                                                        nilai_kd = Math.Round(jumlah_nilai_kd / count_kd, 2, MidpointRounding.AwayFromZero);
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    nilai_kd = 0;
                                                                }

                                                                //load nilai manual
                                                                Rapor_NilaiSiswa_AP_or_KD m_nilai_manual = DAO_Rapor_NilaiSiswa_AP_or_KD.GetAllByTABySMByKelasByMapelBySiswaByStruktur_Entity(
                                                                        tahun_ajaran, semester, rel_kelas_det, m_siswa.Kode.ToString(), item.Rel_Mapel,
                                                                        item_rapor_struktur_nilai_kd.Kode.ToString().Trim().ToUpper()

                                                                    ).FirstOrDefault();
                                                                if (m_nilai_manual != null)
                                                                {
                                                                    if (m_nilai_manual.Nilai != null)
                                                                    {
                                                                        nilai_kd = Libs.GetStringToDecimal(m_nilai_manual.Nilai);
                                                                    }
                                                                }
                                                                //end load nilai manual

                                                                nilai_kd = Math.Round(nilai_kd, Constantas.PEMBULATAN_DESIMAL_NILAI_SD, MidpointRounding.AwayFromZero);
                                                                lst_nilai_kd.Add(nilai_kd);
                                                                //end get struktur nilai det KP

                                                            }
                                                            //end get struktur nilai det KD

                                                            //get nilai ap
                                                            count_ap = 0;
                                                            nilai_ap = 0;
                                                            jumlah_nilai_ap = 0;
                                                            foreach (var item_nilai_kd in lst_nilai_kd)
                                                            {
                                                                if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                {
                                                                    nilai_ap += Math.Round((item_rapor_struktur_nilai_ap.BobotRapor / 100) * item_nilai_kd, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                                else if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    jumlah_nilai_ap += item_nilai_kd;
                                                                }
                                                                count_ap++;
                                                            }
                                                            if (count_ap > 0)
                                                            {
                                                                if (item_rapor_struktur_nilai_ap.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_ap = Math.Round(jumlah_nilai_ap / count_ap, 2, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_ap = 0;
                                                            }
                                                            nilai_ap = Math.Round(nilai_ap, 0, MidpointRounding.AwayFromZero);
                                                            lst_nilai_ap.Add(nilai_ap);
                                                            lst_nilai_ap_bobot.Add(item_rapor_struktur_nilai_ap.BobotRapor);
                                                            //end get nilai ap

                                                        }
                                                        //end get struktur nilai det AP

                                                        //get nilai rapor
                                                        nilai_rapor = 0;
                                                        jumlah_nilai_rapor = 0;
                                                        count_nilai_rapor = 0;
                                                        foreach (var item_nilai_ap in lst_nilai_ap)
                                                        {
                                                            if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                            {
                                                                nilai_rapor += Math.Round((lst_nilai_ap_bobot[Convert.ToInt16(count_nilai_rapor)] / 100) * item_nilai_ap, 2, MidpointRounding.AwayFromZero);
                                                            }
                                                            else if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                jumlah_nilai_rapor += item_nilai_ap;
                                                            }
                                                            count_nilai_rapor++;
                                                        }
                                                        if (count_nilai_rapor > 0)
                                                        {
                                                            if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                            {
                                                                nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            nilai_rapor = 0;
                                                        }
                                                        nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);
                                                        nilai_rapor_mulok = nilai_rapor;
                                                        //end get nilai rapor
                                                    }
                                                    else 
                                                    {
                                                        nilai_rapor_mulok_sm1 = 0;
                                                        decimal nilai_non_q = 0;
                                                        List<Rapor_StrukturNilai_KPKelompok> lst_kpkelompok = new List<Rapor_StrukturNilai_KPKelompok>();
                                                        List<FormatNilai> lst_format_nilai = new List<FormatNilai>();
                                                        List<Rapor_StrukturNilai_AP> lst_rapor_struktur_nilai_ap = new List<Rapor_StrukturNilai_AP>();
                                                        List<FormatNilai> lst_format_nilai2 = new List<FormatNilai>();
                                                        List<FormatNilaiWithNilai> lst_formatnilai_nilai = new List<FormatNilaiWithNilai>();
                                                        List<FormatNilaiWithNilai> lst_formatnilai_nilai2 = new List<FormatNilaiWithNilai>();
                                                        List<NilaiWithKey> lst_nilai = new List<NilaiWithKey>();

                                                        //jika semester 2 get nilai semester 1
                                                        if (m_struktur_nilai.Semester == "2")
                                                        {
                                                            lst_format_nilai = new List<FormatNilai>();
                                                            lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeader_Entity(
                                                                    m_struktur_nilai_sm1.Kode.ToString()
                                                                );
                                                            foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                            {

                                                                List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                        item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                    );

                                                                foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                                {

                                                                    List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                        item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                    );
                                                                    foreach (
                                                                        var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp.FindAll(
                                                                            m => (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == DAO_Rapor_StrukturNilai.Arr_KP_Quran[0]) ||
                                                                                 (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == DAO_Rapor_StrukturNilai.Arr_KP_Quran[1]) ||
                                                                                 (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == DAO_Rapor_StrukturNilai.Arr_KP_Quran[2])
                                                                            )
                                                                    )
                                                                    {

                                                                        if (
                                                                            lst_format_nilai.FindAll(
                                                                                    m => m.Rel_StrukturNilai_AP == item_rapor_struktur_nilai_ap.Kode.ToString() &&
                                                                                         m.Rel_KP == item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                                ).Count == 0
                                                                        )
                                                                        {
                                                                            lst_format_nilai.Add(new FormatNilai
                                                                            {
                                                                                Rel_StrukturNilai_AP = item_rapor_struktur_nilai_ap.Kode.ToString(),
                                                                                Rel_KP = item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                            });
                                                                        }

                                                                    }
                                                                }

                                                            }

                                                            lst_format_nilai2 = new List<FormatNilai>();
                                                            foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                            {

                                                                List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                        item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                    );

                                                                foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                                {

                                                                    List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                        item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                    );
                                                                    foreach (
                                                                        var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp.FindAll(
                                                                            m => (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() != DAO_Rapor_StrukturNilai.Arr_KP_Quran[0]) &&
                                                                                 (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() != DAO_Rapor_StrukturNilai.Arr_KP_Quran[1]) &&
                                                                                 (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() != DAO_Rapor_StrukturNilai.Arr_KP_Quran[2])
                                                                            )
                                                                    )
                                                                    {

                                                                        if (
                                                                            lst_format_nilai2.FindAll(
                                                                                    m => m.Rel_StrukturNilai_AP == item_rapor_struktur_nilai_ap.Kode.ToString() &&
                                                                                         m.Rel_KP == item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                                ).Count == 0
                                                                        )
                                                                        {
                                                                            lst_format_nilai2.Add(new FormatNilai
                                                                            {
                                                                                Rel_StrukturNilai_AP = item_rapor_struktur_nilai_ap.Kode.ToString(),
                                                                                Rel_KP = item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                            });
                                                                        }

                                                                    }
                                                                }

                                                            }

                                                            lst_formatnilai_nilai = new List<FormatNilaiWithNilai>();
                                                            //distinct ap
                                                            foreach (string rel_sn_ap in lst_format_nilai.Select(m => m.Rel_StrukturNilai_AP).Distinct())
                                                            {
                                                                foreach (string rel_kp in lst_format_nilai.Select(m => m.Rel_KP).Distinct())
                                                                {

                                                                    Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(rel_kp);
                                                                    if (m_kp != null)
                                                                    {
                                                                        if (m_kp.Nama != null)
                                                                        {

                                                                            double nilai = lst_nilai_siswa_det_sm1.Where(
                                                                                m => m.Rel_Rapor_StrukturNilai_AP.ToString().Trim().ToUpper() == rel_sn_ap.Trim().ToUpper() &&
                                                                                     m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == rel_kp.Trim().ToUpper() &&
                                                                                     m.Rel_Siswa.Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                     m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai_sm1.Rel_Mapel.ToString().Trim().ToUpper()
                                                                            ).Select(m => Libs.GetStringToDouble(m.Nilai)).DefaultIfEmpty().Average();

                                                                            lst_formatnilai_nilai.Add(new FormatNilaiWithNilai
                                                                            {
                                                                                Nama_KP = m_kp.Nama,
                                                                                Nilai = nilai.ToString(),
                                                                                Rel_KP = rel_kp,
                                                                                Rel_StrukturNilai_AP = rel_sn_ap
                                                                            });

                                                                        }
                                                                    }

                                                                }
                                                            }

                                                            lst_formatnilai_nilai2 = new List<FormatNilaiWithNilai>();
                                                            //distinct ap
                                                            foreach (string rel_sn_ap in lst_format_nilai2.Select(m => m.Rel_StrukturNilai_AP).Distinct())
                                                            {
                                                                foreach (string rel_kp in lst_format_nilai2.Select(m => m.Rel_KP).Distinct())
                                                                {

                                                                    Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(rel_kp);
                                                                    if (m_kp != null)
                                                                    {
                                                                        if (m_kp.Nama != null)
                                                                        {

                                                                            double nilai = lst_nilai_siswa_det_sm1.Where(
                                                                                m => m.Rel_Rapor_StrukturNilai_AP.ToString().Trim().ToUpper() == rel_sn_ap.Trim().ToUpper() &&
                                                                                     m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == rel_kp.Trim().ToUpper() &&
                                                                                     m.Rel_Siswa.Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                     m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai_sm1.Rel_Mapel.ToString().Trim().ToUpper()
                                                                            ).Select(m => Libs.GetStringToDouble(m.Nilai)).DefaultIfEmpty().Average();

                                                                            lst_formatnilai_nilai2.Add(new FormatNilaiWithNilai
                                                                            {
                                                                                Nama_KP = m_kp.Nama,
                                                                                Nilai = nilai.ToString(),
                                                                                Rel_KP = rel_kp,
                                                                                Rel_StrukturNilai_AP = rel_sn_ap
                                                                            });

                                                                        }
                                                                    }

                                                                }
                                                            }

                                                            //get nilai rapor                                                        
                                                            lst_nilai = new List<NilaiWithKey>();
                                                            lst_nilai.Clear();
                                                            foreach (string rel_kp in lst_formatnilai_nilai.Select(m => m.Rel_KP).Distinct())
                                                            {

                                                                nilai_rapor = 0;
                                                                jumlah_nilai_rapor = 0;
                                                                count_nilai_rapor = 0;
                                                                foreach (var m_formatnilai_nilai in lst_formatnilai_nilai.FindAll(m => m.Rel_KP == rel_kp))
                                                                {
                                                                    Rapor_StrukturNilai_AP m_rel_sn_ap = DAO_Rapor_StrukturNilai_AP.GetByID_Entity(m_formatnilai_nilai.Rel_StrukturNilai_AP);
                                                                    if (m_rel_sn_ap != null)
                                                                    {
                                                                        if (m_rel_sn_ap.JenisPerhitungan != null)
                                                                        {

                                                                            if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                            {
                                                                                nilai_rapor += Math.Round((m_rel_sn_ap.BobotRapor / 100) * Libs.GetStringToDecimal(m_formatnilai_nilai.Nilai), 3, MidpointRounding.AwayFromZero);
                                                                            }
                                                                            else if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                            {
                                                                                jumlah_nilai_rapor += m_rel_sn_ap.BobotRapor;
                                                                            }
                                                                            count_nilai_rapor++;

                                                                        }
                                                                    }
                                                                }

                                                                if (count_nilai_rapor > 0)
                                                                {
                                                                    if (m_struktur_nilai_sm1.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                    {
                                                                        nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    nilai_rapor = 0;
                                                                }
                                                                nilai_rapor = Math.Round(nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                                lst_nilai.Add(new NilaiWithKey
                                                                {
                                                                    Key = rel_kp,
                                                                    Nilai = nilai_rapor
                                                                });
                                                            }

                                                            nilai_rapor = 0;
                                                            jumlah_nilai_rapor = 0;
                                                            count_nilai_rapor = 0;
                                                            lst_kpkelompok = DAO_Rapor_StrukturNilai_KPKelompok.GetAllByHeader_Entity(
                                                                    m_struktur_nilai_sm1.Kode.ToString()
                                                                );
                                                            foreach (var item_nilai in lst_nilai)
                                                            {
                                                                Rapor_StrukturNilai_KPKelompok m_kpkelompok = lst_kpkelompok.FindAll(
                                                                        m => m.Rel_Rapor_KomponenPenilaian == new Guid(item_nilai.Key)
                                                                    ).FirstOrDefault();
                                                                if (m_kpkelompok != null)
                                                                {
                                                                    if (m_kpkelompok.Rel_Rapor_StrukturNilai != null)
                                                                    {
                                                                        nilai_rapor += Math.Round((m_kpkelompok.Bobot / 100) * item_nilai.Nilai, 3, MidpointRounding.AwayFromZero);
                                                                    }
                                                                }
                                                            }

                                                            nilai_non_q = 0;
                                                            if (lst_formatnilai_nilai2.Count > 0)
                                                            {
                                                                nilai_non_q = lst_formatnilai_nilai2.Select(m => Libs.GetStringToDecimal(m.Nilai)).DefaultIfEmpty().Average();
                                                            }
                                                            if (nilai_non_q > 0)
                                                            {
                                                                nilai_rapor = Math.Round((nilai_rapor + nilai_non_q) / 2, 3, MidpointRounding.AwayFromZero);
                                                            }
                                                            nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);
                                                            nilai_rapor_mulok_sm1 = nilai_rapor;
                                                        }
                                                        //end get nilai semester 1

                                                        lst_format_nilai = new List<FormatNilai>();
                                                        lst_rapor_struktur_nilai_ap = DAO_Rapor_StrukturNilai_AP.GetAllByHeader_Entity(
                                                                m_struktur_nilai.Kode.ToString()
                                                            );
                                                        foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                        {

                                                            List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                );

                                                            foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                            {

                                                                List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                );
                                                                foreach (
                                                                    var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp.FindAll(
                                                                        m => (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == DAO_Rapor_StrukturNilai.Arr_KP_Quran[0]) ||
                                                                             (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == DAO_Rapor_StrukturNilai.Arr_KP_Quran[1]) ||
                                                                             (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == DAO_Rapor_StrukturNilai.Arr_KP_Quran[2])
                                                                        )
                                                                )
                                                                {

                                                                    if (
                                                                        lst_format_nilai.FindAll(
                                                                                m => m.Rel_StrukturNilai_AP == item_rapor_struktur_nilai_ap.Kode.ToString() &&
                                                                                     m.Rel_KP == item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                            ).Count == 0
                                                                    )
                                                                    {
                                                                        lst_format_nilai.Add(new FormatNilai
                                                                        {
                                                                            Rel_StrukturNilai_AP = item_rapor_struktur_nilai_ap.Kode.ToString(),
                                                                            Rel_KP = item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                        });
                                                                    }

                                                                }
                                                            }

                                                        }

                                                        lst_format_nilai2 = new List<FormatNilai>();
                                                        foreach (var item_rapor_struktur_nilai_ap in lst_rapor_struktur_nilai_ap)
                                                        {

                                                            List<Rapor_StrukturNilai_KD> lst_rapor_struktur_nilai_kd = DAO_Rapor_StrukturNilai_KD.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_ap.Kode.ToString()
                                                                );

                                                            foreach (var item_rapor_struktur_nilai_kd in lst_rapor_struktur_nilai_kd)
                                                            {

                                                                List<Rapor_StrukturNilai_KP> lst_rapor_struktur_nilai_kp = DAO_Rapor_StrukturNilai_KP.GetAllByHeader_Entity(
                                                                    item_rapor_struktur_nilai_kd.Kode.ToString()
                                                                );
                                                                foreach (
                                                                    var item_rapor_struktur_nilai_kp in lst_rapor_struktur_nilai_kp.FindAll(
                                                                        m => (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() != DAO_Rapor_StrukturNilai.Arr_KP_Quran[0]) &&
                                                                             (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() != DAO_Rapor_StrukturNilai.Arr_KP_Quran[1]) &&
                                                                             (m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() != DAO_Rapor_StrukturNilai.Arr_KP_Quran[2])
                                                                        )
                                                                )
                                                                {

                                                                    if (
                                                                        lst_format_nilai2.FindAll(
                                                                                m => m.Rel_StrukturNilai_AP == item_rapor_struktur_nilai_ap.Kode.ToString() &&
                                                                                     m.Rel_KP == item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                            ).Count == 0
                                                                    )
                                                                    {
                                                                        lst_format_nilai2.Add(new FormatNilai
                                                                        {
                                                                            Rel_StrukturNilai_AP = item_rapor_struktur_nilai_ap.Kode.ToString(),
                                                                            Rel_KP = item_rapor_struktur_nilai_kp.Rel_Rapor_KomponenPenilaian.ToString()
                                                                        });
                                                                    }

                                                                }
                                                            }

                                                        }

                                                        lst_formatnilai_nilai = new List<FormatNilaiWithNilai>();
                                                        //distinct ap
                                                        foreach (string rel_sn_ap in lst_format_nilai.Select(m => m.Rel_StrukturNilai_AP).Distinct())
                                                        {
                                                            foreach (string rel_kp in lst_format_nilai.Select(m => m.Rel_KP).Distinct())
                                                            {

                                                                Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(rel_kp);
                                                                if (m_kp != null)
                                                                {
                                                                    if (m_kp.Nama != null)
                                                                    {

                                                                        double nilai = lst_nilai_siswa_det.Where(
                                                                            m => m.Rel_Rapor_StrukturNilai_AP.ToString().Trim().ToUpper() == rel_sn_ap.Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == rel_kp.Trim().ToUpper() &&
                                                                                 m.Rel_Siswa.Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper()
                                                                        ).Select(m => Libs.GetStringToDouble(m.Nilai)).DefaultIfEmpty().Average();

                                                                        lst_formatnilai_nilai.Add(new FormatNilaiWithNilai
                                                                        {
                                                                            Nama_KP = m_kp.Nama,
                                                                            Nilai = nilai.ToString(),
                                                                            Rel_KP = rel_kp,
                                                                            Rel_StrukturNilai_AP = rel_sn_ap
                                                                        });

                                                                    }
                                                                }

                                                            }
                                                        }

                                                        lst_formatnilai_nilai2 = new List<FormatNilaiWithNilai>();
                                                        //distinct ap
                                                        foreach (string rel_sn_ap in lst_format_nilai2.Select(m => m.Rel_StrukturNilai_AP).Distinct())
                                                        {
                                                            foreach (string rel_kp in lst_format_nilai2.Select(m => m.Rel_KP).Distinct())
                                                            {

                                                                Rapor_KomponenPenilaian m_kp = DAO_Rapor_KomponenPenilaian.GetByID_Entity(rel_kp);
                                                                if (m_kp != null)
                                                                {
                                                                    if (m_kp.Nama != null)
                                                                    {

                                                                        double nilai = lst_nilai_siswa_det.Where(
                                                                            m => m.Rel_Rapor_StrukturNilai_AP.ToString().Trim().ToUpper() == rel_sn_ap.Trim().ToUpper() &&
                                                                                 m.Rel_Rapor_KomponenPenilaian.ToString().Trim().ToUpper() == rel_kp.Trim().ToUpper() &&
                                                                                 m.Rel_Siswa.Trim().ToUpper() == m_siswa.Kode.ToString().Trim().ToUpper() &&
                                                                                 m.Rel_Mapel.ToString().Trim().ToUpper() == m_struktur_nilai.Rel_Mapel.ToString().Trim().ToUpper()
                                                                        ).Select(m => Libs.GetStringToDouble(m.Nilai)).DefaultIfEmpty().Average();

                                                                        lst_formatnilai_nilai2.Add(new FormatNilaiWithNilai
                                                                        {
                                                                            Nama_KP = m_kp.Nama,
                                                                            Nilai = nilai.ToString(),
                                                                            Rel_KP = rel_kp,
                                                                            Rel_StrukturNilai_AP = rel_sn_ap
                                                                        });

                                                                    }
                                                                }

                                                            }
                                                        }

                                                        //get nilai rapor                                                        
                                                        lst_nilai = new List<NilaiWithKey>();
                                                        lst_nilai.Clear();
                                                        foreach (string rel_kp in lst_formatnilai_nilai.Select(m => m.Rel_KP).Distinct())
                                                        {

                                                            nilai_rapor = 0;
                                                            jumlah_nilai_rapor = 0;
                                                            count_nilai_rapor = 0;
                                                            foreach (var m_formatnilai_nilai in lst_formatnilai_nilai.FindAll(m => m.Rel_KP == rel_kp))
                                                            {
                                                                Rapor_StrukturNilai_AP m_rel_sn_ap = DAO_Rapor_StrukturNilai_AP.GetByID_Entity(m_formatnilai_nilai.Rel_StrukturNilai_AP);
                                                                if (m_rel_sn_ap != null)
                                                                {
                                                                    if (m_rel_sn_ap.JenisPerhitungan != null)
                                                                    {

                                                                        if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.Bobot).ToString())
                                                                        {
                                                                            nilai_rapor += Math.Round((m_rel_sn_ap.BobotRapor / 100) * Libs.GetStringToDecimal(m_formatnilai_nilai.Nilai), 3, MidpointRounding.AwayFromZero);
                                                                        }
                                                                        else if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                        {
                                                                            jumlah_nilai_rapor += m_rel_sn_ap.BobotRapor;
                                                                        }
                                                                        count_nilai_rapor++;

                                                                    }
                                                                }
                                                            }

                                                            if (count_nilai_rapor > 0)
                                                            {
                                                                if (m_struktur_nilai.JenisPerhitungan == ((int)Libs.JenisPerhitunganNilai.RataRata).ToString())
                                                                {
                                                                    nilai_rapor = Math.Round(jumlah_nilai_rapor / count_nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                nilai_rapor = 0;
                                                            }
                                                            nilai_rapor = Math.Round(nilai_rapor, 3, MidpointRounding.AwayFromZero);
                                                            lst_nilai.Add(new NilaiWithKey
                                                            {
                                                                Key = rel_kp,
                                                                Nilai = nilai_rapor
                                                            });
                                                        }

                                                        nilai_rapor = 0;
                                                        jumlah_nilai_rapor = 0;
                                                        count_nilai_rapor = 0;
                                                        lst_kpkelompok = DAO_Rapor_StrukturNilai_KPKelompok.GetAllByHeader_Entity(
                                                                m_struktur_nilai.Kode.ToString()
                                                            );
                                                        foreach (var item_nilai in lst_nilai)
                                                        {
                                                            Rapor_StrukturNilai_KPKelompok m_kpkelompok = lst_kpkelompok.FindAll(
                                                                    m => m.Rel_Rapor_KomponenPenilaian == new Guid(item_nilai.Key)
                                                                ).FirstOrDefault();
                                                            if (m_kpkelompok != null)
                                                            {
                                                                if (m_kpkelompok.Rel_Rapor_StrukturNilai != null)
                                                                {
                                                                    nilai_rapor += Math.Round((m_kpkelompok.Bobot / 100) * item_nilai.Nilai, 3, MidpointRounding.AwayFromZero);
                                                                }
                                                            }
                                                        }

                                                        nilai_non_q = 0;
                                                        if (lst_formatnilai_nilai2.Count > 0)
                                                        {
                                                            nilai_non_q = lst_formatnilai_nilai2.Select(m => Libs.GetStringToDecimal(m.Nilai)).DefaultIfEmpty().Average();
                                                        }
                                                        if (nilai_non_q > 0)
                                                        {
                                                            nilai_rapor = Math.Round((nilai_rapor + nilai_non_q) / 2, 3, MidpointRounding.AwayFromZero);
                                                        }
                                                        nilai_rapor = Math.Round(nilai_rapor, 0, MidpointRounding.AwayFromZero);
                                                        nilai_rapor_mulok = nilai_rapor;
                                                        //end get nilai rapor
                                                        //end distinct ap
                                                    }

                                                    hasil.Add(new KURTILAS_RaporMulok
                                                    {
                                                        IDSiswa = m_siswa.Nama.Trim().ToUpper() + "_" + m_siswa.Kode.ToString(),
                                                        NamaMapel = item.NamaMapelRapor,
                                                        Nilai = nilai_rapor_mulok.ToString(),
                                                        Predikat = "",
                                                        NilaiRataRataSM1SM2 = Math.Round(((nilai_rapor_mulok + nilai_rapor_mulok_sm1) / 2), 0, MidpointRounding.AwayFromZero).ToString(),
                                                        PredikatRataRataSM1SM2 = ""
                                                    });
                                                }
                                            }
                                            //end get struktur nilai
                                        }

                                    }
                                    //end rapor mulok
                                    nomor++;
                                }
                                // end foreach siswa

                            }

                        }
                    }

                }
            }

            return hasil;
        }

        public static void ClosingRapor()
        {

        }

        public static string GetHTMLLedgerSikap_KURTILAS(
            System.Web.UI.Page page,
            string tahun_ajaran,
            string semester,
            string rel_kelas_det,
            string rel_siswa = ""
        )
        {
            string css_cell_headers = "border-style: solid; border-width: 1px; text-align: center; font-weight: bold; padding: 5px;";
            string css_cell_body = "border-style: solid; border-width: 1px; padding: 3px;";

            string html = "";
            string html_row_header = "<td rowspan=\"3\" style=\"" + css_cell_headers + "\">" +
                                        "No" +
                                     "</td>" +
                                     "<td rowspan=\"3\" style=\"" + css_cell_headers + "\">" +
                                        "NIS" +
                                     "</td>" +
                                     "<td rowspan=\"3\" style=\"" + css_cell_headers + "\">" +
                                        "NAMA LENGKAP" +
                                     "</td>" +
                                     "<td rowspan=\"3\" style=\"" + css_cell_headers + "\">" +
                                        "L/P" +
                                     "</td>";
            string html_row_mapel = "";
            string html_row_jenis_nilai = "";
            string html_row_body = "";

            KelasDet m_kelas_det = DAO_KelasDet.GetByID_Entity(rel_kelas_det);
            if (m_kelas_det != null)
            {
                if (m_kelas_det.Nama != null)
                {

                    Kelas m_kelas = DAO_Kelas.GetByID_Entity(m_kelas_det.Rel_Kelas.ToString());
                    if (m_kelas != null)
                    {
                        if (m_kelas.Nama != null)
                        {

                            Rapor_Desain rapor_desain = DAO_Rapor_Desain.GetByTABySMByKelas_Entity(
                                    tahun_ajaran, semester, rel_kelas_det, DAO_Rapor_Desain.JenisRapor.Semester
                                ).FirstOrDefault();

                            List<Rapor_Desain_Det> lst_rapor_desain_det = DAO_Rapor_Desain_Det.GetAllByHeader_Entity(rapor_desain.Kode.ToString()).FindAll(m => m.Rel_Mapel.Trim() != "");

                            //list cols header
                            int jml_colspan_mapel = 0;
                            int jumlah_mapel = 0;
                            html_row_mapel = "";

                            //nilai guru kelas
                            html_row_mapel += "<td colspan=\"2\" style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                    "GURU KELAS" +
                                              "</td>";
                            html_row_jenis_nilai += "<td style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                            "SPIRITUAL" +
                                                    "</td>" +
                                                    "<td style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                            "SOSIAL" +
                                                    "</td>";
                            jumlah_mapel++;
                            //end nilai guru kelas
                            bool is_guru_matpel = false;
                            foreach (Rapor_Desain_Det item_desain_det in lst_rapor_desain_det)
                            {
                                is_guru_matpel = false;
                                //cek is guru matpel
                                is_guru_matpel = (
                                        DAO_FormasiGuruMapelDet.GetByTABySMByKelasByMapel_Entity(
                                            tahun_ajaran, semester, m_kelas_det.Rel_Kelas.ToString(), item_desain_det.Rel_Mapel
                                        ).FindAll(m0 => m0.Rel_FormasiGuruMapel.ToString().Trim() != "" &&
                                                        m0.Rel_FormasiGuruMapel.ToString().Trim() != Constantas.GUID_NOL).Count > 0
                                        ? true
                                        : false
                                    );
                                //end cek is guru matpel
                                if (is_guru_matpel)
                                {
                                    html_row_mapel += "<td colspan=\"2\" style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                    item_desain_det.NamaMapelRapor.Trim().ToUpper() +
                                                  "</td>";
                                    html_row_jenis_nilai += "<td style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                                    "SPIRITUAL" +
                                                            "</td>" +
                                                            "<td style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                                    "SOSIAL" +
                                                            "</td>";
                                    jumlah_mapel++;
                                }
                            }
                            jml_colspan_mapel = (jumlah_mapel * 2);

                            html_row_header += "<td colspan=\"" + jml_colspan_mapel.ToString() + "\" style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                    "NILAI SIKAP" +
                                               "</td>";
                            html_row_header += "<td colspan=\"4\" style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                    "PRESENSI" +
                                               "</td>";
                            html_row_mapel += "<td rowspan=\"2\" style=\"" + css_cell_headers + " width: 30px; font-size: 8.5px; \">" +
                                                    "S" +
                                              "</td>" +
                                              "<td rowspan=\"2\" style=\"" + css_cell_headers + " width: 30px; font-size: 8.5px; \">" +
                                                    "I" +
                                              "</td>" +
                                              "<td rowspan=\"2\" style=\"" + css_cell_headers + " width: 30px; font-size: 8.5px; \">" +
                                                    "A" +
                                              "</td>" +
                                              "<td rowspan=\"2\" style=\"" + css_cell_headers + " width: 30px; font-size: 8.5px; \">" +
                                                    "T" +
                                              "</td>";
                            //end list cols header
                            if (rapor_desain != null)
                            {

                                List<DAO_Siswa.SiswaDataSimple> lst_siswa = DAO_Siswa.GetAllSiswaDataSimpleByTahunAjaranUnitKelas_Entity(
                                        m_kelas.Rel_Sekolah.ToString(),
                                        rel_kelas_det,
                                        tahun_ajaran,
                                        semester
                                    );
                                int id_kolom_ledger = 0;
                                int nomor = 1;
                                int jumlah_awal_col_ledger = 3;
                                int jumlah_mapel_rapor = 0;

                                if (rel_siswa.Trim() != "")
                                {
                                    lst_siswa = lst_siswa.FindAll(m0 => (rel_siswa + ";").Trim().ToUpper().IndexOf(m0.Kode.ToString().ToUpper() + ";") >= 0).ToList();
                                }
                                List<NilaiWithKey> lst_all_nilai_rapor = new List<NilaiWithKey>();
                                List<NilaiWithKey> lst_kkm_nilai_rapor = new List<NilaiWithKey>();
                                List<NilaiWithKey> lst_jumlah_nilai_keseluruhan = new List<NilaiWithKey>();
                                List<NilaiWithKey> lst_nilai_rapor = new List<NilaiWithKey>();
                                string html_row_rata_rata = "<td colspan=\"4\" style=\"" + css_cell_body + " font-weight: bold;\">" +
                                                                "RATA-RATA KELAS" +
                                                            "</td>";

                                int id_mulai_looping_rata_rata = id_kolom_ledger + 1;
                                int id_mulai_looping_kkm = jumlah_mapel_rapor + 1;

                                foreach (DAO_Siswa.SiswaDataSimple m_siswa in lst_siswa.OrderBy(m => m.Nama))
                                {
                                    jumlah_mapel_rapor = 0;

                                    string html_row_body_siswa = "";
                                    html_row_body_siswa += "<td style=\"" + css_cell_body + " text-align: center;\">" +
                                                                nomor.ToString() +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + "\">" +
                                                                m_siswa.NISSekolah +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + " white-space: nowrap;\">" +
                                                                Libs.GetPerbaikiEjaanNama(m_siswa.Nama) +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + "\">" +
                                                                m_siswa.JenisKelamin +
                                                           "</td>";

                                    lst_kkm_nilai_rapor.Clear();
                                    id_kolom_ledger = jumlah_awal_col_ledger;
                                    //nilai sikap by guru kelas
                                    decimal nilai_sikap_spiritual = 0;
                                    decimal nilai_sikap_sosial = 0;
                                    nilai_sikap_spiritual = 0;
                                    nilai_sikap_sosial = 0;

                                    nilai_sikap_spiritual = DAO_Rapor_SikapSemester.GetNilaiSikapSemesterByMapel_Entity(
                                                    tahun_ajaran, semester, rel_kelas_det, m_siswa.Kode.ToString(), "", KODE_SIKAP_SPIRITUAL
                                                );
                                    lst_all_nilai_rapor.Add(new NilaiWithKey
                                    {
                                        Key = (id_kolom_ledger).ToString(),
                                        Nilai = Math.Round(nilai_sikap_spiritual, 0, MidpointRounding.AwayFromZero)
                                    });
                                    id_kolom_ledger++;

                                    nilai_sikap_sosial = DAO_Rapor_SikapSemester.GetNilaiSikapSemesterByMapel_Entity(
                                            tahun_ajaran, semester, rel_kelas_det, m_siswa.Kode.ToString(), "", KODE_SIKAP_SOSIAL
                                        );
                                    lst_all_nilai_rapor.Add(new NilaiWithKey
                                    {
                                        Key = (id_kolom_ledger).ToString(),
                                        Nilai = Math.Round(nilai_sikap_sosial, 0, MidpointRounding.AwayFromZero)
                                    });
                                    id_kolom_ledger++;

                                    html_row_body_siswa += "<td style=\"" + css_cell_body + " text-align: center; " + "\">" +
                                                                (
                                                                    nilai_sikap_spiritual > 0
                                                                    ? Math.Round(nilai_sikap_spiritual, 0, MidpointRounding.AwayFromZero).ToString()
                                                                    : ""
                                                                ) +
                                                           "</td>";
                                    html_row_body_siswa += "<td style=\"" + css_cell_body + " text-align: center; " + "\">" +
                                                                (
                                                                    nilai_sikap_sosial > 0
                                                                    ? Math.Round(nilai_sikap_sosial, 0, MidpointRounding.AwayFromZero).ToString()
                                                                    : ""
                                                                ) +
                                                           "</td>";
                                    //end nilai sikap by guru kelas
                                    foreach (Rapor_Desain_Det item in DAO_Rapor_Desain_Det.GetAllByHeader_Entity(rapor_desain.Kode.ToString()).FindAll(m => m.Rel_Mapel.Trim() != ""))
                                    {
                                        is_guru_matpel = false;
                                        //cek is guru matpel
                                        is_guru_matpel = (
                                                DAO_FormasiGuruMapelDet.GetByTABySMByKelasByMapel_Entity(
                                                    tahun_ajaran, semester, m_kelas_det.Rel_Kelas.ToString(), item.Rel_Mapel
                                                ).FindAll(m0 => m0.Rel_FormasiGuruMapel.ToString().Trim() != "" &&
                                                                m0.Rel_FormasiGuruMapel.ToString().Trim() != Constantas.GUID_NOL).Count > 0
                                                ? true
                                                : false
                                            );
                                        //end cek is guru matpel
                                        if (item.Rel_Mapel.Trim() != "" && is_guru_matpel)
                                        {

                                            nilai_sikap_spiritual = 0;
                                            nilai_sikap_sosial = 0;

                                            nilai_sikap_spiritual = DAO_Rapor_SikapSemester.GetNilaiSikapSemesterByMapel_Entity(
                                                            tahun_ajaran, semester, rel_kelas_det, m_siswa.Kode.ToString(), item.Rel_Mapel.ToString(), KODE_SIKAP_SPIRITUAL
                                                        );
                                            lst_all_nilai_rapor.Add(new NilaiWithKey
                                            {
                                                Key = (id_kolom_ledger).ToString(),
                                                Nilai = Math.Round(nilai_sikap_spiritual, 0, MidpointRounding.AwayFromZero)
                                            });
                                            id_kolom_ledger++;

                                            nilai_sikap_sosial = DAO_Rapor_SikapSemester.GetNilaiSikapSemesterByMapel_Entity(
                                                    tahun_ajaran, semester, rel_kelas_det, m_siswa.Kode.ToString(), item.Rel_Mapel.ToString(), KODE_SIKAP_SOSIAL
                                                );
                                            lst_all_nilai_rapor.Add(new NilaiWithKey
                                            {
                                                Key = (id_kolom_ledger).ToString(),
                                                Nilai = Math.Round(nilai_sikap_sosial, 0, MidpointRounding.AwayFromZero)
                                            });
                                            id_kolom_ledger++;

                                            html_row_body_siswa += "<td style=\"" + css_cell_body + " text-align: center; " + "\">" +
                                                                        (
                                                                            nilai_sikap_spiritual > 0
                                                                            ? Math.Round(nilai_sikap_spiritual, 0, MidpointRounding.AwayFromZero).ToString()
                                                                            : ""
                                                                        ) +
                                                                   "</td>";
                                            html_row_body_siswa += "<td style=\"" + css_cell_body + " text-align: center; " + "\">" +
                                                                        (
                                                                            nilai_sikap_sosial > 0
                                                                            ? Math.Round(nilai_sikap_sosial, 0, MidpointRounding.AwayFromZero).ToString()
                                                                            : ""
                                                                        ) +
                                                                   "</td>";
                                        }

                                    }
                                    
                                    //absen
                                    string s_sakit = "-";
                                    string s_izin = "-";
                                    string s_alpa = "-";
                                    string s_terlambat = "-";

                                    Rapor_Arsip m_rapor_arsip = DAO_Rapor_Arsip.GetAll_Entity().FindAll(
                                            m0 => m0.TahunAjaran == tahun_ajaran &&
                                                  m0.Semester == semester &&
                                                  m0.JenisRapor == "Semester"

                                        ).FirstOrDefault();
                                    List<DAO_SiswaAbsen.AbsenRekapRapor> lst_absen = new List<DAO_SiswaAbsen.AbsenRekapRapor>();
                                    lst_absen = DAO_SiswaAbsen.GetRekapAbsenRaporBySiswaByPeriode_Entity(
                                            m_siswa.Kode.ToString(),
                                            (m_rapor_arsip != null ? m_rapor_arsip.TanggalAwalAbsen : DateTime.MinValue),
                                            (m_rapor_arsip != null ? m_rapor_arsip.TanggalAkhirAbsen : DateTime.MinValue)
                                        );
                                    foreach (var absen in lst_absen)
                                    {
                                        if (absen.Absen == Libs.JENIS_ABSENSI.SAKIT.Substring(0, 1)) s_sakit = absen.Jumlah.ToString();
                                        if (absen.Absen == Libs.JENIS_ABSENSI.IZIN.Substring(0, 1)) s_izin = absen.Jumlah.ToString();
                                        if (absen.Absen == Libs.JENIS_ABSENSI.ALPA.Substring(0, 1)) s_alpa = absen.Jumlah.ToString();
                                        if (absen.Absen == Libs.JENIS_ABSENSI.TERLAMBAT.Substring(0, 1)) s_terlambat = absen.Jumlah.ToString();
                                    }
                                    html_row_body_siswa += "<td style=\"" + css_cell_body + " text-align: center; \">" +
                                                                s_sakit +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + " text-align: center; \">" +
                                                                s_izin +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + " text-align: center; \">" +
                                                                s_alpa +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + " text-align: center; \">" +
                                                                s_terlambat +
                                                           "</td>";
                                    //end absen

                                    html_row_body += "<tr>" +
                                                        html_row_body_siswa +
                                                     "</tr>";

                                    nomor++;
                                }
                                // end foreach siswa

                                for (int i = (jumlah_awal_col_ledger); i < id_kolom_ledger; i++)
                                {
                                    if (i >= id_mulai_looping_rata_rata)
                                    {
                                        decimal rata_rata = Math.Round(lst_all_nilai_rapor.FindAll(m => m.Key == i.ToString()).Select(m => m.Nilai).DefaultIfEmpty().Sum() / lst_siswa.Count, Constantas.PEMBULATAN_DESIMAL_NILAI_SD);
                                        var lst_all_nilai_rapor_ = lst_all_nilai_rapor.FindAll(m => m.Key == i.ToString());
                                        html_row_rata_rata += "<td style=\"" + css_cell_body + " text-align: right;\">" +
                                                                    (
                                                                        rata_rata > 0
                                                                        ? Libs.GetFormatBilangan(rata_rata, Constantas.PEMBULATAN_DESIMAL_NILAI_SD)
                                                                        : ""
                                                                    ) +
                                                              "</td>";
                                    }
                                    else
                                    {
                                        decimal rata_rata = Math.Round(lst_all_nilai_rapor.FindAll(m => m.Key == i.ToString()).Select(m => m.Nilai).DefaultIfEmpty().Sum() / lst_siswa.Count, Constantas.PEMBULATAN_DESIMAL_NILAI_SD);
                                        var lst_all_nilai_rapor_ = lst_all_nilai_rapor.FindAll(m => m.Key == i.ToString());
                                        html_row_rata_rata += "<td style=\"" + css_cell_body + " text-align: right;\">" +
                                                                    (
                                                                        rata_rata > 0
                                                                        ? Libs.GetFormatBilangan(rata_rata, Constantas.PEMBULATAN_DESIMAL_NILAI_SD)
                                                                        : ""
                                                                    ) +
                                                              "</td>";
                                    }
                                }
                                decimal rata_rata_nilai_keseluruhan = Math.Round(lst_jumlah_nilai_keseluruhan.Select(m => m.Nilai).DefaultIfEmpty().Average(), Constantas.PEMBULATAN_DESIMAL_NILAI_SD);
                                decimal rata_rata_nilai_rata_rata_rapor = Math.Round(lst_nilai_rapor.Select(m => m.Nilai).DefaultIfEmpty().Average(), Constantas.PEMBULATAN_DESIMAL_NILAI_SD);
                                html_row_body += "<tr>" +
                                                    html_row_rata_rata +
                                                 "</tr>";

                            }

                        }
                    }

                }
            }

            html_row_header = "<tr>" +
                                html_row_header +
                              "</tr>" +
                              "<tr>" +
                                html_row_mapel +
                              "</tr>" +
                              "<tr>" +
                                html_row_jenis_nilai +
                              "</tr>" +
                              html_row_body;

            html = "<table style=\"border-collapse: collapse;\">" +
                        html_row_header +
                   "</table>";

            return html;
        }

        public static string GetPredikatNilaiSikap(decimal nilai, string tahun_ajaran, string semester)
        {
            if ((Libs.GetStringToDecimal(tahun_ajaran.Replace("/", "")) * 10) + Libs.GetStringToInteger(semester) >= 202120221)
            {
                Double d_nilai = Convert.ToDouble(nilai);
                if (d_nilai > 2.4 && d_nilai <= 3)
                {
                    return "Sangat Baik";
                }
                else if (d_nilai > 1.7 && d_nilai <= 2.4)
                {
                    return "Baik";
                }
                else if (d_nilai >= 1 && d_nilai <= 1.7)
                {
                    return "Cukup";
                }
            }
            else
            {
                if (nilai >= 3)
                {
                    return "Sangat Baik";
                }
                else if (nilai >= 2 && nilai < 3)
                {
                    return "Baik";
                }
                else if (nilai < 2)
                {
                    return "Cukup";
                }
            }
            
            return "";
        }

        public static string GetHTMLLedgerSikap_KURTILAS_2020(
            System.Web.UI.Page page,
            string tahun_ajaran,
            string semester,
            string rel_kelas_det,
            string rel_siswa = ""
        )
        {
            string css_cell_headers = "border-style: solid; border-width: 1px; text-align: center; font-weight: bold; padding: 5px;";
            string css_cell_body = "border-style: solid; border-width: 1px; padding: 3px;";

            string html = "";
            string html_row_header = "<td rowspan=\"3\" style=\"" + css_cell_headers + "\">" +
                                        "No" +
                                     "</td>" +
                                     "<td rowspan=\"3\" style=\"" + css_cell_headers + "\">" +
                                        "NIS" +
                                     "</td>" +
                                     "<td rowspan=\"3\" style=\"" + css_cell_headers + "\">" +
                                        "NAMA LENGKAP" +
                                     "</td>" +
                                     "<td rowspan=\"3\" style=\"" + css_cell_headers + "\">" +
                                        "L/P" +
                                     "</td>";
            string html_row_mapel = "";
            string html_row_jenis_nilai = "";
            string html_row_body = "";

            KelasDet m_kelas_det = DAO_KelasDet.GetByID_Entity(rel_kelas_det);
            if (m_kelas_det != null)
            {
                if (m_kelas_det.Nama != null)
                {

                    Kelas m_kelas = DAO_Kelas.GetByID_Entity(m_kelas_det.Rel_Kelas.ToString());
                    if (m_kelas != null)
                    {
                        if (m_kelas.Nama != null)
                        {

                            Rapor_Desain rapor_desain = DAO_Rapor_Desain.GetByTABySMByKelas_Entity(
                                    tahun_ajaran, semester, rel_kelas_det, DAO_Rapor_Desain.JenisRapor.Semester
                                ).FirstOrDefault();

                            List<Rapor_Desain_Det> lst_rapor_desain_det = DAO_Rapor_Desain_Det.GetAllByHeader_Entity(rapor_desain.Kode.ToString()).FindAll(m => m.Rel_Mapel.Trim() != "");

                            //list cols header
                            int jml_colspan_mapel = 0;
                            int jumlah_mapel = 0;
                            html_row_mapel = "";

                            //nilai guru kelas
                            html_row_mapel += "<td colspan=\"2\" style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                    "GURU KELAS" +
                                              "</td>";
                            html_row_jenis_nilai += "<td style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                            "SPIRITUAL" +
                                                    "</td>" +
                                                    "<td style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                            "SOSIAL" +
                                                    "</td>";
                            jumlah_mapel++;
                            //end nilai guru kelas
                            bool is_guru_matpel = false;
                            foreach (Rapor_Desain_Det item_desain_det in lst_rapor_desain_det)
                            {
                                is_guru_matpel = false;
                                //cek is guru matpel
                                is_guru_matpel = (
                                        DAO_FormasiGuruMapelDet.GetByTABySMByKelasByMapel_Entity(
                                            tahun_ajaran, semester, m_kelas_det.Rel_Kelas.ToString(), item_desain_det.Rel_Mapel
                                        ).FindAll(m0 => m0.Rel_FormasiGuruMapel.ToString().Trim() != "" &&
                                                        m0.Rel_FormasiGuruMapel.ToString().Trim() != Constantas.GUID_NOL).Count > 0
                                        ? true
                                        : false
                                    );
                                //end cek is guru matpel
                                if (is_guru_matpel)
                                {
                                    html_row_mapel += "<td colspan=\"2\" style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                    item_desain_det.NamaMapelRapor.Trim().ToUpper() +
                                                  "</td>";
                                    html_row_jenis_nilai += "<td style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                                    "SPIRITUAL" +
                                                            "</td>" +
                                                            "<td style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                                    "SOSIAL" +
                                                            "</td>";
                                    jumlah_mapel++;
                                }
                            }
                            jml_colspan_mapel = (jumlah_mapel * 2);

                            //struktur nilai sikap
                            List<Rapor_StrukturNilai> lst_sn_sikap = DAO_Rapor_StrukturNilai.GetMapelSikapByTAByKelas_Entity(tahun_ajaran, DAO_KelasDet.GetByID_Entity(rel_kelas_det).Rel_Kelas.ToString());

                            decimal d_bobot_spiritual_guru_kelas = 0;
                            decimal d_bobot_spiritual_guru_bid_stud = 0;
                            foreach (var sn_sikap in lst_sn_sikap.FindAll(m => m.Semester == semester && m.Rel_Mapel.ToString().Trim().ToUpper() == KODE_SIKAP_SPIRITUAL))
                            {
                                d_bobot_spiritual_guru_kelas = sn_sikap.BobotSikapGuruKelas;
                                d_bobot_spiritual_guru_bid_stud = sn_sikap.BobotSikapGuruMapel;
                            }

                            decimal d_bobot_sosial_guru_kelas = 0;
                            decimal d_bobot_sosial_guru_bid_stud = 0;
                            foreach (var sn_sikap in lst_sn_sikap.FindAll(m => m.Semester == semester && m.Rel_Mapel.ToString().Trim().ToUpper() == KODE_SIKAP_SOSIAL))
                            {
                                d_bobot_sosial_guru_kelas = sn_sikap.BobotSikapGuruKelas;
                                d_bobot_sosial_guru_bid_stud = sn_sikap.BobotSikapGuruMapel;
                            }
                            //end struktur nilai sikap

                            html_row_header += "<td colspan=\"" + jml_colspan_mapel.ToString() + "\" style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                    "NILAI SIKAP" +
                                               "</td>";
                            html_row_header += "<td colspan=\"2\" style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                    "RATA-RATA" +
                                               "</td>";
                            html_row_header += "<td colspan=\"4\" style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                    "BOBOT" +
                                               "</td>";
                            html_row_header += "<td colspan=\"4\" style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                    "NILAI AKHIR" +
                                               "</td>";
                            html_row_header += "<td colspan=\"4\" style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                    "PRESENSI" +
                                               "</td>";

                            html_row_mapel += "<td colspan=\"2\" style=\"" + css_cell_headers + " width: 30px; font-size: 8.5px; \">" +
                                                    "GURU BIDANG STUDI" +
                                              "</td>";

                            html_row_mapel += "<td colspan=\"2\" style=\"" + css_cell_headers + " width: 30px; font-size: 8.5px; \">" +
                                                    "GURU BIDANG STUDI"  +
                                              "</td>";
                            html_row_mapel += "<td colspan=\"2\" style=\"" + css_cell_headers + " width: 30px; font-size: 8.5px; \">" +
                                                    "GURU KELAS" +
                                              "</td>";

                            html_row_mapel += "<td colspan=\"2\" style=\"" + css_cell_headers + " width: 30px; font-size: 8.5px; \">" +
                                                    "SIKAP SPIRITUAL" +
                                              "</td>";
                            html_row_mapel += "<td colspan=\"2\" style=\"" + css_cell_headers + " width: 30px; font-size: 8.5px; \">" +
                                                    "SIKAP SOSIAL" +
                                              "</td>";

                            html_row_mapel += "<td rowspan=\"2\" style=\"" + css_cell_headers + " width: 30px; font-size: 8.5px; \">" +
                                                    "S" +
                                              "</td>" +
                                              "<td rowspan=\"2\" style=\"" + css_cell_headers + " width: 30px; font-size: 8.5px; \">" +
                                                    "I" +
                                              "</td>" +
                                              "<td rowspan=\"2\" style=\"" + css_cell_headers + " width: 30px; font-size: 8.5px; \">" +
                                                    "A" +
                                              "</td>" +
                                              "<td rowspan=\"2\" style=\"" + css_cell_headers + " width: 30px; font-size: 8.5px; \">" +
                                                    "T" +
                                              "</td>";

                            html_row_jenis_nilai += "<td style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                            "SPIRITUAL" +
                                                    "</td>" +
                                                    "<td style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                            "SOSIAL" +
                                                    "</td>";

                            html_row_jenis_nilai += "<td style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                            "SPIRITUAL (" + d_bobot_spiritual_guru_bid_stud.ToString() + "%)" +
                                                    "</td>" +
                                                    "<td style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                            "SOSIAL (" + d_bobot_sosial_guru_bid_stud.ToString() + "%)" +
                                                    "</td>";
                            html_row_jenis_nilai += "<td style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                            "SPIRITUAL (" + d_bobot_spiritual_guru_kelas.ToString() + "%)" +
                                                    "</td>" +
                                                    "<td style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                            "SOSIAL (" + d_bobot_sosial_guru_kelas.ToString() + "%)" +
                                                    "</td>";

                            html_row_jenis_nilai += "<td style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                            "NILAI" +
                                                    "</td>" +
                                                    "<td style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                            "PREDIKAT" +
                                                    "</td>";
                            html_row_jenis_nilai += "<td style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                            "NILAI" +
                                                    "</td>" +
                                                    "<td style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                            "PREDIKAT" +
                                                    "</td>";

                            //end list cols header
                            if (rapor_desain != null)
                            {
                                List<DAO_Siswa.SiswaDataSimple> lst_siswa = DAO_Siswa.GetAllSiswaDataSimpleByTahunAjaranUnitKelas_Entity(
                                        m_kelas.Rel_Sekolah.ToString(),
                                        rel_kelas_det,
                                        tahun_ajaran,
                                        semester
                                    );
                                int id_kolom_ledger = 0;
                                int nomor = 1;
                                int jumlah_awal_col_ledger = 3;
                                int jumlah_mapel_rapor = 0;

                                if (rel_siswa.Trim() != "")
                                {
                                    lst_siswa = lst_siswa.FindAll(m0 => (rel_siswa + ";").Trim().ToUpper().IndexOf(m0.Kode.ToString().ToUpper() + ";") >= 0).ToList();
                                }
                                List<NilaiWithKey> lst_all_nilai_rapor = new List<NilaiWithKey>();
                                List<NilaiWithKey> lst_kkm_nilai_rapor = new List<NilaiWithKey>();
                                List<NilaiWithKey> lst_jumlah_nilai_keseluruhan = new List<NilaiWithKey>();
                                List<NilaiWithKey> lst_nilai_rapor = new List<NilaiWithKey>();
                                string html_row_rata_rata = "<td colspan=\"4\" style=\"" + css_cell_body + " font-weight: bold;\">" +
                                                                "RATA-RATA KELAS" +
                                                            "</td>";

                                int id_mulai_looping_rata_rata = id_kolom_ledger + 1;
                                int id_mulai_looping_kkm = jumlah_mapel_rapor + 1;

                                decimal d_jumlah_rata2_bid_stud_spiritual = 0;
                                decimal d_jumlah_rata2_bid_stud_sosial = 0;

                                decimal d_jumlah_nilai_akhir_sikap_spiritual = 0;
                                decimal d_jumlah_nilai_akhir_sikap_sosial = 0;

                                foreach (DAO_Siswa.SiswaDataSimple m_siswa in lst_siswa.OrderBy(m => m.Nama))
                                {
                                    jumlah_mapel_rapor = 0;

                                    string html_row_body_siswa = "";
                                    html_row_body_siswa += "<td style=\"" + css_cell_body + " text-align: center;\">" +
                                                                nomor.ToString() +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + "\">" +
                                                                m_siswa.NISSekolah +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + " white-space: nowrap;\">" +
                                                                Libs.GetPerbaikiEjaanNama(m_siswa.Nama) +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + "\">" +
                                                                m_siswa.JenisKelamin +
                                                           "</td>";

                                    lst_kkm_nilai_rapor.Clear();
                                    id_kolom_ledger = jumlah_awal_col_ledger;
                                    //nilai sikap by guru kelas
                                    decimal nilai_sikap_spiritual = 0;
                                    decimal nilai_sikap_sosial = 0;
                                    nilai_sikap_spiritual = 0;
                                    nilai_sikap_sosial = 0;

                                    nilai_sikap_spiritual = DAO_Rapor_SikapSemester.GetNilaiSikapSemesterByMapel_Entity(
                                                    tahun_ajaran, semester, rel_kelas_det, m_siswa.Kode.ToString(), "", KODE_SIKAP_SPIRITUAL
                                                );
                                    lst_all_nilai_rapor.Add(new NilaiWithKey
                                    {
                                        Key = (id_kolom_ledger).ToString(),
                                        Nilai = Math.Round(nilai_sikap_spiritual, 0, MidpointRounding.AwayFromZero)
                                    });
                                    id_kolom_ledger++;

                                    nilai_sikap_sosial = DAO_Rapor_SikapSemester.GetNilaiSikapSemesterByMapel_Entity(
                                            tahun_ajaran, semester, rel_kelas_det, m_siswa.Kode.ToString(), "", KODE_SIKAP_SOSIAL
                                        );
                                    lst_all_nilai_rapor.Add(new NilaiWithKey
                                    {
                                        Key = (id_kolom_ledger).ToString(),
                                        Nilai = Math.Round(nilai_sikap_sosial, 0, MidpointRounding.AwayFromZero)
                                    });
                                    id_kolom_ledger++;

                                    decimal d_nilai_sikap_spiritual_guru_kelas = nilai_sikap_spiritual;
                                    html_row_body_siswa += "<td style=\"" + css_cell_body + " text-align: center; " + "\">" +
                                                                (
                                                                    nilai_sikap_spiritual > 0
                                                                    ? Math.Round(nilai_sikap_spiritual, 0, MidpointRounding.AwayFromZero).ToString()
                                                                    : ""
                                                                ) +
                                                           "</td>";
                                    decimal d_nilai_sikap_sosial_guru_kelas = nilai_sikap_sosial;
                                    html_row_body_siswa += "<td style=\"" + css_cell_body + " text-align: center; " + "\">" +
                                                                (
                                                                    nilai_sikap_sosial > 0
                                                                    ? Math.Round(nilai_sikap_sosial, 0, MidpointRounding.AwayFromZero).ToString()
                                                                    : ""
                                                                ) +
                                                           "</td>";
                                    //end nilai sikap by guru kelas
                                    decimal jumlah_sikap_sosial_gb = 0;
                                    decimal jumlah_sikap_spiritual_gb = 0;
                                    decimal i_jumlah_sikap_sosial_gb = 0;
                                    decimal i_jumlah_sikap_spiritual_gb = 0;

                                    foreach (Rapor_Desain_Det item in DAO_Rapor_Desain_Det.GetAllByHeader_Entity(rapor_desain.Kode.ToString()).FindAll(m => m.Rel_Mapel.Trim() != ""))
                                    {
                                        is_guru_matpel = false;
                                        //cek is guru matpel
                                        is_guru_matpel = (
                                                DAO_FormasiGuruMapelDet.GetByTABySMByKelasByMapel_Entity(
                                                    tahun_ajaran, semester, m_kelas_det.Rel_Kelas.ToString(), item.Rel_Mapel
                                                ).FindAll(m0 => m0.Rel_FormasiGuruMapel.ToString().Trim() != "" &&
                                                                m0.Rel_FormasiGuruMapel.ToString().Trim() != Constantas.GUID_NOL).Count > 0
                                                ? true
                                                : false
                                            );
                                        //end cek is guru matpel
                                        if (item.Rel_Mapel.Trim() != "" && is_guru_matpel)
                                        {

                                            nilai_sikap_spiritual = 0;
                                            nilai_sikap_sosial = 0;

                                            nilai_sikap_spiritual = DAO_Rapor_SikapSemester.GetNilaiSikapSemesterByMapel_Entity(
                                                            tahun_ajaran, semester, rel_kelas_det, m_siswa.Kode.ToString(), item.Rel_Mapel.ToString(), KODE_SIKAP_SPIRITUAL
                                                        );
                                            lst_all_nilai_rapor.Add(new NilaiWithKey
                                            {
                                                Key = (id_kolom_ledger).ToString(),
                                                Nilai = Math.Round(nilai_sikap_spiritual, 0, MidpointRounding.AwayFromZero)
                                            });
                                            id_kolom_ledger++;

                                            nilai_sikap_sosial = DAO_Rapor_SikapSemester.GetNilaiSikapSemesterByMapel_Entity(
                                                    tahun_ajaran, semester, rel_kelas_det, m_siswa.Kode.ToString(), item.Rel_Mapel.ToString(), KODE_SIKAP_SOSIAL
                                                );
                                            lst_all_nilai_rapor.Add(new NilaiWithKey
                                            {
                                                Key = (id_kolom_ledger).ToString(),
                                                Nilai = Math.Round(nilai_sikap_sosial, 0, MidpointRounding.AwayFromZero)
                                            });
                                            id_kolom_ledger++;

                                            html_row_body_siswa += "<td style=\"" + css_cell_body + " text-align: center; " + "\">" +
                                                                        (
                                                                            nilai_sikap_spiritual > 0
                                                                            ? Math.Round(nilai_sikap_spiritual, 0, MidpointRounding.AwayFromZero).ToString()
                                                                            : ""
                                                                        ) +
                                                                   "</td>";
                                            if (nilai_sikap_spiritual > 0)
                                            {
                                                i_jumlah_sikap_spiritual_gb++;
                                                jumlah_sikap_spiritual_gb += Math.Round(nilai_sikap_spiritual, 0, MidpointRounding.AwayFromZero);
                                            }

                                            html_row_body_siswa += "<td style=\"" + css_cell_body + " text-align: center; " + "\">" +
                                                                        (
                                                                            nilai_sikap_sosial > 0
                                                                            ? Math.Round(nilai_sikap_sosial, 0, MidpointRounding.AwayFromZero).ToString()
                                                                            : ""
                                                                        ) +
                                                                   "</td>";
                                            if (nilai_sikap_sosial > 0)
                                            {
                                                i_jumlah_sikap_sosial_gb++;
                                                jumlah_sikap_sosial_gb += Math.Round(nilai_sikap_sosial, 0, MidpointRounding.AwayFromZero);
                                            }
                                        }

                                    }

                                    //rata-rata
                                    decimal d_nilai_rata2_spiritual_guru_bid_stud = Math.Round((jumlah_sikap_spiritual_gb / i_jumlah_sikap_spiritual_gb), 2);
                                    decimal d_nilai_rata2_sosial_guru_bid_stud = Math.Round((jumlah_sikap_sosial_gb / i_jumlah_sikap_sosial_gb), 2);
                                    html_row_body_siswa += "<td style=\"" + css_cell_body + " text-align: center; \">" +
                                                                d_nilai_rata2_spiritual_guru_bid_stud +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + " text-align: center; \">" +
                                                                d_nilai_rata2_sosial_guru_bid_stud + 
                                                           "</td>";
                                    d_jumlah_rata2_bid_stud_spiritual += d_nilai_rata2_spiritual_guru_bid_stud;
                                    d_jumlah_rata2_bid_stud_sosial += d_nilai_rata2_sosial_guru_bid_stud;
                                    //end rata-rata

                                    //bobot
                                    html_row_body_siswa += "<td style=\"" + css_cell_body + " text-align: center; \">" +
                                                                Math.Round(
                                                                    (
                                                                        d_nilai_rata2_spiritual_guru_bid_stud * 
                                                                        Math.Round(d_bobot_spiritual_guru_bid_stud / 100, 2)
                                                                    ), 2)
                                                                .ToString() +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + " text-align: center; \">" +
                                                                Math.Round(
                                                                    (
                                                                        d_nilai_rata2_sosial_guru_bid_stud *
                                                                        Math.Round(d_bobot_sosial_guru_bid_stud / 100, 2)
                                                                    ), 2)
                                                                .ToString() +
                                                           "</td>";
                                    html_row_body_siswa += "<td style=\"" + css_cell_body + " text-align: center; \">" +
                                                                Math.Round(
                                                                    (
                                                                        d_nilai_sikap_spiritual_guru_kelas *
                                                                        Math.Round(d_bobot_spiritual_guru_kelas / 100, 2)
                                                                    ), 2)
                                                                .ToString() +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + " text-align: center; \">" +
                                                                Math.Round(
                                                                    (
                                                                        d_nilai_sikap_sosial_guru_kelas *
                                                                        Math.Round(d_bobot_sosial_guru_kelas / 100, 2)
                                                                    ), 2)
                                                                .ToString() +
                                                           "</td>";
                                    //end bobot

                                    //nilai akhir
                                    decimal d_nilai_akhir_sikap_spiritual =
                                        (
                                            Math.Round(
                                                (
                                                    d_nilai_sikap_spiritual_guru_kelas *
                                                    Math.Round(d_bobot_spiritual_guru_kelas / 100, 2)
                                                ), 2) +
                                            Math.Round(
                                                (
                                                    d_nilai_rata2_spiritual_guru_bid_stud *
                                                    Math.Round(d_bobot_spiritual_guru_bid_stud / 100, 2)
                                                ), 2)
                                        );
                                    decimal d_nilai_akhir_sikap_sosial =
                                        (
                                            Math.Round(
                                                (
                                                    d_nilai_sikap_sosial_guru_kelas *
                                                    Math.Round(d_bobot_sosial_guru_kelas / 100, 2)
                                                ), 2) +
                                            Math.Round(
                                                (
                                                    d_nilai_rata2_sosial_guru_bid_stud *
                                                    Math.Round(d_bobot_sosial_guru_bid_stud / 100, 2)
                                                ), 2)
                                        );
                                    html_row_body_siswa += "<td style=\"" + css_cell_body + " text-align: center; white-space: nowrap\">" +
                                                                d_nilai_akhir_sikap_spiritual.ToString() +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + " text-align: center; white-space: nowrap\">" +
                                                                GetPredikatNilaiSikap(d_nilai_akhir_sikap_spiritual, tahun_ajaran, semester) +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + " text-align: center; white-space: nowrap\">" +
                                                                d_nilai_akhir_sikap_sosial.ToString() +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + " text-align: center; white-space: nowrap\">" +
                                                                GetPredikatNilaiSikap(d_nilai_akhir_sikap_sosial, tahun_ajaran, semester) +
                                                           "</td>";
                                    d_jumlah_nilai_akhir_sikap_spiritual += d_nilai_akhir_sikap_spiritual;
                                    d_jumlah_nilai_akhir_sikap_sosial += d_nilai_akhir_sikap_sosial;
                                    //end nilai akhir

                                    //absen
                                    string s_sakit = "-";
                                    string s_izin = "-";
                                    string s_alpa = "-";
                                    string s_terlambat = "-";

                                    Rapor_Arsip m_rapor_arsip = DAO_Rapor_Arsip.GetAll_Entity().FindAll(
                                            m0 => m0.TahunAjaran == tahun_ajaran &&
                                                  m0.Semester == semester &&
                                                  m0.JenisRapor == "Semester"

                                        ).FirstOrDefault();
                                    List<DAO_SiswaAbsen.AbsenRekapRapor> lst_absen = new List<DAO_SiswaAbsen.AbsenRekapRapor>();
                                    lst_absen = DAO_SiswaAbsen.GetRekapAbsenRaporBySiswaByPeriode_Entity(
                                            m_siswa.Kode.ToString(),
                                            (m_rapor_arsip != null ? m_rapor_arsip.TanggalAwalAbsen : DateTime.MinValue),
                                            (m_rapor_arsip != null ? m_rapor_arsip.TanggalAkhirAbsen : DateTime.MinValue)
                                        );
                                    foreach (var absen in lst_absen)
                                    {
                                        if (absen.Absen == Libs.JENIS_ABSENSI.SAKIT.Substring(0, 1)) s_sakit = absen.Jumlah.ToString();
                                        if (absen.Absen == Libs.JENIS_ABSENSI.IZIN.Substring(0, 1)) s_izin = absen.Jumlah.ToString();
                                        if (absen.Absen == Libs.JENIS_ABSENSI.ALPA.Substring(0, 1)) s_alpa = absen.Jumlah.ToString();
                                        if (absen.Absen == Libs.JENIS_ABSENSI.TERLAMBAT.Substring(0, 1)) s_terlambat = absen.Jumlah.ToString();
                                    }
                                    html_row_body_siswa += "<td style=\"" + css_cell_body + " text-align: center; \">" +
                                                                s_sakit +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + " text-align: center; \">" +
                                                                s_izin +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + " text-align: center; \">" +
                                                                s_alpa +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + " text-align: center; \">" +
                                                                s_terlambat +
                                                           "</td>";
                                    //end absen

                                    html_row_body += "<tr>" +
                                                        html_row_body_siswa +
                                                     "</tr>";

                                    nomor++;
                                }
                                // end foreach siswa

                                for (int i = (jumlah_awal_col_ledger); i < id_kolom_ledger; i++)
                                {
                                    if (i >= id_mulai_looping_rata_rata)
                                    {
                                        decimal rata_rata = Math.Round(lst_all_nilai_rapor.FindAll(m => m.Key == i.ToString()).Select(m => m.Nilai).DefaultIfEmpty().Sum() / lst_siswa.Count, Constantas.PEMBULATAN_DESIMAL_NILAI_SD);
                                        var lst_all_nilai_rapor_ = lst_all_nilai_rapor.FindAll(m => m.Key == i.ToString());
                                        html_row_rata_rata += "<td style=\"" + css_cell_body + " text-align: right;\">" +
                                                                    (
                                                                        rata_rata > 0
                                                                        ? Libs.GetFormatBilangan(rata_rata, Constantas.PEMBULATAN_DESIMAL_NILAI_SD)
                                                                        : ""
                                                                    ) +
                                                              "</td>";
                                    }
                                    else
                                    {
                                        decimal rata_rata = Math.Round(lst_all_nilai_rapor.FindAll(m => m.Key == i.ToString()).Select(m => m.Nilai).DefaultIfEmpty().Sum() / lst_siswa.Count, Constantas.PEMBULATAN_DESIMAL_NILAI_SD);
                                        var lst_all_nilai_rapor_ = lst_all_nilai_rapor.FindAll(m => m.Key == i.ToString());
                                        html_row_rata_rata += "<td style=\"" + css_cell_body + " text-align: right;\">" +
                                                                    (
                                                                        rata_rata > 0
                                                                        ? Libs.GetFormatBilangan(rata_rata, Constantas.PEMBULATAN_DESIMAL_NILAI_SD)
                                                                        : ""
                                                                    ) +
                                                              "</td>";
                                    }
                                }

                                html_row_rata_rata += "<td style=\"" + css_cell_body + " text-align: right;\">" +
                                                            (
                                                                d_jumlah_rata2_bid_stud_spiritual > 0
                                                                ? Libs.GetFormatBilangan((d_jumlah_rata2_bid_stud_spiritual / lst_siswa.Count), 2)
                                                                : ""
                                                            ) +
                                                      "</td>" +
                                                      "<td style=\"" + css_cell_body + " text-align: right;\">" +
                                                            (
                                                                d_jumlah_rata2_bid_stud_sosial > 0
                                                                ? Libs.GetFormatBilangan((d_jumlah_rata2_bid_stud_sosial / lst_siswa.Count), 2)
                                                                : ""
                                                            ) +
                                                      "</td>" +
                                                      "<td style=\"" + css_cell_body + " text-align: right;\">&nbsp;</td>" +
                                                      "<td style=\"" + css_cell_body + " text-align: right;\">&nbsp;</td>" +
                                                      "<td style=\"" + css_cell_body + " text-align: right;\">&nbsp;</td>" +
                                                      "<td style=\"" + css_cell_body + " text-align: right;\">&nbsp;</td>" +
                                                      "<td style=\"" + css_cell_body + " text-align: right;\">" +
                                                            (
                                                                d_jumlah_nilai_akhir_sikap_spiritual > 0
                                                                ? Libs.GetFormatBilangan((d_jumlah_nilai_akhir_sikap_spiritual / lst_siswa.Count), 2)
                                                                : ""
                                                            ) +
                                                      "</td>" +
                                                      "<td style=\"" + css_cell_body + " text-align: right;\">&nbsp;</td>" +
                                                      "<td style=\"" + css_cell_body + " text-align: right;\">" +
                                                            (
                                                                d_jumlah_nilai_akhir_sikap_sosial > 0
                                                                ? Libs.GetFormatBilangan((d_jumlah_nilai_akhir_sikap_sosial / lst_siswa.Count), 2)
                                                                : ""
                                                            ) +
                                                      "</td>" +
                                                      "<td style=\"" + css_cell_body + " text-align: right;\">";

                                decimal rata_rata_nilai_keseluruhan = Math.Round(lst_jumlah_nilai_keseluruhan.Select(m => m.Nilai).DefaultIfEmpty().Average(), Constantas.PEMBULATAN_DESIMAL_NILAI_SD);
                                decimal rata_rata_nilai_rata_rata_rapor = Math.Round(lst_nilai_rapor.Select(m => m.Nilai).DefaultIfEmpty().Average(), Constantas.PEMBULATAN_DESIMAL_NILAI_SD);
                                html_row_body += "<tr>" +
                                                    html_row_rata_rata +
                                                 "</tr>";

                            }

                        }
                    }

                }
            }

            html_row_header = "<tr>" +
                                html_row_header +
                              "</tr>" +
                              "<tr>" +
                                html_row_mapel +
                              "</tr>" +
                              "<tr>" +
                                html_row_jenis_nilai +
                              "</tr>" +
                              html_row_body;

            html = "<table style=\"border-collapse: collapse;\">" +
                        html_row_header +
                   "</table>";

            return html;
        }

        public static string GetHTMLLedgerSikap_KTSP(
            System.Web.UI.Page page,
            string tahun_ajaran,
            string semester,
            string rel_kelas_det,
            string rel_siswa = ""
        )
        {
            string css_cell_headers = "border-style: solid; border-width: 1px; text-align: center; font-weight: bold; padding: 5px;";
            string css_cell_body = "border-style: solid; border-width: 1px; padding: 3px;";

            string html = "";
            string html_row_header = "<td rowspan=\"3\" style=\"" + css_cell_headers + "\">" +
                                        "No" +
                                     "</td>" +
                                     "<td rowspan=\"3\" style=\"" + css_cell_headers + "\">" +
                                        "NIS" +
                                     "</td>" +
                                     "<td rowspan=\"3\" style=\"" + css_cell_headers + "\">" +
                                        "NAMA LENGKAP" +
                                     "</td>" +
                                     "<td rowspan=\"3\" style=\"" + css_cell_headers + "\">" +
                                        "L/P" +
                                     "</td>";
            string html_row_mapel = "";
            string html_row_jenis_nilai = "";
            string html_row_body = "";

            KelasDet m_kelas_det = DAO_KelasDet.GetByID_Entity(rel_kelas_det);
            if (m_kelas_det != null)
            {
                if (m_kelas_det.Nama != null)
                {

                    Kelas m_kelas = DAO_Kelas.GetByID_Entity(m_kelas_det.Rel_Kelas.ToString());
                    if (m_kelas != null)
                    {
                        if (m_kelas.Nama != null)
                        {

                            Rapor_Desain rapor_desain = DAO_Rapor_Desain.GetByTABySMByKelas_Entity(
                                    tahun_ajaran, semester, rel_kelas_det, DAO_Rapor_Desain.JenisRapor.Semester
                                ).FirstOrDefault();

                            List<Rapor_Desain_Det> lst_rapor_desain_det = DAO_Rapor_Desain_Det.GetAllByHeader_Entity(rapor_desain.Kode.ToString()).FindAll(m => m.Rel_Mapel.Trim() != "");

                            //list cols header
                            int jml_colspan_mapel = 0;
                            int jumlah_mapel = 0;
                            html_row_mapel = "";

                            //nilai guru kelas
                            html_row_mapel += "<td rowspan=\"2\" style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                    "GURU KELAS" +
                                              "</td>";
                            jumlah_mapel++;
                            //end nilai guru kelas
                            bool is_guru_matpel = false;
                            foreach (Rapor_Desain_Det item_desain_det in lst_rapor_desain_det)
                            {
                                is_guru_matpel = false;
                                //cek is guru matpel
                                is_guru_matpel = (
                                        DAO_FormasiGuruMapelDet.GetByTABySMByKelasByMapel_Entity(
                                            tahun_ajaran, semester, m_kelas_det.Rel_Kelas.ToString(), item_desain_det.Rel_Mapel
                                        ).FindAll(m0 => m0.Rel_FormasiGuruMapel.ToString().Trim() != "" && 
                                                        m0.Rel_FormasiGuruMapel.ToString().Trim() != Constantas.GUID_NOL).Count > 0
                                        ? true
                                        : false
                                    );
                                var _lst = DAO_FormasiGuruMapelDet.GetByTABySMByKelasByMapel_Entity(
                                            tahun_ajaran, semester, m_kelas_det.Rel_Kelas.ToString(), item_desain_det.Rel_Mapel
                                        ).FindAll(m0 => m0.Rel_FormasiGuruMapel.ToString().Trim() != "");
                                //end cek is guru matpel
                                if (is_guru_matpel)
                                {
                                    html_row_mapel += "<td rowspan=\"2\" style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                    item_desain_det.NamaMapelRapor.Trim().ToUpper() +
                                                  "</td>";
                                    jumlah_mapel++;
                                }
                            }
                            jml_colspan_mapel = (jumlah_mapel);

                            html_row_header += "<td colspan=\"" + jml_colspan_mapel.ToString() + "\" style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                    "NILAI SIKAP" +
                                               "</td>";
                            html_row_header += "<td colspan=\"4\" style=\"" + css_cell_headers + " font-size: 8.5px; \">" +
                                                    "PRESENSI" +
                                               "</td>";
                            html_row_mapel += "<td rowspan=\"2\" style=\"" + css_cell_headers + " width: 30px; font-size: 8.5px; \">" +
                                                    "S" +
                                              "</td>" +
                                              "<td rowspan=\"2\" style=\"" + css_cell_headers + " width: 30px; font-size: 8.5px; \">" +
                                                    "I" +
                                              "</td>" +
                                              "<td rowspan=\"2\" style=\"" + css_cell_headers + " width: 30px; font-size: 8.5px; \">" +
                                                    "A" +
                                              "</td>" +
                                              "<td rowspan=\"2\" style=\"" + css_cell_headers + " width: 30px; font-size: 8.5px; \">" +
                                                    "T" +
                                              "</td>";
                            //end list cols header
                            if (rapor_desain != null)
                            {

                                List<DAO_Siswa.SiswaDataSimple> lst_siswa = DAO_Siswa.GetAllSiswaDataSimpleByTahunAjaranUnitKelas_Entity(
                                        m_kelas.Rel_Sekolah.ToString(),
                                        rel_kelas_det,
                                        tahun_ajaran,
                                        semester
                                    );
                                int id_kolom_ledger = 0;
                                int nomor = 1;
                                int jumlah_awal_col_ledger = 3;
                                int jumlah_mapel_rapor = 0;

                                if (rel_siswa.Trim() != "")
                                {
                                    lst_siswa = lst_siswa.FindAll(m0 => (rel_siswa + ";").Trim().ToUpper().IndexOf(m0.Kode.ToString().ToUpper() + ";") >= 0).ToList();
                                }
                                List<NilaiWithKey> lst_all_nilai_rapor = new List<NilaiWithKey>();
                                List<NilaiWithKey> lst_kkm_nilai_rapor = new List<NilaiWithKey>();
                                List<NilaiWithKey> lst_jumlah_nilai_keseluruhan = new List<NilaiWithKey>();
                                List<NilaiWithKey> lst_nilai_rapor = new List<NilaiWithKey>();
                                string html_row_rata_rata = "<td colspan=\"4\" style=\"" + css_cell_body + " font-weight: bold;\">" +
                                                                "RATA-RATA KELAS" +
                                                            "</td>";

                                int id_mulai_looping_rata_rata = id_kolom_ledger + 1;
                                int id_mulai_looping_kkm = jumlah_mapel_rapor + 1;

                                foreach (DAO_Siswa.SiswaDataSimple m_siswa in lst_siswa.OrderBy(m => m.Nama))
                                {
                                    jumlah_mapel_rapor = 0;

                                    string html_row_body_siswa = "";
                                    html_row_body_siswa += "<td style=\"" + css_cell_body + " text-align: center;\">" +
                                                                nomor.ToString() +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + "\">" +
                                                                m_siswa.NISSekolah +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + " white-space: nowrap;\">" +
                                                                Libs.GetPerbaikiEjaanNama(m_siswa.Nama) +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + "\">" +
                                                                m_siswa.JenisKelamin +
                                                           "</td>";

                                    lst_kkm_nilai_rapor.Clear();
                                    id_kolom_ledger = jumlah_awal_col_ledger;
                                    //nilai sikap by guru kelas
                                    decimal nilai_sikap = 0;
                                    nilai_sikap = DAO_Rapor_SikapSemester.GetNilaiSikapSemesterByMapel_Entity(
                                                    tahun_ajaran, semester, rel_kelas_det, m_siswa.Kode.ToString(), "", KODE_SIKAP
                                                );
                                    lst_all_nilai_rapor.Add(new NilaiWithKey
                                    {
                                        Key = (id_kolom_ledger).ToString(),
                                        Nilai = Math.Round(nilai_sikap, 0, MidpointRounding.AwayFromZero)
                                    });
                                    id_kolom_ledger++;

                                    html_row_body_siswa += "<td style=\"" + css_cell_body + " text-align: center; " + "\">" +
                                                                (
                                                                    nilai_sikap > 0
                                                                    ? Math.Round(nilai_sikap, 0, MidpointRounding.AwayFromZero).ToString()
                                                                    : ""
                                                                ) +
                                                           "</td>";
                                    //end nilai sikap by guru kelas
                                    foreach (Rapor_Desain_Det item in DAO_Rapor_Desain_Det.GetAllByHeader_Entity(rapor_desain.Kode.ToString()).FindAll(m => m.Rel_Mapel.Trim() != ""))
                                    {
                                        is_guru_matpel = false;
                                        //cek is guru matpel
                                        is_guru_matpel = (
                                                DAO_FormasiGuruMapelDet.GetByTABySMByKelasByMapel_Entity(
                                                    tahun_ajaran, semester, m_kelas_det.Rel_Kelas.ToString(), item.Rel_Mapel
                                                ).FindAll(m0 => m0.Rel_FormasiGuruMapel.ToString().Trim() != "" &&
                                                                m0.Rel_FormasiGuruMapel.ToString().Trim() != Constantas.GUID_NOL).Count > 0
                                                ? true
                                                : false
                                            );
                                        //end cek is guru matpel
                                        if (item.Rel_Mapel.Trim() != "" && is_guru_matpel)
                                        {

                                            nilai_sikap = DAO_Rapor_SikapSemester.GetNilaiSikapSemesterByMapel_Entity(
                                                            tahun_ajaran, semester, rel_kelas_det, m_siswa.Kode.ToString(), item.Rel_Mapel.ToString(), KODE_SIKAP
                                                        );
                                            lst_all_nilai_rapor.Add(new NilaiWithKey
                                            {
                                                Key = (id_kolom_ledger).ToString(),
                                                Nilai = Math.Round(nilai_sikap, 0, MidpointRounding.AwayFromZero)
                                            });
                                            id_kolom_ledger++;

                                            html_row_body_siswa += "<td style=\"" + css_cell_body + " text-align: center; " + "\">" +
                                                                        (
                                                                            nilai_sikap > 0
                                                                            ? Math.Round(nilai_sikap, 0, MidpointRounding.AwayFromZero).ToString()
                                                                            : ""
                                                                        ) +
                                                                   "</td>";
                                        }

                                    }

                                    //absen
                                    string s_sakit = "-";
                                    string s_izin = "-";
                                    string s_alpa = "-";
                                    string s_terlambat = "-";

                                    Rapor_Arsip m_rapor_arsip = DAO_Rapor_Arsip.GetAll_Entity().FindAll(
                                            m0 => m0.TahunAjaran == tahun_ajaran &&
                                                  m0.Semester == semester &&
                                                  m0.JenisRapor == "Semester"

                                        ).FirstOrDefault();
                                    List<DAO_SiswaAbsen.AbsenRekapRapor> lst_absen = new List<DAO_SiswaAbsen.AbsenRekapRapor>();
                                    lst_absen = DAO_SiswaAbsen.GetRekapAbsenRaporBySiswaByPeriode_Entity(
                                            m_siswa.Kode.ToString(),
                                            (m_rapor_arsip != null ? m_rapor_arsip.TanggalAwalAbsen : DateTime.MinValue),
                                            (m_rapor_arsip != null ? m_rapor_arsip.TanggalAkhirAbsen : DateTime.MinValue)
                                        );
                                    foreach (var absen in lst_absen)
                                    {
                                        if (absen.Absen == Libs.JENIS_ABSENSI.SAKIT.Substring(0, 1)) s_sakit = absen.Jumlah.ToString();
                                        if (absen.Absen == Libs.JENIS_ABSENSI.IZIN.Substring(0, 1)) s_izin = absen.Jumlah.ToString();
                                        if (absen.Absen == Libs.JENIS_ABSENSI.ALPA.Substring(0, 1)) s_alpa = absen.Jumlah.ToString();
                                        if (absen.Absen == Libs.JENIS_ABSENSI.TERLAMBAT.Substring(0, 1)) s_terlambat = absen.Jumlah.ToString();
                                    }
                                    html_row_body_siswa += "<td style=\"" + css_cell_body + " text-align: center; \">" +
                                                                s_sakit +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + " text-align: center; \">" +
                                                                s_izin +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + " text-align: center; \">" +
                                                                s_alpa +
                                                           "</td>" +
                                                           "<td style=\"" + css_cell_body + " text-align: center; \">" +
                                                                s_terlambat +
                                                           "</td>";
                                    //end absen

                                    html_row_body += "<tr>" +
                                                        html_row_body_siswa +
                                                     "</tr>";

                                    nomor++;
                                }
                                // end foreach siswa

                                for (int i = (jumlah_awal_col_ledger); i < id_kolom_ledger; i++)
                                {
                                    if (i >= id_mulai_looping_rata_rata)
                                    {
                                        decimal rata_rata = Math.Round(lst_all_nilai_rapor.FindAll(m => m.Key == i.ToString()).Select(m => m.Nilai).DefaultIfEmpty().Sum() / lst_siswa.Count, Constantas.PEMBULATAN_DESIMAL_NILAI_SD);
                                        var lst_all_nilai_rapor_ = lst_all_nilai_rapor.FindAll(m => m.Key == i.ToString());
                                        html_row_rata_rata += "<td style=\"" + css_cell_body + " text-align: right;\">" +
                                                                    (
                                                                        rata_rata > 0
                                                                        ? Libs.GetFormatBilangan(rata_rata, Constantas.PEMBULATAN_DESIMAL_NILAI_SD)
                                                                        : ""
                                                                    ) +
                                                              "</td>";
                                    }
                                    else
                                    {
                                        decimal rata_rata = Math.Round(lst_all_nilai_rapor.FindAll(m => m.Key == i.ToString()).Select(m => m.Nilai).DefaultIfEmpty().Sum() / lst_siswa.Count, Constantas.PEMBULATAN_DESIMAL_NILAI_SD);
                                        var lst_all_nilai_rapor_ = lst_all_nilai_rapor.FindAll(m => m.Key == i.ToString());
                                        html_row_rata_rata += "<td style=\"" + css_cell_body + " text-align: right;\">" +
                                                                    (
                                                                        rata_rata > 0
                                                                        ? Libs.GetFormatBilangan(rata_rata, Constantas.PEMBULATAN_DESIMAL_NILAI_SD)
                                                                        : ""
                                                                    ) +
                                                              "</td>";
                                    }
                                }
                                decimal rata_rata_nilai_keseluruhan = Math.Round(lst_jumlah_nilai_keseluruhan.Select(m => m.Nilai).DefaultIfEmpty().Average(), Constantas.PEMBULATAN_DESIMAL_NILAI_SD);
                                decimal rata_rata_nilai_rata_rata_rapor = Math.Round(lst_nilai_rapor.Select(m => m.Nilai).DefaultIfEmpty().Average(), Constantas.PEMBULATAN_DESIMAL_NILAI_SD);
                                html_row_body += "<tr>" +
                                                    html_row_rata_rata +
                                                 "</tr>";

                            }

                        }
                    }

                }
            }

            html_row_header = "<tr>" +
                                html_row_header +
                              "</tr>" +
                              "<tr>" +
                                html_row_mapel +
                              "</tr>" +
                              "<tr>" +
                                html_row_jenis_nilai +
                              "</tr>" +
                              html_row_body;

            html = "<table style=\"border-collapse: collapse;\">" +
                        html_row_header +
                   "</table>";

            return html;
        }
    }
}